<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0A0A0A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Laktic Training">
    <meta name="description" content="Evidence-based 800m-3200m training system">
    <title>Laktic Training System - 800m to 3200m</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Archivo+Black&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF4D00;
            --secondary: #FFE600;
            --accent: #00D9FF;
            --dark: #0A0A0A;
            --light: #F5F5F5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Mono', monospace;
            background: var(--dark);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(90deg, rgba(255,77,0,0.03) 1px, transparent 1px),
                linear-gradient(rgba(255,77,0,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        h1 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: var(--accent);
            font-size: 0.9rem;
            margin-bottom: 40px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 77, 0, 0.3);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .card h2 {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .input-group {
            margin: 16px 0;
        }

        label {
            display: block;
            color: var(--accent);
            font-size: 0.85rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input, select {
            width: 100%;
            padding: 14px;
            background: var(--dark);
            border: 2px solid rgba(255, 77, 0, 0.4);
            border-radius: 8px;
            color: var(--light);
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(255, 77, 0, 0.3);
        }

        .btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--primary), #FF6B00);
            border: none;
            border-radius: 12px;
            color: var(--light);
            font-family: 'Archivo Black', sans-serif;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 77, 0, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid rgba(255, 77, 0, 0.3);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .workout-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .workout-day {
            font-weight: bold;
            color: var(--accent);
            font-size: 0.9rem;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .workout-type {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.05rem;
        }

        .workout-details {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .workout-rest {
            color: rgba(0, 217, 255, 0.7);
            font-size: 0.85rem;
            margin-top: 6px;
            font-style: italic;
        }

        .workout-notes {
            color: rgba(255, 230, 0, 0.7);
            font-size: 0.8rem;
            margin-top: 6px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 6px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(255, 77, 0, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .workout-plan {
            display: none;
        }

        .workout-plan.active {
            display: block;
        }

        #weekSelector {
            display: none;
        }

        .phase-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .phase-early {
            background: rgba(0, 217, 255, 0.2);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .phase-mid {
            background: rgba(255, 230, 0, 0.2);
            color: var(--secondary);
            border: 1px solid var(--secondary);
        }

        .phase-late {
            background: rgba(255, 77, 0, 0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .race-schedule-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .race-a { border-left: 4px solid var(--primary); }
        .race-b { border-left: 4px solid var(--secondary); }
        .race-c { border-left: 4px solid var(--accent); }

        /* Mobile App Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--dark);
            border-top: 2px solid rgba(255, 77, 0, 0.3);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 max(8px, env(safe-area-inset-bottom));
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            color: rgba(255,255,255,0.5);
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: bold;
            flex: 1;
            max-width: 100px;
        }

        .nav-item:active {
            transform: scale(0.95);
        }

        .nav-item.active {
            color: var(--primary);
            background: rgba(255, 77, 0, 0.15);
        }

        .nav-icon {
            font-size: 1.4rem;
        }

        .app-page {
            display: none;
            padding-bottom: 80px;
            min-height: calc(100vh - 80px);
        }

        .app-page.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Today's Workout Styles */
        .todays-workout-card {
            background: linear-gradient(135deg, rgba(255,77,0,0.15), rgba(0,217,255,0.15));
            border: 3px solid var(--primary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .workout-day-label {
            font-size: 0.85rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .workout-main-type {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 16px;
        }

        /* Calendar Styles */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(255,77,0,0.1);
            border-radius: 12px;
        }

        .calendar-nav-btn {
            padding: 8px 16px;
            background: rgba(255,77,0,0.2);
            border: 2px solid var(--primary);
            border-radius: 8px;
            color: var(--primary);
            cursor: pointer;
            font-weight: bold;
            font-family: 'Space Mono', monospace;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-top: 16px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 0.7rem;
            color: var(--accent);
            font-weight: bold;
            padding: 8px 4px;
            text-transform: uppercase;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,77,0,0.2);
            border-radius: 8px;
            padding: 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .calendar-day:active {
            transform: scale(0.95);
        }

        .calendar-day.empty {
            background: transparent;
            border: none;
            cursor: default;
        }

        .calendar-day.today {
            border: 2px solid var(--secondary);
            box-shadow: 0 0 10px rgba(255,230,0,0.3);
        }

        .calendar-day-number {
            font-weight: bold;
            color: var(--accent);
        }

        .calendar-workout-indicator {
            font-size: 0.6rem;
            color: rgba(255,255,255,0.6);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .calendar-day.hard {
            background: rgba(255,77,0,0.2);
            border-color: var(--primary);
        }

        .calendar-day.race {
            background: rgba(255,230,0,0.2);
            border: 2px solid var(--secondary);
        }

        .calendar-day.rest {
            background: rgba(0,217,255,0.1);
        }

        /* Profile Stats */
        .profile-stat-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
        }

        .profile-stat-label {
            color: rgba(255,255,255,0.6);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .profile-stat-value {
            color: var(--accent);
            font-size: 1.3rem;
            font-weight: bold;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
                padding-bottom: 90px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .card {
                padding: 20px;
            }
        }

        .feedback-btn {
            background: rgba(255, 77, 0, 0.2);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-top: 8px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .feedback-btn:hover {
            background: rgba(255, 77, 0, 0.4);
            transform: translateY(-1px);
        }

        .feedback-btn.completed {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00FF88;
            color: #00FF88;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--dark);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--light);
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
        }

        .effort-scale {
            display: flex;
            gap: 8px;
            margin: 16px 0;
        }

        .effort-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 77, 0, 0.3);
            border-radius: 8px;
            color: var(--light);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Space Mono', monospace;
        }

        .effort-btn:hover {
            background: rgba(255, 77, 0, 0.2);
            transform: scale(1.05);
        }

        .effort-btn.selected {
            background: var(--primary);
            border-color: var(--primary);
            transform: scale(1.1);
        }

        textarea {
            width: 100%;
            min-height: 100px;
            padding: 14px;
            background: var(--dark);
            border: 2px solid rgba(255, 77, 0, 0.4);
            border-radius: 8px;
            color: var(--light);
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(255, 77, 0, 0.3);
        }

        .feedback-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .feedback-indicator.good { background: #00FF88; }
        .feedback-indicator.okay { background: var(--secondary); }
        .feedback-indicator.tough { background: var(--primary); }

        .workout-item.adapted {
            border-left-color: var(--secondary);
            background: rgba(255, 230, 0, 0.08);
        }

        .workout-item.adapted .workout-type {
            color: var(--secondary);
        }

        .regenerate-week-btn {
            background: rgba(0, 217, 255, 0.2);
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 16px;
            display: inline-block;
        }

        .regenerate-week-btn:hover {
            background: rgba(0, 217, 255, 0.3);
            transform: translateY(-2px);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { 
                transform: scale(0.8);
                opacity: 0;
            }
            to { 
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home/Welcome Page -->
        <div id="homePage" class="app-page active">
            <h1 style="font-size: 2.5rem; margin-bottom: 16px; text-align: center;">Laktic Training</h1>
            <div class="subtitle" style="text-align: center; margin-bottom: 40px;">by TR_Performance</div>
            
            <div class="card" style="text-align: center; padding: 40px 30px;">
                <div style="font-size: 3rem; margin-bottom: 20px;">üèÉ‚Äç‚ôÇÔ∏è</div>
                <h2 style="color: var(--accent); margin-bottom: 20px;">Elite-Level Training, Precision Programming</h2>
                <p style="color: rgba(255,255,255,0.8); line-height: 1.8; font-size: 1.05rem; margin-bottom: 30px;">
                    TR_Performance brings you evidence-based training plans designed for 800m-3200m athletes. 
                    Our system combines decades of coaching wisdom with cutting-edge exercise science to deliver 
                    highly specific, individualized training at the precision of elite programs.
                </p>
                <p style="color: rgba(255,255,255,0.7); line-height: 1.6; margin-bottom: 30px;">
                    Whether you're chasing a PR, preparing for championships, or building your aerobic base, 
                    Laktic Training adapts to your current fitness level and goals‚Äîdelivering the right workout 
                    at the right time.
                </p>
                <button onclick="switchPage('createPlanPage');" class="btn" style="width: 100%; max-width: 300px; margin: 0 auto;">
                    <span style="position: relative; z-index: 1;">Get Started ‚Üí</span>
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 30px;">
                <div class="card" style="text-align: center; padding: 24px 16px;">
                    <div style="font-size: 2rem; margin-bottom: 12px;">üìä</div>
                    <h3 style="font-size: 1rem; color: var(--primary); margin-bottom: 8px;">VDOT-Based</h3>
                    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">Training paces calibrated to your current fitness</p>
                </div>
                <div class="card" style="text-align: center; padding: 24px 16px;">
                    <div style="font-size: 2rem; margin-bottom: 12px;">üéØ</div>
                    <h3 style="font-size: 1rem; color: var(--primary); margin-bottom: 8px;">Event-Specific</h3>
                    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">Workouts tailored to 800m, 1500m, or 3200m</p>
                </div>
                <div class="card" style="text-align: center; padding: 24px 16px;">
                    <div style="font-size: 2rem; margin-bottom: 12px;">üìà</div>
                    <h3 style="font-size: 1rem; color: var(--primary); margin-bottom: 8px;">Periodized</h3>
                    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">Progressive training phases for peak performance</p>
                </div>
                <div class="card" style="text-align: center; padding: 24px 16px;">
                    <div style="font-size: 2rem; margin-bottom: 12px;">üíæ</div>
                    <h3 style="font-size: 1rem; color: var(--primary); margin-bottom: 8px;">Portable</h3>
                    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">Save, backup, and share your plans</p>
                </div>
            </div>
        </div>

        <!-- Create Plan Page (Form only) -->
        <div id="createPlanPage" class="app-page">
            <h2 style="margin-bottom: 20px;">Create Training Plan</h2>
        </div>

        <!-- My Plans Page (Active Plan + Saved Plans Management) -->
        <div id="myPlansPage" class="app-page">
            <!-- Toggle between Active Plan and Saved Plans -->
            <div style="display: flex; gap: 12px; justify-content: center; margin-bottom: 20px;">
                <button id="activePlanTab" onclick="showActivePlan()" 
                        style="padding: 10px 24px; background: linear-gradient(135deg, var(--primary), #FF6B00); 
                               border: none; border-radius: 8px; color: var(--light); font-weight: bold; 
                               cursor: pointer; font-family: 'Space Mono', monospace; font-size: 0.85rem;">
                    üìñ Active Plan
                </button>
                <button id="savedPlansListTab" onclick="showSavedPlansList()" 
                        style="padding: 10px 24px; background: rgba(0,217,255,0.2); 
                               border: 2px solid var(--accent); border-radius: 8px; color: var(--accent); 
                               font-weight: bold; cursor: pointer; font-family: 'Space Mono', monospace; 
                               font-size: 0.85rem;">
                    üíæ Saved (<span id="savedPlansCount">0</span>)
                </button>
            </div>

            <!-- Active Plan View -->
            <div id="activePlanView">
                <div id="myPlansContent">
                    <!-- No plan message - shown when no plan exists -->
                    <div id="noPlanMessage" class="card">
                        <h2 style="text-align: center; color: rgba(255,255,255,0.5);">No Active Plan</h2>
                        <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">
                            Create a new training plan or set a saved plan as active to get started!
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 12px; max-width: 300px; margin: 0 auto;">
                            <button onclick="switchPage('createPlanPage');" class="btn">
                                <span style="position: relative; z-index: 1;">üìù Create New Plan</span>
                            </button>
                            <button onclick="showSavedPlansList();" 
                                    style="padding: 14px; background: rgba(0,217,255,0.2); border: 2px solid var(--accent); 
                                           border-radius: 12px; color: var(--accent); font-weight: bold; cursor: pointer;
                                           font-family: 'Space Mono', monospace;">
                                üíæ Load from Saved Plans
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Workout Plan Details (hidden until generated) -->
                <div class="workout-plan" id="workoutPlan" style="display: none;">
                    <!-- Active Plan Banner -->
                    <div id="activePlanBanner" style="background: linear-gradient(135deg, rgba(0,217,255,0.2), rgba(0,255,136,0.2)); 
                                border: 2px solid var(--accent); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center;">
                        <div id="activePlanNameDisplay" style="font-size: 1.4rem; font-weight: bold; color: var(--secondary); margin-bottom: 8px; display: none;">
                            <!-- Plan name will be inserted here -->
                        </div>
                        <div id="activePlanStatus" style="font-size: 1.1rem; font-weight: bold; color: var(--accent); margin-bottom: 8px;">
                            ‚úì This is your Active Training Plan
                        </div>
                        <div id="activePlanSubtext" style="font-size: 0.85rem; color: rgba(255,255,255,0.7);">
                            To change plans, select a different one from Saved Plans or create a new one.
                        </div>
                        <div id="unsavedPlanWarning" style="display: none; margin-top: 12px; padding: 10px; background: rgba(255,230,0,0.2); border: 1px solid var(--secondary); border-radius: 8px;">
                            <span style="color: var(--secondary); font-weight: bold;">‚ö†Ô∏è Unsaved Plan</span>
                            <span style="color: rgba(255,255,255,0.8);"> - Save this plan to keep your training schedule!</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>Training Stats</h2>
                        <div class="stats-grid" id="statsGrid"></div>
                    </div>

                    <!-- Save Plan Button -->
                    <div id="savePlanSection" style="text-align: center; margin-bottom: 20px;">
                        <button onclick="savePlan()" 
                                style="padding: 14px 32px; background: linear-gradient(135deg, #00D9FF, #00FF88); 
                                       border: none; border-radius: 12px; color: var(--dark); font-weight: bold; 
                                       font-size: 1.1rem; cursor: pointer; font-family: 'Archivo Black', sans-serif;
                                       text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 4px 15px rgba(0,217,255,0.3);">
                            üíæ Save This Plan
                        </button>
                    </div>

                    <div class="card" id="raceScheduleCard" style="display: none;">
                        <h2>Your Race Schedule</h2>
                        <div id="raceScheduleDisplay"></div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h2 id="planTitle">This Week's Plan</h2>
                            <div id="weekSelector" style="display: none;">
                                <select id="weekDropdown" onchange="changeWeek()" style="padding: 10px 20px; font-size: 1rem; background: var(--dark); border: 2px solid var(--accent); color: var(--light); border-radius: 8px; cursor: pointer; font-family: 'Space Mono', monospace;">
                                </select>
                            </div>
                        </div>
                        <div id="periodizationNote" style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-bottom: 16px;"></div>
                        <div id="workoutList"></div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap;">
                        <button class="btn" onclick="switchPage('createPlanPage');" style="flex: 1; min-width: 200px;">
                            <span style="position: relative; z-index: 1;">üìù Create New Plan</span>
                        </button>
                        <button onclick="showSavedPlansList();" 
                                style="flex: 1; min-width: 200px; padding: 18px; background: rgba(0,217,255,0.2); 
                                       border: 2px solid var(--accent); border-radius: 12px; color: var(--accent); 
                                       font-weight: bold; cursor: pointer; font-family: 'Archivo Black', sans-serif;
                                       text-transform: uppercase; letter-spacing: 2px;">
                            üíæ Load Different Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Saved Plans List View (hidden by default) -->
            <div id="savedPlansView" style="display: none;">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                        <h3 style="margin: 0; font-size: 1.3rem;">Saved Plans</h3>
                        <button onclick="uploadPlanFile()" 
                                style="padding: 8px 16px; background: linear-gradient(135deg, var(--accent), #00FF88); 
                                       border: none; border-radius: 8px; color: var(--dark); font-weight: bold; 
                                       cursor: pointer; font-family: 'Space Mono', monospace; font-size: 0.8rem;">
                            üì§ Import
                        </button>
                    </div>
                    <div id="savedPlansList">
                        <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 30px 20px;">
                            No saved plans yet!
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Page -->
        <div id="calendarPage" class="app-page">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Training Calendar</h2>
                
                <!-- Plan Selector -->
                <div style="margin-bottom: 20px;">
                    <label style="color: var(--accent); font-weight: bold; margin-bottom: 8px; display: block;">Select Training Plan:</label>
                    <select id="calendarPlanSelector" onchange="loadPlanToCalendar()" 
                            style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
                                   border: 2px solid var(--primary); color: var(--light); border-radius: 8px; 
                                   font-size: 1rem; font-family: 'Space Mono', monospace;">
                        <option value="">-- Select a plan --</option>
                        <option value="active">üìñ Current Active Plan</option>
                    </select>
                </div>
                
                <!-- Start Date Selector -->
                <div id="calendarStartDateSection" style="margin-bottom: 20px; display: none;">
                    <label style="color: var(--accent); font-weight: bold; margin-bottom: 8px; display: block;">Plan Start Date:</label>
                    <input type="date" id="calendarStartDate" onchange="renderCalendar()"
                           style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
                                  border: 2px solid var(--primary); color: var(--light); border-radius: 8px; 
                                  font-size: 1rem; font-family: 'Space Mono', monospace;">
                </div>
                
                <div class="calendar-header">
                    <button onclick="changeCalendarMonth(-1)" class="calendar-nav-btn">
                        ‚Üê Prev
                    </button>
                    <div id="calendarMonthName" style="font-size: 1.2rem; font-weight: bold; color: var(--accent);">
                        <!-- Month/Year will be inserted here -->
                    </div>
                    <button onclick="changeCalendarMonth(1)" class="calendar-nav-btn">
                        Next ‚Üí
                    </button>
                </div>
                <div id="calendarContent">
                    <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 40px 20px;">
                        Select a training plan above to view on the calendar!
                    </p>
                </div>
                
                <!-- Legend -->
                <div id="calendarLegend" style="display: none; margin-top: 20px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <div style="font-weight: bold; margin-bottom: 12px; color: var(--accent);">Legend:</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 0.85rem;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 16px; height: 16px; background: rgba(255,77,0,0.3); border: 2px solid var(--primary); border-radius: 4px;"></div>
                            <span>Hard Workout</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 16px; height: 16px; background: rgba(138,43,226,0.3); border: 2px solid #8A2BE2; border-radius: 4px;"></div>
                            <span>Speed Dev</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 16px; height: 16px; background: rgba(0,217,255,0.2); border: 2px solid var(--accent); border-radius: 4px;"></div>
                            <span>Easy/Recovery</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 16px; height: 16px; background: rgba(255,230,0,0.3); border: 2px solid var(--secondary); border-radius: 4px;"></div>
                            <span>Race Day</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 16px; height: 16px; background: rgba(0,255,136,0.2); border: 2px solid #00FF88; border-radius: 4px;"></div>
                            <span>Long Run</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" class="app-page">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Your Profile</h2>
                <div id="profileContent">
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--accent); margin-bottom: 16px; font-size: 1.1rem;">Personal Information</h3>
                        <div class="input-group">
                            <label>Name</label>
                            <input type="text" id="profileName" placeholder="Your name" 
                                   onchange="saveProfile()" 
                                   style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                          color: var(--light); padding: 12px; border-radius: 8px; width: 100%;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                            <div class="input-group">
                                <label>Age</label>
                                <input type="number" id="profileAge" placeholder="Age" 
                                       onchange="saveProfile()"
                                       style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                              color: var(--light); padding: 12px; border-radius: 8px; width: 100%;">
                            </div>
                            <div class="input-group">
                                <label>Gender</label>
                                <select id="profileGender" onchange="saveProfile()"
                                        style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                               color: var(--light); padding: 12px; border-radius: 8px; width: 100%;">
                                    <option value="">Select</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--accent); margin-bottom: 16px; font-size: 1.1rem;">Personal Records</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="input-group">
                                <label>800m PR</label>
                                <input type="text" id="pr800m" placeholder="2:05" 
                                       onchange="saveProfile()"
                                       style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                              color: var(--light); padding: 12px; border-radius: 8px; width: 100%;">
                            </div>
                            <div class="input-group">
                                <label>1600m PR</label>
                                <input type="text" id="pr1600m" placeholder="4:30" 
                                       onchange="saveProfile()"
                                       style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                              color: var(--light); padding: 12px; border-radius: 8px; width: 100%;">
                            </div>
                            <div class="input-group">
                                <label>3200m PR</label>
                                <input type="text" id="pr3200m" placeholder="9:45" 
                                       onchange="saveProfile()"
                                       style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                              color: var(--light); padding: 12px; border-radius: 8px; width: 100%;">
                            </div>
                            <div class="input-group">
                                <label>5000m PR</label>
                                <input type="text" id="pr5000m" placeholder="16:15" 
                                       onchange="saveProfile()"
                                       style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                              color: var(--light); padding: 12px; border-radius: 8px; width: 100%;">
                            </div>
                        </div>
                    </div>

                    <div id="profileStats">
                        <!-- Current plan stats will be shown here if plan exists -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Input -->
        <div id="dataInput">
            <div class="card">
                <h2>Your Race Times</h2>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: 16px; font-size: 0.85rem;">
                    Enter at least ONE recent race time for accurate training paces.
                </p>
                
                <div class="input-group">
                    <label>800m Time (mm:ss)</label>
                    <input type="text" id="time800m" placeholder="2:05">
                </div>
                
                <div class="input-group">
                    <label>1600m / Mile Time (mm:ss)</label>
                    <input type="text" id="time1600m" placeholder="4:30">
                </div>
                
                <div class="input-group">
                    <label>3200m / 2 Mile Time (mm:ss)</label>
                    <input type="text" id="time3200m" placeholder="9:45">
                </div>
                
                <div class="input-group">
                    <label>5000m / 5K Time (mm:ss)</label>
                    <input type="text" id="time5000m" placeholder="16:00">
                </div>
            </div>

            <div class="card">
                <h2>Training Profile</h2>
                <div class="input-group">
                    <label>Current Weekly Mileage</label>
                    <input type="number" id="currentMileage" placeholder="40" value="40">
                </div>
                <div class="input-group">
                    <label>Goal Weekly Mileage (Peak Weeks)</label>
                    <input type="number" id="goalMileage" placeholder="50" value="50">
                </div>
                <div class="input-group">
                    <label>Current Fitness Level (1-100%)</label>
                    <div style="display: flex; align-items: center; gap: 16px; margin-top: 12px;">
                        <input type="range" id="fitnessLevel" min="1" max="100" value="75" 
                               oninput="updateFitnessDisplay(this.value)"
                               style="flex: 1; height: 8px; background: linear-gradient(to right, #FF4D00, #FFE600, #00FF88, #00D9FF); border-radius: 4px;">
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 140px;">
                            <div id="fitnessPercent" style="font-size: 2rem; font-weight: bold; color: var(--primary);">75%</div>
                            <div id="fitnessLabel" style="text-align: center; padding: 6px 12px; background: rgba(255,77,0,0.2); border-radius: 6px; border: 2px solid var(--primary); font-weight: bold; font-size: 0.85rem; margin-top: 4px;">
                                Race Ready
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 12px; font-size: 0.7rem; color: rgba(255,255,255,0.5);">
                        <div style="text-align: center;">1-25%<br>Recovering</div>
                        <div style="text-align: center;">26-50%<br>Building</div>
                        <div style="text-align: center;">51-75%<br>Race Ready</div>
                        <div style="text-align: center;">76-100%<br>Peak Fitness</div>
                    </div>
                    <p style="color: rgba(255,255,255,0.5); margin-top: 12px; font-size: 0.75rem;">
                        How close to peak fitness are you? This adjusts training intensity and volume.<br>
                        <strong>Lower %</strong> = easier paces, more recovery | <strong>Higher %</strong> = normal/aggressive paces
                    </p>
                </div>
                <div class="input-group">
                    <label>Primary Goal Event</label>
                    <select id="goalEvent">
                        <option value="800">800m</option>
                        <option value="1500">1500m / Mile</option>
                        <option value="3200" selected>3200m / 2 Mile / 3K</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Training Plan Duration</label>
                    <select id="planDuration">
                        <option value="weekly" selected>1 Week (Sample Week)</option>
                        <option value="monthly">4 Weeks (Monthly Block)</option>
                        <option value="quarterly">12 Weeks (Season)</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h2>Race Schedule (Optional)</h2>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: 16px; font-size: 0.85rem;">
                    Add upcoming races. Training will adapt to taper and peak appropriately.
                </p>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer; color: var(--accent); font-size: 0.9rem;">
                        <input type="checkbox" id="noRacesCheckbox"
                               style="width: auto; margin-right: 10px; cursor: pointer; transform: scale(1.2);">
                        <span>üìà No races - just building fitness</span>
                    </label>
                    <p style="color: rgba(255,255,255,0.5); margin-top: 8px; margin-left: 32px; font-size: 0.75rem;">
                        Check this if you're in base building or off-season and don't have any target races scheduled.
                    </p>
                </div>
                
                <div id="raceInputs">
                
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <div style="flex: 1;">
                        <label>Race Date</label>
                        <input type="date" id="raceDate1">
                    </div>
                    <div style="flex: 1;">
                        <label>Distance</label>
                        <select id="raceDistance1">
                            <option value="">Select...</option>
                            <option value="800m">800m</option>
                            <option value="1600m">1600m/Mile</option>
                            <option value="3200m">3200m/2Mi</option>
                        </select>
                    </div>
                    <div style="flex: 0.6;">
                        <label>Priority</label>
                        <select id="racePriority1">
                            <option value="C">C (Tune-up)</option>
                            <option value="B">B (Important)</option>
                            <option value="A">A (TARGET)</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <div style="flex: 1;">
                        <label>Race Date</label>
                        <input type="date" id="raceDate2">
                    </div>
                    <div style="flex: 1;">
                        <label>Distance</label>
                        <select id="raceDistance2">
                            <option value="">Select...</option>
                            <option value="800m">800m</option>
                            <option value="1600m">1600m/Mile</option>
                            <option value="3200m">3200m/2Mi</option>
                        </select>
                    </div>
                    <div style="flex: 0.6;">
                        <label>Priority</label>
                        <select id="racePriority2">
                            <option value="C">C (Tune-up)</option>
                            <option value="B">B (Important)</option>
                            <option value="A">A (TARGET)</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <div style="flex: 1;">
                        <label>Race Date</label>
                        <input type="date" id="raceDate3">
                    </div>
                    <div style="flex: 1;">
                        <label>Distance</label>
                        <select id="raceDistance3">
                            <option value="">Select...</option>
                            <option value="800m">800m</option>
                            <option value="1600m">1600m/Mile</option>
                            <option value="3200m">3200m/2Mi</option>
                        </select>
                    </div>
                    <div style="flex: 0.6;">
                        <label>Priority</label>
                        <select id="racePriority3">
                            <option value="C">C (Tune-up)</option>
                            <option value="B">B (Important)</option>
                            <option value="A">A (TARGET)</option>
                        </select>
                    </div>
                </div>
                
                </div> <!-- Close raceInputs -->
                
                <p style="color: rgba(255,255,255,0.5); margin-top: 12px; font-size: 0.75rem;">
                    A races = full taper. B races = mini-taper. C races = training through.
                </p>
            </div>

            <button class="btn" onclick="generatePlan()">
                <span style="position: relative; z-index: 1;">Generate Training Plan</span>
            </button>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: var(--accent);">BUILDING YOUR PLAN...</p>
        </div>

    </div>

    <script>
        console.log('=== SCRIPT LOADING STARTED ===');
        
        let allWeeksData = [];
        let currentPlanData = null;
        let workoutFeedback = {}; // Store feedback by week-day key
        let currentFeedbackKey = null;
        let fitnessLevel = 75; // Default 75%
        let savedPlans = {}; // Store multiple saved plans
        
        console.log('Variables initialized');

        // Load saved plans and feedback from localStorage on page load
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('laktic_feedback');
            if (saved) {
                workoutFeedback = JSON.parse(saved);
            }
            
            const plans = localStorage.getItem('laktic_saved_plans');
            if (plans) {
                savedPlans = JSON.parse(plans);
            }
            
            // Show saved plans if any exist
            if (Object.keys(savedPlans).length > 0) {
                showLoadPlansOption();
            }
            
            // Add event listener for no races checkbox
            const noRacesCheckbox = document.getElementById('noRacesCheckbox');
            if (noRacesCheckbox) {
                noRacesCheckbox.addEventListener('change', function() {
                    toggleRaceInputs(this.checked);
                });
            }
        });

        function showLoadPlansOption() {
            // Update saved plans count
            const count = Object.keys(savedPlans).length;
            const countElement = document.getElementById('savedPlansCount');
            if (countElement) {
                countElement.textContent = count;
            }
            
            // Update the saved plans list
            updateSavedPlansList();
        }

        function showNewPlanView() {
            document.getElementById('dataInput').style.display = 'block';
            document.getElementById('savedPlansView').style.display = 'none';
            document.getElementById('workoutPlan').classList.remove('active');
            
            // Update tab styling
            document.getElementById('newPlanTab').style.background = 'linear-gradient(135deg, var(--primary), #FF6B00)';
            document.getElementById('newPlanTab').style.border = 'none';
            document.getElementById('newPlanTab').style.color = 'var(--light)';
            
            document.getElementById('savedPlansTab').style.background = 'rgba(0,217,255,0.2)';
            document.getElementById('savedPlansTab').style.border = '2px solid var(--accent)';
            document.getElementById('savedPlansTab').style.color = 'var(--accent)';
        }

        function showSavedPlansView() {
            document.getElementById('dataInput').style.display = 'none';
            document.getElementById('savedPlansView').style.display = 'block';
            document.getElementById('workoutPlan').classList.remove('active');
            
            // Update tab styling
            document.getElementById('savedPlansTab').style.background = 'linear-gradient(135deg, var(--accent), #00FF88)';
            document.getElementById('savedPlansTab').style.border = 'none';
            document.getElementById('savedPlansTab').style.color = 'var(--dark)';
            
            document.getElementById('newPlanTab').style.background = 'rgba(255,77,0,0.2)';
            document.getElementById('newPlanTab').style.border = '2px solid var(--primary)';
            document.getElementById('newPlanTab').style.color = 'var(--primary)';
            
            // Refresh the saved plans list
            updateSavedPlansList();
        }

        function updateSavedPlansList() {
            const listContainer = document.getElementById('savedPlansList');
            const activePlanId = localStorage.getItem('laktic_active_plan_id');
            
            if (Object.keys(savedPlans).length === 0) {
                listContainer.innerHTML = `
                    <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 40px 20px;">
                        No saved plans yet. Create and save a training plan to access it here anytime!
                    </p>
                `;
                return;
            }
            
            let html = '';
            for (const [planId, plan] of Object.entries(savedPlans)) {
                const createdDate = new Date(plan.created).toLocaleDateString();
                const eventLabel = plan.planData.goalEvent === '800' ? '800m' : 
                                  plan.planData.goalEvent === '1500' ? '1500m/Mile' : '3200m/3K';
                const isActive = planId === activePlanId;
                
                html += `
                    <div style="background: ${isActive ? 'rgba(0,255,136,0.1)' : 'rgba(255,255,255,0.05)'}; 
                                padding: 20px; margin-bottom: 16px; 
                                border-radius: 12px; 
                                border-left: 4px solid ${isActive ? '#00FF88' : 'var(--primary)'};">
                        ${isActive ? `<div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #00FF88; font-weight: bold; margin-bottom: 8px;">‚úì CURRENTLY ACTIVE</div>` : ''}
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px;">
                            <div style="flex: 1;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 8px;">
                                    ${plan.name}
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px;">
                                    <div>
                                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); text-transform: uppercase;">Event</div>
                                        <div style="color: var(--primary); font-weight: bold;">${eventLabel}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); text-transform: uppercase;">Duration</div>
                                        <div style="color: var(--primary); font-weight: bold;">${plan.weeksData.length} weeks</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); text-transform: uppercase;">VDOT</div>
                                        <div style="color: var(--primary); font-weight: bold;">${plan.vdot}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); text-transform: uppercase;">Mileage</div>
                                        <div style="color: var(--primary); font-weight: bold;">${plan.planData.currentMileage}-${plan.planData.goalMileage} mpw</div>
                                    </div>
                                </div>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">
                                    Created: ${createdDate}
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                ${isActive ? `
                                    <button onclick="showActivePlan(); switchPage('myPlansPage');" 
                                            style="padding: 10px 24px; background: linear-gradient(135deg, #00FF88, #00D9FF); 
                                                   border: none; border-radius: 8px; color: var(--dark); font-weight: bold; 
                                                   cursor: pointer; white-space: nowrap; font-family: 'Space Mono', monospace;">
                                        üìñ View Plan
                                    </button>
                                ` : `
                                    <button onclick="setAsActivePlan('${planId}')" 
                                            style="padding: 10px 24px; background: linear-gradient(135deg, var(--accent), #00FF88); 
                                                   border: none; border-radius: 8px; color: var(--dark); font-weight: bold; 
                                                   cursor: pointer; white-space: nowrap; font-family: 'Space Mono', monospace;">
                                        ‚úì Set as Active
                                    </button>
                                `}
                                <button onclick="deletePlanFromList('${planId}')" 
                                        style="padding: 10px 24px; background: rgba(255,77,0,0.2); 
                                               border: 2px solid var(--primary); border-radius: 8px; color: var(--primary); 
                                               font-weight: bold; cursor: pointer; font-family: 'Space Mono', monospace;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            listContainer.innerHTML = html;
        }

        function setAsActivePlan(planId) {
            const plan = savedPlans[planId];
            if (!plan) {
                alert('Plan not found!');
                return;
            }
            
            // Confirm setting as active
            if (confirm(`Set "${plan.name}" as your active training plan? This will replace any current active plan.`)) {
                // Load the plan data
                loadPlan(planId);
                
                // Save which plan is active to localStorage
                localStorage.setItem('laktic_active_plan_id', planId);
                
                // Update the active plan banner to show the plan name
                updateActivePlanBanner(plan.name, true);
                
                showNotification(`"${plan.name}" is now your active plan!`, '#00FF88');
                
                // Switch to Active tab
                showActivePlan();
            }
        }
        
        function updateActivePlanBanner(planName, isSaved) {
            const nameDisplay = document.getElementById('activePlanNameDisplay');
            const statusDisplay = document.getElementById('activePlanStatus');
            const subtextDisplay = document.getElementById('activePlanSubtext');
            const unsavedWarning = document.getElementById('unsavedPlanWarning');
            
            if (planName && isSaved) {
                // Saved plan is active
                nameDisplay.textContent = 'üìã ' + planName;
                nameDisplay.style.display = 'block';
                statusDisplay.innerHTML = '‚úì Active Training Plan';
                subtextDisplay.textContent = 'To change plans, select a different one from Saved Plans or create a new one.';
                unsavedWarning.style.display = 'none';
            } else if (planName) {
                // Plan has a name but isn't saved yet
                nameDisplay.textContent = 'üìã ' + planName;
                nameDisplay.style.display = 'block';
                statusDisplay.innerHTML = '‚úì Active Training Plan';
                unsavedWarning.style.display = 'block';
            } else {
                // New unsaved plan
                nameDisplay.style.display = 'none';
                statusDisplay.innerHTML = '‚úì This is your Active Training Plan';
                subtextDisplay.textContent = 'To change plans, select a different one from Saved Plans or create a new one.';
                unsavedWarning.style.display = 'block';
            }
        }

        function loadPlanFromList(planId) {
            loadPlan(planId);
            // Switch to My Plans page and show active plan
            setTimeout(() => {
                switchPage('myPlansPage');
                showActivePlan();
            }, 300);
        }

        function deletePlanFromList(planId) {
            const plan = savedPlans[planId];
            if (!plan) return;
            
            if (confirm(`Delete plan "${plan.name}"? This cannot be undone.`)) {
                delete savedPlans[planId];
                localStorage.setItem('laktic_saved_plans', JSON.stringify(savedPlans));
                
                showNotification(`Plan "${plan.name}" deleted`, '#FF4D00');
                updateSavedPlansList();
                showLoadPlansOption(); // Update count
            }
        }

        function savePlan() {
            console.log('savePlan called, currentPlanData:', currentPlanData);
            
            if (!currentPlanData) {
                alert('No plan to save! Please generate a plan first.');
                return;
            }
            
            // Create a modal for plan name input instead of using prompt()
            const modal = document.createElement('div');
            modal.id = 'savePlanModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.9); z-index: 3000;
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            const defaultName = `${currentPlanData.goalEvent}m Plan - ${new Date().toLocaleDateString()}`;
            
            modal.innerHTML = `
                <div style="background: var(--dark); border: 3px solid var(--accent); border-radius: 16px; padding: 30px; max-width: 400px; width: 100%;">
                    <h2 style="color: var(--accent); margin-bottom: 20px;">Save Training Plan</h2>
                    <div style="margin-bottom: 20px;">
                        <label style="color: var(--light); display: block; margin-bottom: 8px;">Plan Name:</label>
                        <input type="text" id="savePlanNameInput" value="${defaultName}" 
                               style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 2px solid var(--primary); 
                                      color: var(--light); border-radius: 8px; font-size: 1rem;">
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="confirmSavePlan()" 
                                style="flex: 1; padding: 14px; background: linear-gradient(135deg, #00D9FF, #00FF88); 
                                       border: none; border-radius: 8px; color: var(--dark); font-weight: bold; 
                                       font-size: 1rem; cursor: pointer;">
                            üíæ Save Plan
                        </button>
                        <button onclick="document.getElementById('savePlanModal').remove()" 
                                style="padding: 14px 20px; background: rgba(255,255,255,0.1); 
                                       border: 2px solid var(--light); border-radius: 8px; color: var(--light); 
                                       font-weight: bold; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('savePlanNameInput').focus();
            document.getElementById('savePlanNameInput').select();
        }
        
        function confirmSavePlan() {
            const planName = document.getElementById('savePlanNameInput').value.trim();
            
            if (!planName) {
                alert('Please enter a plan name');
                return;
            }
            
            // Remove modal
            document.getElementById('savePlanModal').remove();
            
            // Create plan object with all data
            const planToSave = {
                name: planName,
                created: new Date().toISOString(),
                planData: currentPlanData,
                weeksData: allWeeksData,
                feedback: workoutFeedback,
                vdot: currentPlanData.vdot,
                paces: currentPlanData.paces
            };
            
            // Save to savedPlans object
            const planId = 'plan_' + Date.now();
            savedPlans[planId] = planToSave;
            
            // Save to localStorage
            localStorage.setItem('laktic_saved_plans', JSON.stringify(savedPlans));
            
            // Set this as the active plan
            localStorage.setItem('laktic_active_plan_id', planId);
            
            // Update the active plan banner to show the saved plan name
            updateActivePlanBanner(planName, true);
            
            // Update the saved plans count
            const countEl = document.getElementById('savedPlansCount');
            if (countEl) {
                countEl.textContent = Object.keys(savedPlans).length;
            }
            
            // Update the saved plans list
            updateSavedPlansList();
            
            // Update calendar plan selector
            populateCalendarPlanSelector();
            
            // ALSO download as JSON file to device
            downloadPlanAsFile(planToSave, planName);
            
            // Show confirmation
            showNotification('‚úì Plan saved! Check "Saved" tab and downloaded to your device', '#00FF88');
        }

        function downloadPlanAsFile(plan, planName) {
            // Convert plan to JSON
            const jsonData = JSON.stringify(plan, null, 2);
            
            // Create blob
            const blob = new Blob([jsonData], { type: 'application/json' });
            
            // Create download link
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${planName.replace(/[^a-z0-9]/gi, '_')}_laktic_plan.json`;
            
            // Trigger download
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function uploadPlanFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const plan = JSON.parse(event.target.result);
                        
                        // Validate plan structure
                        if (!plan.planData || !plan.weeksData || !plan.vdot) {
                            alert('Invalid plan file format!');
                            return;
                        }
                        
                        // Add to saved plans
                        const planId = 'plan_' + Date.now();
                        savedPlans[planId] = plan;
                        localStorage.setItem('laktic_saved_plans', JSON.stringify(savedPlans));
                        
                        showNotification('‚úì Plan "' + plan.name + '" imported successfully!', '#00FF88');
                        showLoadPlansOption();
                        updateSavedPlansList();
                        
                    } catch (error) {
                        alert('Error reading plan file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function loadPlan(planId) {
            const plan = savedPlans[planId];
            if (!plan) {
                alert('Plan not found!');
                return;
            }
            
            // Restore plan data
            currentPlanData = plan.planData;
            allWeeksData = plan.weeksData;
            workoutFeedback = plan.feedback || {};
            
            // Store active plan ID
            localStorage.setItem('laktic_active_plan_id', planId);
            
            // Close modal
            document.querySelectorAll('div[style*="position: fixed"]').forEach(el => el.remove());
            
            // Hide input, show plan
            document.getElementById('dataInput').style.display = 'none';
            document.getElementById('noPlanMessage').style.display = 'none';
            document.getElementById('workoutPlan').style.display = 'block';
            document.getElementById('workoutPlan').classList.add('active');
            
            // Update the active plan banner to show the plan name
            updateActivePlanBanner(plan.name, true);
            
            // Display the plan
            displayStats(plan.vdot, plan.planData.currentMileage, plan.planData.goalMileage, plan.paces, plan.planData.intensityAdjustment, plan.planData.fitnessLevel);
            
            if (plan.planData.raceSchedule && plan.planData.raceSchedule.length > 0) {
                displayRaceSchedule(plan.planData.raceSchedule);
            }
            
            // Set up week selector if multi-week plan
            if (allWeeksData.length > 1) {
                setupWeekSelector(allWeeksData.length);
                displaySelectedWeek(0);
                document.getElementById('planTitle').textContent = `${allWeeksData.length}-Week Training Plan`;
                document.getElementById('periodizationNote').innerHTML = `
                    <strong>${allWeeksData.length}-Week Plan:</strong> Loaded from saved plan "${plan.name}".
                `;
            } else {
                displaySampleWeek(plan.paces, plan.planData.currentMileage, plan.planData.goalEvent);
            }
            
            showNotification(`‚úì Loaded plan: "${plan.name}"`, '#00FF88');
        }

        function showNotification(message, color) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-weight: bold;
                z-index: 4000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(400px)';
                notification.style.transition = 'all 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function updateFitnessDisplay(value) {
            fitnessLevel = parseInt(value);
            const percentDisplay = document.getElementById('fitnessPercent');
            const labelDisplay = document.getElementById('fitnessLabel');
            
            percentDisplay.textContent = value + '%';
            
            let label, color, bgColor;
            if (value <= 25) {
                label = 'Recovering';
                color = '#FF4D00';
                bgColor = 'rgba(255,77,0,0.2)';
            } else if (value <= 50) {
                label = 'Building';
                color = '#FFE600';
                bgColor = 'rgba(255,230,0,0.2)';
            } else if (value <= 75) {
                label = 'Race Ready';
                color = '#00FF88';
                bgColor = 'rgba(0,255,136,0.2)';
            } else {
                label = 'Peak Fitness';
                color = '#00D9FF';
                bgColor = 'rgba(0,217,255,0.2)';
            }
            
            percentDisplay.style.color = color;
            labelDisplay.textContent = label;
            labelDisplay.style.borderColor = color;
            labelDisplay.style.background = bgColor;
            labelDisplay.style.color = color;
        }

        function toggleRaceInputs(checked) {
            const raceInputs = document.getElementById('raceInputs');
            if (checked) {
                raceInputs.style.opacity = '0.3';
                raceInputs.style.pointerEvents = 'none';
                raceInputs.style.filter = 'grayscale(1)';
            } else {
                raceInputs.style.opacity = '1';
                raceInputs.style.pointerEvents = 'auto';
                raceInputs.style.filter = 'none';
            }
        }

        function openFeedbackModal(weekNum, dayName, workoutType) {
            currentFeedbackKey = `week${weekNum}-${dayName}`;
            
            // Create modal if it doesn't exist
            let modal = document.getElementById('feedbackModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'feedbackModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 style="color: var(--primary); margin: 0;">Workout Feedback</h2>
                            <button class="modal-close" onclick="closeFeedbackModal()">&times;</button>
                        </div>
                        
                        <div id="feedbackWorkoutName" style="color: var(--accent); margin-bottom: 20px; font-size: 1.1rem;"></div>
                        
                        <div class="input-group">
                            <label>How did this workout feel? (1 = Easy, 10 = Maximal)</label>
                            <div class="effort-scale" id="effortScale"></div>
                        </div>

                        <div class="input-group">
                            <label>Completed As Planned?</label>
                            <select id="completionStatus">
                                <option value="full">‚úÖ Completed fully</option>
                                <option value="partial">‚ö†Ô∏è Partial (cut short)</option>
                                <option value="modified">üîÑ Modified workout</option>
                                <option value="skipped">‚ùå Skipped</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label>Notes / Comments</label>
                            <textarea id="feedbackNotes" placeholder="How did you feel? Any issues? Paces felt easy/hard? Weather conditions?"></textarea>
                        </div>

                        <button class="btn" onclick="submitFeedback()" style="margin-top: 20px;">
                            <span style="position: relative; z-index: 1;">Save Feedback</span>
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('feedbackWorkoutName').textContent = `Week ${weekNum} - ${dayName}: ${workoutType}`;
            
            // Create effort scale buttons
            const effortScale = document.getElementById('effortScale');
            effortScale.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement('button');
                btn.className = 'effort-btn';
                btn.textContent = i;
                btn.onclick = () => selectEffort(i);
                effortScale.appendChild(btn);
            }
            
            // Load existing feedback if present
            const existingFeedback = workoutFeedback[currentFeedbackKey];
            if (existingFeedback) {
                selectEffort(existingFeedback.effort);
                document.getElementById('completionStatus').value = existingFeedback.completion;
                document.getElementById('feedbackNotes').value = existingFeedback.notes;
            } else {
                document.getElementById('completionStatus').value = 'full';
                document.getElementById('feedbackNotes').value = '';
            }
            
            modal.classList.add('active');
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('active');
            currentFeedbackKey = null;
        }

        function selectEffort(level) {
            document.querySelectorAll('.effort-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (parseInt(btn.textContent) === level) {
                    btn.classList.add('selected');
                }
            });
        }

        function submitFeedback() {
            const selectedEffort = document.querySelector('.effort-btn.selected');
            if (!selectedEffort) {
                alert('Please select an effort level (1-10)');
                return;
            }
            
            const effort = parseInt(selectedEffort.textContent);
            const completion = document.getElementById('completionStatus').value;
            const notes = document.getElementById('feedbackNotes').value;
            
            if (!currentFeedbackKey) {
                alert('Error: No workout selected');
                return;
            }
            
            // Store the key before closing modal
            const savedFeedbackKey = currentFeedbackKey;
            
            workoutFeedback[savedFeedbackKey] = {
                effort: effort,
                completion: completion,
                notes: notes,
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem('laktic_feedback', JSON.stringify(workoutFeedback));
            console.log('Feedback saved:', savedFeedbackKey, workoutFeedback[savedFeedbackKey]);
            
            // Also save feedback to the current active plan if one exists
            const activePlanId = localStorage.getItem('laktic_active_plan_id');
            if (activePlanId && savedPlans[activePlanId]) {
                savedPlans[activePlanId].feedback = workoutFeedback;
                localStorage.setItem('laktic_saved_plans', JSON.stringify(savedPlans));
                console.log('Feedback also saved to active plan:', activePlanId);
            }
            
            // Parse the feedback key to get week and day
            const keyParts = savedFeedbackKey.split('-');
            let weekNum = 1;
            let dayName = '';
            
            if (keyParts.length >= 2) {
                weekNum = parseInt(keyParts[0].replace('week', ''));
                dayName = keyParts.slice(1).join('-');
            }
            
            // Close the modal first
            closeFeedbackModal();
            
            // Show notification that feedback was saved
            showNotification('‚úì Feedback saved!', '#00FF88');
            
            // Analyze the workout and show acknowledgment
            try {
                if (!isNaN(weekNum) && dayName) {
                    // Get workout type to determine intent
                    const workoutType = document.getElementById('feedbackWorkoutName')?.textContent || '';
                    const acknowledgment = analyzeWorkoutFeedback(effort, completion, workoutType, dayName);
                    showFeedbackAcknowledgment(acknowledgment);
                    
                    // Check for patterns before adapting
                    const shouldAdapt = checkForPatterns(weekNum, dayName, effort, completion);
                    if (shouldAdapt.adapt) {
                        adaptRemainingWeek(weekNum, dayName, effort, completion, shouldAdapt.reason);
                    }
                }
            } catch (error) {
                console.error('Error processing feedback:', error);
            }
            
            // Analyze overall trends
            adaptTrainingBasedOnFeedback();
            
            // Refresh the workout display to show green "Edit Feedback" button
            setTimeout(() => {
                refreshWorkoutDisplay();
            }, 200);
        }
        
        function refreshWorkoutDisplay() {
            console.log('Refreshing workout display...');
            
            // Check if we have a week dropdown (multi-week plan)
            const weekDropdown = document.getElementById('weekDropdown');
            
            if (weekDropdown && weekDropdown.style.display !== 'none' && weekDropdown.value !== '') {
                const currentWeek = parseInt(weekDropdown.value);
                if (!isNaN(currentWeek)) {
                    console.log('Refreshing multi-week display, week:', currentWeek);
                    displaySelectedWeek(currentWeek);
                    return;
                }
            }
            
            // If it's a sample/single week plan, refresh using displaySampleWeek
            if (allWeeksData && allWeeksData.length === 1 && currentPlanData) {
                console.log('Refreshing single-week/sample display');
                displaySampleWeek(currentPlanData.paces, currentPlanData.currentMileage, currentPlanData.goalEvent);
                return;
            }
            
            // Fallback: if we have allWeeksData, just display the first week
            if (allWeeksData && allWeeksData.length > 0) {
                console.log('Fallback: displaying first week');
                displaySelectedWeek(0);
                return;
            }
            
            console.log('Could not refresh display - no plan data found');
        }

        function analyzeWorkoutFeedback(effort, completion, workoutType, dayName) {
            const isHardWorkout = workoutType.includes('Specific') || 
                                 workoutType.includes('Bank') || 
                                 workoutType.includes('Workout') ||
                                 workoutType.includes('Primer');
            
            const isEasyDay = workoutType.includes('Easy') || 
                             workoutType.includes('Recovery') ||
                             dayName === 'Sunday' || 
                             dayName === 'Wednesday';
            
            const isLongRun = workoutType.includes('Long Run');
            
            let message = '';
            let emoji = '';
            let color = '';
            
            // HARD WORKOUT DAY
            if (isHardWorkout) {
                if (effort >= 7 && effort <= 9 && completion === 'full') {
                    emoji = '‚úÖ';
                    color = '#00FF88';
                    message = '<strong>Perfect execution!</strong> Hard workouts should feel challenging (7-9/10). You nailed it and completed the full session. This is exactly the stimulus needed for adaptation.';
                } else if (effort >= 9 && completion === 'full') {
                    emoji = 'üí™';
                    color = '#FFE600';
                    message = '<strong>Maximal effort!</strong> You pushed to a 9-10/10 and still completed it. Great mental toughness, but make sure you are recovering properly. We will monitor if this pattern continues.';
                } else if (effort >= 8 && (completion === 'partial' || completion === 'modified')) {
                    emoji = '‚ö†Ô∏è';
                    color = '#FF4D00';
                    message = '<strong>Struggled today.</strong> The workout felt very hard (8+/10) and you could not complete it as planned. This is valuable feedback. If this becomes a pattern, we will adjust your training load.';
                } else if (effort <= 6 && completion === 'full') {
                    emoji = 'üìà';
                    color = '#00D9FF';
                    message = '<strong>Strong day!</strong> Quality workout felt easier than expected (‚â§6/10). This suggests good fitness progression. If this continues, you may be ready for more challenging work.';
                } else if (completion === 'skipped') {
                    emoji = 'üîÑ';
                    color = '#FF4D00';
                    message = '<strong>Workout skipped.</strong> Sometimes life happens. We will track if skipped sessions become a pattern and adjust accordingly. One missed workout will not derail your progress.';
                } else {
                    emoji = 'üìù';
                    color = '#00D9FF';
                    message = '<strong>Feedback recorded.</strong> Effort level and completion noted. Keep logging your sessions so we can optimize your training.';
                }
            }
            // EASY/RECOVERY DAY
            else if (isEasyDay) {
                if (effort <= 5 && completion === 'full') {
                    emoji = '‚úÖ';
                    color = '#00FF88';
                    message = '<strong>Perfect recovery!</strong> Easy days should feel easy (‚â§5/10). You are recovering properly while maintaining aerobic fitness. Keep it controlled.';
                } else if (effort >= 6 && effort <= 7) {
                    emoji = '‚ö†Ô∏è';
                    color = '#FFE600';
                    message = '<strong>Too hard for easy day.</strong> This run felt moderate-hard (6-7/10) when it should feel easy. Could be cumulative fatigue. We will monitor if you need more recovery.';
                } else if (effort >= 8) {
                    emoji = 'üö®';
                    color = '#FF4D00';
                    message = '<strong>Recovery day felt very hard.</strong> Easy runs should never feel this hard. This suggests you are not recovering properly. If this pattern continues, we will reduce your training load.';
                } else {
                    emoji = 'üìù';
                    color = '#00D9FF';
                    message = '<strong>Easy day completed.</strong> Effort level noted. Keep monitoring how recovery days feel.';
                }
            }
            // LONG RUN
            else if (isLongRun) {
                if (effort >= 6 && effort <= 8 && completion === 'full') {
                    emoji = '‚úÖ';
                    color = '#00FF88';
                    message = '<strong>Solid long run!</strong> Long runs should feel moderately hard (6-8/10) by the end. You built endurance while managing effort appropriately.';
                } else if (effort >= 9 && completion === 'full') {
                    emoji = '‚ö†Ô∏è';
                    color = '#FFE600';
                    message = '<strong>Very hard long run.</strong> While you finished, a 9-10/10 effort suggests the pace might have been too aggressive. Long runs build aerobic capacity through volume, not intensity.';
                } else if (effort <= 5 && completion === 'full') {
                    emoji = 'üìà';
                    color = '#00D9FF';
                    message = '<strong>Long run felt comfortable.</strong> If long runs consistently feel this easy, your aerobic base is strong and you may be ready for progression.';
                } else if (completion === 'partial') {
                    emoji = '‚ö†Ô∏è';
                    color = '#FF4D00';
                    message = '<strong>Cut the long run short.</strong> Could be fatigue, weather, or other factors. We will track if this becomes a pattern.';
                } else {
                    emoji = 'üìù';
                    color = '#00D9FF';
                    message = '<strong>Long run logged.</strong> Volume and effort recorded.';
                }
            }
            // OTHER WORKOUTS
            else {
                if (completion === 'full') {
                    emoji = '‚úÖ';
                    color = '#00FF88';
                    message = '<strong>Workout completed!</strong> Session finished as planned. Effort level noted for training optimization.';
                } else {
                    emoji = 'üìù';
                    color = '#00D9FF';
                    message = '<strong>Feedback recorded.</strong> We will use this data to optimize your training progression.';
                }
            }
            
            return { message, emoji, color };
        }

        function checkForPatterns(weekNum, dayName, effort, completion) {
            // Get recent feedback (last 5-7 workouts)
            const recentWorkouts = Object.entries(workoutFeedback)
                .filter(([key, _]) => {
                    const [wk, dy] = key.split('-');
                    const wkNum = parseInt(wk.replace('week', ''));
                    return !isNaN(wkNum) && wkNum <= weekNum; // Only past/current workouts
                })
                .map(([key, data]) => data)
                .slice(-7); // Last 7 workouts
            
            if (recentWorkouts.length < 3) {
                // Not enough data to detect pattern
                return { adapt: false, reason: 'insufficient_data' };
            }
            
            // PATTERN 1: Multiple hard workouts rated 8+ with partial/skipped completions
            const strugglingWorkouts = recentWorkouts.filter(w => 
                w.effort >= 8 && (w.completion === 'partial' || w.completion === 'skipped')
            );
            
            if (strugglingWorkouts.length >= 3) {
                return { 
                    adapt: true, 
                    reason: 'struggling_pattern',
                    details: `Detected pattern: ${strugglingWorkouts.length} of last ${recentWorkouts.length} workouts rated 8+/10 with incomplete sessions.`
                };
            }
            
            // PATTERN 2: Easy days consistently feeling hard (6+/10)
            const hardEasyDays = recentWorkouts.filter(w => 
                w.effort >= 6 && workoutFeedback[Object.keys(workoutFeedback).find(k => workoutFeedback[k] === w)]?.includes('Easy')
            );
            
            if (hardEasyDays.length >= 2 && recentWorkouts.length >= 4) {
                return { 
                    adapt: true, 
                    reason: 'recovery_insufficient',
                    details: `Recovery days feeling too hard. ${hardEasyDays.length} easy days rated 6+/10.`
                };
            }
            
            // PATTERN 3: Multiple maximal efforts (9-10/10) in short period
            const maximalEfforts = recentWorkouts.filter(w => w.effort >= 9).length;
            
            if (maximalEfforts >= 3 && recentWorkouts.length <= 5) {
                return { 
                    adapt: true, 
                    reason: 'overreaching',
                    details: `Multiple maximal efforts detected (${maximalEfforts} workouts at 9-10/10 in recent sessions).`
                };
            }
            
            // PATTERN 4: Everything consistently too easy (3+ workouts at ‚â§4/10, all completed)
            const easyWorkouts = recentWorkouts.filter(w => 
                w.effort <= 4 && w.completion === 'full'
            );
            
            if (easyWorkouts.length >= 4) {
                return { 
                    adapt: true, 
                    reason: 'ready_for_progression',
                    details: `${easyWorkouts.length} of last ${recentWorkouts.length} workouts felt very easy (‚â§4/10).`
                };
            }
            
            // PATTERN 5: Consistent skipping/modifying (3+ in last 7)
            const incompleteWorkouts = recentWorkouts.filter(w => 
                w.completion === 'skipped' || w.completion === 'modified'
            );
            
            if (incompleteWorkouts.length >= 3) {
                return { 
                    adapt: true, 
                    reason: 'consistency_issue',
                    details: `${incompleteWorkouts.length} of last ${recentWorkouts.length} workouts were skipped or modified.`
                };
            }
            
            // No pattern detected - maintain current training
            return { adapt: false, reason: 'no_pattern' };
        }

        function showFeedbackAcknowledgment(acknowledgment) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.85);
                backdrop-filter: blur(5px);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease-out;
                cursor: pointer;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: var(--dark);
                border: 3px solid ${acknowledgment.color};
                border-radius: 16px;
                padding: 40px;
                max-width: 500px;
                text-align: center;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                animation: scaleIn 0.3s ease-out;
                cursor: default;
            `;
            
            // Stop event propagation on content clicks
            content.onclick = (e) => e.stopPropagation();
            
            content.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 20px;">${acknowledgment.emoji}</div>
                <div style="color: ${acknowledgment.color}; font-size: 1.1rem; line-height: 1.6;">
                    ${acknowledgment.message}
                </div>
                <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                        style="margin-top: 30px; padding: 12px 30px; background: ${acknowledgment.color}; 
                               border: none; border-radius: 8px; color: var(--dark); font-weight: bold; 
                               font-size: 1rem; cursor: pointer; font-family: 'Space Mono', monospace;">
                    Got it!
                </button>
                <div style="color: rgba(255,255,255,0.4); font-size: 0.75rem; margin-top: 16px;">
                    (or click anywhere to close)
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Click anywhere on modal backdrop to close
            modal.onclick = () => modal.remove();
            
            // Auto-close after 8 seconds
            setTimeout(() => {
                if (modal.parentElement) {
                    modal.style.opacity = '0';
                    modal.style.transition = 'opacity 0.3s';
                    setTimeout(() => modal.remove(), 300);
                }
            }, 8000);
        }

        function adaptRemainingWeek(weekNum, completedDay, effort, completion, patternReason) {
            // Safety checks
            if (!allWeeksData || allWeeksData.length === 0) {
                console.log('No weeks data available for adaptation');
                return;
            }
            
            // Find the week in allWeeksData
            const weekIndex = allWeeksData.findIndex(w => w.weekNumber === weekNum);
            if (weekIndex === -1) {
                console.log('Week not found:', weekNum);
                return;
            }
            
            const weekData = allWeeksData[weekIndex];
            if (!weekData || !weekData.workouts) {
                console.log('Invalid week data');
                return;
            }
            
            const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const completedDayIndex = dayOrder.indexOf(completedDay);
            
            if (completedDayIndex === -1) {
                console.log('Invalid day name:', completedDay);
                return;
            }
            
            // Determine adaptation strategy based on feedback
            let adaptationNeeded = false;
            let adaptationType = '';
            
            if ((effort >= 8 && completion !== 'full') || completion === 'skipped') {
                // HARD WORKOUT or SKIPPED - need recovery
                adaptationNeeded = true;
                adaptationType = 'recovery';
            } else if (effort >= 9 && completion === 'full') {
                // MAXIMAL EFFORT but completed - maintain but don't pile on
                adaptationNeeded = true;
                adaptationType = 'maintain';
            } else if (effort >= 8 && completion === 'partial') {
                // STRUGGLED - reduce load
                adaptationNeeded = true;
                adaptationType = 'reduce';
            } else if (effort <= 4 && completion === 'full') {
                // TOO EASY - can handle more (but be conservative)
                adaptationNeeded = true;
                adaptationType = 'progress';
            }
            
            if (!adaptationNeeded) {
                console.log('No adaptation needed for this effort/completion level');
                return;
            }
            
            // Modify remaining days in the week
            for (let i = completedDayIndex + 1; i < dayOrder.length; i++) {
                const upcomingDay = dayOrder[i];
                const workout = weekData.workouts.find(w => w.day === upcomingDay);
                if (!workout) continue;
                
                const originalDetails = workout.originalDetails || workout.details;
                if (!workout.originalDetails) {
                    workout.originalDetails = workout.details; // Save original
                }
                
                // Apply adaptations based on type
                if (adaptationType === 'recovery') {
                    // Convert next hard workout to easy, reduce mileage
                    if (workout.type.includes('Workout') || workout.type.includes('Specific') || workout.type.includes('Bank')) {
                        workout.details = originalDetails.replace(/(\d+(?:\.\d+)?)\s*miles/g, (match, miles) => {
                            return Math.round(parseFloat(miles) * 0.7) + ' miles';
                        });
                        workout.type = '‚ö†Ô∏è ADAPTED: ' + workout.type.replace('‚ö†Ô∏è ADAPTED: ', '') + ' ‚Üí Easy';
                        workout.notes = 'üîÑ AUTO-ADJUSTED: Previous workout was tough. Converted to easy recovery. ' + (workout.notes || '');
                        workout.adapted = true;
                    } else if (workout.type.includes('Easy')) {
                        workout.details = originalDetails.replace(/(\d+(?:\.\d+)?)\s*miles/g, (match, miles) => {
                            return Math.max(3, Math.round(parseFloat(miles) * 0.8)) + ' miles';
                        });
                        workout.notes = 'üîÑ AUTO-ADJUSTED: Reduced mileage for recovery. ' + (workout.notes || '');
                        workout.adapted = true;
                    }
                } else if (adaptationType === 'reduce') {
                    // Reduce intensity/volume of upcoming workouts
                    if (workout.type.includes('Workout') || workout.type.includes('Specific')) {
                        workout.details = originalDetails + '\n\nüîÑ REDUCE: Cut reps by 20-30% or reduce pace slightly. Listen to your body.';
                        workout.type = '‚ö†Ô∏è ADAPTED: ' + workout.type.replace('‚ö†Ô∏è ADAPTED: ', '');
                        workout.adapted = true;
                    }
                } else if (adaptationType === 'maintain') {
                    // Keep as planned but don't add more
                    if (workout.type.includes('Workout') || workout.type.includes('Specific')) {
                        workout.notes = '‚úì Maintaining plan as-is after maximal effort. Focus on execution. ' + (workout.notes || '');
                    }
                } else if (adaptationType === 'progress') {
                    // Could handle slightly more (but be conservative - don't auto-increase)
                    workout.notes = 'üìà Last workout felt easy. Consider pushing pace slightly if feeling good. ' + (workout.notes || '');
                }
            }
            
            // Show adaptation notification
            showAdaptationNotification(adaptationType, completedDay, patternReason);
        }

        function showAdaptationNotification(adaptationType, day, patternReason) {
            const messages = {
                'recovery': `üîÑ <strong>Training Adapted - Pattern Detected:</strong><br>${patternReason?.details || 'Multiple tough sessions detected'}. Upcoming workouts reduced for recovery.`,
                'reduce': `‚ö†Ô∏è <strong>Training Adapted - Pattern Detected:</strong><br>${patternReason?.details || 'Consistency issues detected'}. Upcoming intensity reduced.`,
                'maintain': `‚úì <strong>Training Maintained:</strong><br>Recent efforts appropriate. Plan stays as scheduled.`,
                'progress': `üìà <strong>Progression Opportunity Detected:</strong><br>${patternReason?.details || 'Multiple easy sessions'}. Consider pushing pace in upcoming workouts if feeling strong.`
            };
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(255, 77, 0, 0.95);
                color: white;
                padding: 16px 20px;
                border-radius: 12px;
                border: 2px solid var(--accent);
                max-width: 400px;
                z-index: 2000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            `;
            notification.innerHTML = messages[adaptationType] || messages['maintain'];
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(400px)';
                notification.style.transition = 'all 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 7000);
        }

        function adaptTrainingBasedOnFeedback() {
            // Analyze recent feedback to adjust future training
            const recentFeedback = Object.values(workoutFeedback).slice(-7); // Last week
            
            if (recentFeedback.length < 3) return; // Need at least 3 workouts to adapt
            
            const avgEffort = recentFeedback.reduce((sum, f) => sum + f.effort, 0) / recentFeedback.length;
            const completionRate = recentFeedback.filter(f => f.completion === 'full').length / recentFeedback.length;
            
            let adaptationMessage = '';
            
            if (avgEffort > 8.5 && completionRate < 0.7) {
                adaptationMessage = '‚ö†Ô∏è Recent workouts rated very hard with low completion. Consider reducing volume or intensity.';
            } else if (avgEffort < 4 && completionRate > 0.9) {
                adaptationMessage = 'üìà Recent workouts felt easy with full completion. You may be ready for progression.';
            } else if (avgEffort >= 7 && avgEffort <= 8.5 && completionRate > 0.85) {
                adaptationMessage = '‚úÖ Training load is well-balanced. Keep current progression.';
            }
            
            if (adaptationMessage) {
                console.log('Training adaptation:', adaptationMessage);
                // Could display this in the UI if desired
            }
        }

        function getFeedbackIndicator(weekNum, dayName) {
            const key = `week${weekNum}-${dayName}`;
            const feedback = workoutFeedback[key];
            
            if (!feedback) return '';
            
            let indicatorClass = '';
            if (feedback.effort <= 5 && feedback.completion === 'full') {
                indicatorClass = 'good';
            } else if (feedback.effort <= 7 || feedback.completion === 'partial') {
                indicatorClass = 'okay';
            } else {
                indicatorClass = 'tough';
            }
            
            return `<span class="feedback-indicator ${indicatorClass}"></span>`;
        }

        function parseTimeToSeconds(timeStr) {
            if (!timeStr) return null;
            const parts = timeStr.split(':');
            if (parts.length === 2) {
                return parseInt(parts[0]) * 60 + parseFloat(parts[1]);
            }
            return parseFloat(timeStr);
        }

        function secondsToTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function estimateVDOT(seconds, meters) {
            const velocity = (meters / seconds) * 60;
            const minutes = seconds / 60;
            
            const percentMax = 0.8 + 0.1894393 * Math.exp(-0.012778 * minutes) + 
                             0.2989558 * Math.exp(-0.1932605 * minutes);
            
            const vo2 = -4.60 + 0.182258 * velocity + 0.000104 * Math.pow(velocity, 2);
            const vdot = vo2 / percentMax;
            
            return Math.max(30, Math.round(vdot));
        }

        function vdotToPace(vdot, percentVO2max) {
            const vo2 = vdot * percentVO2max;
            
            const a = 0.000104;
            const b = 0.182258;
            const c = -4.60 - vo2;
            
            const discriminant = b*b - 4*a*c;
            
            if (discriminant < 0) {
                const approxVelocity = 29.54 + 5.000663 * vdot - 0.007546 * vdot * vdot;
                return (1609.344 / approxVelocity) * 60;
            }
            
            const velocity = (-b + Math.sqrt(discriminant)) / (2*a);
            const metersPerMile = 1609.344;
            const secondsPerMile = (metersPerMile / velocity) * 60;
            
            return secondsPerMile;
        }
        
        // Convert per-mile pace (in seconds) to time for a given distance (in meters)
        function paceToRepTime(paceSecondsPerMile, distanceMeters) {
            const metersPerMile = 1609.344;
            const secondsPerMeter = paceSecondsPerMile / metersPerMile;
            const repTimeSeconds = secondsPerMeter * distanceMeters;
            return repTimeSeconds;
        }
        
        // Format rep time nicely (handles both mm:ss and just seconds)
        function formatRepTime(seconds) {
            if (seconds >= 60) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.round(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${Math.round(seconds)}s`;
            }
        }
        
        // Get rep time for a specific distance at a given VDOT percentage
        function getRepTime(vdot, percentVO2max, distanceMeters) {
            const pacePerMile = vdotToPace(vdot, percentVO2max);
            const repSeconds = paceToRepTime(pacePerMile, distanceMeters);
            return formatRepTime(repSeconds);
        }

        function calculatePaces(vdot) {
            // Base per-mile paces (still useful for easy/long runs)
            const easyPaceSlow = vdotToPace(vdot, 0.59);
            const easyPaceFast = vdotToPace(vdot, 0.74);
            const thresholdPace = vdotToPace(vdot, 0.85);
            const tempoPaceFast = vdotToPace(vdot, 0.88);
            const tempoPaceSlow = vdotToPace(vdot, 0.83);
            const fiveKPace = vdotToPace(vdot, 0.95);
            const threeKPace = vdotToPace(vdot, 0.98);
            const milePace = vdotToPace(vdot, 1.00);
            const e800Pace = vdotToPace(vdot, 1.05);
            
            return {
                // Per-mile paces for easy/long runs
                easy: `${secondsToTime(easyPaceFast)}-${secondsToTime(easyPaceSlow)}`,
                threshold: secondsToTime(thresholdPace),
                tempo: `${secondsToTime(tempoPaceFast)}-${secondsToTime(tempoPaceSlow)}`,
                fiveK: secondsToTime(fiveKPace),
                threeK: secondsToTime(threeKPace),
                interval: `${secondsToTime(milePace)}-${secondsToTime(fiveKPace)}`,
                mile: secondsToTime(milePace),
                e800: secondsToTime(e800Pace / 2),
                
                // Rep times for common workout distances
                rep200_mile: formatRepTime(paceToRepTime(milePace, 200)),
                rep200_800: formatRepTime(paceToRepTime(e800Pace, 200)),
                rep300_mile: formatRepTime(paceToRepTime(milePace, 300)),
                rep300_800: formatRepTime(paceToRepTime(e800Pace, 300)),
                rep400_mile: formatRepTime(paceToRepTime(milePace, 400)),
                rep400_800: formatRepTime(paceToRepTime(e800Pace, 400)),
                rep400_5k: formatRepTime(paceToRepTime(fiveKPace, 400)),
                rep400_3k: formatRepTime(paceToRepTime(threeKPace, 400)),
                rep500_mile: formatRepTime(paceToRepTime(milePace, 500)),
                rep600_mile: formatRepTime(paceToRepTime(milePace, 600)),
                rep600_3k: formatRepTime(paceToRepTime(threeKPace, 600)),
                rep800_3k: formatRepTime(paceToRepTime(threeKPace, 800)),
                rep800_5k: formatRepTime(paceToRepTime(fiveKPace, 800)),
                rep1000_threshold: formatRepTime(paceToRepTime(thresholdPace, 1000)),
                rep1000_3k: formatRepTime(paceToRepTime(threeKPace, 1000)),
                rep1000_5k: formatRepTime(paceToRepTime(fiveKPace, 1000))
            };
        }

        function getMileageBand(mileage) {
            if (mileage < 35) return '25-35';
            if (mileage < 50) return '35-50';
            return '50-65';
        }

        console.log('About to define generatePlan function...');

        function generatePlan() {
            console.log('generatePlan called!');
            
            // Always start fresh - clear previous plan data
            allWeeksData = [];
            currentPlanData = null;
            workoutFeedback = {}; // Start with fresh feedback for new plan
            
            // Clear any previous error highlighting
            document.querySelectorAll('.input-group').forEach(group => {
                group.style.border = '';
                group.style.background = '';
            });
            
            const times = {
                '800m': parseTimeToSeconds(document.getElementById('time800m').value),
                '1600m': parseTimeToSeconds(document.getElementById('time1600m').value),
                '3200m': parseTimeToSeconds(document.getElementById('time3200m').value),
                '5000m': parseTimeToSeconds(document.getElementById('time5000m').value)
            };

            const currentMileage = parseInt(document.getElementById('currentMileage').value);
            const goalMileage = parseInt(document.getElementById('goalMileage').value);
            const goalEvent = document.getElementById('goalEvent').value;
            const planDuration = document.getElementById('planDuration').value;
            fitnessLevel = parseInt(document.getElementById('fitnessLevel').value);

            // Validation with highlighting
            const errors = [];
            
            // Check if at least one time is entered
            const hasTime = Object.values(times).some(t => t !== null);
            if (!hasTime) {
                errors.push('race-times');
                // Highlight the race times card
                document.querySelector('#time800m').closest('.card').style.border = '3px solid #FF4D00';
                document.querySelector('#time800m').closest('.card').style.background = 'rgba(255,77,0,0.1)';
            }
            
            if (!currentMileage || currentMileage <= 0) {
                errors.push('current-mileage');
                const input = document.getElementById('currentMileage').closest('.input-group');
                input.style.border = '2px solid #FF4D00';
                input.style.background = 'rgba(255,77,0,0.1)';
                input.style.padding = '12px';
                input.style.borderRadius = '8px';
            }
            
            if (!goalMileage || goalMileage <= 0) {
                errors.push('goal-mileage');
                const input = document.getElementById('goalMileage').closest('.input-group');
                input.style.border = '2px solid #FF4D00';
                input.style.background = 'rgba(255,77,0,0.1)';
                input.style.padding = '12px';
                input.style.borderRadius = '8px';
            }
            
            if (errors.length > 0) {
                let errorMsg = 'Please fill out the following required fields:\n\n';
                if (errors.includes('race-times')) errorMsg += '‚Ä¢ At least ONE race time\n';
                if (errors.includes('current-mileage')) errorMsg += '‚Ä¢ Current Weekly Mileage\n';
                if (errors.includes('goal-mileage')) errorMsg += '‚Ä¢ Goal Weekly Mileage\n';
                
                alert(errorMsg);
                
                // Scroll to first error
                if (errors.includes('race-times')) {
                    document.querySelector('#time800m').closest('.card').scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    document.getElementById(errors.includes('current-mileage') ? 'currentMileage' : 'goalMileage')
                        .closest('.input-group').scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                return;
            }

            // Check for race schedule (unless checkbox is checked)
            const noRaces = document.getElementById('noRacesCheckbox')?.checked || false;
            const raceSchedule = [];
            
            if (!noRaces) {
                for (let i = 1; i <= 3; i++) {
                    const date = document.getElementById(`raceDate${i}`).value;
                    const distance = document.getElementById(`raceDistance${i}`).value;
                    const priority = document.getElementById(`racePriority${i}`).value;
                    
                    if (date && distance) {
                        raceSchedule.push({ date, distance, priority });
                    }
                }
                
                // If no races and checkbox not checked, highlight and show error
                if (raceSchedule.length === 0) {
                    // Highlight race schedule section
                    const raceCard = document.getElementById('raceDate1').closest('.card');
                    if (raceCard) {
                        raceCard.style.border = '3px solid #FF4D00';
                        raceCard.style.background = 'rgba(255,77,0,0.1)';
                    }
                    
                    // Highlight the checkbox option
                    const checkboxLabel = document.getElementById('noRacesCheckbox')?.closest('label');
                    if (checkboxLabel) {
                        checkboxLabel.style.border = '2px solid #FFE600';
                        checkboxLabel.style.background = 'rgba(255,230,0,0.2)';
                        checkboxLabel.style.padding = '12px';
                        checkboxLabel.style.borderRadius = '8px';
                        checkboxLabel.style.display = 'block';
                    }
                    
                    alert('Please either:\n\n‚Ä¢ Add at least ONE race to your schedule\n\nOR\n\n‚Ä¢ Check the "No races - just building fitness" box');
                    
                    // Scroll to race schedule
                    document.getElementById('raceDate1').closest('.card').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
            }

            document.getElementById('dataInput').style.display = 'none';
            document.getElementById('loading').classList.add('active');

            setTimeout(() => {
                const vdots = [];
                const distanceMap = {
                    '800m': 800,
                    '1600m': 1600,
                    '3200m': 3200,
                    '5000m': 5000
                };

                for (const [distance, seconds] of Object.entries(times)) {
                    if (seconds !== null) {
                        const meters = distanceMap[distance];
                        const vdot = estimateVDOT(seconds, meters);
                        vdots.push(vdot);
                    }
                }

                const avgVDOT = Math.round(vdots.reduce((a, b) => a + b, 0) / vdots.length);
                
                // Adjust training based on fitness level (1-100%)
                let paceMultiplier, volumeMultiplier, intensityAdjustment;
                
                if (fitnessLevel <= 25) {
                    // RECOVERING (1-25%): Significantly easier training
                    paceMultiplier = 0.94;  // 6% slower paces
                    volumeMultiplier = 0.85; // 15% less volume
                    intensityAdjustment = 'RECOVERY MODE: Reduced volume and easier paces. Focus on rebuilding.';
                } else if (fitnessLevel <= 50) {
                    // BUILDING (26-50%): Moderate reduction
                    paceMultiplier = 0.97;  // 3% slower paces
                    volumeMultiplier = 0.92; // 8% less volume
                    intensityAdjustment = 'BUILDING PHASE: Slightly reduced intensity. Progressive overload.';
                } else if (fitnessLevel <= 75) {
                    // RACE READY (51-75%): Normal training
                    paceMultiplier = 1.0;   // Normal paces
                    volumeMultiplier = 1.0; // Full volume
                    intensityAdjustment = 'RACE READY: Full training load. Normal workout intensity.';
                } else {
                    // PEAK FITNESS (76-100%): Aggressive/sharp training
                    paceMultiplier = 1.0;   // Normal paces (don't go faster)
                    volumeMultiplier = 0.95; // Slightly less volume for sharpness
                    intensityAdjustment = 'PEAK FITNESS: Maintaining sharpness. Reduced volume, high quality.';
                }
                
                const adjustedVDOT = Math.round(avgVDOT * paceMultiplier);
                const paces = calculatePaces(adjustedVDOT);
                
                // Store current plan data for saving
                currentPlanData = {
                    vdot: adjustedVDOT,
                    paces: paces,
                    currentMileage: currentMileage,
                    goalMileage: goalMileage,
                    goalEvent: goalEvent,
                    planDuration: planDuration,
                    raceSchedule: raceSchedule,
                    fitnessLevel: fitnessLevel,
                    intensityAdjustment: intensityAdjustment,
                    volumeMultiplier: volumeMultiplier,
                    createdDate: new Date().toISOString()
                };

                displayStats(adjustedVDOT, currentMileage, goalMileage, paces, intensityAdjustment, fitnessLevel);
                displayRaceSchedule(raceSchedule);
                displayPeriodizedPlan(paces, currentMileage, goalMileage, goalEvent, planDuration, raceSchedule, volumeMultiplier);
                
                // Update profile stats after plan is created
                updateProfileStats();
                
                // Clear the active plan ID since this is a new unsaved plan
                localStorage.removeItem('laktic_active_plan_id');
                
                // Update the banner to show this is an unsaved plan
                updateActivePlanBanner(null, false);
                
                // Hide the "No Active Plan" message, show the workout plan
                document.getElementById('noPlanMessage').style.display = 'none';
                document.getElementById('workoutPlan').style.display = 'block';
                
                // Switch to My Plans tab to show the generated plan
                setTimeout(() => {
                    switchPage('myPlansPage');
                    showActivePlan();
                }, 300);

                document.getElementById('loading').classList.remove('active');
                document.getElementById('workoutPlan').classList.add('active');
            }, 2000);
        }

        function displayStats(vdot, currentMileage, goalMileage, paces, intensityAdjustment, fitnessLevel) {
            let fitnessLabel, fitnessColor;
            if (fitnessLevel <= 25) {
                fitnessLabel = 'Recovering';
                fitnessColor = '#FF4D00';
            } else if (fitnessLevel <= 50) {
                fitnessLabel = 'Building';
                fitnessColor = '#FFE600';
            } else if (fitnessLevel <= 75) {
                fitnessLabel = 'Race Ready';
                fitnessColor = '#00FF88';
            } else {
                fitnessLabel = 'Peak Fitness';
                fitnessColor = '#00D9FF';
            }
            
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-box">
                    <div class="stat-value">${vdot}</div>
                    <div class="stat-label">VDOT</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${currentMileage}</div>
                    <div class="stat-label">Current MPW</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${goalMileage}</div>
                    <div class="stat-label">Goal MPW</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${paces.threshold}</div>
                    <div class="stat-label">Threshold</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${paces.mile}</div>
                    <div class="stat-label">Mile Pace</div>
                </div>
                <div class="stat-box" style="grid-column: span 2;">
                    <div class="stat-value" style="font-size: 1.5rem; color: ${fitnessColor};">${fitnessLevel}%</div>
                    <div class="stat-label">${fitnessLabel}</div>
                </div>
            `;
            
            // Add training adjustment notice
            if (intensityAdjustment) {
                const statsCard = document.getElementById('statsGrid').parentElement;
                const existingNotice = document.getElementById('intensityNotice');
                if (existingNotice) existingNotice.remove();
                
                const notice = document.createElement('div');
                notice.id = 'intensityNotice';
                notice.style.cssText = `
                    margin-top: 16px; 
                    padding: 12px; 
                    background: rgba(${fitnessLevel <= 25 ? '255,77,0' : fitnessLevel <= 50 ? '255,230,0' : fitnessLevel <= 75 ? '0,255,136' : '0,217,255'},0.15); 
                    border-left: 4px solid ${fitnessColor}; 
                    border-radius: 8px; 
                    font-size: 0.85rem;
                    color: rgba(255,255,255,0.9);
                `;
                notice.innerHTML = `<strong>üìä Training Adjustment:</strong> ${intensityAdjustment}`;
                statsCard.appendChild(notice);
            }
        }

        function displayRaceSchedule(raceSchedule) {
            if (raceSchedule.length === 0) {
                document.getElementById('raceScheduleCard').style.display = 'none';
                return;
            }

            document.getElementById('raceScheduleCard').style.display = 'block';
            
            const priorityClasses = { 'A': 'race-a', 'B': 'race-b', 'C': 'race-c' };
            const priorityLabels = { 'A': 'TARGET RACE', 'B': 'Important Race', 'C': 'Tune-up Race' };

            document.getElementById('raceScheduleDisplay').innerHTML = raceSchedule.map(race => `
                <div class="race-schedule-item ${priorityClasses[race.priority]}">
                    <div>
                        <div style="font-weight: bold; margin-bottom: 4px;">${race.distance.toUpperCase()}</div>
                        <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">
                            ${new Date(race.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2rem; font-weight: bold;">${race.priority}</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">${priorityLabels[race.priority]}</div>
                    </div>
                </div>
            `).join('');
        }

        function displayPeriodizedPlan(paces, currentMileage, goalMileage, goalEvent, duration, raceSchedule, volumeMultiplier = 1.0) {
            const today = new Date();
            
            if (duration === 'weekly') {
                document.getElementById('planTitle').textContent = 'This Week\'s Plan';
                document.getElementById('periodizationNote').textContent = 'Sample training week using Laktic workout system';
                document.getElementById('weekSelector').style.display = 'none';
                const adjustedMileage = Math.round(currentMileage * volumeMultiplier);
                displaySampleWeek(paces, adjustedMileage, goalEvent);
            } else if (duration === 'monthly') {
                document.getElementById('planTitle').textContent = '4-Week Training Block';
                buildMultiWeekPlan(paces, currentMileage, goalMileage, goalEvent, 4, raceSchedule, today, volumeMultiplier);
            } else if (duration === 'quarterly') {
                document.getElementById('planTitle').textContent = '12-Week Training Plan';
                buildMultiWeekPlan(paces, currentMileage, goalMileage, goalEvent, 12, raceSchedule, today, volumeMultiplier);
            }
        }

        function displaySampleWeek(paces, mileage, goalEvent) {
            window.currentPaces = paces; // Store for reload after feedback
            
            const band = getMileageBand(mileage);
            const phase = 'Mid';
            
            const week = buildWeekFromLibrary(paces, mileage, goalEvent, phase, band, 1, false);
            
            // IMPORTANT: Populate allWeeksData so the plan can be saved and used in calendar
            allWeeksData = [{
                weekNumber: 1,
                label: 'Sample Week',
                description: 'Sample training week using Laktic workout system',
                mileage: mileage,
                season: phase,
                workouts: week,
                raceWeek: false
            }];
            
            // Calculate total mileage
            let totalMileage = 0;
            week.forEach(w => {
                const mileMatch = w.details.match(/(\d+(?:\.\d+)?)\s*miles/);
                if (mileMatch) {
                    totalMileage += parseFloat(mileMatch[1]);
                }
            });
            
            let html = `
                <div style="background: rgba(0,217,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid var(--accent);">
                    <strong>Weekly Total:</strong> ~${Math.round(totalMileage)} miles (Target: ${mileage} miles)
                </div>
            `;
            
            week.forEach((w, idx) => {
                const feedbackKey = `week1-${w.day}`;
                const hasFeedback = workoutFeedback[feedbackKey];
                const indicator = getFeedbackIndicator(1, w.day);
                
                html += `
                    <div class="workout-item ${w.adapted ? 'adapted' : ''}" style="animation-delay: ${idx * 0.05}s;">
                        <div class="workout-day">${indicator}${w.day}${w.adapted ? ' <span style="color: var(--secondary); font-size: 0.75rem;">‚ö° ADAPTED</span>' : ''}</div>
                        <div class="workout-type">${w.type}</div>
                        <div class="workout-details">${w.details}</div>
                        ${w.rest ? `<div class="workout-rest">Rest: ${w.rest}</div>` : ''}
                        ${w.notes ? `<div class="workout-notes">üìù ${w.notes}</div>` : ''}
                        ${hasFeedback && hasFeedback.notes ? 
                            `<div style="margin-top: 8px; padding: 8px; background: rgba(0,217,255,0.1); border-radius: 4px; font-size: 0.8rem;">
                                <strong>Your feedback:</strong> ${hasFeedback.notes} (Effort: ${hasFeedback.effort}/10)
                            </div>` : ''}
                        <button class="feedback-btn ${hasFeedback ? 'completed' : ''}" 
                                onclick="openFeedbackModal(1, '${w.day}', '${w.type.replace(/'/g, "\\'")}')">
                            ${hasFeedback ? '‚úì Edit Feedback' : '+ Add Feedback'}
                        </button>
                    </div>
                `;
            });
            
            document.getElementById('workoutList').innerHTML = html;
        }

        function buildWeekFromLibrary(paces, mileage, goalEvent, season, band, weekNum, isRaceWeek) {
            // Calculate workout volumes first
            const workoutMileage = isRaceWeek ? 
                Math.round(mileage * 0.08) : // Race week: minimal quality
                Math.round(mileage * 0.12);  // Normal: ~12% in hard workouts
            
            const longRun = Math.min(Math.round(mileage * 0.25), Math.min(14, mileage * 0.28));
            const primerMileage = 3; // ~3 miles for primer workout
            
            // Calculate remaining mileage for easy runs
            let remainingMiles = mileage - workoutMileage - longRun;
            if (isRaceWeek) {
                remainingMiles -= primerMileage;
            }
            
            // Distribute remaining miles across easy days
            const numEasyDays = isRaceWeek ? 3 : 4; // Wed, Thu, Sun (+ possibly Mon in race week)
            const easyDayMiles = Math.max(3, Math.floor(remainingMiles / numEasyDays));
            
            const week = [
                {
                    day: 'Monday',
                    type: 'Speed Development',
                    details: getSpeedDevWorkout(band, weekNum) + ` Total: ${Math.round(easyDayMiles * 0.7)} miles including warm-up/cool-down.`,
                    rest: 'Full recovery between reps (2:00-5:00)',
                    notes: 'Stop early if mechanics fade. Never tiring.'
                },
                {
                    day: 'Tuesday',
                    type: 'Aerobic Bank',
                    details: getAerobicBankWorkout(season, band, paces, isRaceWeek) + ` Total: ${workoutMileage} miles including warm-up/cool-down.`,
                    rest: '60-90s jog between reps',
                    notes: 'Keep it controlled. Last rep should be best without strain.'
                },
                {
                    day: 'Wednesday',
                    type: 'Easy Run',
                    details: `${easyDayMiles} miles at ${paces.easy} pace. Recovery day.`,
                    rest: null,
                    notes: 'Can add light drills/strides if feeling good.'
                },
                {
                    day: 'Thursday',
                    type: isRaceWeek ? 'Primer' : 'Easy Run',
                    details: isRaceWeek ? 
                        getPrimerWorkout(goalEvent, paces) + ` Total: ${primerMileage} miles including warm-up/cool-down.` :
                        `${easyDayMiles} miles easy. Light day before workout.`,
                    rest: isRaceWeek ? '2:30-4:00 full recovery between reps' : null,
                    notes: isRaceWeek ? 'Stay snappy, not fatigued. Quality > density.' : 'Keep it very easy.'
                },
                {
                    day: 'Friday',
                    type: isRaceWeek ? 'RACE or Shakeout' : 'Specific Workout',
                    details: isRaceWeek ? 
                        'Race day! Or easy 3-4 miles if racing Saturday.' : 
                        getSpecificWorkout(season, goalEvent, band, paces, weekNum) + ` Total: ${workoutMileage} miles including warm-up/cool-down.`,
                    rest: isRaceWeek ? null : '2:00-4:00 between reps, 5:00-8:00 between sets',
                    notes: isRaceWeek ? 'Execute your race plan!' : 'Stop if pace drops >2-3%. This is your key session.'
                },
                {
                    day: 'Saturday',
                    type: isRaceWeek ? 'Race Day' : 'Long Run',
                    details: isRaceWeek ? 
                        'Race day or easy ' + longRun + ' miles if raced Friday' : 
                        `${longRun} miles at ${paces.easy} pace. Steady aerobic work.`,
                    rest: null,
                    notes: isRaceWeek ? 'Execute your race plan!' : 'Build the aerobic engine. Stay patient.'
                },
                {
                    day: 'Sunday',
                    type: 'Recovery',
                    details: `${easyDayMiles} miles easy OR complete rest.`,
                    rest: null,
                    notes: 'Listen to your body. Recovery is training.'
                }
            ];
            
            return week;
        }

        function getSpeedDevWorkout(band, weekNum) {
            const workouts = [
                'Accels + Flys: 4-6√ó20-30m accels (walk back + 30-60s) + 3-5√ófly20 (20m build + 20m fly, 3:00-5:00 rest). Full relaxation.',
                'Short hill sprints: 6-10√ó8-12s hills at perfect form. Walk back + 2:00-4:00 full recovery.',
                'Fast-relaxed 150s: 3-5√ó150m smooth (not lactate). 4:00-6:00 full recovery. Use sparingly.',
                'Strides + drills: 6-10√ó100m strides + dynamic drills/skills. 60-120s walk/jog between.'
            ];
            return workouts[weekNum % 4];
        }

        function getAerobicBankWorkout(season, band, paces, isRaceWeek) {
            if (isRaceWeek) {
                return `Short tempo + strides: 16-20 min @ ${paces.tempo}/mi pace + 4√ó150m fast-relaxed (2:00-4:00 rest). Race-week safe anchor.`;
            }
            
            if (season === 'Early') {
                const reps = band === '25-35' ? 4 : band === '35-50' ? 5 : '5-6';
                return `${reps}√ó1000m in ${paces.rep1000_threshold} each (threshold pace). 60-90s jog recovery. Bank aerobic fitness.`;
            } else if (season === 'Mid') {
                const length = band === '25-35' ? '20 min' : band === '35-50' ? '22 min' : '24 min';
                return `Tempo ${length} @ ${paces.tempo}/mi + 4-6√ó150m fast-relaxed (2:00-4:00 rest). Best mid-season default.`;
            } else {
                return `4-5√ó1000m cutdown (${paces.rep1000_threshold}‚Üífaster). 75-90s jog recovery. Stay controlled.`;
            }
        }

        function getPrimerWorkout(goalEvent, paces) {
            if (goalEvent === '800') {
                return `3-5√ó200m in ${paces.rep200_800} each (800 rhythm). 2:30-4:00 full recovery. Quality > density.`;
            } else if (goalEvent === '1500') {
                return `4-6√ó200m in ${paces.rep200_mile} each (mile rhythm). 2:30-4:00 full recovery. Keep mechanics smooth.`;
            } else {
                return `4-6√ó200m in ${paces.rep200_mile} each (3K-mile rhythm). 2:30-4:00 full recovery. Great before Saturday invites.`;
            }
        }

        function getSpecificWorkout(season, goalEvent, band, paces, weekNum) {
            const eventKey = goalEvent === '800' ? 'S' : goalEvent === '1500' ? 'M' : 'K';
            const workoutNum = (weekNum % 6) + 1;
            
            if (eventKey === 'S') {
                const workouts = [
                    `2-3√ó(300-200-100) @ 800 pace: 300s in ${paces.rep300_800}, 200s in ${paces.rep200_800}. 300‚Üí200: 4:00-6:00; 200‚Üí100: 3:00-5:00; sets: 8:00-12:00. Classic 800 work.`,
                    `2√ó(400-200-200) @ 800 pace: 400s in ${paces.rep400_800}, 200s in ${paces.rep200_800}. 2:00 between reps; 7:00 between sets. Speed endurance.`,
                    `8-10√ó200m in ${paces.rep200_800} each (800 pace). 60-90s if rhythm, 2:00-3:00 if all-out. Fewer reps if true race pace.`,
                    `1-2√ó(500-300-200): 500s in ${paces.rep500_mile}, 300/200s in ${paces.rep300_800}/${paces.rep200_800}. 500‚Üí300: 4:00-6:00; 300‚Üí200: 3:00-5:00; sets: 8:00-12:00.`,
                    `2√ó4√ó200 in ${paces.rep200_800} (60-90s rest), 6:00 between sets. Then spike up + 1√ó400 in ${paces.rep400_800} (8:00-12:00 rest).`,
                    `250-150-100-250 @ fast rhythm. 4:00-8:00 full recovery between all reps. Championship sharpening.`
                ];
                return workouts[workoutNum - 1];
            } else if (eventKey === 'M') {
                const workouts = [
                    `2√ó3√ó400 in ${paces.rep400_mile} (mile pace) + 5√ó200 in ${paces.rep200_800} (800 pace). 400s: 90s; sets: 3:00. 200s: 2:00-4:00. Classic miler session.`,
                    `2-3√ó(500-300-200) @ mile pace: 500s in ${paces.rep500_mile}, 300s in ${paces.rep300_mile}, 200s in ${paces.rep200_mile}. 90s between reps; 3:00 set rest. Build speed endurance.`,
                    `10√ó300m in ${paces.rep300_mile} each (mile pace). 100m walk/jog (60-90s) or fixed 2:00 rest. Controlled rhythm.`,
                    `3-4√ó(400-300-200) in ${paces.rep400_mile}/${paces.rep300_mile}/${paces.rep200_mile} + 2-3√ó(250-150). 90s-2:00 within; 2:30-3:30 sets. Speed layering.`,
                    `6-8√ó300 in ${paces.rep300_mile} (mile) + 2-3√ó300 in ${paces.rep300_800} (800 pace). Mile 300s: 60-90s. 800 300s: 3:00-6:00. Quality first.`,
                    `2√ó(600-400-200) in ${paces.rep600_mile}/${paces.rep400_mile}/${paces.rep200_mile} + quick 400 in ${paces.rep400_800}. 600‚Üí400: 3:00-4:00; 400‚Üí200: 2:30-3:30; sets: 6:00-8:00. 400: 8:00-12:00.`
                ];
                return workouts[workoutNum - 1];
            } else {
                const workouts = [
                    `2√ó3√ó600 in ${paces.rep600_3k} (3K pace) + 5√ó200 in ${paces.rep200_mile} (mile pace). 600s: 90s-2:00; sets: 4:00. 200s: 2:00-3:00. Volume builder.`,
                    `1000-1000-800-600-400 @ 3K rhythm: 1000s in ${paces.rep1000_3k}, 800 in ${paces.rep800_3k}, 600 in ${paces.rep600_3k}, 400 in ${paces.rep400_3k}. Rest: 3:00, 3:00, 2:30, 2:00.`,
                    `2-3√ó(1000-600-400): 1000s in ${paces.rep1000_5k} (5K), 600s in ${paces.rep600_3k} (3K), 400s in ${paces.rep400_mile} (mile). 1000‚Üí600: 3:00-4:00; 600‚Üí400: 3:00; sets: 6:00-8:00.`,
                    `2-3√ó(800-600-400) @ 3K pace: 800s in ${paces.rep800_3k}, 600s in ${paces.rep600_3k}, 400s in ${paces.rep400_3k}. 2:00-3:00 between reps; 5:00-7:00 between sets.`,
                    `4-5√ó800 in ${paces.rep800_3k} each (3200 pace). 2:00-3:00 between reps. Classic 2-mile training.`,
                    `12-14√ó400 in ${paces.rep400_3k} each (3K pace). 60-75s rest (or 75-90s for quality). High volume speed work.`
                ];
                return workouts[workoutNum - 1];
            }
        }

        function buildMultiWeekPlan(paces, currentMileage, goalMileage, goalEvent, totalWeeks, raceSchedule, today, volumeMultiplier = 1.0) {
            allWeeksData = [];
            const mileageProgression = calculateMileageProgression(currentMileage, goalMileage, totalWeeks);
            
            for (let week = 1; week <= totalWeeks; week++) {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() + (week - 1) * 7);
                
                // Apply volume multiplier based on fitness level
                const baseWeekMileage = mileageProgression[week - 1];
                const weekMileage = Math.round(baseWeekMileage * volumeMultiplier);
                
                const band = getMileageBand(weekMileage);
                const phase = determinePhase(week, totalWeeks, weekStart, raceSchedule);
                
                const workouts = buildWeekFromLibrary(paces, weekMileage, goalEvent, phase.season, band, week, phase.raceWeek);
                
                allWeeksData.push({
                    weekNumber: week,
                    label: phase.label,
                    description: phase.description,
                    mileage: weekMileage,
                    season: phase.season,
                    workouts: workouts,
                    raceWeek: phase.raceWeek
                });
            }
            
            setupWeekSelector(totalWeeks);
            displaySelectedWeek(0);
            
            const adjustedStart = Math.round(currentMileage * volumeMultiplier);
            const adjustedGoal = Math.round(goalMileage * volumeMultiplier);
            
            document.getElementById('periodizationNote').innerHTML = `
                <strong>${totalWeeks}-Week Plan:</strong> Mileage ${adjustedStart}‚Üí${adjustedGoal} mpw. 
                Laktic workout system with event-specific training for ${goalEvent === '800' ? '800m' : goalEvent === '1500' ? '1500m/Mile' : '3200m/3K'}.
                ${volumeMultiplier < 1.0 ? `<br><span style="color: var(--secondary);">‚ö†Ô∏è Volume reduced by ${Math.round((1 - volumeMultiplier) * 100)}% based on current fitness level.</span>` : ''}
            `;
        }

        function determinePhase(weekNum, totalWeeks, weekStart, raceSchedule) {
            const raceInWeek = raceSchedule.find(race => {
                const raceDate = new Date(race.date);
                const daysDiff = Math.floor((raceDate - weekStart) / (1000 * 60 * 60 * 24));
                return daysDiff >= 0 && daysDiff < 7;
            });

            if (raceInWeek) {
                const labels = {
                    'A': `Taper - ${raceInWeek.distance} TARGET`,
                    'B': `${raceInWeek.distance} B Race`,
                    'C': `Training Week (${raceInWeek.distance} tune-up)`
                };
                return {
                    season: 'Late',
                    label: labels[raceInWeek.priority],
                    description: raceInWeek.priority === 'A' ? 'Peak week - reduce volume, maintain sharpness' : 
                                raceInWeek.priority === 'B' ? 'Light taper week' : 'Normal training, race as workout',
                    raceWeek: true
                };
            }

            const percentThrough = weekNum / totalWeeks;
            if (percentThrough < 0.35) {
                return { season: 'Early', label: 'Base Building', description: 'Aerobic development, threshold work', raceWeek: false };
            } else if (percentThrough < 0.75) {
                return { season: 'Mid', label: 'Race Preparation', description: 'Event-specific training, race rhythm', raceWeek: false };
            } else {
                return { season: 'Late', label: 'Championship Phase', description: 'Sharpening, maintaining fitness', raceWeek: false };
            }
        }

        function calculateMileageProgression(start, goal, weeks) {
            const progression = [];
            const increment = (goal - start) / (weeks - 1);
            
            for (let i = 0; i < weeks; i++) {
                let weekMileage = start + (increment * i);
                if ((i + 1) % 4 === 0 && i > 0) {
                    weekMileage *= 0.9;
                }
                progression.push(Math.round(weekMileage));
            }
            
            return progression;
        }

        function setupWeekSelector(totalWeeks) {
            const selector = document.getElementById('weekSelector');
            const dropdown = document.getElementById('weekDropdown');
            
            selector.style.display = 'block';
            dropdown.innerHTML = '';
            
            for (let i = 0; i < totalWeeks; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Week ${i + 1}`;
                dropdown.appendChild(option);
            }
        }

        function changeWeek() {
            const selectedIndex = parseInt(document.getElementById('weekDropdown').value);
            displaySelectedWeek(selectedIndex);
        }

        function displaySelectedWeek(weekIndex) {
            const weekData = allWeeksData[weekIndex];
            if (!weekData) return;
            
            // Calculate total weekly mileage from workouts
            let totalMileage = 0;
            weekData.workouts.forEach(w => {
                const mileMatch = w.details.match(/(\d+(?:\.\d+)?)\s*miles/);
                if (mileMatch) {
                    totalMileage += parseFloat(mileMatch[1]);
                }
            });
            
            // Check if any workouts were adapted
            const hasAdaptations = weekData.workouts.some(w => w.adapted);
            
            const phaseClass = weekData.season === 'Early' ? 'phase-early' : 
                              weekData.season === 'Mid' ? 'phase-mid' : 'phase-late';
            
            let html = `
                <div style="margin-bottom: 32px; border: 2px solid var(--accent); border-radius: 12px; padding: 20px; background: rgba(255,77,0,0.05);">
                    <span class="phase-badge ${phaseClass}">${weekData.season.toUpperCase()} SEASON</span>
                    <h3 style="color: var(--accent); margin-bottom: 8px; font-size: 1.3rem;">
                        Week ${weekData.weekNumber}: ${weekData.label} ${weekData.raceWeek ? 'üèÅ' : ''}
                    </h3>
                    <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-bottom: 16px;">
                        ${weekData.description} | Target: ${weekData.mileage} miles | Actual: ~${Math.round(totalMileage)} miles
                    </p>
                    ${hasAdaptations ? `
                        <div style="background: rgba(255,230,0,0.15); border: 2px solid var(--secondary); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                            <strong style="color: var(--secondary);">‚ö° Adapted Training:</strong> 
                            Some workouts have been automatically adjusted based on your feedback.
                            <button class="regenerate-week-btn" onclick="resetWeekToOriginal(${weekData.weekNumber})" style="margin-left: 12px; display: inline; padding: 6px 12px; font-size: 0.8rem;">
                                üîÑ Reset Week to Original
                            </button>
                        </div>
                    ` : ''}
            `;
            
            weekData.workouts.forEach((w, idx) => {
                const feedbackKey = `week${weekData.weekNumber}-${w.day}`;
                const hasFeedback = workoutFeedback[feedbackKey];
                const indicator = getFeedbackIndicator(weekData.weekNumber, w.day);
                
                html += `
                    <div class="workout-item ${w.adapted ? 'adapted' : ''}" style="margin-bottom: 10px; animation-delay: ${idx * 0.05}s;">
                        <div class="workout-day">${indicator}${w.day}${w.adapted ? ' <span style="color: var(--secondary); font-size: 0.75rem;">‚ö° ADAPTED</span>' : ''}</div>
                        <div class="workout-type">${w.type}</div>
                        <div class="workout-details">${w.details}</div>
                        ${w.rest ? `<div class="workout-rest">Rest: ${w.rest}</div>` : ''}
                        ${w.notes ? `<div class="workout-notes">üìù ${w.notes}</div>` : ''}
                        ${hasFeedback ? 
                            `<div style="margin-top: 8px; padding: 10px; background: rgba(0,255,136,0.1); border: 1px solid #00FF88; border-radius: 6px; font-size: 0.85rem;">
                                <strong style="color: #00FF88;">‚úì Feedback recorded:</strong> Effort ${hasFeedback.effort}/10, ${hasFeedback.completion === 'full' ? 'Completed' : hasFeedback.completion}
                                ${hasFeedback.notes ? `<br><span style="color: rgba(255,255,255,0.7);">"${hasFeedback.notes}"</span>` : ''}
                            </div>` : ''}
                        <button class="feedback-btn ${hasFeedback ? 'completed' : ''}" 
                                onclick="openFeedbackModal(${weekData.weekNumber}, '${w.day}', '${w.type.replace(/'/g, "\\'")}')">
                            ${hasFeedback ? '‚úì Edit Feedback' : '+ Add Feedback'}
                        </button>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            document.getElementById('workoutList').innerHTML = html;
        }

        function resetWeekToOriginal(weekNum) {
            const weekIndex = allWeeksData.findIndex(w => w.weekNumber === weekNum);
            if (weekIndex === -1) return;
            
            const weekData = allWeeksData[weekIndex];
            
            // Reset all workouts to original
            weekData.workouts.forEach(w => {
                if (w.originalDetails) {
                    w.details = w.originalDetails;
                    w.type = w.type.replace('‚ö†Ô∏è ADAPTED: ', '').replace(' ‚Üí Easy', '');
                    // Clean up notes
                    if (w.notes) {
                        w.notes = w.notes
                            .replace(/üîÑ AUTO-ADJUSTED:.*?\./g, '')
                            .replace(/‚úì Maintaining plan.*?\./g, '')
                            .replace(/üìà Last workout.*?\./g, '')
                            .trim();
                    }
                    w.adapted = false;
                    delete w.originalDetails;
                }
            });
            
            // Refresh display
            const currentWeek = parseInt(document.getElementById('weekDropdown')?.value || 0);
            displaySelectedWeek(currentWeek);
            
            // Show notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 217, 255, 0.95);
                color: white;
                padding: 16px 20px;
                border-radius: 12px;
                border: 2px solid var(--accent);
                z-index: 2000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = '‚úì Week ${weekNum} reset to original plan';
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function resetApp() {
            document.getElementById('workoutPlan').classList.remove('active');
            document.getElementById('dataInput').style.display = 'block';
        }
        
        console.log('=== SCRIPT LOADING COMPLETED ===');
        console.log('generatePlan function exists:', typeof generatePlan);
        console.log('All functions loaded successfully');
        
        // Mobile navigation functions
        let currentCalendarMonth = new Date();
        let userProfile = {};
        
        function showActivePlan() {
            document.getElementById('activePlanView').style.display = 'block';
            document.getElementById('savedPlansView').style.display = 'none';
            
            // Update button styling
            document.getElementById('activePlanTab').style.background = 'linear-gradient(135deg, var(--primary), #FF6B00)';
            document.getElementById('activePlanTab').style.border = 'none';
            document.getElementById('activePlanTab').style.color = 'var(--light)';
            
            document.getElementById('savedPlansListTab').style.background = 'rgba(0,217,255,0.2)';
            document.getElementById('savedPlansListTab').style.border = '2px solid var(--accent)';
            document.getElementById('savedPlansListTab').style.color = 'var(--accent)';
        }
        
        function showSavedPlansList() {
            document.getElementById('activePlanView').style.display = 'none';
            document.getElementById('savedPlansView').style.display = 'block';
            
            // Update button styling
            document.getElementById('savedPlansListTab').style.background = 'linear-gradient(135deg, var(--accent), #00FF88)';
            document.getElementById('savedPlansListTab').style.border = 'none';
            document.getElementById('savedPlansListTab').style.color = 'var(--dark)';
            
            document.getElementById('activePlanTab').style.background = 'rgba(255,77,0,0.2)';
            document.getElementById('activePlanTab').style.border = '2px solid var(--primary)';
            document.getElementById('activePlanTab').style.color = 'var(--primary)';
            
            // Refresh saved plans list
            updateSavedPlansList();
        }
        
        // Load user profile from localStorage
        window.addEventListener('load', () => {
            // Move dataInput into createPlanPage
            const createPlanPage = document.getElementById('createPlanPage');
            const dataInput = document.getElementById('dataInput');
            if (createPlanPage && dataInput) {
                createPlanPage.appendChild(dataInput);
            }
            
            const saved = localStorage.getItem('laktic_feedback');
            if (saved) {
                workoutFeedback = JSON.parse(saved);
            }
            
            const plans = localStorage.getItem('laktic_saved_plans');
            if (plans) {
                savedPlans = JSON.parse(plans);
            }
            
            // Load profile
            const profile = localStorage.getItem('laktic_user_profile');
            if (profile) {
                userProfile = JSON.parse(profile);
                loadProfileData();
            }
            
            // Show saved plans if any exist
            if (Object.keys(savedPlans).length > 0) {
                showLoadPlansOption();
            }
            
            // Check if there's an active plan and load it automatically
            const activePlanId = localStorage.getItem('laktic_active_plan_id');
            if (activePlanId && savedPlans[activePlanId]) {
                console.log('Loading active plan on startup:', activePlanId);
                loadPlan(activePlanId);
            }
            
            // Add event listener for no races checkbox
            const noRacesCheckbox = document.getElementById('noRacesCheckbox');
            if (noRacesCheckbox) {
                noRacesCheckbox.addEventListener('change', function() {
                    toggleRaceInputs(this.checked);
                });
            }
        });
        
        function saveProfile() {
            userProfile = {
                name: document.getElementById('profileName')?.value || '',
                age: document.getElementById('profileAge')?.value || '',
                gender: document.getElementById('profileGender')?.value || '',
                pr800m: document.getElementById('pr800m')?.value || '',
                pr1600m: document.getElementById('pr1600m')?.value || '',
                pr3200m: document.getElementById('pr3200m')?.value || '',
                pr5000m: document.getElementById('pr5000m')?.value || ''
            };
            localStorage.setItem('laktic_user_profile', JSON.stringify(userProfile));
        }
        
        function loadProfileData() {
            if (document.getElementById('profileName')) {
                document.getElementById('profileName').value = userProfile.name || '';
                document.getElementById('profileAge').value = userProfile.age || '';
                document.getElementById('profileGender').value = userProfile.gender || '';
                document.getElementById('pr800m').value = userProfile.pr800m || '';
                document.getElementById('pr1600m').value = userProfile.pr1600m || '';
                document.getElementById('pr3200m').value = userProfile.pr3200m || '';
                document.getElementById('pr5000m').value = userProfile.pr5000m || '';
            }
            updateProfileStats();
        }
        
        function updateProfileStats() {
            const statsDiv = document.getElementById('profileStats');
            if (!statsDiv) return;
            
            if (!currentPlanData) {
                statsDiv.innerHTML = '';
                return;
            }
            
            const eventLabel = currentPlanData.goalEvent === '800' ? '800m' : 
                              currentPlanData.goalEvent === '1500' ? '1500m/Mile' : '3200m/3K';
            
            let html = '<div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid rgba(255,77,0,0.3);">';
            html += '<h3 style="color: var(--accent); margin-bottom: 16px; font-size: 1.1rem;">Current Training Plan</h3>';
            
            html += `<div class="profile-stat-card">
                <span class="profile-stat-label">Goal Event</span>
                <span class="profile-stat-value">${eventLabel}</span>
            </div>`;
            
            html += `<div class="profile-stat-card">
                <span class="profile-stat-label">VDOT</span>
                <span class="profile-stat-value">${currentPlanData.vdot}</span>
            </div>`;
            
            html += `<div class="profile-stat-card">
                <span class="profile-stat-label">Weekly Mileage</span>
                <span class="profile-stat-value">${currentPlanData.currentMileage}-${currentPlanData.goalMileage} mpw</span>
            </div>`;
            
            html += `<div class="profile-stat-card">
                <span class="profile-stat-label">Plan Duration</span>
                <span class="profile-stat-value">${allWeeksData.length} weeks</span>
            </div>`;
            
            // Training Paces
            html += `<h3 style="color: var(--accent); margin: 24px 0 16px 0; font-size: 1.1rem;">Training Paces</h3>`;
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">';
            html += `<div style="background: rgba(255,77,0,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Easy</div>
                <div style="font-weight: bold; color: var(--primary);">${currentPlanData.paces.easy}</div>
            </div>`;
            html += `<div style="background: rgba(255,77,0,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Threshold</div>
                <div style="font-weight: bold; color: var(--primary);">${currentPlanData.paces.threshold}</div>
            </div>`;
            html += `<div style="background: rgba(255,77,0,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Interval</div>
                <div style="font-weight: bold; color: var(--primary);">${currentPlanData.paces.interval}</div>
            </div>`;
            html += `<div style="background: rgba(255,77,0,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Mile Pace</div>
                <div style="font-weight: bold; color: var(--primary);">${currentPlanData.paces.milePace}</div>
            </div>`;
            html += '</div></div>';
            
            statsDiv.innerHTML = html;
        }
        
        function switchPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.app-page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Load page-specific content
            if (pageId === 'createPlanPage') {
                // Always show the input form when going to Create page
                document.getElementById('dataInput').style.display = 'block';
            } else if (pageId === 'myPlanPage') {
                updateMyPlanPage();
            } else if (pageId === 'calendarPage') {
                updateCalendarPage();
            } else if (pageId === 'profilePage') {
                loadProfileData();
            }
        }
        
        function updateMyPlanPage() {
            if (!currentPlanData || !allWeeksData || allWeeksData.length === 0) {
                document.getElementById('myPlanContent').innerHTML = `
                    <div class="card">
                        <h2 style="text-align: center; color: rgba(255,255,255,0.5);">No Active Plan</h2>
                        <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">
                            Create or load a training plan to see it here!
                        </p>
                        <button onclick="switchPage('plansPage'); showNewPlanView();" class="btn" style="width: 100%; max-width: 300px; margin: 20px auto; display: block;">
                            <span style="position: relative; z-index: 1;">üìù Create Plan</span>
                        </button>
                    </div>
                `;
                return;
            }
            
            const eventLabel = currentPlanData.goalEvent === '800' ? '800m' : 
                              currentPlanData.goalEvent === '1500' ? '1500m/Mile' : '3200m/3K';
            
            let html = `
                <div class="card" style="margin-bottom: 20px;">
                    <h2 style="color: var(--accent); margin-bottom: 16px;">${eventLabel} Training Plan</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">VDOT</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary);">${currentPlanData.vdot}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Duration</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary);">${allWeeksData.length}w</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Mileage</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary);">${currentPlanData.goalMileage}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Week selector dropdown if multi-week plan
            if (allWeeksData.length > 1) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <label style="color: var(--accent); font-weight: bold; margin-bottom: 8px; display: block;">Select Week:</label>
                        <select id="myPlanWeekDropdown" onchange="updateMyPlanWeekDisplay()" 
                                style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
                                       border: 2px solid var(--primary); color: var(--light); border-radius: 8px; 
                                       font-size: 1rem; font-weight: bold;">
                `;
                allWeeksData.forEach((week, idx) => {
                    html += `<option value="${idx}">Week ${week.weekNumber}: ${week.label}</option>`;
                });
                html += `</select></div>`;
            }
            
            // Week details container
            html += '<div id="myPlanWeekDetails"></div>';
            
            document.getElementById('myPlanContent').innerHTML = html;
            
            // Display first week by default
            updateMyPlanWeekDisplay();
        }
        
        function updateMyPlanWeekDisplay() {
            const weekIndex = document.getElementById('myPlanWeekDropdown')?.value || 0;
            const weekData = allWeeksData[parseInt(weekIndex)];
            
            if (!weekData) return;
            
            // Calculate total weekly mileage
            let totalMileage = 0;
            weekData.workouts.forEach(w => {
                const mileMatch = w.details.match(/(\d+(?:\.\d+)?)\s*miles/);
                if (mileMatch) {
                    totalMileage += parseFloat(mileMatch[1]);
                }
            });
            
            const hasAdaptations = weekData.workouts.some(w => w.adapted);
            const phaseClass = weekData.season === 'Early' ? 'phase-early' : 
                              weekData.season === 'Mid' ? 'phase-mid' : 'phase-late';
            
            let html = `
                <div style="margin-bottom: 20px; border: 2px solid var(--accent); border-radius: 12px; padding: 16px; background: rgba(255,77,0,0.05);">
                    <span class="phase-badge ${phaseClass}">${weekData.season.toUpperCase()}</span>
                    <h3 style="color: var(--accent); margin: 8px 0; font-size: 1.2rem;">
                        ${weekData.label} ${weekData.raceWeek ? 'üèÅ' : ''}
                    </h3>
                    <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 12px;">
                        ${weekData.description}
                    </p>
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                        <span style="color: rgba(255,255,255,0.6);">Target: ${weekData.mileage} miles</span>
                        <span style="color: var(--accent);">Actual: ~${Math.round(totalMileage)} miles</span>
                    </div>
                    ${hasAdaptations ? `
                        <div style="background: rgba(255,230,0,0.15); border: 2px solid var(--secondary); border-radius: 8px; padding: 12px; margin-top: 12px;">
                            <strong style="color: var(--secondary);">‚ö° Adapted Training:</strong> 
                            Some workouts adjusted based on feedback.
                            <button class="regenerate-week-btn" onclick="resetWeekToOriginal(${weekData.weekNumber})" 
                                    style="margin-left: 8px; display: inline; padding: 6px 12px; font-size: 0.75rem;">
                                üîÑ Reset
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Display each workout
            weekData.workouts.forEach((w, idx) => {
                const feedbackKey = `week${weekData.weekNumber}-${w.day}`;
                const hasFeedback = workoutFeedback[feedbackKey];
                const indicator = getFeedbackIndicator(weekData.weekNumber, w.day);
                
                html += `
                    <div class="workout-item ${w.adapted ? 'adapted' : ''}" style="margin-bottom: 12px; animation-delay: ${idx * 0.05}s;">
                        <div class="workout-day">${indicator}${w.day}${w.adapted ? ' <span style="color: var(--secondary); font-size: 0.75rem;">‚ö° ADAPTED</span>' : ''}</div>
                        <div class="workout-type">${w.type}</div>
                        <div class="workout-details">${w.details}</div>
                        ${w.rest ? `<div class="workout-rest">Rest: ${w.rest}</div>` : ''}
                        ${w.notes ? `<div class="workout-notes">üìù ${w.notes}</div>` : ''}
                        ${hasFeedback ? 
                            `<div style="margin-top: 8px; padding: 10px; background: rgba(0,255,136,0.1); border: 1px solid #00FF88; border-radius: 6px; font-size: 0.85rem;">
                                <strong style="color: #00FF88;">‚úì Feedback recorded:</strong> Effort ${hasFeedback.effort}/10, ${hasFeedback.completion === 'full' ? 'Completed' : hasFeedback.completion}
                                ${hasFeedback.notes ? `<br><span style="color: rgba(255,255,255,0.7);">"${hasFeedback.notes}"</span>` : ''}
                            </div>` : ''}
                        <button class="feedback-btn ${hasFeedback ? 'completed' : ''}" 
                                onclick="openFeedbackModal(${weekData.weekNumber}, '${w.day}', '${w.type.replace(/'/g, "\\'")}')">
                            ${hasFeedback ? '‚úì Edit Feedback' : '+ Add Feedback'}
                        </button>
                    </div>
                `;
            });
            
            document.getElementById('myPlanWeekDetails').innerHTML = html;
        }
        
        function changeCalendarMonth(direction) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + direction);
            renderCalendar();
        }
        
        let calendarPlanData = null;
        let calendarStartDate = null;
        
        function loadPlanToCalendar() {
            const selector = document.getElementById('calendarPlanSelector');
            const selectedValue = selector.value;
            
            if (!selectedValue) {
                calendarPlanData = null;
                document.getElementById('calendarStartDateSection').style.display = 'none';
                document.getElementById('calendarLegend').style.display = 'none';
                document.getElementById('calendarContent').innerHTML = `
                    <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 40px 20px;">
                        Select a training plan above to view on the calendar!
                    </p>
                `;
                return;
            }
            
            if (selectedValue === 'active') {
                if (!allWeeksData || allWeeksData.length === 0) {
                    alert('No active plan! Create a plan first or select a saved plan.');
                    selector.value = '';
                    return;
                }
                calendarPlanData = { weeksData: allWeeksData };
            } else {
                const plan = savedPlans[selectedValue];
                if (!plan) {
                    alert('Plan not found!');
                    selector.value = '';
                    return;
                }
                if (!plan.weeksData || plan.weeksData.length === 0) {
                    alert('This saved plan has no workout data. Please create and save a new plan.');
                    selector.value = '';
                    return;
                }
                calendarPlanData = plan;
            }
            
            // Show the start date section and legend
            document.getElementById('calendarStartDateSection').style.display = 'block';
            document.getElementById('calendarLegend').style.display = 'block';
            
            // Set default start date if not already set
            const startDateInput = document.getElementById('calendarStartDate');
            if (!startDateInput.value) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                startDateInput.value = `${yyyy}-${mm}-${dd}`;
            }
            
            // Reset the current calendar month to the start date's month
            const dateParts = startDateInput.value.split('-');
            currentCalendarMonth = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, 1);
            
            // Force an immediate render
            renderCalendar();
            
            // Scroll the calendar content into view to ensure visibility
            const calendarContent = document.getElementById('calendarContent');
            if (calendarContent) {
                calendarContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        function populateCalendarPlanSelector() {
            const selector = document.getElementById('calendarPlanSelector');
            if (!selector) return;
            
            while (selector.options.length > 2) { selector.remove(2); }
            
            for (const [planId, plan] of Object.entries(savedPlans)) {
                const option = document.createElement('option');
                option.value = planId;
                option.textContent = 'üíæ ' + plan.name;
                selector.appendChild(option);
            }
        }
        
        function updateCalendarPage() {
            populateCalendarPlanSelector();
            if (calendarPlanData) {
                renderCalendar();
            }
        }
        
        function renderCalendar() {
            if (!calendarPlanData || !calendarPlanData.weeksData) {
                return;
            }
            
            // Parse start date - ensure we have a valid date
            const startDateInput = document.getElementById('calendarStartDate');
            let dateValue = startDateInput.value;
            
            // If no date value, set today's date
            if (!dateValue) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                dateValue = `${yyyy}-${mm}-${dd}`;
                startDateInput.value = dateValue;
            }
            
            const parts = dateValue.split('-');
            calendarStartDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            
            // Ensure currentCalendarMonth is set
            if (!currentCalendarMonth || isNaN(currentCalendarMonth.getTime())) {
                currentCalendarMonth = new Date(calendarStartDate.getFullYear(), calendarStartDate.getMonth(), 1);
            }
            
            // Day name to index mapping (0 = Sunday, 1 = Monday, etc.)
            const dayNameToIndex = {
                'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
                'Thursday': 4, 'Friday': 5, 'Saturday': 6
            };
            
            // Build workout map
            const workoutMap = {};
            const weeksData = calendarPlanData.weeksData;
            
            // Find the first Monday on or after the start date to begin the plan
            const startDayOfWeek = calendarStartDate.getDay(); // 0 = Sunday
            let planStartDate = new Date(calendarStartDate);
            
            // If start date is not Monday, find next Monday (or adjust to align week)
            // Actually, let's align based on the workout day names
            // Week starts on the start date, and we map each workout to its named day
            
            weeksData.forEach((week, weekIndex) => {
                if (!week.workouts) return;
                week.workouts.forEach((workout) => {
                    // Get the day index from the workout's day name
                    const workoutDayIndex = dayNameToIndex[workout.day];
                    if (workoutDayIndex === undefined) return;
                    
                    // Calculate the date for this workout
                    // Week 0 starts on start date, find the correct day of that week
                    const weekStartDate = new Date(calendarStartDate);
                    weekStartDate.setDate(calendarStartDate.getDate() + (weekIndex * 7));
                    
                    // Find the day of week for the week start
                    const weekStartDay = weekStartDate.getDay();
                    
                    // Calculate offset to get to the workout's day
                    let dayOffset = workoutDayIndex - weekStartDay;
                    if (dayOffset < 0) dayOffset += 7; // Wrap to next week if needed
                    
                    const workoutDate = new Date(weekStartDate);
                    workoutDate.setDate(weekStartDate.getDate() + dayOffset);
                    
                    const y = workoutDate.getFullYear();
                    const m = String(workoutDate.getMonth() + 1).padStart(2, '0');
                    const d = String(workoutDate.getDate()).padStart(2, '0');
                    const dateKey = `${y}-${m}-${d}`;
                    
                    workoutMap[dateKey] = {
                        type: workout.type,
                        details: workout.details,
                        rest: workout.rest,
                        notes: workout.notes,
                        weekNumber: week.weekNumber,
                        weekLabel: week.label
                    };
                });
            });
            
            // Render month name
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonthName').textContent = monthNames[currentCalendarMonth.getMonth()] + ' ' + currentCalendarMonth.getFullYear();
            
            // Build calendar
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            let html = '<div class="calendar-grid">';
            
            // Headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += '<div class="calendar-day-header">' + day + '</div>';
            });
            
            // Empty cells
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            // Day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const m = String(month + 1).padStart(2, '0');
                const d = String(day).padStart(2, '0');
                const dateKey = `${year}-${m}-${d}`;
                
                const workout = workoutMap[dateKey];
                
                let classes = 'calendar-day';
                let label = '';
                let inlineStyle = '';
                
                if (workout) {
                    const type = workout.type.toLowerCase();
                    
                    if (type.includes('race')) {
                        classes += ' race';
                        label = 'üèÅ Race';
                    } else if (type.includes('long')) {
                        inlineStyle = 'background: rgba(0,255,136,0.2); border-color: #00FF88;';
                        label = 'Long Run';
                    } else if (type.includes('speed dev') || type.includes('speed development')) {
                        inlineStyle = 'background: rgba(138,43,226,0.25); border-color: #8A2BE2;';
                        label = 'Speed Dev';
                    } else if (type.includes('specific') || type.includes('bank') || type.includes('primer')) {
                        classes += ' hard';
                        label = workout.type.length > 10 ? workout.type.substring(0, 10) : workout.type;
                    } else if (type.includes('easy') || type.includes('recovery')) {
                        classes += ' rest';
                        label = workout.type.length > 10 ? workout.type.substring(0, 10) : workout.type;
                    } else {
                        label = workout.type.length > 10 ? workout.type.substring(0, 10) : workout.type;
                    }
                }
                
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    classes += ' today';
                }
                
                html += `<div class="${classes}" style="${inlineStyle}" onclick="showDayDetails('${dateKey}')">`;
                html += `<div class="calendar-day-number">${day}</div>`;
                if (label) {
                    html += `<div class="calendar-workout-indicator">${label}</div>`;
                }
                html += '</div>';
            }
            
            html += '</div>';
            
            document.getElementById('calendarContent').innerHTML = html;
        }
        
        function showDayDetails(dateKey) {
            if (!calendarPlanData || !calendarPlanData.weeksData) return;
            
            // Day name to index mapping
            const dayNameToIndex = {
                'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
                'Thursday': 4, 'Friday': 5, 'Saturday': 6
            };
            
            // Rebuild workout map
            const workoutMap = {};
            const startDateInput = document.getElementById('calendarStartDate');
            const dateValue = startDateInput.value;
            const parts = dateValue.split('-');
            const startDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            
            calendarPlanData.weeksData.forEach((week, weekIndex) => {
                if (!week.workouts) return;
                week.workouts.forEach((workout) => {
                    const workoutDayIndex = dayNameToIndex[workout.day];
                    if (workoutDayIndex === undefined) return;
                    
                    const weekStartDate = new Date(startDate);
                    weekStartDate.setDate(startDate.getDate() + (weekIndex * 7));
                    
                    const weekStartDay = weekStartDate.getDay();
                    let dayOffset = workoutDayIndex - weekStartDay;
                    if (dayOffset < 0) dayOffset += 7;
                    
                    const workoutDate = new Date(weekStartDate);
                    workoutDate.setDate(weekStartDate.getDate() + dayOffset);
                    
                    const y = workoutDate.getFullYear();
                    const m = String(workoutDate.getMonth() + 1).padStart(2, '0');
                    const d = String(workoutDate.getDate()).padStart(2, '0');
                    workoutMap[`${y}-${m}-${d}`] = { ...workout, weekNumber: week.weekNumber, weekLabel: week.label };
                });
            });
            
            const workout = workoutMap[dateKey];
            if (!workout) {
                alert('No workout scheduled for this day');
                return;
            }
            
            const dateParts = dateKey.split('-');
            const dateObj = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
            const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div style="background: var(--dark); border: 3px solid var(--primary); border-radius: 16px; padding: 24px; max-width: 400px; width: 100%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="color: var(--accent); margin: 0;">${dateStr}</h3>
                        <button id="closeModalBtn" style="background: none; border: none; color: var(--light); font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 12px;">Week ${workout.weekNumber}: ${workout.weekLabel}</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary); margin-bottom: 12px;">${workout.type}</div>
                    <div style="color: var(--light); line-height: 1.6; margin-bottom: 12px;">${workout.details}</div>
                    ${workout.rest ? `<div style="color: var(--accent); margin-bottom: 8px;">Rest: ${workout.rest}</div>` : ''}
                    ${workout.notes ? `<div style="color: rgba(255,255,255,0.7); font-style: italic;">üìù ${workout.notes}</div>` : ''}
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add click handler for close button
            document.getElementById('closeModalBtn').addEventListener('click', function() {
                modal.remove();
            });
        }
        
    </script>
    
    <!-- Mobile Navigation Bar -->
    <div class="mobile-nav">
        <div class="nav-item active" onclick="switchPage('homePage')">
            <div class="nav-icon">üè†</div>
            <div>Home</div>
        </div>
        <div class="nav-item" onclick="switchPage('createPlanPage')">
            <div class="nav-icon">üìù</div>
            <div>Create</div>
        </div>
        <div class="nav-item" onclick="switchPage('myPlansPage')">
            <div class="nav-icon">üìã</div>
            <div>My Plans</div>
        </div>
        <div class="nav-item" onclick="switchPage('calendarPage')">
            <div class="nav-icon">üìÖ</div>
            <div>Calendar</div>
        </div>
        <div class="nav-item" onclick="switchPage('profilePage')">
            <div class="nav-icon">üë§</div>
            <div>Profile</div>
        </div>
    </div>
</body>
</html>

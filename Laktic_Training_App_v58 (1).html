<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1A1D2E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Laktic Training">
    <meta name="description" content="Evidence-based 800m-3200m training system">
    <title>Laktic Training System - 800m to 3200m</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366F1;
            --primary-light: #818CF8;
            --secondary: #F59E0B;
            --accent: #10B981;
            --bg-dark: #1A1D2E;
            --bg-card: #242839;
            --bg-elevated: #2D3148;
            --text-primary: #F8FAFC;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
            --border: rgba(255, 255, 255, 0.08);
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        h1 {
            font-weight: 700;
            font-size: 2rem;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-align: center;
            letter-spacing: -0.5px;
        }

        h2 {
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: 16px;
            letter-spacing: -0.3px;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 32px;
            font-weight: 500;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .card h2 {
            color: var(--text-primary);
            font-size: 1.1rem;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .input-group {
            margin: 16px 0;
        }

        label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        input::placeholder {
            color: var(--text-muted);
        }

        .btn {
            width: 100%;
            padding: 16px 24px;
            background: var(--primary);
            border: none;
            border-radius: 12px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .stat-box {
            background: var(--bg-elevated);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .workout-item {
            background: var(--bg-elevated);
            padding: 20px;
            margin-bottom: 12px;
            border-radius: 12px;
            border-left: 3px solid var(--primary);
        }

        .workout-day {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .workout-type {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .workout-details {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .workout-rest {
            color: var(--accent);
            font-size: 0.85rem;
            margin-top: 8px;
        }

        .workout-notes {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid var(--bg-elevated);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .workout-plan {
            display: none;
        }

        .workout-plan.active {
            display: block;
        }

        #weekSelector {
            display: none;
        }

        .phase-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .phase-early {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent);
        }

        .phase-mid {
            background: rgba(245, 158, 11, 0.15);
            color: var(--secondary);
        }

        .phase-late {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary);
        }

        .race-schedule-item {
            background: var(--bg-elevated);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .race-a { border-left: 3px solid var(--danger); }
        .race-b { border-left: 3px solid var(--secondary); }
        .race-c { border-left: 3px solid var(--accent); }

        /* Coach Chat Styles */
        .coach-quick-btn {
            padding: 8px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }
        .coach-quick-btn:hover, .coach-quick-btn:active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .chat-message {
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease-out;
        }
        .chat-message.user {
            text-align: right;
        }
        .chat-message.coach {
            text-align: left;
        }
        .chat-bubble {
            display: inline-block;
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.9rem;
            line-height: 1.5;
            text-align: left;
        }
        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-message.coach .chat-bubble {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }
        .chat-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Mobile App Navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 max(8px, env(safe-area-inset-bottom));
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 12px;
            transition: all 0.2s ease;
            color: var(--text-muted);
            font-size: 0.65rem;
            font-weight: 600;
            flex: 1;
            max-width: 80px;
        }

        .nav-item:active {
            transform: scale(0.95);
        }

        .nav-item.active {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .nav-icon {
            font-size: 1.3rem;
        }

        .app-page {
            display: none;
            padding-bottom: 90px;
            min-height: calc(100vh - 80px);
        }

        .app-page.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        /* Show onboarding by default until JS runs */
        #onboardingPage {
            display: block;
        }

        /* Today's Workout Styles */
        .todays-workout-card {
            background: linear-gradient(135deg, var(--bg-elevated), var(--bg-card));
            border: 1px solid var(--primary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .workout-day-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .workout-main-type {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        /* Calendar Styles */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 12px;
        }

        .calendar-nav-btn {
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }

        .calendar-nav-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--primary);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 16px;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 0.65rem;
            color: var(--text-muted);
            font-weight: 600;
            padding: 6px 2px;
            text-transform: uppercase;
        }

        .calendar-day {
            min-height: 50px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 4px;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow: hidden;
        }
        
        @media (min-width: 500px) {
            .calendar-day {
                min-height: 70px;
                padding: 6px;
                font-size: 0.7rem;
                border-radius: 10px;
            }
            .calendar-grid {
                gap: 6px;
            }
            .calendar-day-header {
                font-size: 0.7rem;
                padding: 8px 4px;
            }
        }

        .calendar-day:hover {
            border-color: var(--primary);
        }

        .calendar-day:active {
            transform: scale(0.95);
        }

        .calendar-day.empty {
            background: transparent;
            border: none;
            cursor: default;
        }

        .calendar-day.today {
            border: 2px solid var(--secondary);
            box-shadow: 0 0 12px rgba(245, 158, 11, 0.2);
        }

        .calendar-day-number {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .calendar-workout-indicator {
            font-size: 0.5rem;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
            margin-top: 2px;
        }
        
        @media (min-width: 500px) {
            .calendar-workout-indicator {
                font-size: 0.55rem;
            }
        }

        .calendar-day.hard {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--primary);
        }

        .calendar-day.race {
            background: rgba(245, 158, 11, 0.15);
            border: 2px solid var(--secondary);
        }

        .calendar-day.rest {
            background: rgba(16, 185, 129, 0.1);
        }

        /* Profile Stats */
        .profile-stat-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .profile-stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .profile-stat-value {
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
                padding-bottom: 100px;
            }

            h1 {
                font-size: 1.6rem;
            }

            .card {
                padding: 20px;
            }
        }

        .feedback-btn {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 12px;
            display: inline-block;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .feedback-btn:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .feedback-btn.completed {
            background: rgba(16, 185, 129, 0.15);
            border-color: var(--accent);
            color: var(--accent);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-close {
            background: var(--bg-elevated);
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .effort-scale {
            display: flex;
            gap: 6px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .effort-btn {
            flex: 1;
            min-width: 36px;
            padding: 12px 8px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
        }

        .effort-btn:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .effort-btn.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        textarea {
            width: 100%;
            min-height: 100px;
            padding: 14px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            resize: vertical;
            line-height: 1.6;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        textarea::placeholder {
            color: var(--text-muted);
        }

        .feedback-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .feedback-indicator.good { background: var(--accent); }
        .feedback-indicator.okay { background: var(--secondary); }
        .feedback-indicator.tough { background: var(--danger); }

        .workout-item.adapted {
            border-left-color: var(--secondary);
            background: rgba(245, 158, 11, 0.08);
        }

        .workout-item.adapted .workout-type {
            color: var(--secondary);
        }

        .regenerate-week-btn {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            transition: all 0.2s ease;
            margin-top: 16px;
            display: inline-block;
        }

        .regenerate-week-btn:hover {
            background: rgba(16, 185, 129, 0.2);
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { 
                transform: scale(0.95);
                opacity: 0;
            }
            to { 
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-elevated);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Onboarding Screen (shown on first launch) -->
        <div id="onboardingPage" class="app-page">
            <div style="min-height: 80vh; display: flex; flex-direction: column; justify-content: center; padding: 20px;">
                <div style="text-align: center; margin-bottom: 40px;">
                    <h1 style="font-size: 2.2rem; margin-bottom: 8px; color: var(--primary);">Laktic Training</h1>
                    <div class="subtitle">by TR_Performance</div>
                </div>
                
                <!-- Step 1: Role Selection -->
                <div class="card" id="onboardingStep1" style="text-align: center; padding: 32px 24px;">
                    <h2 style="color: var(--text-primary); margin-bottom: 24px; font-size: 1.3rem;">Welcome! I am a...</h2>
                    
                    <div style="display: flex; flex-direction: column; gap: 16px; max-width: 300px; margin: 0 auto;">
                        <button onclick="showAthleteOnboarding()" 
                                style="padding: 24px; background: linear-gradient(135deg, rgba(255,77,0,0.1), rgba(255,77,0,0.2)); 
                                       border: 2px solid var(--primary); border-radius: 16px; cursor: pointer; 
                                       transition: all 0.2s ease; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 12px;">üèÉ</div>
                            <div style="color: var(--text-primary); font-weight: 700; font-size: 1.2rem;">Athlete</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 6px;">I want to train and track my progress</div>
                        </button>
                        
                        <button onclick="showCoachOnboarding()" 
                                style="padding: 24px; background: linear-gradient(135deg, rgba(0,217,255,0.1), rgba(0,217,255,0.2)); 
                                       border: 2px solid var(--accent); border-radius: 16px; cursor: pointer; 
                                       transition: all 0.2s ease; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 12px;">üìã</div>
                            <div style="color: var(--text-primary); font-weight: 700; font-size: 1.2rem;">Coach</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 6px;">I want to create plans for my athletes</div>
                        </button>
                    </div>
                </div>
                
                <!-- Step 2a: Athlete Flow -->
                <div class="card" id="onboardingAthlete" style="display: none; padding: 32px 24px;">
                    <div style="text-align: center; margin-bottom: 24px;">
                        <div style="font-size: 2.5rem; margin-bottom: 12px;">üèÉ</div>
                        <h2 style="color: var(--primary); margin-bottom: 8px;">Athlete Setup</h2>
                    </div>
                    
                    <div class="input-group">
                        <label>Your Name</label>
                        <input type="text" id="onboardingAthleteName" placeholder="Enter your name"
                               style="width: 100%; padding: 14px; background: var(--bg-elevated); border: 2px solid var(--border); 
                                      border-radius: 10px; color: var(--text-primary); font-size: 1rem; font-family: 'Inter', sans-serif;">
                    </div>
                    
                    <div style="background: var(--bg-elevated); padding: 20px; border-radius: 12px; margin: 20px 0;">
                        <div style="color: var(--accent); font-weight: 600; margin-bottom: 12px;">üë• Join a Team (Optional)</div>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;">
                            If your coach gave you a team code, enter it below to connect with them.
                        </p>
                        <input type="text" id="onboardingTeamCode" placeholder="Enter 6-digit team code"
                               maxlength="6"
                               style="width: 100%; padding: 14px; background: var(--bg-dark); border: 2px solid var(--border); 
                                      border-radius: 10px; color: var(--text-primary); font-size: 1.2rem; font-family: monospace;
                                      text-transform: uppercase; letter-spacing: 4px; text-align: center;">
                        <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 8px; text-align: center;">
                            Don't have a code? No problem - you can add it later in Profile.
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button onclick="showOnboardingStep1()" 
                                style="flex: 1; padding: 14px; background: var(--bg-elevated); border: 1px solid var(--border); 
                                       border-radius: 10px; color: var(--text-secondary); font-weight: 600; cursor: pointer;">
                            ‚Üê Back
                        </button>
                        <button onclick="completeAthleteOnboarding()" 
                                style="flex: 2; padding: 14px; background: linear-gradient(135deg, var(--primary), var(--accent)); 
                                       border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 1rem;">
                            Get Started ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Step 2b: Coach Flow -->
                <div class="card" id="onboardingCoach" style="display: none; padding: 32px 24px;">
                    <div style="text-align: center; margin-bottom: 24px;">
                        <div style="font-size: 2.5rem; margin-bottom: 12px;">üìã</div>
                        <h2 style="color: var(--accent); margin-bottom: 8px;">Coach Setup</h2>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">Create your team and add athletes</p>
                    </div>
                    
                    <div class="input-group">
                        <label>Team Name</label>
                        <input type="text" id="onboardingTeamName" placeholder="e.g., Lincoln HS Track"
                               style="width: 100%; padding: 14px; background: var(--bg-elevated); border: 2px solid var(--border); 
                                      border-radius: 10px; color: var(--text-primary); font-size: 1rem; font-family: 'Inter', sans-serif;">
                    </div>
                    
                    <div style="background: var(--bg-elevated); padding: 20px; border-radius: 12px; margin: 20px 0;">
                        <div style="color: var(--primary); font-weight: 600; margin-bottom: 12px;">üë• Add Athletes</div>
                        
                        <!-- Manual Entry -->
                        <div id="athleteEntryList">
                            <div class="athlete-entry" style="display: flex; gap: 8px; margin-bottom: 10px;">
                                <input type="text" placeholder="Athlete name" class="athlete-name-input"
                                       style="flex: 2; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border); 
                                              border-radius: 8px; color: var(--text-primary); font-size: 0.9rem; font-family: 'Inter', sans-serif;">
                                <input type="text" placeholder="Event (800m)" class="athlete-event-input"
                                       style="flex: 1; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border); 
                                              border-radius: 8px; color: var(--text-primary); font-size: 0.9rem; font-family: 'Inter', sans-serif;">
                            </div>
                        </div>
                        
                        <button onclick="addAthleteEntryRow()" 
                                style="width: 100%; padding: 10px; background: transparent; border: 1px dashed var(--border); 
                                       border-radius: 8px; color: var(--text-muted); cursor: pointer; font-size: 0.85rem; margin-top: 8px;">
                            + Add Another Athlete
                        </button>
                        
                        <!-- CSV Import -->
                        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 10px; text-align: center;">Or import from file</div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="document.getElementById('csvFileInput').click()" 
                                        style="flex: 1; padding: 12px; background: var(--bg-dark); border: 1px solid var(--success); 
                                               border-radius: 8px; color: var(--success); cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                    üìÑ Import CSV
                                </button>
                                <button onclick="document.getElementById('excelFileInput').click()" 
                                        style="flex: 1; padding: 12px; background: var(--bg-dark); border: 1px solid var(--accent); 
                                               border-radius: 8px; color: var(--accent); cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                    üìä Import Excel
                                </button>
                            </div>
                            <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
                            <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelImport(event)">
                            <p style="color: var(--text-muted); font-size: 0.7rem; margin-top: 8px; text-align: center;">
                                CSV/Excel should have columns: Name, Event (optional), PR (optional)
                            </p>
                        </div>
                    </div>
                    
                    <div id="importPreview" style="display: none; background: var(--bg-dark); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="color: var(--success); font-weight: 600; margin-bottom: 8px;">‚úì Athletes to Import</div>
                        <div id="importPreviewList" style="max-height: 150px; overflow-y: auto; font-size: 0.85rem; color: var(--text-secondary);"></div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button onclick="showOnboardingStep1()" 
                                style="flex: 1; padding: 14px; background: var(--bg-elevated); border: 1px solid var(--border); 
                                       border-radius: 10px; color: var(--text-secondary); font-weight: 600; cursor: pointer;">
                            ‚Üê Back
                        </button>
                        <button onclick="completeCoachOnboarding()" 
                                style="flex: 2; padding: 14px; background: linear-gradient(135deg, var(--accent), var(--success)); 
                                       border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 1rem;">
                            Create Team ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Home/Welcome Page -->
        <div id="homePage" class="app-page">
            <h1 style="font-size: 1.8rem; margin-bottom: 8px; text-align: center;">Laktic Training</h1>
            <div class="subtitle" style="text-align: center; margin-bottom: 32px;">by TR_Performance</div>
            
            <div class="card" style="text-align: center; padding: 32px 24px;">
                <div style="font-size: 2.5rem; margin-bottom: 20px;">üèÉ‚Äç‚ôÇÔ∏è</div>
                <h2 style="color: var(--primary); margin-bottom: 16px; font-size: 1.2rem;">Elite-Level Training, Precision Programming</h2>
                <p style="color: var(--text-secondary); line-height: 1.7; font-size: 0.95rem; margin-bottom: 24px;">
                    Evidence-based training plans designed for 800m-3200m athletes. 
                    Our system combines decades of coaching wisdom with cutting-edge exercise science.
                </p>
                <p style="color: var(--text-muted); line-height: 1.6; margin-bottom: 28px; font-size: 0.9rem;">
                    Whether you're chasing a PR or preparing for championships, 
                    Laktic Training adapts to your fitness level and goals.
                </p>
                <button onclick="getStartedAction()" class="btn" style="max-width: 280px; margin: 0 auto;">
                    Get Started ‚Üí
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px;">
                <div class="card" style="text-align: center; padding: 20px 16px;">
                    <div style="font-size: 1.5rem; margin-bottom: 12px;">üìä</div>
                    <h3 style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 8px; font-weight: 600;">VDOT-Based</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted);">Paces calibrated to your fitness</p>
                </div>
                <div class="card" style="text-align: center; padding: 20px 16px;">
                    <div style="font-size: 1.5rem; margin-bottom: 12px;">üéØ</div>
                    <h3 style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 8px; font-weight: 600;">Event-Specific</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted);">Tailored to your goal race</p>
                </div>
                <div class="card" style="text-align: center; padding: 20px 16px;">
                    <div style="font-size: 1.5rem; margin-bottom: 12px;">üìà</div>
                    <h3 style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 8px; font-weight: 600;">Periodized</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted);">Progressive training phases</p>
                </div>
                <div class="card" style="text-align: center; padding: 20px 16px;">
                    <div style="font-size: 1.5rem; margin-bottom: 12px;">üíæ</div>
                    <h3 style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 8px; font-weight: 600;">Portable</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted);">Save and share your plans</p>
                </div>
            </div>
        </div>

        <!-- My Plans Page (Active Plan + Saved Plans Management) -->
        <div id="myPlansPage" class="app-page">
            <!-- Toggle between Active Plan and Saved Plans -->
            <div style="display: flex; gap: 12px; justify-content: center; margin-bottom: 20px;">
                <button id="activePlanTab" onclick="showActivePlan()" 
                        style="padding: 10px 24px; background: linear-gradient(135deg, var(--primary), #FF6B00); 
                               border: none; border-radius: 8px; color: var(--text-primary); font-weight: bold; 
                               cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.85rem;">
                    üìñ Active Plan
                </button>
                <button id="savedPlansListTab" onclick="showSavedPlansList()" 
                        style="padding: 10px 24px; background: rgba(0,217,255,0.2); 
                               border: 2px solid var(--accent); border-radius: 8px; color: var(--accent); 
                               font-weight: bold; cursor: pointer; font-family: 'Inter', sans-serif; 
                               font-size: 0.85rem;">
                    üíæ Saved (<span id="savedPlansCount">0</span>)
                </button>
            </div>

            <!-- Active Plan View -->
            <div id="activePlanView">
                <div id="myPlansContent">
                    <!-- No plan message - shown when no plan exists -->
                    <div id="noPlanMessage" class="card">
                        <h2 style="text-align: center; color: var(--text-muted);">No Active Plan</h2>
                        <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                            Create a new training plan or set a saved plan as active to get started!
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 12px; max-width: 300px; margin: 0 auto;">
                            <button onclick="showNewPlanForm();" class="btn">
                                <span style="position: relative; z-index: 1;">üìù Create New Plan</span>
                            </button>
                            <button onclick="showSavedPlansList();" 
                                    style="padding: 14px; background: rgba(0,217,255,0.2); border: 2px solid var(--accent); 
                                           border-radius: 12px; color: var(--accent); font-weight: bold; cursor: pointer;
                                           font-family: 'Inter', sans-serif;">
                                üíæ Load from Saved Plans
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Workout Plan Details (hidden until generated) -->
                <div class="workout-plan" id="workoutPlan" style="display: none;">
                    <!-- Active Plan Banner -->
                    <div id="activePlanBanner" style="background: linear-gradient(135deg, rgba(0,217,255,0.2), rgba(0,255,136,0.2)); 
                                border: 2px solid var(--accent); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center;">
                        <div id="activePlanNameDisplay" style="font-size: 1.4rem; font-weight: bold; color: var(--secondary); margin-bottom: 8px; display: none;">
                            <!-- Plan name will be inserted here -->
                        </div>
                        <div id="activePlanStatus" style="font-size: 1.1rem; font-weight: bold; color: var(--accent); margin-bottom: 8px;">
                            ‚úì This is your Active Training Plan
                        </div>
                        <div id="activePlanSubtext" style="font-size: 0.85rem; color: var(--text-secondary);">
                            To change plans, select a different one from Saved Plans or create a new one.
                        </div>
                        <div id="unsavedPlanWarning" style="display: none; margin-top: 12px; padding: 10px; background: rgba(255,230,0,0.2); border: 1px solid var(--secondary); border-radius: 8px;">
                            <span style="color: var(--secondary); font-weight: bold;">‚ö†Ô∏è Unsaved Plan</span>
                            <span style="color: var(--text-secondary);"> - Save this plan to keep your training schedule!</span>
                        </div>
                    </div>
                    
                    <!-- Quick Links -->
                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;">
                        <button onclick="switchPage('todayPage')" 
                                style="padding: 12px 20px; background: linear-gradient(135deg, var(--primary), var(--accent)); 
                                       border: none; border-radius: 10px; color: white; font-weight: 600; 
                                       cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.9rem;
                                       display: flex; align-items: center; gap: 8px;">
                            üìä Go to Today's Workout
                        </button>
                        <button onclick="switchPage('calendarPage')" 
                                style="padding: 12px 20px; background: var(--bg-elevated); 
                                       border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); 
                                       font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.9rem;
                                       display: flex; align-items: center; gap: 8px;">
                            üìÖ View Calendar
                        </button>
                    </div>
                    
                    <div class="card">
                        <h2>Training Stats</h2>
                        <div class="stats-grid" id="statsGrid"></div>
                    </div>

                    <!-- Save Plan Button -->
                    <div id="savePlanSection" style="text-align: center; margin-bottom: 20px;">
                        <button onclick="savePlan()" 
                                style="padding: 14px 32px; background: linear-gradient(135deg, var(--primary-light), var(--success)); 
                                       border: none; border-radius: 12px; color: var(--bg-card); font-weight: bold; 
                                       font-size: 1.1rem; cursor: pointer; font-family: 'Inter', sans-serif;
                                       text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 4px 15px rgba(0,217,255,0.3);">
                            üíæ Save This Plan
                        </button>
                    </div>

                    <div class="card" id="raceScheduleDisplayCard" style="display: none;">
                        <h2>Your Race Schedule</h2>
                        <div id="raceScheduleDisplay"></div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h2 id="planTitle">This Week's Plan</h2>
                            <div id="weekSelector" style="display: none;">
                                <select id="weekDropdown" onchange="changeWeek()" style="padding: 10px 20px; font-size: 1rem; background: var(--bg-card); border: 2px solid var(--accent); color: var(--text-primary); border-radius: 8px; cursor: pointer; font-family: 'Inter', sans-serif;">
                                </select>
                            </div>
                        </div>
                        <div id="periodizationNote" style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;"></div>
                        <div id="workoutList"></div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap;">
                        <button class="btn" onclick="showNewPlanForm();" style="flex: 1; min-width: 200px;">
                            <span style="position: relative; z-index: 1;">üìù Create New Plan</span>
                        </button>
                        <button onclick="showSavedPlansList();" 
                                style="flex: 1; min-width: 200px; padding: 18px; background: rgba(0,217,255,0.2); 
                                       border: 2px solid var(--accent); border-radius: 12px; color: var(--accent); 
                                       font-weight: bold; cursor: pointer; font-family: 'Inter', sans-serif;
                                       text-transform: uppercase; letter-spacing: 2px;">
                            üíæ Load Different Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Saved Plans List View (hidden by default) -->
            <div id="savedPlansView" style="display: none;">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                        <h3 style="margin: 0; font-size: 1.3rem;">Saved Plans</h3>
                        <button onclick="uploadPlanFile()" 
                                style="padding: 8px 16px; background: linear-gradient(135deg, var(--accent), var(--success)); 
                                       border: none; border-radius: 8px; color: var(--bg-card); font-weight: bold; 
                                       cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.8rem;">
                            üì§ Import
                        </button>
                    </div>
                    <div id="savedPlansList">
                        <p style="color: var(--text-muted); text-align: center; padding: 30px 20px;">
                            No saved plans yet!
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Data Input - Plan Creation Form -->
            <div id="dataInput">
                <!-- Coach Roster Plan Creation (shown only for coaches with athletes) -->
                <div id="coachRosterPlanSection" style="display: none;">
                    <div class="card" style="margin-bottom: 20px; border: 2px solid var(--accent);">
                        <h2 style="color: var(--accent); margin-bottom: 8px;">üë• Create Plans for Your Roster</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.9rem;">
                            Set up training parameters for each athlete, then generate individual plans.
                        </p>
                        <div id="rosterAthleteCount" style="background: var(--bg-elevated); padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 16px;">
                            <span style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">0</span>
                            <span style="color: var(--text-muted);"> athletes on roster</span>
                        </div>
                    </div>
                    
                    <!-- Season Selection for Coach -->
                    <div class="card" id="coachSeasonCard" style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 12px;">Step 1: Select Season</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="selectCoachTemplate('xc_season')" id="coachTemplateBtn_xc" class="coach-season-btn"
                                    style="padding: 14px; background: var(--bg-elevated); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; text-align: center;">
                                <div style="font-size: 1.5rem;">üçÇ</div>
                                <div style="font-weight: 600; color: var(--text-primary);">Cross Country</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Aug - Dec</div>
                            </button>
                            <button onclick="selectCoachTemplate('indoor_track')" id="coachTemplateBtn_indoor" class="coach-season-btn"
                                    style="padding: 14px; background: var(--bg-elevated); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; text-align: center;">
                                <div style="font-size: 1.5rem;">üèüÔ∏è</div>
                                <div style="font-weight: 600; color: var(--text-primary);">Indoor Track</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Dec - Mar</div>
                            </button>
                            <button onclick="selectCoachTemplate('outdoor_track')" id="coachTemplateBtn_outdoor" class="coach-season-btn"
                                    style="padding: 14px; background: var(--bg-elevated); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; text-align: center;">
                                <div style="font-size: 1.5rem;">‚òÄÔ∏è</div>
                                <div style="font-weight: 600; color: var(--text-primary);">Outdoor Track</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Mar - Jun</div>
                            </button>
                            <button onclick="selectCoachTemplate('summer_base')" id="coachTemplateBtn_summer" class="coach-season-btn"
                                    style="padding: 14px; background: var(--bg-elevated); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; text-align: center;">
                                <div style="font-size: 1.5rem;">üåû</div>
                                <div style="font-weight: 600; color: var(--text-primary);">Aerobic Base</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Jun - Sep</div>
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
                            <div class="input-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">Start Date</label>
                                <input type="date" id="coachStartDate" onchange="updateCoachPlanDuration()"
                                       style="width: 100%; padding: 10px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                            </div>
                            <div class="input-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">End Date</label>
                                <input type="date" id="coachEndDate" onchange="updateCoachPlanDuration()"
                                       style="width: 100%; padding: 10px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                            </div>
                        </div>
                        <div id="coachPlanDuration" style="text-align: center; margin-top: 12px; color: var(--text-muted); font-size: 0.9rem;"></div>
                    </div>
                    
                    <!-- Athlete Parameters List -->
                    <div class="card" id="coachAthleteParamsCard" style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 16px;">Step 2: Set Up Each Athlete</h3>
                        <div id="coachAthleteParamsList">
                            <!-- Athletes will be listed here -->
                        </div>
                    </div>
                    
                    <!-- Generate Button -->
                    <button onclick="generateAllRosterPlans()" id="generateRosterPlansBtn" class="btn" style="width: 100%; padding: 18px; font-size: 1.1rem;" disabled>
                        <span style="position: relative; z-index: 1;">üöÄ Generate Plans for All Athletes</span>
                    </button>
                </div>
                
                <!-- Regular Athlete Plan Creation (hidden when coach mode active) -->
                <div id="athletePlanSection">
                <!-- Step 1: Select Season Template (Required) -->
                <div class="card" id="seasonTemplatesCard">
                    <h2>Step 1: Select Your Season</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.85rem;">
                        Choose your training season, then select your start and end dates.
                    </p>
                    
                    <div style="display: grid; gap: 12px;">
                        <button onclick="selectTemplate('xc_season')" id="templateBtn_xc_season"
                                style="padding: 16px; background: var(--bg-elevated); 
                                       border: 2px solid var(--border); border-radius: 12px; cursor: pointer; text-align: left;
                                       transition: all 0.2s ease;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--success); margin-bottom: 4px;">üçÇ Cross Country</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">5K focus ‚Ä¢ Aug - Dec</div>
                                </div>
                                <div id="templateCheck_xc_season" style="display: none; color: var(--success); font-size: 1.5rem;">‚úì</div>
                            </div>
                        </button>
                        
                        <button onclick="selectTemplate('indoor_track')" id="templateBtn_indoor_track"
                                style="padding: 16px; background: var(--bg-elevated); 
                                       border: 2px solid var(--border); border-radius: 12px; cursor: pointer; text-align: left;
                                       transition: all 0.2s ease;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--primary); margin-bottom: 4px;">üèüÔ∏è Indoor Track</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">800/1600/3200 ‚Ä¢ Dec - Mar</div>
                                </div>
                                <div id="templateCheck_indoor_track" style="display: none; color: var(--success); font-size: 1.5rem;">‚úì</div>
                            </div>
                        </button>
                        
                        <button onclick="selectTemplate('outdoor_track')" id="templateBtn_outdoor_track"
                                style="padding: 16px; background: var(--bg-elevated); 
                                       border: 2px solid var(--border); border-radius: 12px; cursor: pointer; text-align: left;
                                       transition: all 0.2s ease;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent); margin-bottom: 4px;">‚òÄÔ∏è Outdoor Track</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">800/1600/3200 ‚Ä¢ Mar - Jun</div>
                                </div>
                                <div id="templateCheck_outdoor_track" style="display: none; color: var(--success); font-size: 1.5rem;">‚úì</div>
                            </div>
                        </button>
                        
                        <button onclick="selectTemplate('summer_base')" id="templateBtn_summer_base"
                                style="padding: 16px; background: var(--bg-elevated); 
                                       border: 2px solid var(--border); border-radius: 12px; cursor: pointer; text-align: left;
                                       transition: all 0.2s ease;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--secondary); margin-bottom: 4px;">üåû Aerobic Base</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Aerobic focus ‚Ä¢ Jun - Sep</div>
                                </div>
                                <div id="templateCheck_summer_base" style="display: none; color: var(--success); font-size: 1.5rem;">‚úì</div>
                            </div>
                        </button>
                    </div>
                    
                    <!-- Selected template info with start AND end date -->
                    <div id="selectedTemplateInfo" style="display: none; margin-top: 16px; padding: 16px; background: rgba(255,77,0,0.1); border-radius: 10px; border: 1px solid var(--primary);">
                        <div style="font-weight: 600; color: var(--primary); margin-bottom: 12px;" id="selectedTemplateName">Cross Country</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="input-group" style="margin: 0;">
                                <label style="font-size: 0.75rem;">Start Date</label>
                                <input type="date" id="templateStartDate" onchange="calculatePlanDuration()"
                                       style="padding: 10px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); width: 100%;">
                            </div>
                            <div class="input-group" style="margin: 0;">
                                <label style="font-size: 0.75rem;">End Date</label>
                                <input type="date" id="templateEndDate" onchange="calculatePlanDuration()"
                                       style="padding: 10px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); width: 100%;">
                            </div>
                        </div>
                        <div id="selectedTemplateDuration" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 10px; text-align: center;">Select dates to see plan length</div>
                    </div>
                </div>
                
                <!-- Hidden field for plan duration (set by template) -->
                <input type="hidden" id="planDuration" value="quarterly">
                <input type="hidden" id="selectedTemplateId" value="">

                <!-- Step 2: Race Times (shown after template selected) -->
                <div class="card" id="raceTimesCard" style="opacity: 0.5; pointer-events: none;">
                    <h2>Step 2: Your Race Times</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.85rem;">
                        Enter at least ONE recent race time for accurate training paces.
                    </p>
                    <div class="input-group">
                        <label>800m Time (mm:ss)</label>
                        <input type="text" id="time800m" placeholder="2:05">
                    </div>
                    <div class="input-group">
                        <label>1600m / Mile Time (mm:ss)</label>
                        <input type="text" id="time1600m" placeholder="4:30">
                    </div>
                    <div class="input-group">
                        <label>3200m / 2 Mile Time (mm:ss)</label>
                        <input type="text" id="time3200m" placeholder="9:45">
                    </div>
                    <div class="input-group">
                        <label>5000m / 5K Time (mm:ss)</label>
                        <input type="text" id="time5000m" placeholder="16:00">
                    </div>
                </div>

                <!-- Step 3: Training Profile -->
                <div class="card" id="trainingProfileCard" style="opacity: 0.5; pointer-events: none;">
                    <h2>Step 3: Training Profile</h2>
                    <div class="input-group">
                        <label>Current Weekly Mileage</label>
                        <input type="number" id="currentMileage" placeholder="40" value="40">
                    </div>
                    <div class="input-group">
                        <label>Goal Weekly Mileage (Peak Weeks)</label>
                        <input type="number" id="goalMileage" placeholder="50" value="50">
                    </div>
                    <div class="input-group">
                        <label>Current Fitness Level</label>
                        <select id="fitnessLevel">
                            <option value="25">Recovering (25%)</option>
                            <option value="50">Building (50%)</option>
                            <option value="75" selected>Race Ready (75%)</option>
                            <option value="100">Peak Fitness (100%)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Primary Goal Event</label>
                        <select id="goalEvent">
                            <option value="800">800m</option>
                            <option value="1500">1500m / Mile</option>
                            <option value="3200" selected>3200m / 2 Mile / 3K</option>
                            <option value="5000">5K</option>
                        </select>
                    </div>
                </div>
                
                <!-- Step 4: Race Schedule -->
                <div class="card" id="raceScheduleCard" style="opacity: 0.5; pointer-events: none;">
                    <h2>Step 4: Race Schedule</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.85rem;">
                        Add upcoming races to auto-taper training, or check the box if just building fitness.
                    </p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; cursor: pointer; color: var(--accent); font-size: 0.9rem; padding: 12px; background: var(--bg-elevated); border-radius: 8px;">
                            <input type="checkbox" id="noRacesCheckbox" onchange="toggleRaceInputs()"
                                   style="width: auto; margin-right: 10px; cursor: pointer; transform: scale(1.3);">
                            <span>üìà No races planned - just building fitness</span>
                        </label>
                    </div>
                    
                    <div id="raceInputsContainer">
                        <div id="raceInputsList">
                            <!-- Race row 1 -->
                            <div class="race-input-row" id="raceRow1" style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: flex-end;">
                                <div style="flex: 1; min-width: 120px;">
                                    <label style="font-size: 0.8rem;">Race Date</label>
                                    <input type="date" id="raceDate1" style="width: 100%;">
                                </div>
                                <div style="flex: 1; min-width: 100px;">
                                    <label style="font-size: 0.8rem;">Distance</label>
                                    <select id="raceDistance1" style="width: 100%;">
                                        <option value="">Select...</option>
                                        <option value="800m">800m</option>
                                        <option value="1600m">1600m/Mile</option>
                                        <option value="3200m">3200m/2Mi</option>
                                        <option value="5000m">5K</option>
                                    </select>
                                </div>
                                <div style="flex: 0.6; min-width: 70px;">
                                    <label style="font-size: 0.8rem;">Priority</label>
                                    <select id="racePriority1" style="width: 100%;">
                                        <option value="C">C</option>
                                        <option value="B">B</option>
                                        <option value="A">A ‚≠ê</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="addRaceRow()" id="addRaceBtn"
                                style="width: 100%; padding: 12px; background: transparent; border: 2px dashed var(--border); 
                                       border-radius: 8px; color: var(--accent); cursor: pointer; font-size: 0.9rem;
                                       display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">+</span> Add Another Race
                        </button>
                    </div>
                    
                    <p style="color: var(--text-muted); margin-top: 12px; font-size: 0.75rem;">
                        <strong>A</strong> = Goal race (full taper) ‚Ä¢ <strong>B</strong> = Important (mini-taper) ‚Ä¢ <strong>C</strong> = Tune-up (train through)
                    </p>
                </div>

                <button class="btn" id="generatePlanBtn" onclick="generatePlanFromTemplate()" style="opacity: 0.5; pointer-events: none;">
                    <span style="position: relative; z-index: 1;">Generate Training Plan</span>
                </button>
                </div> <!-- End athletePlanSection -->
            </div>
        </div>

        <!-- Calendar Page -->
        <div id="calendarPage" class="app-page">
            <div class="card">
                <h2 style="margin-bottom: 16px;">Training Calendar</h2>
                
                <!-- Quick Navigation -->
                <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="switchPage('todayPage')" 
                            style="padding: 10px 16px; background: linear-gradient(135deg, var(--primary), var(--accent)); 
                                   border: none; border-radius: 8px; color: white; font-weight: 600; 
                                   cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.85rem;
                                   display: flex; align-items: center; gap: 6px;">
                        üìä Today's Workout
                    </button>
                    <button onclick="switchPage('myPlansPage')" 
                            style="padding: 10px 16px; background: var(--bg-elevated); 
                                   border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); 
                                   font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.85rem;
                                   display: flex; align-items: center; gap: 6px;">
                        üìã View Plans
                    </button>
                </div>
                
                <!-- View Toggle for Coaches -->
                <div id="calendarViewToggle" style="display: none; margin-bottom: 20px;">
                    <div style="display: flex; gap: 8px;">
                        <button onclick="setCalendarView('team')" id="calendarTeamViewBtn"
                                style="flex: 1; padding: 12px; background: linear-gradient(135deg, var(--primary), var(--accent)); 
                                       border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                            üë• Team View
                        </button>
                        <button onclick="setCalendarView('individual')" id="calendarIndividualViewBtn"
                                style="flex: 1; padding: 12px; background: var(--bg-elevated); 
                                       border: 2px solid var(--border); border-radius: 8px; color: var(--text-secondary); font-weight: 600; cursor: pointer;">
                            üë§ Individual
                        </button>
                    </div>
                </div>
                
                <!-- Individual Athlete Selector (for individual view) -->
                <div id="calendarAthleteSelector" style="display: none; margin-bottom: 20px;">
                    <label style="color: var(--accent); font-weight: bold; margin-bottom: 8px; display: block;">Select Athlete:</label>
                    <select id="calendarAthleteDropdown" onchange="loadAthleteToCalendar()" 
                            style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
                                   border: 2px solid var(--primary); color: var(--text-primary); border-radius: 8px; 
                                   font-size: 1rem; font-family: 'Inter', sans-serif;">
                        <option value="">-- Select an athlete --</option>
                    </select>
                </div>
                
                <!-- Plan Selector (for non-coaches) -->
                <div id="calendarPlanSelectorSection" style="margin-bottom: 20px;">
                    <label style="color: var(--accent); font-weight: bold; margin-bottom: 8px; display: block;">Select Training Plan:</label>
                    <select id="calendarPlanSelector" onchange="loadPlanToCalendar()" 
                            style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
                                   border: 2px solid var(--primary); color: var(--text-primary); border-radius: 8px; 
                                   font-size: 1rem; font-family: 'Inter', sans-serif;">
                        <option value="">-- Select a plan --</option>
                        <option value="active">üìñ Current Active Plan</option>
                    </select>
                </div>
                
                <!-- Start Date Selector -->
                <div id="calendarStartDateSection" style="margin-bottom: 20px; display: none;">
                    <label style="color: var(--accent); font-weight: bold; margin-bottom: 8px; display: block;">Plan Start Date:</label>
                    <input type="date" id="calendarStartDate" onchange="renderCalendar()"
                           style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
                                  border: 2px solid var(--primary); color: var(--text-primary); border-radius: 8px; 
                                  font-size: 1rem; font-family: 'Inter', sans-serif;">
                </div>
                
                <div class="calendar-header">
                    <button onclick="changeCalendarMonth(-1)" class="calendar-nav-btn">
                        ‚Üê Prev
                    </button>
                    <div id="calendarMonthName" style="font-size: 1.2rem; font-weight: bold; color: var(--accent);">
                        <!-- Month/Year will be inserted here -->
                    </div>
                    <button onclick="changeCalendarMonth(1)" class="calendar-nav-btn">
                        Next ‚Üí
                    </button>
                </div>
                <div id="calendarContent">
                    <p style="color: var(--text-muted); text-align: center; padding: 40px 20px;">
                        Select a training plan above to view on the calendar!
                    </p>
                </div>
                
                <!-- Legend -->
                <div id="calendarLegend" style="display: none; margin-top: 20px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <div style="font-weight: bold; margin-bottom: 12px; color: var(--accent);">Legend:</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.8rem;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 14px; height: 14px; background: rgba(0,217,255,0.2); border: 2px solid var(--accent); border-radius: 3px;"></div>
                            <span>üö∂ Easy</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 14px; height: 14px; background: rgba(0,200,150,0.25); border: 2px solid #00C896; border-radius: 3px;"></div>
                            <span>üèÉ Steady</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 14px; height: 14px; background: rgba(0,255,136,0.25); border: 2px solid var(--success); border-radius: 3px;"></div>
                            <span>üèÉ Long Run</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 14px; height: 14px; background: rgba(255,77,0,0.3); border: 2px solid var(--primary); border-radius: 3px;"></div>
                            <span>üî• Tempo</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 14px; height: 14px; background: rgba(255,77,0,0.35); border: 2px solid #FF4500; border-radius: 3px;"></div>
                            <span>üí® Intervals</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 14px; height: 14px; background: rgba(138,43,226,0.3); border: 2px solid #8A2BE2; border-radius: 3px;"></div>
                            <span>‚ö° Speed Dev</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 14px; height: 14px; background: rgba(255,165,0,0.3); border: 2px solid orange; border-radius: 3px;"></div>
                            <span>üé≤ Fartlek</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 14px; height: 14px; background: rgba(139,69,19,0.3); border: 2px solid #8B4513; border-radius: 3px;"></div>
                            <span>‚õ∞Ô∏è Hills</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 14px; height: 14px; background: rgba(255,230,0,0.3); border: 2px solid var(--secondary); border-radius: 3px;"></div>
                            <span>üèÅ Race</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 14px; height: 14px; background: rgba(100,100,100,0.2); border: 2px solid #666; border-radius: 3px;"></div>
                            <span>üò¥ Rest</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today Page - Workout Logging -->
        <div id="todayPage" class="app-page">
            <!-- Weather Advisory Card -->
            <div class="card" id="weatherCard" style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; font-size: 1rem; color: var(--accent);">üå§Ô∏è Weather Conditions</h3>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="refreshWeather()" style="padding: 6px 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); font-size: 0.75rem; cursor: pointer;">
                            üîÑ Refresh
                        </button>
                        <button onclick="openWeatherModal()" style="padding: 6px 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); font-size: 0.75rem; cursor: pointer;">
                            ‚úèÔ∏è Edit
                        </button>
                    </div>
                </div>
                <div id="weatherDisplay">
                    <div id="weatherNotSet" style="text-align: center; padding: 16px;">
                        <div style="font-size: 2rem; margin-bottom: 8px;">üå°Ô∏è</div>
                        <p style="color: var(--text-muted); margin-bottom: 12px;">Get real-time weather for training advice</p>
                        <button onclick="fetchWeatherAuto()" style="padding: 12px 24px; background: linear-gradient(135deg, var(--primary), var(--accent)); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; font-size: 1rem;">
                            üìç Get My Weather
                        </button>
                        <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 10px;">Uses your location to fetch current conditions</p>
                    </div>
                    <div id="weatherSet" style="display: none;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                            <div id="weatherIcon" style="font-size: 2.5rem;">‚òÄÔ∏è</div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary);"><span id="weatherTemp">--</span>¬∞F</div>
                                <div style="color: var(--text-muted); font-size: 0.85rem;" id="weatherCondition">--</div>
                            </div>
                            <div style="margin-left: auto; text-align: right;">
                                <div style="font-size: 0.8rem; color: var(--text-muted);" id="weatherLocation">--</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);" id="weatherFeelsLike">--</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">üí® <span id="weatherWind">0</span> mph ‚Ä¢ üíß <span id="weatherHumidity">50</span>%</div>
                            </div>
                        </div>
                        <div id="weatherAdvisory" style="display: none; padding: 12px; border-radius: 8px; margin-top: 8px;">
                            <!-- Weather advisory will appear here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h2 style="margin: 0;">Today's Workout</h2>
                    <span id="todayFeedbackStatus" style="display: none; background: var(--success); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">‚úì Logged</span>
                </div>
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <button onclick="switchPage('myPlansPage')" 
                            style="padding: 8px 14px; background: var(--bg-elevated); border: 1px solid var(--border); 
                                   border-radius: 8px; color: var(--text-secondary); font-size: 0.8rem; cursor: pointer;
                                   display: flex; align-items: center; gap: 6px; font-family: 'Inter', sans-serif;">
                        üìã View Full Plan
                    </button>
                    <button onclick="switchPage('calendarPage')" 
                            style="padding: 8px 14px; background: var(--bg-elevated); border: 1px solid var(--border); 
                                   border-radius: 8px; color: var(--text-secondary); font-size: 0.8rem; cursor: pointer;
                                   display: flex; align-items: center; gap: 6px; font-family: 'Inter', sans-serif;">
                        üìÖ Calendar
                    </button>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px;" id="todayDate"></p>
                
                <!-- Today's Scheduled Workout from Plan -->
                <div id="todayScheduledWorkout">
                    <!-- Will be populated with the scheduled workout -->
                </div>
                
                <!-- Log Workout Button - Always visible -->
                <div id="todayLogButtonContainer" style="margin-top: 20px;">
                    <button id="todayLogButton" class="btn" onclick="openTodayFeedbackModal()" style="width: 100%;">
                        + Log Today's Workout
                    </button>
                </div>
                
                <!-- Quick Log Section (when no plan active) -->
                <div id="quickLogSection" style="display: none; margin-top: 16px;">
                    <div style="text-align: center; padding: 16px; background: var(--bg-elevated); border-radius: 12px; border: 1px dashed var(--border);">
                        <p style="color: var(--text-muted); margin-bottom: 12px; font-size: 0.9rem;">No training plan active</p>
                        <button onclick="switchPage('myPlansPage')" style="padding: 10px 20px; background: var(--primary); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                            Create a Plan
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Existing Feedback Display -->
            <div class="card" id="todayExistingFeedback" style="display: none;">
                <h3 style="color: var(--success); margin-bottom: 12px; font-size: 1rem; font-weight: 600;">‚úì Workout Logged</h3>
                <div id="todayFeedbackSummary">
                    <!-- Will show summary of logged feedback -->
                </div>
                <button class="btn" onclick="openTodayFeedbackModal()" style="margin-top: 16px; background: var(--bg-elevated); border: 1px solid var(--success); color: var(--success);">
                    ‚úèÔ∏è Edit Feedback
                </button>
            </div>
            
            <!-- Additional Metrics (shown after logging) -->
            <!-- Additional Metrics Card -->
            <div class="card" id="additionalMetricsCard" style="display: none;">
                <h3 style="color: var(--text-primary); margin-bottom: 16px; font-size: 1rem; font-weight: 600;">üìä Additional Metrics <span style="color: var(--text-muted); font-size: 0.8rem; font-weight: normal;">(optional)</span></h3>
                
                <!-- Recovery & Readiness -->
                <div style="background: var(--bg-elevated); padding: 14px; border-radius: 10px; margin-bottom: 14px;">
                    <div style="color: var(--accent); font-weight: 600; margin-bottom: 10px; font-size: 0.85rem;">üò¥ Recovery & Readiness</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="input-group" style="margin-bottom: 8px;">
                            <label>Sleep (hrs)</label>
                            <input type="number" id="todayMetricsSleep" step="0.5" placeholder="7.5">
                        </div>
                        <div class="input-group" style="margin-bottom: 8px;">
                            <label>Sleep Quality</label>
                            <select id="todayMetricsSleepQuality">
                                <option value="">Select...</option>
                                <option value="1">1 - Poor</option>
                                <option value="3">3 - Below Avg</option>
                                <option value="5">5 - Average</option>
                                <option value="7">7 - Good</option>
                                <option value="9">9 - Excellent</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="input-group" style="margin-bottom: 8px;">
                            <label>Soreness</label>
                            <select id="todayMetricsSoreness">
                                <option value="">Select...</option>
                                <option value="none">üòä None</option>
                                <option value="light">üôÇ Light</option>
                                <option value="moderate">üòê Moderate</option>
                                <option value="heavy">üò´ Heavy</option>
                                <option value="pain">ü§ï Pain</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin-bottom: 8px;">
                            <label>Energy Level</label>
                            <select id="todayMetricsEnergy">
                                <option value="">Select...</option>
                                <option value="low">üò´ Low</option>
                                <option value="medium">üòê Medium</option>
                                <option value="high">üí™ High</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label>Resting HR</label>
                            <input type="number" id="todayMetricsRestingHR" placeholder="52">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label>Stress Level</label>
                            <select id="todayMetricsStress">
                                <option value="">Select...</option>
                                <option value="1">1 - Very Low</option>
                                <option value="2">2 - Low</option>
                                <option value="3">3 - Moderate</option>
                                <option value="4">4 - High</option>
                                <option value="5">5 - Very High</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Environment -->
                <div style="background: var(--bg-elevated); padding: 14px; border-radius: 10px; margin-bottom: 14px;">
                    <div style="color: var(--warning); font-weight: 600; margin-bottom: 10px; font-size: 0.85rem;">üå°Ô∏è Environment</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="input-group" style="margin-bottom: 8px;">
                            <label>Temperature (¬∞F)</label>
                            <input type="number" id="todayMetricsTemp" placeholder="65">
                        </div>
                        <div class="input-group" style="margin-bottom: 8px;">
                            <label>Weather</label>
                            <select id="todayMetricsWeather">
                                <option value="">Select...</option>
                                <option value="sunny">‚òÄÔ∏è Sunny</option>
                                <option value="cloudy">‚òÅÔ∏è Cloudy</option>
                                <option value="rainy">üåßÔ∏è Rainy</option>
                                <option value="windy">üí® Windy</option>
                                <option value="hot">ü•µ Hot/Humid</option>
                                <option value="cold">ü•∂ Cold</option>
                                <option value="indoor">üè† Indoor</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-group" style="margin-bottom: 0;">
                        <label>Running Surface</label>
                        <select id="todayMetricsSurface">
                            <option value="">Select...</option>
                            <option value="track">üèüÔ∏è Track</option>
                            <option value="road">üõ£Ô∏è Road</option>
                            <option value="trail">üå≤ Trail</option>
                            <option value="grass">üåø Grass</option>
                            <option value="treadmill">üèÉ Treadmill</option>
                            <option value="mixed">üîÄ Mixed</option>
                        </select>
                    </div>
                </div>
                
                <!-- Nutrition -->
                <div style="background: var(--bg-elevated); padding: 14px; border-radius: 10px; margin-bottom: 14px;">
                    <div style="color: var(--success); font-weight: 600; margin-bottom: 10px; font-size: 0.85rem;">üçé Nutrition & Hydration</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label>Hydration</label>
                            <select id="todayMetricsHydration">
                                <option value="">Select...</option>
                                <option value="poor">üò∞ Poor</option>
                                <option value="fair">üôÇ Fair</option>
                                <option value="good">üòä Good</option>
                                <option value="excellent">üíß Excellent</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label>Pre-Workout Fuel</label>
                            <select id="todayMetricsFueling">
                                <option value="">Select...</option>
                                <option value="fasted">Fasted</option>
                                <option value="light">Light snack</option>
                                <option value="moderate">Moderate meal</option>
                                <option value="full">Full meal</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button class="btn" onclick="saveTodayAdditionalMetrics()" style="width: 100%; background: var(--bg-elevated); border: 1px solid var(--primary); color: var(--primary);">
                    üíæ Save Additional Metrics
                </button>
            </div>
            
            <!-- Recent Logs -->
            <div class="card">
                <h3 style="color: var(--text-primary); margin-bottom: 16px; font-size: 1rem; font-weight: 600;">üìÖ Recent Logs</h3>
                <div id="recentLogs">
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">No logs yet. Start tracking today!</p>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" class="app-page">
            <!-- Role Selection Card -->
            <div class="card" id="roleSelectionCard">
                <h2 style="margin-bottom: 16px;">I am a...</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button onclick="setUserRole('athlete')" id="roleAthleteBtn"
                            style="padding: 20px; background: var(--bg-elevated); border: 2px solid var(--border); 
                                   border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
                        <div style="font-size: 2.5rem; margin-bottom: 8px;">üèÉ</div>
                        <div style="color: var(--text-primary); font-weight: 600; font-size: 1.1rem;">Athlete</div>
                        <div style="color: var(--text-muted); font-size: 0.75rem; margin-top: 4px;">I train myself</div>
                    </button>
                    <button onclick="setUserRole('coach')" id="roleCoachBtn"
                            style="padding: 20px; background: var(--bg-elevated); border: 2px solid var(--border); 
                                   border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
                        <div style="font-size: 2.5rem; margin-bottom: 8px;">üìã</div>
                        <div style="color: var(--text-primary); font-weight: 600; font-size: 1.1rem;">Coach</div>
                        <div style="color: var(--text-muted); font-size: 0.75rem; margin-top: 4px;">I train athletes</div>
                    </button>
                </div>
            </div>
            
            <!-- Team Section (for Athletes) -->
            <div class="card" id="athleteTeamCard" style="display: none;">
                <h3 style="color: var(--accent); margin-bottom: 16px; font-size: 1.1rem;">üë• My Team</h3>
                <div id="athleteTeamStatus">
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 16px;">Join your coach's team to receive training plans and share your progress.</p>
                    <div class="input-group">
                        <label>Team Code</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="joinTeamCode" placeholder="Enter 6-digit code" 
                                   style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                          color: var(--text-primary); padding: 12px; border-radius: 8px; text-transform: uppercase; letter-spacing: 2px;">
                            <button onclick="joinTeam()" class="btn" style="padding: 12px 20px;">Join</button>
                        </div>
                    </div>
                </div>
                <div id="athleteTeamInfo" style="display: none;">
                    <!-- Shows current team info when joined -->
                </div>
                
                <!-- Parent Share Section -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <h4 style="color: var(--text-primary); font-size: 0.95rem; margin-bottom: 12px;">üë®‚Äçüë©‚Äçüëß Share with Parents</h4>
                    <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 12px;">
                        Let parents view your training plan and logged workouts (read-only).
                    </p>
                    <button onclick="showParentShareModal()" 
                            style="width: 100%; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--accent); 
                                   border-radius: 8px; color: var(--accent); font-weight: 600; cursor: pointer; font-size: 0.9rem;">
                        üì§ Generate Share Code
                    </button>
                </div>
            </div>
            
            <!-- Team Section (for Coaches) -->
            <div class="card" id="coachTeamCard" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="color: var(--accent); margin: 0; font-size: 1.1rem;">üë• My Team</h3>
                    <button onclick="switchPage('teamPage')" 
                            style="padding: 8px 16px; background: linear-gradient(135deg, var(--primary), var(--accent)); 
                                   border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; font-size: 0.85rem;">
                        Open Dashboard ‚Üí
                    </button>
                </div>
                
                <!-- Team Name -->
                <div class="input-group" style="margin-bottom: 16px;">
                    <label>Team / Club Name</label>
                    <input type="text" id="coachTeamName" placeholder="e.g., Lincoln HS Track" 
                           onchange="updateCoachTeamName()"
                           style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                  color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%;">
                </div>
                
                <!-- Team Code Display -->
                <div id="coachTeamCodeDisplay" style="display: none; background: var(--bg-elevated); padding: 16px; border-radius: 10px; margin-bottom: 16px; text-align: center;">
                    <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 6px;">Team Code (share with athletes)</div>
                    <div id="coachTeamCodeValue" style="font-size: 1.8rem; font-weight: 700; color: var(--primary); letter-spacing: 4px; font-family: monospace;"></div>
                    <button onclick="copyTeamCode()" style="margin-top: 10px; padding: 8px 16px; background: transparent; border: 1px solid var(--primary); border-radius: 6px; color: var(--primary); cursor: pointer; font-size: 0.8rem;">
                        üìã Copy Code
                    </button>
                </div>
                
                <!-- Roster Preview -->
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: var(--text-primary); margin: 0; font-size: 0.95rem;">üìã Roster</h4>
                        <span id="coachAthleteCount" style="background: var(--primary); color: white; padding: 2px 10px; border-radius: 10px; font-size: 0.8rem;">0 athletes</span>
                    </div>
                    <div id="coachRosterPreview" style="max-height: 200px; overflow-y: auto;">
                        <p style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 20px;">No athletes yet. Share your team code!</p>
                    </div>
                    <button onclick="addDemoAthlete()" style="width: 100%; margin-top: 12px; padding: 10px; background: transparent; border: 1px dashed var(--border); border-radius: 8px; color: var(--text-muted); cursor: pointer; font-size: 0.85rem;">
                        + Add Athlete Manually
                    </button>
                </div>
            </div>

            <!-- Athlete Profile Card (only for athletes) -->
            <div class="card" id="athleteProfileCard">
                <h2 style="margin-bottom: 20px;">Your Profile</h2>
                <div id="profileContent">
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--accent); margin-bottom: 16px; font-size: 1.1rem;">Personal Information</h3>
                        <div class="input-group">
                            <label>Name</label>
                            <input type="text" id="profileName" placeholder="Your name" 
                                   onchange="saveProfile()" 
                                   style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                          color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                            <div class="input-group">
                                <label>Age</label>
                                <input type="number" id="profileAge" placeholder="Age" 
                                       onchange="saveProfile()"
                                       style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                              color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%;">
                            </div>
                            <div class="input-group">
                                <label>Gender</label>
                                <select id="profileGender" onchange="saveProfile()"
                                        style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                               color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%;">
                                    <option value="">Select</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--accent); margin-bottom: 16px; font-size: 1.1rem;">Body Metrics</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="input-group">
                                <label>Height (inches)</label>
                                <input type="number" id="profileHeight" placeholder="70" 
                                       onchange="saveProfile()"
                                       style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                              color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%;">
                            </div>
                            <div class="input-group">
                                <label>Weight (lbs)</label>
                                <input type="number" id="profileWeight" placeholder="150" step="0.1"
                                       onchange="saveProfile()"
                                       style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                              color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--accent); margin-bottom: 16px; font-size: 1.1rem;">Heart Rate Zones</h3>
                        <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 12px;">Used to calculate training zones and monitor recovery</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="input-group">
                                <label>Resting HR (bpm)</label>
                                <input type="number" id="profileRestingHR" placeholder="52" 
                                       onchange="saveProfile(); calculateHRZones();"
                                       style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                              color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%;">
                            </div>
                            <div class="input-group">
                                <label>Max HR (bpm)</label>
                                <input type="number" id="profileMaxHR" placeholder="195" 
                                       onchange="saveProfile(); calculateHRZones();"
                                       style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                              color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%;">
                            </div>
                        </div>
                        <div id="hrZonesDisplay" style="margin-top: 16px; display: none;">
                            <!-- HR zones will be calculated and displayed here -->
                        </div>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--accent); margin-bottom: 16px; font-size: 1.1rem;">Personal Records</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="input-group">
                                <label>800m PR</label>
                                <input type="text" id="pr800m" placeholder="2:05" 
                                       onchange="saveProfile()"
                                       style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                              color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%;">
                            </div>
                            <div class="input-group">
                                <label>1600m PR</label>
                                <input type="text" id="pr1600m" placeholder="4:30" 
                                       onchange="saveProfile()"
                                       style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                              color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%;">
                            </div>
                            <div class="input-group">
                                <label>3200m PR</label>
                                <input type="text" id="pr3200m" placeholder="9:45" 
                                       onchange="saveProfile()"
                                       style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                              color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%;">
                            </div>
                            <div class="input-group">
                                <label>5000m PR</label>
                                <input type="text" id="pr5000m" placeholder="16:15" 
                                       onchange="saveProfile()"
                                       style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,77,0,0.3); 
                                              color: var(--text-primary); padding: 12px; border-radius: 8px; width: 100%;">
                            </div>
                        </div>
                    </div>

                    <div id="profileStats">
                        <!-- Current plan stats will be shown here if plan exists -->
                    </div>
                </div>
            </div>
            
            <!-- Reset Options (visible to all) -->
            <div class="card">
                <h3 style="color: var(--danger); margin-bottom: 16px; font-size: 1rem;">‚ö†Ô∏è Reset Options</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button onclick="resetOnboarding()" 
                            style="padding: 12px; background: transparent; border: 1px solid var(--warning); 
                                   border-radius: 8px; color: var(--warning); cursor: pointer; font-size: 0.85rem; text-align: left;">
                        üîÑ Reset Onboarding <span style="color: var(--text-muted); font-size: 0.75rem;">- Go through setup again</span>
                    </button>
                    <button onclick="resetAllData()" 
                            style="padding: 12px; background: transparent; border: 1px solid var(--danger); 
                                   border-radius: 8px; color: var(--danger); cursor: pointer; font-size: 0.85rem; text-align: left;">
                        üóëÔ∏è Reset All Data <span style="color: var(--text-muted); font-size: 0.75rem;">- Clear everything and start fresh</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Team Dashboard Page (for Coaches) -->
        <div id="teamPage" class="app-page">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin: 0;">Team Dashboard</h2>
                    <button onclick="switchPage('profilePage')" 
                            style="padding: 8px 12px; background: var(--bg-elevated); border: 1px solid var(--border); 
                                   border-radius: 8px; color: var(--text-secondary); font-size: 0.8rem; cursor: pointer;">
                        ‚Üê Back
                    </button>
                </div>
                
                <div id="teamDashboardContent">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            
            <!-- Team Code Card -->
            <div class="card" id="teamCodeCard" style="display: none;">
                <div style="text-align: center;">
                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 8px;">Share this code with your athletes</div>
                    <div id="teamCodeDisplay" style="font-size: 2.5rem; font-weight: 700; color: var(--primary); letter-spacing: 8px; font-family: monospace;"></div>
                    <button onclick="copyTeamCode()" style="margin-top: 12px; padding: 10px 20px; background: var(--bg-elevated); 
                                   border: 1px solid var(--primary); border-radius: 8px; color: var(--primary); cursor: pointer; font-weight: 600;">
                        üìã Copy Code
                    </button>
                </div>
            </div>
            
            <!-- Athletes List -->
            <div class="card" id="athletesListCard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: var(--accent);">üë• Roster</h3>
                    <span id="athleteCount" style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">0</span>
                </div>
                <div id="athletesList">
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">No athletes yet. Add your roster below!</p>
                </div>
                <button onclick="openAddAthleteModal()" class="btn" style="width: 100%; margin-top: 16px;">
                    <span style="position: relative; z-index: 1;">+ Add Athlete</span>
                </button>
            </div>
            
            <!-- Build Plans Section -->
            <div class="card" id="buildPlansCard" style="display: none;">
                <h3 style="margin-bottom: 16px; color: var(--accent);">üìã Build Training Plans</h3>
                <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.9rem;">
                    Set up training parameters for each athlete, then generate individual plans.
                </p>
                <div id="athleteSetupList">
                    <!-- Athletes needing setup will appear here -->
                </div>
                <button onclick="generateAllAthletePlans()" id="generateAllPlansBtn" class="btn" style="width: 100%; margin-top: 16px; display: none;">
                    <span style="position: relative; z-index: 1;">üöÄ Generate All Plans</span>
                </button>
            </div>
            
            <!-- Team Activity Feed -->
            <div class="card" id="teamActivityCard" style="display: none;">
                <h3 style="margin-bottom: 16px; color: var(--accent);">üìä Recent Activity</h3>
                <div id="teamActivityFeed">
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">No activity yet.</p>
                </div>
            </div>
        </div>
        
        <!-- Add Athlete Modal -->
        <div id="addAthleteModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 3000; padding: 20px; overflow-y: auto;">
            <div style="max-width: 500px; margin: 40px auto; background: var(--bg-card); border-radius: 16px; padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: var(--accent);">Add Athlete</h2>
                    <button onclick="closeAddAthleteModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                
                <div class="input-group">
                    <label>Athlete Name *</label>
                    <input type="text" id="newAthleteName" placeholder="e.g., John Smith" 
                           style="width: 100%; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                </div>
                
                <div class="input-group">
                    <label>Grade / Year</label>
                    <select id="newAthleteGrade" style="width: 100%; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        <option value="">Select...</option>
                        <option value="FR">Freshman</option>
                        <option value="SO">Sophomore</option>
                        <option value="JR">Junior</option>
                        <option value="SR">Senior</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Events (select all that apply)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; padding: 10px; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="event800" value="800m" style="margin-right: 10px; transform: scale(1.2);">
                            <span>800m</span>
                        </label>
                        <label style="display: flex; align-items: center; padding: 10px; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="event1600" value="1600m" style="margin-right: 10px; transform: scale(1.2);">
                            <span>1600m / Mile</span>
                        </label>
                        <label style="display: flex; align-items: center; padding: 10px; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="event3200" value="3200m" style="margin-right: 10px; transform: scale(1.2);">
                            <span>3200m / 2 Mile</span>
                        </label>
                        <label style="display: flex; align-items: center; padding: 10px; background: var(--bg-elevated); border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="event5k" value="5000m" style="margin-right: 10px; transform: scale(1.2);">
                            <span>5K / XC</span>
                        </label>
                    </div>
                </div>
                
                <button onclick="saveNewAthlete()" class="btn" style="width: 100%; margin-top: 20px;">
                    <span style="position: relative; z-index: 1;">+ Add to Roster</span>
                </button>
            </div>
        </div>
        
        <!-- Athlete Setup Modal (for entering training parameters) -->
        <div id="athleteSetupModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 3000; padding: 20px; overflow-y: auto;">
            <div style="max-width: 500px; margin: 20px auto; background: var(--bg-card); border-radius: 16px; padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: var(--accent);" id="setupAthleteName">Setup Athlete</h2>
                    <button onclick="closeAthleteSetupModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                
                <input type="hidden" id="setupAthleteId">
                
                <!-- Race Times -->
                <div style="background: var(--bg-elevated); padding: 16px; border-radius: 10px; margin-bottom: 16px;">
                    <h4 style="color: var(--primary); margin-bottom: 12px; font-size: 0.9rem;">üèÉ Race Times (enter at least one)</h4>
                    <div class="input-group" style="margin-bottom: 8px;">
                        <label style="font-size: 0.8rem;">800m (mm:ss)</label>
                        <input type="text" id="setup800m" placeholder="2:05" style="width: 100%; padding: 10px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                    </div>
                    <div class="input-group" style="margin-bottom: 8px;">
                        <label style="font-size: 0.8rem;">1600m (mm:ss)</label>
                        <input type="text" id="setup1600m" placeholder="4:30" style="width: 100%; padding: 10px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                    </div>
                    <div class="input-group" style="margin-bottom: 8px;">
                        <label style="font-size: 0.8rem;">3200m (mm:ss)</label>
                        <input type="text" id="setup3200m" placeholder="9:45" style="width: 100%; padding: 10px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                    </div>
                    <div class="input-group" style="margin-bottom: 0;">
                        <label style="font-size: 0.8rem;">5K (mm:ss)</label>
                        <input type="text" id="setup5k" placeholder="16:30" style="width: 100%; padding: 10px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                    </div>
                </div>
                
                <!-- Training Parameters -->
                <div style="background: var(--bg-elevated); padding: 16px; border-radius: 10px; margin-bottom: 16px;">
                    <h4 style="color: var(--accent); margin-bottom: 12px; font-size: 0.9rem;">üìä Training Parameters</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="input-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.8rem;">Current Miles/Week</label>
                            <input type="number" id="setupCurrentMileage" placeholder="25" style="width: 100%; padding: 10px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.8rem;">Goal Miles/Week</label>
                            <input type="number" id="setupGoalMileage" placeholder="35" style="width: 100%; padding: 10px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                        </div>
                    </div>
                    <div class="input-group" style="margin-top: 12px; margin-bottom: 0;">
                        <label style="font-size: 0.8rem;">Primary Event</label>
                        <select id="setupGoalEvent" style="width: 100%; padding: 10px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                            <option value="800">800m</option>
                            <option value="1500" selected>1500m / Mile</option>
                            <option value="3200">3200m / 2 Mile</option>
                        </select>
                    </div>
                    <div class="input-group" style="margin-top: 12px; margin-bottom: 0;">
                        <label style="font-size: 0.8rem;">Fitness Level</label>
                        <select id="setupFitnessLevel" style="width: 100%; padding: 10px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                            <option value="25">Recovering (25%)</option>
                            <option value="50">Building (50%)</option>
                            <option value="75" selected>Race Ready (75%)</option>
                            <option value="100">Peak (100%)</option>
                        </select>
                    </div>
                </div>
                
                <button onclick="saveAthleteSetup()" class="btn" style="width: 100%;">
                    <span style="position: relative; z-index: 1;">üíæ Save Parameters</span>
                </button>
            </div>
        </div>
            </div>
        </div>

        <!-- Coach Page - Chat Interface -->
        <div id="coachPage" class="app-page">
            <div class="card" style="padding: 16px; margin-bottom: 10px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 2rem;">üèÉ‚Äç‚ôÇÔ∏è</div>
                    <div>
                        <h2 style="margin: 0; font-size: 1.2rem;">Laktic Coach</h2>
                        <p style="margin: 0; color: var(--text-muted); font-size: 0.8rem;">Your training assistant</p>
                    </div>
                </div>
            </div>
            
            <!-- Quick Action Buttons -->
            <div style="display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; padding: 0 4px;">
                <button onclick="coachQuickAction('today')" class="coach-quick-btn">üìä Today's workout</button>
                <button onclick="coachQuickAction('week')" class="coach-quick-btn">üìÖ This week</button>
                <button onclick="coachQuickAction('log')" class="coach-quick-btn">‚úèÔ∏è Log workout</button>
                <button onclick="coachQuickAction('tips')" class="coach-quick-btn">üí° Training tips</button>
            </div>
            
            <!-- Chat Messages Container -->
            <div id="chatContainer" class="card" style="flex: 1; min-height: 350px; max-height: 50vh; overflow-y: auto; padding: 16px; margin-bottom: 10px;">
                <div id="chatMessages">
                    <!-- Messages will be inserted here -->
                </div>
            </div>
            
            <!-- Chat Input -->
            <div class="card" style="padding: 12px;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="Ask me anything about your training..." 
                           onkeypress="if(event.key === 'Enter') sendChatMessage()"
                           style="flex: 1; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); 
                                  border-radius: 10px; color: var(--text-primary); font-size: 0.95rem; font-family: 'Inter', sans-serif;">
                    <button onclick="sendChatMessage()" 
                            style="padding: 12px 20px; background: linear-gradient(135deg, var(--primary), var(--accent)); 
                                   border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer;">
                        Send
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: var(--accent);">BUILDING YOUR PLAN...</p>
        </div>

    </div>

    <script>
        console.log('=== SCRIPT LOADING STARTED ===');
        
        let allWeeksData = [];
        let currentPlanData = null;
        let workoutFeedback = {}; // Store feedback by week-day key
        let currentFeedbackKey = null;
        let fitnessLevel = 75; // Default 75%
        let savedPlans = {}; // Store multiple saved plans
        
        console.log('Variables initialized');

        // Load saved plans and feedback from localStorage on page load
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('laktic_feedback');
            if (saved) {
                workoutFeedback = JSON.parse(saved);
            }
            
            const plans = localStorage.getItem('laktic_saved_plans');
            if (plans) {
                savedPlans = JSON.parse(plans);
            }
            
            // Show saved plans if any exist
            if (Object.keys(savedPlans).length > 0) {
                showLoadPlansOption();
            }
            
            // Add event listener for no races checkbox
            const noRacesCheckbox = document.getElementById('noRacesCheckbox');
            if (noRacesCheckbox) {
                noRacesCheckbox.addEventListener('change', function() {
                    toggleRaceInputs(this.checked);
                });
            }
            
            // Check if user has completed onboarding
            checkOnboarding();
        });
        
        function checkOnboarding() {
            const hasCompletedOnboarding = localStorage.getItem('laktic_onboarding_complete');
            const savedRole = localStorage.getItem('laktic_user_role');
            
            if (!hasCompletedOnboarding || !savedRole) {
                // Show onboarding screen (it's visible by default via CSS)
                document.querySelectorAll('.app-page').forEach(page => {
                    page.classList.remove('active');
                    page.style.display = 'none';
                });
                document.getElementById('onboardingPage').style.display = 'block';
                document.getElementById('onboardingPage').classList.add('active');
                
                // Hide nav bar during onboarding
                document.querySelector('.mobile-nav').style.display = 'none';
            } else {
                // User has completed onboarding, hide onboarding and show home page
                document.getElementById('onboardingPage').style.display = 'none';
                document.querySelectorAll('.app-page').forEach(page => {
                    page.classList.remove('active');
                });
                document.getElementById('homePage').classList.add('active');
                
                // Show nav bar
                document.querySelector('.mobile-nav').style.display = 'flex';
                
                // Load user role
                userRole = savedRole;
            }
        }
        
        // ==================== RESET FUNCTIONS ====================
        
        function resetOnboarding() {
            if (!confirm('This will take you back to the Athlete/Coach selection screen. Continue?')) {
                return;
            }
            
            localStorage.removeItem('laktic_onboarding_complete');
            localStorage.removeItem('laktic_user_role');
            location.reload();
        }
        
        function resetAllData() {
            if (!confirm('‚ö†Ô∏è This will delete ALL your data including plans, feedback, and settings. This cannot be undone!\n\nAre you sure?')) {
                return;
            }
            
            if (!confirm('Really delete everything?')) {
                return;
            }
            
            localStorage.clear();
            location.reload();
        }

        // ==================== ONBOARDING FUNCTIONS ====================
        
        let importedAthletes = [];
        
        function showOnboardingStep1() {
            document.getElementById('onboardingStep1').style.display = 'block';
            document.getElementById('onboardingAthlete').style.display = 'none';
            document.getElementById('onboardingCoach').style.display = 'none';
        }
        
        function showAthleteOnboarding() {
            document.getElementById('onboardingStep1').style.display = 'none';
            document.getElementById('onboardingAthlete').style.display = 'block';
            document.getElementById('onboardingCoach').style.display = 'none';
        }
        
        function showCoachOnboarding() {
            document.getElementById('onboardingStep1').style.display = 'none';
            document.getElementById('onboardingAthlete').style.display = 'none';
            document.getElementById('onboardingCoach').style.display = 'block';
        }
        
        function addAthleteEntryRow() {
            const list = document.getElementById('athleteEntryList');
            const row = document.createElement('div');
            row.className = 'athlete-entry';
            row.style.cssText = 'display: flex; gap: 8px; margin-bottom: 10px;';
            row.innerHTML = `
                <input type="text" placeholder="Athlete name" class="athlete-name-input"
                       style="flex: 2; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border); 
                              border-radius: 8px; color: var(--text-primary); font-size: 0.9rem; font-family: 'Inter', sans-serif;">
                <input type="text" placeholder="Event" class="athlete-event-input"
                       style="flex: 1; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border); 
                              border-radius: 8px; color: var(--text-primary); font-size: 0.9rem; font-family: 'Inter', sans-serif;">
                <button onclick="this.parentElement.remove()" 
                        style="padding: 0 12px; background: transparent; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem;">√ó</button>
            `;
            list.appendChild(row);
        }
        
        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                importedAthletes = [];
                
                // Skip header if present
                const startIdx = lines[0].toLowerCase().includes('name') ? 1 : 0;
                
                for (let i = startIdx; i < lines.length; i++) {
                    const parts = lines[i].split(',').map(p => p.trim().replace(/"/g, ''));
                    if (parts[0]) {
                        importedAthletes.push({
                            name: parts[0],
                            event: parts[1] || '',
                            pr: parts[2] || ''
                        });
                    }
                }
                
                showImportPreview();
            };
            reader.readAsText(file);
        }
        
        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // For Excel, we'll use a simple approach - suggest CSV conversion
            // In production, you'd use SheetJS library
            alert('For best results, save your Excel file as CSV first, then import the CSV.\n\nOr manually enter athletes above.');
        }
        
        function showImportPreview() {
            if (importedAthletes.length === 0) {
                document.getElementById('importPreview').style.display = 'none';
                return;
            }
            
            document.getElementById('importPreview').style.display = 'block';
            const list = document.getElementById('importPreviewList');
            list.innerHTML = importedAthletes.map(a => 
                `<div style="padding: 4px 0; border-bottom: 1px solid var(--border);">
                    ${a.name}${a.event ? ' ‚Ä¢ ' + a.event : ''}${a.pr ? ' ‚Ä¢ PR: ' + a.pr : ''}
                </div>`
            ).join('');
        }
        
        function completeAthleteOnboarding() {
            var name = document.getElementById('onboardingAthleteName').value.trim();
            var teamCode = document.getElementById('onboardingTeamCode').value.trim().toUpperCase();
            
            if (!name) {
                alert('Please enter your name.');
                return;
            }
            
            // Save role and profile
            userRole = 'athlete';
            localStorage.setItem('laktic_user_role', 'athlete');
            localStorage.setItem('laktic_onboarding_complete', 'true');
            
            // Save profile name
            userProfile.name = name;
            localStorage.setItem('laktic_profile', JSON.stringify(userProfile));
            
            // Join team if code provided
            if (teamCode && teamCode.length === 6) {
                athleteTeam = {
                    code: teamCode,
                    teamName: 'Team ' + teamCode,
                    coachName: 'Coach',
                    joinedAt: new Date().toISOString(),
                    athleteName: name,
                    athleteId: Date.now().toString()
                };
                localStorage.setItem('laktic_athlete_team', JSON.stringify(athleteTeam));
            }
            
            // Complete onboarding
            finishOnboarding('athlete');
        }
        
        function completeCoachOnboarding() {
            const teamName = document.getElementById('onboardingTeamName').value.trim();
            
            if (!teamName) {
                alert('Please enter a team name.');
                return;
            }
            
            // Save role
            userRole = 'coach';
            localStorage.setItem('laktic_user_role', 'coach');
            localStorage.setItem('laktic_onboarding_complete', 'true');
            
            // Create team
            const teamCode = generateTeamCode();
            
            // Collect manually entered athletes
            const manualAthletes = [];
            document.querySelectorAll('.athlete-entry').forEach(row => {
                const nameInput = row.querySelector('.athlete-name-input');
                const eventInput = row.querySelector('.athlete-event-input');
                if (nameInput && nameInput.value.trim()) {
                    manualAthletes.push({
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                        name: nameInput.value.trim(),
                        event: eventInput ? eventInput.value.trim() : '',
                        prs: {},
                        feedback: {},
                        joinedAt: new Date().toISOString(),
                        lastSync: new Date().toISOString()
                    });
                }
            });
            
            // Combine with imported athletes
            const allAthletes = [...manualAthletes];
            importedAthletes.forEach(a => {
                allAthletes.push({
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                    name: a.name,
                    event: a.event,
                    prs: a.pr ? { 'primary': a.pr } : {},
                    feedback: {},
                    joinedAt: new Date().toISOString(),
                    lastSync: new Date().toISOString()
                });
            });
            
            teamData = {
                id: Date.now().toString(),
                name: teamName,
                code: teamCode,
                createdAt: new Date().toISOString(),
                athletes: allAthletes,
                plans: []
            };
            
            localStorage.setItem('laktic_team_data', JSON.stringify(teamData));
            
            // Complete onboarding
            finishOnboarding('coach');
            
            // Show team code
            setTimeout(() => {
                showNotification(`Team created! Code: ${teamCode}`, 'var(--success)');
            }, 600);
        }
        
        function finishOnboarding(role) {
            // Hide ALL onboarding elements
            var onboardingPage = document.getElementById('onboardingPage');
            onboardingPage.style.display = 'none';
            onboardingPage.style.visibility = 'hidden';
            onboardingPage.classList.remove('active');
            onboardingPage.innerHTML = ''; // Clear it completely
            
            // Show mobile nav
            var mobileNav = document.querySelector('.mobile-nav');
            mobileNav.style.display = 'flex';
            
            // For coaches, clear any personal plan data
            if (role === 'coach') {
                currentPlanData = null;
                allWeeksData = [];
                localStorage.removeItem('laktic_active_plan_id');
            }
            
            // For coaches with athletes, go straight to create plan
            if (role === 'coach' && teamData && teamData.athletes && teamData.athletes.length > 0) {
                // Hide all pages first
                document.querySelectorAll('.app-page').forEach(function(p) {
                    p.classList.remove('active');
                    p.style.display = 'none';
                });
                
                // Show myPlansPage with dataInput visible
                var plansPage = document.getElementById('myPlansPage');
                plansPage.style.display = 'block';
                plansPage.classList.add('active');
                
                // Hide workout plan display (stale personal plans)
                var workoutPlan = document.getElementById('workoutPlan');
                if (workoutPlan) workoutPlan.style.display = 'none';
                
                // Hide no plan message
                var noPlanMessage = document.getElementById('noPlanMessage');
                if (noPlanMessage) noPlanMessage.style.display = 'none';
                
                // Hide myPlanContent
                var myPlanContent = document.getElementById('myPlanContent');
                if (myPlanContent) myPlanContent.style.display = 'none';
                
                // Show dataInput (the plan creation form)
                var dataInput = document.getElementById('dataInput');
                if (dataInput) {
                    dataInput.style.display = 'block';
                }
                
                // Initialize coach plan creation
                initCoachPlanCreation();
                
                // Update nav highlighting - Plans tab (index 2)
                var navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(function(item) { item.classList.remove('active'); });
                if (navItems[2]) navItems[2].classList.add('active');
                
                setTimeout(function() {
                    showNotification('Team created! Now set up training plans for your athletes.', 'var(--success)');
                }, 500);
                return;
            }
            
            // Show Home page for athletes or coaches without roster
            var homePage = document.getElementById('homePage');
            homePage.style.display = 'block';
            homePage.classList.add('active');
            
            // Update nav highlighting - Home tab (index 0)
            var navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(function(item) { item.classList.remove('active'); });
            if (navItems[0]) navItems[0].classList.add('active');
            
            // Show appropriate welcome message
            if (role === 'coach') {
                if (teamData) {
                    setTimeout(function() {
                        showNotification('Team "' + teamData.name + '" created! Go to Plans to create training.', 'var(--accent)');
                    }, 500);
                }
            } else {
                var userName = userProfile.name || 'Athlete';
                setTimeout(function() {
                    showNotification('Welcome ' + userName + '! Tap Plans to build your training.', 'var(--primary)');
                }, 500);
            }
        }
        
        function getStartedAction() {
            // For coaches with athletes, go to plan creation
            if (userRole === 'coach' && teamData && teamData.athletes && teamData.athletes.length > 0) {
                switchPage('myPlansPage');
                setTimeout(function() {
                    var dataInput = document.getElementById('dataInput');
                    if (dataInput) dataInput.style.display = 'block';
                    initCoachPlanCreation();
                }, 100);
            } else {
                // For athletes, go to regular plan creation
                switchPage('myPlansPage');
                setTimeout(function() {
                    var dataInput = document.getElementById('dataInput');
                    if (dataInput) dataInput.style.display = 'block';
                }, 100);
            }
        }
        
        function showNewPlanForm() {
            // Show the plan creation form
            var dataInput = document.getElementById('dataInput');
            if (dataInput) {
                dataInput.style.display = 'block';
            }
            
            // Hide other views
            var noPlanMessage = document.getElementById('noPlanMessage');
            if (noPlanMessage) noPlanMessage.style.display = 'none';
            
            var myPlanContent = document.getElementById('myPlanContent');
            if (myPlanContent) myPlanContent.style.display = 'none';
            
            // Initialize based on user role
            if (userRole === 'coach' && teamData && teamData.athletes && teamData.athletes.length > 0) {
                // For coaches, HIDE the workout plan completely (no stale personal plans)
                var workoutPlan = document.getElementById('workoutPlan');
                if (workoutPlan) workoutPlan.style.display = 'none';
                
                // Show only roster form, hide athlete form completely
                document.getElementById('coachRosterPlanSection').style.display = 'block';
                document.getElementById('athletePlanSection').style.display = 'none';
                var generateBtn = document.getElementById('generatePlanBtn');
                if (generateBtn) generateBtn.style.display = 'none';
                populateCoachAthleteParams();
            } else {
                // For athletes, show normal form
                document.getElementById('coachRosterPlanSection').style.display = 'none';
                document.getElementById('athletePlanSection').style.display = 'block';
                var generateBtn = document.getElementById('generatePlanBtn');
                if (generateBtn) generateBtn.style.display = 'block';
            }
        }
        
        // Keep old function for backwards compatibility
        function completeOnboarding(role) {
            if (role === 'athlete') {
                showAthleteOnboarding();
            } else {
                showCoachOnboarding();
            }
        }

        function showLoadPlansOption() {
            // Update saved plans count
            const count = Object.keys(savedPlans).length;
            const countElement = document.getElementById('savedPlansCount');
            if (countElement) {
                countElement.textContent = count;
            }
            
            // Update the saved plans list
            updateSavedPlansList();
        }

        function showNewPlanView() {
            document.getElementById('dataInput').style.display = 'block';
            document.getElementById('savedPlansView').style.display = 'none';
            document.getElementById('workoutPlan').classList.remove('active');
            
            // Update tab styling
            document.getElementById('newPlanTab').style.background = 'linear-gradient(135deg, var(--primary), #FF6B00)';
            document.getElementById('newPlanTab').style.border = 'none';
            document.getElementById('newPlanTab').style.color = 'var(--text-primary)';
            
            document.getElementById('savedPlansTab').style.background = 'rgba(0,217,255,0.2)';
            document.getElementById('savedPlansTab').style.border = '2px solid var(--accent)';
            document.getElementById('savedPlansTab').style.color = 'var(--accent)';
        }

        function showSavedPlansView() {
            document.getElementById('dataInput').style.display = 'none';
            document.getElementById('savedPlansView').style.display = 'block';
            document.getElementById('workoutPlan').classList.remove('active');
            
            // Update tab styling
            document.getElementById('savedPlansTab').style.background = 'linear-gradient(135deg, var(--accent), var(--success))';
            document.getElementById('savedPlansTab').style.border = 'none';
            document.getElementById('savedPlansTab').style.color = 'var(--bg-card)';
            
            document.getElementById('newPlanTab').style.background = 'rgba(255,77,0,0.2)';
            document.getElementById('newPlanTab').style.border = '2px solid var(--primary)';
            document.getElementById('newPlanTab').style.color = 'var(--primary)';
            
            // Refresh the saved plans list
            updateSavedPlansList();
        }

        function updateSavedPlansList() {
            const listContainer = document.getElementById('savedPlansList');
            const activePlanId = localStorage.getItem('laktic_active_plan_id');
            
            if (Object.keys(savedPlans).length === 0) {
                listContainer.innerHTML = `
                    <p style="color: var(--text-muted); text-align: center; padding: 40px 20px;">
                        No saved plans yet. Create and save a training plan to access it here anytime!
                    </p>
                `;
                return;
            }
            
            let html = '';
            for (const [planId, plan] of Object.entries(savedPlans)) {
                const createdDate = new Date(plan.created).toLocaleDateString();
                const eventLabel = plan.planData.goalEvent === '800' ? '800m' : 
                                  plan.planData.goalEvent === '1500' ? '1500m/Mile' : '3200m/3K';
                const isActive = planId === activePlanId;
                
                html += `
                    <div style="background: ${isActive ? 'rgba(0,255,136,0.1)' : 'rgba(255,255,255,0.05)'}; 
                                padding: 20px; margin-bottom: 16px; 
                                border-radius: 12px; 
                                border-left: 4px solid ${isActive ? 'var(--success)' : 'var(--primary)'};">
                        ${isActive ? `<div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--success); font-weight: bold; margin-bottom: 8px;">‚úì CURRENTLY ACTIVE</div>` : ''}
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px;">
                            <div style="flex: 1;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 8px;">
                                    ${plan.name}
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px;">
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Event</div>
                                        <div style="color: var(--primary); font-weight: bold;">${eventLabel}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Duration</div>
                                        <div style="color: var(--primary); font-weight: bold;">${plan.weeksData.length} weeks</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">VDOT</div>
                                        <div style="color: var(--primary); font-weight: bold;">${plan.vdot}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Mileage</div>
                                        <div style="color: var(--primary); font-weight: bold;">${plan.planData.currentMileage}-${plan.planData.goalMileage} mpw</div>
                                    </div>
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Created: ${createdDate}
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                ${isActive ? `
                                    <button onclick="showActivePlan(); switchPage('myPlansPage');" 
                                            style="padding: 10px 24px; background: linear-gradient(135deg, var(--success), var(--primary-light)); 
                                                   border: none; border-radius: 8px; color: var(--bg-card); font-weight: bold; 
                                                   cursor: pointer; white-space: nowrap; font-family: 'Inter', sans-serif;">
                                        üìñ View Plan
                                    </button>
                                ` : `
                                    <button onclick="setAsActivePlan('${planId}')" 
                                            style="padding: 10px 24px; background: linear-gradient(135deg, var(--accent), var(--success)); 
                                                   border: none; border-radius: 8px; color: var(--bg-card); font-weight: bold; 
                                                   cursor: pointer; white-space: nowrap; font-family: 'Inter', sans-serif;">
                                        ‚úì Set as Active
                                    </button>
                                `}
                                <button onclick="deletePlanFromList('${planId}')" 
                                        style="padding: 10px 24px; background: rgba(255,77,0,0.2); 
                                               border: 2px solid var(--primary); border-radius: 8px; color: var(--primary); 
                                               font-weight: bold; cursor: pointer; font-family: 'Inter', sans-serif;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            listContainer.innerHTML = html;
        }

        function setAsActivePlan(planId) {
            const plan = savedPlans[planId];
            if (!plan) {
                alert('Plan not found!');
                return;
            }
            
            // Confirm setting as active
            if (confirm(`Set "${plan.name}" as your active training plan? This will replace any current active plan.`)) {
                // Load the plan data
                loadPlan(planId);
                
                // Save which plan is active to localStorage
                localStorage.setItem('laktic_active_plan_id', planId);
                
                // Update the active plan banner to show the plan name
                updateActivePlanBanner(plan.name, true);
                
                showNotification(`"${plan.name}" is now your active plan!`, 'var(--success)');
                
                // Switch to Active tab
                showActivePlan();
            }
        }
        
        function updateActivePlanBanner(planName, isSaved) {
            const nameDisplay = document.getElementById('activePlanNameDisplay');
            const statusDisplay = document.getElementById('activePlanStatus');
            const subtextDisplay = document.getElementById('activePlanSubtext');
            const unsavedWarning = document.getElementById('unsavedPlanWarning');
            
            if (planName && isSaved) {
                // Saved plan is active
                nameDisplay.textContent = 'üìã ' + planName;
                nameDisplay.style.display = 'block';
                statusDisplay.innerHTML = '‚úì Active Training Plan';
                subtextDisplay.textContent = 'To change plans, select a different one from Saved Plans or create a new one.';
                unsavedWarning.style.display = 'none';
            } else if (planName) {
                // Plan has a name but isn't saved yet
                nameDisplay.textContent = 'üìã ' + planName;
                nameDisplay.style.display = 'block';
                statusDisplay.innerHTML = '‚úì Active Training Plan';
                unsavedWarning.style.display = 'block';
            } else {
                // New unsaved plan
                nameDisplay.style.display = 'none';
                statusDisplay.innerHTML = '‚úì This is your Active Training Plan';
                subtextDisplay.textContent = 'To change plans, select a different one from Saved Plans or create a new one.';
                unsavedWarning.style.display = 'block';
            }
        }

        function loadPlanFromList(planId) {
            loadPlan(planId);
            // Switch to My Plans page and show active plan
            setTimeout(() => {
                switchPage('myPlansPage');
                showActivePlan();
            }, 300);
        }

        function deletePlanFromList(planId) {
            const plan = savedPlans[planId];
            if (!plan) return;
            
            if (confirm(`Delete plan "${plan.name}"? This cannot be undone.`)) {
                delete savedPlans[planId];
                localStorage.setItem('laktic_saved_plans', JSON.stringify(savedPlans));
                
                showNotification(`Plan "${plan.name}" deleted`, 'var(--danger)');
                updateSavedPlansList();
                showLoadPlansOption(); // Update count
            }
        }

        function savePlan() {
            console.log('savePlan called, currentPlanData:', currentPlanData);
            
            if (!currentPlanData) {
                alert('No plan to save! Please generate a plan first.');
                return;
            }
            
            // Create a modal for plan name input instead of using prompt()
            const modal = document.createElement('div');
            modal.id = 'savePlanModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.9); z-index: 3000;
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            const defaultName = `${currentPlanData.goalEvent}m Plan - ${new Date().toLocaleDateString()}`;
            
            modal.innerHTML = `
                <div style="background: var(--bg-card); border: 3px solid var(--accent); border-radius: 16px; padding: 30px; max-width: 400px; width: 100%;">
                    <h2 style="color: var(--accent); margin-bottom: 20px;">Save Training Plan</h2>
                    <div style="margin-bottom: 20px;">
                        <label style="color: var(--text-primary); display: block; margin-bottom: 8px;">Plan Name:</label>
                        <input type="text" id="savePlanNameInput" value="${defaultName}" 
                               style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 2px solid var(--primary); 
                                      color: var(--text-primary); border-radius: 8px; font-size: 1rem;">
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="confirmSavePlan()" 
                                style="flex: 1; padding: 14px; background: linear-gradient(135deg, var(--primary-light), var(--success)); 
                                       border: none; border-radius: 8px; color: var(--bg-card); font-weight: bold; 
                                       font-size: 1rem; cursor: pointer;">
                            üíæ Save Plan
                        </button>
                        <button onclick="document.getElementById('savePlanModal').remove()" 
                                style="padding: 14px 20px; background: rgba(255,255,255,0.1); 
                                       border: 2px solid var(--text-primary); border-radius: 8px; color: var(--text-primary); 
                                       font-weight: bold; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('savePlanNameInput').focus();
            document.getElementById('savePlanNameInput').select();
        }
        
        function confirmSavePlan() {
            const planName = document.getElementById('savePlanNameInput').value.trim();
            
            if (!planName) {
                alert('Please enter a plan name');
                return;
            }
            
            // Remove modal
            document.getElementById('savePlanModal').remove();
            
            // Create plan object with all data
            const planToSave = {
                name: planName,
                created: new Date().toISOString(),
                planData: currentPlanData,
                weeksData: allWeeksData,
                feedback: workoutFeedback,
                vdot: currentPlanData.vdot,
                paces: currentPlanData.paces
            };
            
            // Save to savedPlans object
            const planId = 'plan_' + Date.now();
            savedPlans[planId] = planToSave;
            
            // Save to localStorage
            localStorage.setItem('laktic_saved_plans', JSON.stringify(savedPlans));
            
            // Set this as the active plan
            localStorage.setItem('laktic_active_plan_id', planId);
            
            // Update the active plan banner to show the saved plan name
            updateActivePlanBanner(planName, true);
            
            // Update the saved plans count
            const countEl = document.getElementById('savedPlansCount');
            if (countEl) {
                countEl.textContent = Object.keys(savedPlans).length;
            }
            
            // Update the saved plans list
            updateSavedPlansList();
            
            // Update calendar plan selector
            populateCalendarPlanSelector();
            
            // ALSO download as JSON file to device
            downloadPlanAsFile(planToSave, planName);
            
            // Show confirmation
            showNotification('‚úì Plan saved! Redirecting to Plans...', 'var(--success)');
            
            // Navigate to Plans tab after a brief delay
            setTimeout(() => {
                switchPage('myPlansPage');
            }, 1000);
        }

        function downloadPlanAsFile(plan, planName) {
            // Convert plan to JSON
            const jsonData = JSON.stringify(plan, null, 2);
            
            // Create blob
            const blob = new Blob([jsonData], { type: 'application/json' });
            
            // Create download link
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${planName.replace(/[^a-z0-9]/gi, '_')}_laktic_plan.json`;
            
            // Trigger download
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function uploadPlanFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const plan = JSON.parse(event.target.result);
                        
                        // Validate plan structure
                        if (!plan.planData || !plan.weeksData || !plan.vdot) {
                            alert('Invalid plan file format!');
                            return;
                        }
                        
                        // Add to saved plans
                        const planId = 'plan_' + Date.now();
                        savedPlans[planId] = plan;
                        localStorage.setItem('laktic_saved_plans', JSON.stringify(savedPlans));
                        
                        showNotification('‚úì Plan "' + plan.name + '" imported successfully!', 'var(--success)');
                        showLoadPlansOption();
                        updateSavedPlansList();
                        
                    } catch (error) {
                        alert('Error reading plan file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function loadPlan(planId) {
            const plan = savedPlans[planId];
            if (!plan) {
                alert('Plan not found!');
                return;
            }
            
            // Restore plan data
            currentPlanData = plan.planData;
            allWeeksData = plan.weeksData;
            workoutFeedback = plan.feedback || {};
            
            // Store active plan ID
            localStorage.setItem('laktic_active_plan_id', planId);
            
            // Close modal
            document.querySelectorAll('div[style*="position: fixed"]').forEach(el => el.remove());
            
            // Hide input, show plan
            document.getElementById('dataInput').style.display = 'none';
            document.getElementById('noPlanMessage').style.display = 'none';
            document.getElementById('workoutPlan').style.display = 'block';
            document.getElementById('workoutPlan').classList.add('active');
            
            // Update the active plan banner to show the plan name
            updateActivePlanBanner(plan.name, true);
            
            // Display the plan
            displayStats(plan.vdot, plan.planData.currentMileage, plan.planData.goalMileage, plan.paces, plan.planData.intensityAdjustment, plan.planData.fitnessLevel);
            
            if (plan.planData.raceSchedule && plan.planData.raceSchedule.length > 0) {
                displayRaceSchedule(plan.planData.raceSchedule);
            }
            
            // Set up week selector if multi-week plan
            if (allWeeksData.length > 1) {
                setupWeekSelector(allWeeksData.length);
                displaySelectedWeek(0);
                document.getElementById('planTitle').textContent = `${allWeeksData.length}-Week Training Plan`;
                document.getElementById('periodizationNote').innerHTML = `
                    <strong>${allWeeksData.length}-Week Plan:</strong> Loaded from saved plan "${plan.name}".
                `;
            } else {
                displaySampleWeek(plan.paces, plan.planData.currentMileage, plan.planData.goalEvent);
            }
            
            showNotification(`‚úì Loaded plan: "${plan.name}"`, 'var(--success)');
        }

        function showNotification(message, color) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-weight: bold;
                z-index: 4000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(400px)';
                notification.style.transition = 'all 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function updateFitnessDisplay(value) {
            fitnessLevel = parseInt(value);
            const percentDisplay = document.getElementById('fitnessPercent');
            const labelDisplay = document.getElementById('fitnessLabel');
            
            percentDisplay.textContent = value + '%';
            
            let label, color, bgColor;
            if (value <= 25) {
                label = 'Recovering';
                color = 'var(--danger)';
                bgColor = 'rgba(255,77,0,0.2)';
            } else if (value <= 50) {
                label = 'Building';
                color = 'var(--warning)';
                bgColor = 'rgba(255,230,0,0.2)';
            } else if (value <= 75) {
                label = 'Race Ready';
                color = 'var(--success)';
                bgColor = 'rgba(0,255,136,0.2)';
            } else {
                label = 'Peak Fitness';
                color = 'var(--primary-light)';
                bgColor = 'rgba(0,217,255,0.2)';
            }
            
            percentDisplay.style.color = color;
            labelDisplay.textContent = label;
            labelDisplay.style.borderColor = color;
            labelDisplay.style.background = bgColor;
            labelDisplay.style.color = color;
        }

        function toggleRaceInputs(checked) {
            const raceInputs = document.getElementById('raceInputs');
            if (checked) {
                raceInputs.style.opacity = '0.3';
                raceInputs.style.pointerEvents = 'none';
                raceInputs.style.filter = 'grayscale(1)';
            } else {
                raceInputs.style.opacity = '1';
                raceInputs.style.pointerEvents = 'auto';
                raceInputs.style.filter = 'none';
            }
        }

        function openFeedbackModal(weekNum, dayName, workoutType) {
            currentFeedbackKey = `week${weekNum}-${dayName}`;
            currentFeedbackWorkoutType = workoutType; // Store for comparison
            
            // Create modal if it doesn't exist
            let modal = document.getElementById('feedbackModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'feedbackModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2 style="color: var(--primary); margin: 0;">Workout Feedback</h2>
                            <button class="modal-close" onclick="closeFeedbackModal()">&times;</button>
                        </div>
                        
                        <div id="feedbackWorkoutName" style="color: var(--accent); margin-bottom: 20px; font-size: 1.1rem;"></div>
                        
                        <div class="input-group">
                            <label>How did this workout feel? (1 = Easy, 10 = Maximal)</label>
                            <div class="effort-scale" id="effortScale"></div>
                        </div>

                        <div class="input-group">
                            <label>Completed As Planned?</label>
                            <select id="completionStatus" onchange="toggleActualWorkoutFields()">
                                <option value="full">‚úÖ Completed fully</option>
                                <option value="partial">‚ö†Ô∏è Partial (cut short)</option>
                                <option value="modified">üîÑ Modified workout</option>
                                <option value="skipped">‚ùå Skipped</option>
                            </select>
                        </div>
                        
                        <!-- Actual Workout Details (shown when modified/partial) -->
                        <div id="actualWorkoutSection" style="display: none; background: var(--bg-elevated); padding: 16px; border-radius: 10px; margin-bottom: 16px;">
                            <div style="color: var(--warning); font-weight: 600; margin-bottom: 12px; font-size: 0.9rem;">üìù What did you actually do?</div>
                            <div class="input-group">
                                <label>Actual Workout Type</label>
                                <select id="actualWorkoutType">
                                    <option value="">Same as planned</option>
                                    <option value="easy">Easy Run</option>
                                    <option value="long">Long Run</option>
                                    <option value="tempo">Tempo / Threshold</option>
                                    <option value="intervals">Intervals / Repeats</option>
                                    <option value="recovery">Recovery</option>
                                    <option value="cross">Cross Training</option>
                                    <option value="rest">Rest / Off</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Core Metrics -->
                        <div style="background: var(--bg-elevated); padding: 16px; border-radius: 10px; margin-bottom: 16px;">
                            <div style="color: var(--primary); font-weight: 600; margin-bottom: 12px; font-size: 0.9rem;">üìä Workout Data</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="input-group" style="margin-bottom: 0;">
                                    <label>Distance (miles)</label>
                                    <input type="number" id="feedbackDistance" step="0.1" placeholder="5.0" oninput="calculateFeedbackPace()">
                                </div>
                                <div class="input-group" style="margin-bottom: 0;">
                                    <label>Duration (min)</label>
                                    <input type="number" id="feedbackDuration" step="1" placeholder="40" oninput="calculateFeedbackPace()">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                                <div class="input-group" style="margin-bottom: 0;">
                                    <label>Avg Pace</label>
                                    <input type="text" id="feedbackPace" placeholder="--:--" readonly style="background: var(--bg-dark); color: var(--primary); font-weight: 600;">
                                </div>
                                <div class="input-group" style="margin-bottom: 0;">
                                    <label>Avg HR (bpm)</label>
                                    <input type="number" id="feedbackHR" placeholder="145">
                                </div>
                            </div>
                        </div>

                        <div class="input-group">
                            <label>Notes / Comments</label>
                            <textarea id="feedbackNotes" placeholder="How did you feel? Any issues? What went well?"></textarea>
                        </div>

                        <button class="btn" onclick="submitFeedback()" style="margin-top: 20px; width: 100%;">
                            <span style="position: relative; z-index: 1;">Save Feedback</span>
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('feedbackWorkoutName').textContent = `Week ${weekNum} - ${dayName}: ${workoutType}`;
            
            // Create effort scale buttons
            const effortScale = document.getElementById('effortScale');
            effortScale.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement('button');
                btn.className = 'effort-btn';
                btn.textContent = i;
                btn.onclick = () => selectEffort(i);
                effortScale.appendChild(btn);
            }
            
            // Load existing feedback if present
            const existingFeedback = workoutFeedback[currentFeedbackKey];
            if (existingFeedback) {
                selectEffort(existingFeedback.effort);
                document.getElementById('completionStatus').value = existingFeedback.completion || 'full';
                document.getElementById('feedbackNotes').value = existingFeedback.notes || '';
                document.getElementById('feedbackDistance').value = existingFeedback.distance || '';
                document.getElementById('feedbackDuration').value = existingFeedback.duration || '';
                document.getElementById('feedbackPace').value = existingFeedback.avgPace || '--:--';
                document.getElementById('feedbackHR').value = existingFeedback.avgHR || '';
                document.getElementById('actualWorkoutType').value = existingFeedback.actualWorkoutType || '';
                toggleActualWorkoutFields();
            } else {
                document.getElementById('completionStatus').value = 'full';
                document.getElementById('feedbackNotes').value = '';
                document.getElementById('feedbackDistance').value = '';
                document.getElementById('feedbackDuration').value = '';
                document.getElementById('feedbackPace').value = '--:--';
                document.getElementById('feedbackHR').value = '';
                document.getElementById('actualWorkoutType').value = '';
                document.getElementById('actualWorkoutSection').style.display = 'none';
            }
            
            modal.classList.add('active');
        }
        
        let currentFeedbackWorkoutType = '';
        
        function toggleActualWorkoutFields() {
            const status = document.getElementById('completionStatus').value;
            const section = document.getElementById('actualWorkoutSection');
            if (status === 'modified' || status === 'partial') {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        }
        
        function calculateFeedbackPace() {
            const distance = parseFloat(document.getElementById('feedbackDistance').value);
            const duration = parseFloat(document.getElementById('feedbackDuration').value);
            
            if (distance > 0 && duration > 0) {
                const paceMinutes = duration / distance;
                const mins = Math.floor(paceMinutes);
                const secs = Math.round((paceMinutes - mins) * 60);
                document.getElementById('feedbackPace').value = `${mins}:${secs.toString().padStart(2, '0')}`;
            } else {
                document.getElementById('feedbackPace').value = '--:--';
            }
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('active');
            currentFeedbackKey = null;
        }

        let currentMetricsKey = null;
        
        function openMetricsModal(weekNum, dayName, workoutType) {
            currentMetricsKey = `week${weekNum}-${dayName}`;
            
            // Create modal if it doesn't exist
            let modal = document.getElementById('metricsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'metricsModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2 style="color: var(--primary); margin: 0;">üìä Additional Metrics</h2>
                            <button class="modal-close" onclick="closeMetricsModal()">&times;</button>
                        </div>
                        
                        <div id="metricsWorkoutName" style="color: var(--accent); margin-bottom: 20px; font-size: 1rem;"></div>
                        
                        <!-- Recovery & Readiness -->
                        <div style="background: var(--bg-elevated); padding: 16px; border-radius: 10px; margin-bottom: 16px;">
                            <div style="color: var(--accent); font-weight: 600; margin-bottom: 12px; font-size: 0.9rem;">üò¥ Recovery & Readiness</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="input-group" style="margin-bottom: 8px;">
                                    <label>Sleep (hrs)</label>
                                    <input type="number" id="metricsSleep" step="0.5" placeholder="7.5">
                                </div>
                                <div class="input-group" style="margin-bottom: 8px;">
                                    <label>Sleep Quality</label>
                                    <select id="metricsSleepQuality">
                                        <option value="">Select...</option>
                                        <option value="1">1 - Poor</option>
                                        <option value="3">3 - Below Avg</option>
                                        <option value="5">5 - Average</option>
                                        <option value="7">7 - Good</option>
                                        <option value="9">9 - Excellent</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="input-group" style="margin-bottom: 8px;">
                                    <label>Soreness</label>
                                    <select id="metricsSoreness">
                                        <option value="">Select...</option>
                                        <option value="none">üòä None</option>
                                        <option value="light">üôÇ Light</option>
                                        <option value="moderate">üòê Moderate</option>
                                        <option value="heavy">üò´ Heavy</option>
                                        <option value="pain">ü§ï Pain</option>
                                    </select>
                                </div>
                                <div class="input-group" style="margin-bottom: 8px;">
                                    <label>Energy Level</label>
                                    <select id="metricsEnergy">
                                        <option value="">Select...</option>
                                        <option value="low">üò´ Low</option>
                                        <option value="medium">üòê Medium</option>
                                        <option value="high">üí™ High</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="input-group" style="margin-bottom: 0;">
                                    <label>Resting HR (morning)</label>
                                    <input type="number" id="metricsRestingHR" placeholder="52">
                                </div>
                                <div class="input-group" style="margin-bottom: 0;">
                                    <label>Stress Level</label>
                                    <select id="metricsStress">
                                        <option value="">Select...</option>
                                        <option value="1">1 - Very Low</option>
                                        <option value="2">2 - Low</option>
                                        <option value="3">3 - Moderate</option>
                                        <option value="4">4 - High</option>
                                        <option value="5">5 - Very High</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Environment -->
                        <div style="background: var(--bg-elevated); padding: 16px; border-radius: 10px; margin-bottom: 16px;">
                            <div style="color: var(--warning); font-weight: 600; margin-bottom: 12px; font-size: 0.9rem;">üå°Ô∏è Environment</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="input-group" style="margin-bottom: 8px;">
                                    <label>Temperature (¬∞F)</label>
                                    <input type="number" id="metricsTemp" placeholder="65">
                                </div>
                                <div class="input-group" style="margin-bottom: 8px;">
                                    <label>Weather</label>
                                    <select id="metricsWeather">
                                        <option value="">Select...</option>
                                        <option value="sunny">‚òÄÔ∏è Sunny</option>
                                        <option value="cloudy">‚òÅÔ∏è Cloudy</option>
                                        <option value="rainy">üåßÔ∏è Rainy</option>
                                        <option value="windy">üí® Windy</option>
                                        <option value="hot">ü•µ Hot/Humid</option>
                                        <option value="cold">ü•∂ Cold</option>
                                        <option value="indoor">üè† Indoor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-group" style="margin-bottom: 0;">
                                <label>Running Surface</label>
                                <select id="metricsSurface">
                                    <option value="">Select...</option>
                                    <option value="track">üèüÔ∏è Track</option>
                                    <option value="road">üõ£Ô∏è Road</option>
                                    <option value="trail">üå≤ Trail</option>
                                    <option value="grass">üåø Grass</option>
                                    <option value="treadmill">üèÉ Treadmill</option>
                                    <option value="mixed">üîÄ Mixed</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Nutrition -->
                        <div style="background: var(--bg-elevated); padding: 16px; border-radius: 10px; margin-bottom: 16px;">
                            <div style="color: var(--success); font-weight: 600; margin-bottom: 12px; font-size: 0.9rem;">üçé Nutrition & Hydration</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="input-group" style="margin-bottom: 0;">
                                    <label>Hydration</label>
                                    <select id="metricsHydration">
                                        <option value="">Select...</option>
                                        <option value="poor">üò∞ Poor</option>
                                        <option value="fair">üôÇ Fair</option>
                                        <option value="good">üòä Good</option>
                                        <option value="excellent">üíß Excellent</option>
                                    </select>
                                </div>
                                <div class="input-group" style="margin-bottom: 0;">
                                    <label>Pre-Workout Fuel</label>
                                    <select id="metricsFueling">
                                        <option value="">Select...</option>
                                        <option value="fasted">Fasted</option>
                                        <option value="light">Light snack</option>
                                        <option value="moderate">Moderate meal</option>
                                        <option value="full">Full meal</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <button class="btn" onclick="saveMetrics()" style="margin-top: 10px; width: 100%;">
                            <span style="position: relative; z-index: 1;">üíæ Save Additional Metrics</span>
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('metricsWorkoutName').textContent = `Week ${weekNum} - ${dayName}: ${workoutType}`;
            
            // Load existing metrics if present
            const existingFeedback = workoutFeedback[currentMetricsKey];
            if (existingFeedback) {
                document.getElementById('metricsSleep').value = existingFeedback.sleepHours || '';
                document.getElementById('metricsSleepQuality').value = existingFeedback.sleepQuality || '';
                document.getElementById('metricsSoreness').value = existingFeedback.soreness || '';
                document.getElementById('metricsEnergy').value = existingFeedback.energy || '';
                document.getElementById('metricsRestingHR').value = existingFeedback.restingHR || '';
                document.getElementById('metricsStress').value = existingFeedback.stress || '';
                document.getElementById('metricsTemp').value = existingFeedback.temp || '';
                document.getElementById('metricsWeather').value = existingFeedback.weather || '';
                document.getElementById('metricsSurface').value = existingFeedback.surface || '';
                document.getElementById('metricsHydration').value = existingFeedback.hydration || '';
                document.getElementById('metricsFueling').value = existingFeedback.fueling || '';
            } else {
                // Clear fields
                document.getElementById('metricsSleep').value = '';
                document.getElementById('metricsSleepQuality').value = '';
                document.getElementById('metricsSoreness').value = '';
                document.getElementById('metricsEnergy').value = '';
                document.getElementById('metricsRestingHR').value = '';
                document.getElementById('metricsStress').value = '';
                document.getElementById('metricsTemp').value = '';
                document.getElementById('metricsWeather').value = '';
                document.getElementById('metricsSurface').value = '';
                document.getElementById('metricsHydration').value = '';
                document.getElementById('metricsFueling').value = '';
            }
            
            modal.classList.add('active');
        }
        
        function closeMetricsModal() {
            document.getElementById('metricsModal').classList.remove('active');
            currentMetricsKey = null;
        }
        
        function saveMetrics() {
            if (!currentMetricsKey) {
                alert('Error: No workout selected');
                return;
            }
            
            // Get existing feedback or create new
            const existingFeedback = workoutFeedback[currentMetricsKey] || {};
            
            // Update with additional metrics
            workoutFeedback[currentMetricsKey] = {
                ...existingFeedback,
                sleepHours: parseFloat(document.getElementById('metricsSleep').value) || null,
                sleepQuality: parseInt(document.getElementById('metricsSleepQuality').value) || null,
                soreness: document.getElementById('metricsSoreness').value,
                energy: document.getElementById('metricsEnergy').value,
                restingHR: parseInt(document.getElementById('metricsRestingHR').value) || null,
                stress: parseInt(document.getElementById('metricsStress').value) || null,
                temp: parseInt(document.getElementById('metricsTemp').value) || null,
                weather: document.getElementById('metricsWeather').value,
                surface: document.getElementById('metricsSurface').value,
                hydration: document.getElementById('metricsHydration').value,
                fueling: document.getElementById('metricsFueling').value,
                metricsTimestamp: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem('laktic_feedback', JSON.stringify(workoutFeedback));
            
            // Close modal
            closeMetricsModal();
            
            // Show notification
            showNotification('‚úì Additional metrics saved!', 'var(--success)');
            
            // Refresh display
            setTimeout(() => {
                refreshWorkoutDisplay();
                
                // Also refresh Today page if active
                if (document.getElementById('todayPage')?.classList.contains('active')) {
                    checkExistingFeedback();
                }
            }, 200);
        }

        function selectEffort(level) {
            document.querySelectorAll('.effort-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (parseInt(btn.textContent) === level) {
                    btn.classList.add('selected');
                }
            });
        }

        function submitFeedback() {
            const selectedEffort = document.querySelector('.effort-btn.selected');
            if (!selectedEffort) {
                alert('Please select an effort level (1-10)');
                return;
            }
            
            const effort = parseInt(selectedEffort.textContent);
            const completion = document.getElementById('completionStatus').value;
            const notes = document.getElementById('feedbackNotes').value;
            const distance = parseFloat(document.getElementById('feedbackDistance').value) || null;
            const duration = parseInt(document.getElementById('feedbackDuration').value) || null;
            const avgPace = document.getElementById('feedbackPace').value;
            const avgHR = parseInt(document.getElementById('feedbackHR').value) || null;
            const actualWorkoutType = document.getElementById('actualWorkoutType').value;
            
            if (!currentFeedbackKey) {
                alert('Error: No workout selected');
                return;
            }
            
            // Store the key and workout type before closing modal
            const savedFeedbackKey = currentFeedbackKey;
            const plannedWorkoutType = currentFeedbackWorkoutType;
            
            // Build feedback data
            const feedbackData = {
                effort: effort,
                completion: completion,
                notes: notes,
                distance: distance,
                duration: duration,
                avgPace: avgPace,
                avgHR: avgHR,
                actualWorkoutType: actualWorkoutType,
                plannedWorkoutType: plannedWorkoutType,
                timestamp: new Date().toISOString()
            };
            
            workoutFeedback[savedFeedbackKey] = feedbackData;
            
            // Save to localStorage
            localStorage.setItem('laktic_feedback', JSON.stringify(workoutFeedback));
            console.log('Feedback saved:', savedFeedbackKey, feedbackData);
            
            // Also save feedback to the current active plan if one exists
            const activePlanId = localStorage.getItem('laktic_active_plan_id');
            if (activePlanId && savedPlans[activePlanId]) {
                savedPlans[activePlanId].feedback = workoutFeedback;
                localStorage.setItem('laktic_saved_plans', JSON.stringify(savedPlans));
            }
            
            // Parse the feedback key to get week and day
            const keyParts = savedFeedbackKey.split('-');
            let weekNum = 1;
            let dayName = '';
            
            if (keyParts.length >= 2) {
                weekNum = parseInt(keyParts[0].replace('week', ''));
                dayName = keyParts.slice(1).join('-');
            }
            
            // Close the modal first
            closeFeedbackModal();
            
            // Show notification that feedback was saved
            showNotification('‚úì Feedback saved!', 'var(--success)');
            
            // Analyze the workout and show acknowledgment
            try {
                if (!isNaN(weekNum) && dayName) {
                    // Enhanced analysis including planned vs actual comparison
                    const acknowledgment = analyzeWorkoutFeedbackEnhanced(feedbackData, plannedWorkoutType, dayName);
                    showFeedbackAcknowledgment(acknowledgment);
                    
                    // Check for patterns before adapting
                    const shouldAdapt = checkForPatterns(weekNum, dayName, effort, completion);
                    if (shouldAdapt.adapt) {
                        adaptRemainingWeek(weekNum, dayName, effort, completion, shouldAdapt.reason);
                    }
                }
            } catch (error) {
                console.error('Error processing feedback:', error);
            }
            
            // Analyze overall trends
            adaptTrainingBasedOnFeedback();
            
            // Refresh the workout display to show green "Edit Feedback" button
            setTimeout(() => {
                refreshWorkoutDisplay();
                
                // Also refresh the Today page if it's the current page
                if (document.getElementById('todayPage')?.classList.contains('active')) {
                    checkExistingFeedback();
                }
            }, 200);
        }
        
        // Enhanced workout feedback analysis that considers planned vs actual
        function analyzeWorkoutFeedbackEnhanced(feedback, plannedType, dayName) {
            const effort = feedback.effort;
            const completion = feedback.completion;
            const actualType = feedback.actualWorkoutType;
            const distance = feedback.distance;
            const avgPace = feedback.avgPace;
            const avgHR = feedback.avgHR;
            
            let message = '';
            let emoji = '';
            let color = '';
            let summary = [];
            
            // Determine if workout was modified
            const wasModified = completion === 'modified' || (actualType && actualType !== '');
            const wasPartial = completion === 'partial';
            const wasSkipped = completion === 'skipped';
            
            // Classify the planned workout
            const isHardWorkout = plannedType.includes('Speed') || 
                                 plannedType.includes('Bank') || 
                                 plannedType.includes('Workout') ||
                                 plannedType.includes('Tempo') ||
                                 plannedType.includes('Interval') ||
                                 plannedType.includes('Threshold');
            
            const isEasyDay = plannedType.includes('Easy') || 
                             plannedType.includes('Recovery') ||
                             dayName === 'Sunday';
            
            const isLongRun = plannedType.includes('Long');
            
            // Build summary of what was logged
            if (distance) summary.push(`${distance} mi`);
            if (avgPace && avgPace !== '--:--') summary.push(`${avgPace}/mi`);
            if (avgHR) summary.push(`${avgHR} bpm avg HR`);
            
            const summaryText = summary.length > 0 ? `<br><span style="font-size: 0.9rem; opacity: 0.8;">Logged: ${summary.join(' ‚Ä¢ ')}</span>` : '';
            
            // SKIPPED
            if (wasSkipped) {
                emoji = 'üìù';
                color = 'var(--text-muted)';
                message = `<strong>Workout skipped.</strong> That's okay - rest days happen. We'll track this and adjust if needed.${summaryText}`;
                
                // Check if this is becoming a pattern
                const skipPattern = checkSkipPattern();
                if (skipPattern) {
                    message += `<br><br><span style="color: var(--warning);">‚ö†Ô∏è Pattern detected: ${skipPattern}</span>`;
                }
            }
            // MODIFIED
            else if (wasModified) {
                const actualTypeLabel = getWorkoutTypeLabel(actualType);
                emoji = 'üîÑ';
                color = 'var(--warning)';
                message = `<strong>Workout modified.</strong> You did ${actualTypeLabel || 'a different workout'} instead of the planned ${plannedType}. Effort: ${effort}/10.${summaryText}`;
                
                // Analyze if modification was appropriate
                if (isHardWorkout && (actualType === 'easy' || actualType === 'recovery')) {
                    message += `<br><br><span style="color: var(--accent);">üí° Dialing back intensity can be smart if you're fatigued. We'll monitor recovery patterns.</span>`;
                } else if (isEasyDay && (actualType === 'tempo' || actualType === 'intervals')) {
                    message += `<br><br><span style="color: var(--warning);">‚ö†Ô∏è Upgrading easy days to hard workouts can lead to overtraining. Recovery matters!</span>`;
                }
            }
            // PARTIAL
            else if (wasPartial) {
                emoji = '‚ö†Ô∏è';
                color = 'var(--warning)';
                
                if (effort >= 8) {
                    message = `<strong>Cut short at high effort (${effort}/10).</strong> Stopping when you need to is smart training. Listen to your body.${summaryText}`;
                } else {
                    message = `<strong>Workout cut short.</strong> Effort: ${effort}/10. We'll track if this becomes a pattern.${summaryText}`;
                }
            }
            // COMPLETED - analyze based on workout type and effort
            else {
                // HARD WORKOUT
                if (isHardWorkout) {
                    if (effort >= 7 && effort <= 9) {
                        emoji = '‚úÖ';
                        color = 'var(--success)';
                        message = `<strong>Quality session completed!</strong> Effort ${effort}/10 is right in the target zone for hard workouts.${summaryText}`;
                    } else if (effort >= 9) {
                        emoji = 'üí™';
                        color = 'var(--warning)';
                        message = `<strong>Maximum effort workout!</strong> ${effort}/10 is very hard. Make sure tomorrow is truly easy to recover.${summaryText}`;
                    } else if (effort <= 5) {
                        emoji = 'üìà';
                        color = 'var(--primary)';
                        message = `<strong>Workout felt comfortable (${effort}/10).</strong> You might be ready for a pace upgrade on these sessions.${summaryText}`;
                    } else {
                        emoji = '‚úÖ';
                        color = 'var(--success)';
                        message = `<strong>Solid workout!</strong> Effort ${effort}/10. Session logged.${summaryText}`;
                    }
                }
                // LONG RUN
                else if (isLongRun) {
                    if (effort >= 6 && effort <= 8) {
                        emoji = '‚úÖ';
                        color = 'var(--success)';
                        message = `<strong>Great long run!</strong> Effort ${effort}/10 is perfect - challenging but sustainable.${summaryText}`;
                    } else if (effort >= 9) {
                        emoji = '‚ö†Ô∏è';
                        color = 'var(--warning)';
                        message = `<strong>Long run was very hard (${effort}/10).</strong> These should feel controlled. Consider slowing the pace next time.${summaryText}`;
                    } else {
                        emoji = '‚úÖ';
                        color = 'var(--success)';
                        message = `<strong>Long run in the books!</strong> Effort ${effort}/10. Building that endurance.${summaryText}`;
                    }
                }
                // EASY/RECOVERY DAY
                else if (isEasyDay) {
                    if (effort <= 5) {
                        emoji = '‚úÖ';
                        color = 'var(--success)';
                        message = `<strong>Perfect easy day!</strong> ${effort}/10 is exactly right - these runs build you up for hard days.${summaryText}`;
                    } else if (effort >= 7) {
                        emoji = '‚ö†Ô∏è';
                        color = 'var(--warning)';
                        message = `<strong>Easy day felt hard (${effort}/10).</strong> This could signal fatigue. Consider extra recovery.${summaryText}`;
                        
                        // Flag for pattern detection
                        message += `<br><br><span style="color: var(--accent);">üí° We'll monitor if easy days consistently feel hard.</span>`;
                    } else {
                        emoji = '‚úÖ';
                        color = 'var(--success)';
                        message = `<strong>Easy day done!</strong> Effort ${effort}/10 logged.${summaryText}`;
                    }
                }
                // OTHER
                else {
                    emoji = '‚úÖ';
                    color = 'var(--success)';
                    message = `<strong>Workout completed!</strong> Effort ${effort}/10.${summaryText}`;
                }
            }
            
            return { message, emoji, color };
        }
        
        function getWorkoutTypeLabel(type) {
            const labels = {
                'easy': 'an Easy Run',
                'long': 'a Long Run',
                'tempo': 'a Tempo/Threshold workout',
                'intervals': 'an Interval session',
                'recovery': 'a Recovery run',
                'cross': 'Cross Training',
                'rest': 'Rest'
            };
            return labels[type] || type;
        }
        
        function checkSkipPattern() {
            // Check recent feedback for skip pattern
            const recentFeedback = Object.values(workoutFeedback)
                .filter(f => f.timestamp)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 7);
            
            const skippedCount = recentFeedback.filter(f => f.completion === 'skipped').length;
            
            if (skippedCount >= 3) {
                return `${skippedCount} skipped workouts in recent sessions. May need to reassess training load.`;
            }
            return null;
        }
        
        function refreshWorkoutDisplay() {
            console.log('Refreshing workout display...');
            
            // Check if we have a week dropdown (multi-week plan)
            const weekDropdown = document.getElementById('weekDropdown');
            
            if (weekDropdown && weekDropdown.style.display !== 'none' && weekDropdown.value !== '') {
                const currentWeek = parseInt(weekDropdown.value);
                if (!isNaN(currentWeek)) {
                    console.log('Refreshing multi-week display, week:', currentWeek);
                    displaySelectedWeek(currentWeek);
                    return;
                }
            }
            
            // If it's a sample/single week plan, refresh using displaySampleWeek
            if (allWeeksData && allWeeksData.length === 1 && currentPlanData) {
                console.log('Refreshing single-week/sample display');
                displaySampleWeek(currentPlanData.paces, currentPlanData.currentMileage, currentPlanData.goalEvent);
                return;
            }
            
            // Fallback: if we have allWeeksData, just display the first week
            if (allWeeksData && allWeeksData.length > 0) {
                console.log('Fallback: displaying first week');
                displaySelectedWeek(0);
                return;
            }
            
            console.log('Could not refresh display - no plan data found');
        }

        function analyzeWorkoutFeedback(effort, completion, workoutType, dayName) {
            const isHardWorkout = workoutType.includes('Specific') || 
                                 workoutType.includes('Bank') || 
                                 workoutType.includes('Workout') ||
                                 workoutType.includes('Primer');
            
            const isEasyDay = workoutType.includes('Easy') || 
                             workoutType.includes('Recovery') ||
                             dayName === 'Sunday' || 
                             dayName === 'Wednesday';
            
            const isLongRun = workoutType.includes('Long Run');
            
            let message = '';
            let emoji = '';
            let color = '';
            
            // HARD WORKOUT DAY
            if (isHardWorkout) {
                if (effort >= 7 && effort <= 9 && completion === 'full') {
                    emoji = '‚úÖ';
                    color = 'var(--success)';
                    message = '<strong>Perfect execution!</strong> Hard workouts should feel challenging (7-9/10). You nailed it and completed the full session. This is exactly the stimulus needed for adaptation.';
                } else if (effort >= 9 && completion === 'full') {
                    emoji = 'üí™';
                    color = 'var(--warning)';
                    message = '<strong>Maximal effort!</strong> You pushed to a 9-10/10 and still completed it. Great mental toughness, but make sure you are recovering properly. We will monitor if this pattern continues.';
                } else if (effort >= 8 && (completion === 'partial' || completion === 'modified')) {
                    emoji = '‚ö†Ô∏è';
                    color = 'var(--danger)';
                    message = '<strong>Struggled today.</strong> The workout felt very hard (8+/10) and you could not complete it as planned. This is valuable feedback. If this becomes a pattern, we will adjust your training load.';
                } else if (effort <= 6 && completion === 'full') {
                    emoji = 'üìà';
                    color = 'var(--primary-light)';
                    message = '<strong>Strong day!</strong> Quality workout felt easier than expected (‚â§6/10). This suggests good fitness progression. If this continues, you may be ready for more challenging work.';
                } else if (completion === 'skipped') {
                    emoji = 'üîÑ';
                    color = 'var(--danger)';
                    message = '<strong>Workout skipped.</strong> Sometimes life happens. We will track if skipped sessions become a pattern and adjust accordingly. One missed workout will not derail your progress.';
                } else {
                    emoji = 'üìù';
                    color = 'var(--primary-light)';
                    message = '<strong>Feedback recorded.</strong> Effort level and completion noted. Keep logging your sessions so we can optimize your training.';
                }
            }
            // EASY/RECOVERY DAY
            else if (isEasyDay) {
                if (effort <= 5 && completion === 'full') {
                    emoji = '‚úÖ';
                    color = 'var(--success)';
                    message = '<strong>Perfect recovery!</strong> Easy days should feel easy (‚â§5/10). You are recovering properly while maintaining aerobic fitness. Keep it controlled.';
                } else if (effort >= 6 && effort <= 7) {
                    emoji = '‚ö†Ô∏è';
                    color = 'var(--warning)';
                    message = '<strong>Too hard for easy day.</strong> This run felt moderate-hard (6-7/10) when it should feel easy. Could be cumulative fatigue. We will monitor if you need more recovery.';
                } else if (effort >= 8) {
                    emoji = 'üö®';
                    color = 'var(--danger)';
                    message = '<strong>Recovery day felt very hard.</strong> Easy runs should never feel this hard. This suggests you are not recovering properly. If this pattern continues, we will reduce your training load.';
                } else {
                    emoji = 'üìù';
                    color = 'var(--primary-light)';
                    message = '<strong>Easy day completed.</strong> Effort level noted. Keep monitoring how recovery days feel.';
                }
            }
            // LONG RUN
            else if (isLongRun) {
                if (effort >= 6 && effort <= 8 && completion === 'full') {
                    emoji = '‚úÖ';
                    color = 'var(--success)';
                    message = '<strong>Solid long run!</strong> Long runs should feel moderately hard (6-8/10) by the end. You built endurance while managing effort appropriately.';
                } else if (effort >= 9 && completion === 'full') {
                    emoji = '‚ö†Ô∏è';
                    color = 'var(--warning)';
                    message = '<strong>Very hard long run.</strong> While you finished, a 9-10/10 effort suggests the pace might have been too aggressive. Long runs build aerobic capacity through volume, not intensity.';
                } else if (effort <= 5 && completion === 'full') {
                    emoji = 'üìà';
                    color = 'var(--primary-light)';
                    message = '<strong>Long run felt comfortable.</strong> If long runs consistently feel this easy, your aerobic base is strong and you may be ready for progression.';
                } else if (completion === 'partial') {
                    emoji = '‚ö†Ô∏è';
                    color = 'var(--danger)';
                    message = '<strong>Cut the long run short.</strong> Could be fatigue, weather, or other factors. We will track if this becomes a pattern.';
                } else {
                    emoji = 'üìù';
                    color = 'var(--primary-light)';
                    message = '<strong>Long run logged.</strong> Volume and effort recorded.';
                }
            }
            // OTHER WORKOUTS
            else {
                if (completion === 'full') {
                    emoji = '‚úÖ';
                    color = 'var(--success)';
                    message = '<strong>Workout completed!</strong> Session finished as planned. Effort level noted for training optimization.';
                } else {
                    emoji = 'üìù';
                    color = 'var(--primary-light)';
                    message = '<strong>Feedback recorded.</strong> We will use this data to optimize your training progression.';
                }
            }
            
            return { message, emoji, color };
        }

        function checkForPatterns(weekNum, dayName, effort, completion) {
            // Get recent feedback (last 5-7 workouts)
            const recentWorkouts = Object.entries(workoutFeedback)
                .filter(([key, _]) => {
                    const [wk, dy] = key.split('-');
                    const wkNum = parseInt(wk.replace('week', ''));
                    return !isNaN(wkNum) && wkNum <= weekNum; // Only past/current workouts
                })
                .map(([key, data]) => data)
                .slice(-7); // Last 7 workouts
            
            if (recentWorkouts.length < 3) {
                // Not enough data to detect pattern
                return { adapt: false, reason: 'insufficient_data' };
            }
            
            // PATTERN 1: Multiple hard workouts rated 8+ with partial/skipped completions
            const strugglingWorkouts = recentWorkouts.filter(w => 
                w.effort >= 8 && (w.completion === 'partial' || w.completion === 'skipped')
            );
            
            if (strugglingWorkouts.length >= 3) {
                return { 
                    adapt: true, 
                    reason: 'struggling_pattern',
                    details: `Detected pattern: ${strugglingWorkouts.length} of last ${recentWorkouts.length} workouts rated 8+/10 with incomplete sessions.`
                };
            }
            
            // PATTERN 2: Easy days consistently feeling hard (6+/10)
            const hardEasyDays = recentWorkouts.filter(w => 
                w.effort >= 6 && workoutFeedback[Object.keys(workoutFeedback).find(k => workoutFeedback[k] === w)]?.includes('Easy')
            );
            
            if (hardEasyDays.length >= 2 && recentWorkouts.length >= 4) {
                return { 
                    adapt: true, 
                    reason: 'recovery_insufficient',
                    details: `Recovery days feeling too hard. ${hardEasyDays.length} easy days rated 6+/10.`
                };
            }
            
            // PATTERN 3: Multiple maximal efforts (9-10/10) in short period
            const maximalEfforts = recentWorkouts.filter(w => w.effort >= 9).length;
            
            if (maximalEfforts >= 3 && recentWorkouts.length <= 5) {
                return { 
                    adapt: true, 
                    reason: 'overreaching',
                    details: `Multiple maximal efforts detected (${maximalEfforts} workouts at 9-10/10 in recent sessions).`
                };
            }
            
            // PATTERN 4: Everything consistently too easy (3+ workouts at ‚â§4/10, all completed)
            const easyWorkouts = recentWorkouts.filter(w => 
                w.effort <= 4 && w.completion === 'full'
            );
            
            if (easyWorkouts.length >= 4) {
                return { 
                    adapt: true, 
                    reason: 'ready_for_progression',
                    details: `${easyWorkouts.length} of last ${recentWorkouts.length} workouts felt very easy (‚â§4/10).`
                };
            }
            
            // PATTERN 5: Consistent skipping/modifying (3+ in last 7)
            const incompleteWorkouts = recentWorkouts.filter(w => 
                w.completion === 'skipped' || w.completion === 'modified'
            );
            
            if (incompleteWorkouts.length >= 3) {
                return { 
                    adapt: true, 
                    reason: 'consistency_issue',
                    details: `${incompleteWorkouts.length} of last ${recentWorkouts.length} workouts were skipped or modified.`
                };
            }
            
            // No pattern detected - maintain current training
            return { adapt: false, reason: 'no_pattern' };
        }

        function showFeedbackAcknowledgment(acknowledgment) {
            const modal = document.createElement('div');
            modal.id = 'feedbackAckModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.85);
                backdrop-filter: blur(5px);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease-out;
                cursor: pointer;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: var(--bg-card);
                border: 3px solid ${acknowledgment.color};
                border-radius: 16px;
                padding: 40px;
                max-width: 500px;
                text-align: center;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                animation: scaleIn 0.3s ease-out;
                cursor: default;
            `;
            
            // Stop event propagation on content clicks (but not on button)
            content.addEventListener('click', (e) => {
                if (e.target === content) {
                    e.stopPropagation();
                }
            });
            
            content.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 20px;">${acknowledgment.emoji}</div>
                <div style="color: ${acknowledgment.color}; font-size: 1.1rem; line-height: 1.6;">
                    ${acknowledgment.message}
                </div>
                <button id="feedbackAckGotIt"
                        style="margin-top: 30px; padding: 12px 30px; background: ${acknowledgment.color}; 
                               border: none; border-radius: 8px; color: var(--bg-card); font-weight: bold; 
                               font-size: 1rem; cursor: pointer; font-family: 'Inter', sans-serif;">
                    Got it!
                </button>
                <div style="color: rgba(255,255,255,0.4); font-size: 0.75rem; margin-top: 16px;">
                    (or click anywhere to close)
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Close function
            function closeModal() {
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    if (modal.parentElement) modal.remove();
                }, 300);
            }
            
            // Click anywhere on modal backdrop to close
            modal.addEventListener('click', closeModal);
            
            // Got it button closes
            document.getElementById('feedbackAckGotIt').addEventListener('click', (e) => {
                e.stopPropagation();
                closeModal();
            });
            
            // Auto-close after 8 seconds
            setTimeout(() => {
                if (modal.parentElement) {
                    closeModal();
                }
            }, 8000);
        }

        function adaptRemainingWeek(weekNum, completedDay, effort, completion, patternReason) {
            // Safety checks
            if (!allWeeksData || allWeeksData.length === 0) {
                console.log('No weeks data available for adaptation');
                return;
            }
            
            // Find the week in allWeeksData
            const weekIndex = allWeeksData.findIndex(w => w.weekNumber === weekNum);
            if (weekIndex === -1) {
                console.log('Week not found:', weekNum);
                return;
            }
            
            const weekData = allWeeksData[weekIndex];
            if (!weekData || !weekData.workouts) {
                console.log('Invalid week data');
                return;
            }
            
            const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const completedDayIndex = dayOrder.indexOf(completedDay);
            
            if (completedDayIndex === -1) {
                console.log('Invalid day name:', completedDay);
                return;
            }
            
            // Determine adaptation strategy based on feedback
            let adaptationNeeded = false;
            let adaptationType = '';
            
            if ((effort >= 8 && completion !== 'full') || completion === 'skipped') {
                // HARD WORKOUT or SKIPPED - need recovery
                adaptationNeeded = true;
                adaptationType = 'recovery';
            } else if (effort >= 9 && completion === 'full') {
                // MAXIMAL EFFORT but completed - maintain but don't pile on
                adaptationNeeded = true;
                adaptationType = 'maintain';
            } else if (effort >= 8 && completion === 'partial') {
                // STRUGGLED - reduce load
                adaptationNeeded = true;
                adaptationType = 'reduce';
            } else if (effort <= 4 && completion === 'full') {
                // TOO EASY - can handle more (but be conservative)
                adaptationNeeded = true;
                adaptationType = 'progress';
            }
            
            if (!adaptationNeeded) {
                console.log('No adaptation needed for this effort/completion level');
                return;
            }
            
            // Modify remaining days in the week
            for (let i = completedDayIndex + 1; i < dayOrder.length; i++) {
                const upcomingDay = dayOrder[i];
                const workout = weekData.workouts.find(w => w.day === upcomingDay);
                if (!workout) continue;
                
                const originalDetails = workout.originalDetails || workout.details;
                if (!workout.originalDetails) {
                    workout.originalDetails = workout.details; // Save original
                }
                
                // Apply adaptations based on type
                if (adaptationType === 'recovery') {
                    // Convert next hard workout to easy, reduce mileage
                    if (workout.type.includes('Workout') || workout.type.includes('Specific') || workout.type.includes('Bank')) {
                        workout.details = originalDetails.replace(/(\d+(?:\.\d+)?)\s*miles/g, (match, miles) => {
                            return Math.round(parseFloat(miles) * 0.7) + ' miles';
                        });
                        workout.type = '‚ö†Ô∏è ADAPTED: ' + workout.type.replace('‚ö†Ô∏è ADAPTED: ', '') + ' ‚Üí Easy';
                        workout.notes = 'üîÑ AUTO-ADJUSTED: Previous workout was tough. Converted to easy recovery. ' + (workout.notes || '');
                        workout.adapted = true;
                    } else if (workout.type.includes('Easy')) {
                        workout.details = originalDetails.replace(/(\d+(?:\.\d+)?)\s*miles/g, (match, miles) => {
                            return Math.max(3, Math.round(parseFloat(miles) * 0.8)) + ' miles';
                        });
                        workout.notes = 'üîÑ AUTO-ADJUSTED: Reduced mileage for recovery. ' + (workout.notes || '');
                        workout.adapted = true;
                    }
                } else if (adaptationType === 'reduce') {
                    // Reduce intensity/volume of upcoming workouts
                    if (workout.type.includes('Workout') || workout.type.includes('Specific')) {
                        workout.details = originalDetails + '\n\nüîÑ REDUCE: Cut reps by 20-30% or reduce pace slightly. Listen to your body.';
                        workout.type = '‚ö†Ô∏è ADAPTED: ' + workout.type.replace('‚ö†Ô∏è ADAPTED: ', '');
                        workout.adapted = true;
                    }
                } else if (adaptationType === 'maintain') {
                    // Keep as planned but don't add more
                    if (workout.type.includes('Workout') || workout.type.includes('Specific')) {
                        workout.notes = '‚úì Maintaining plan as-is after maximal effort. Focus on execution. ' + (workout.notes || '');
                    }
                } else if (adaptationType === 'progress') {
                    // Could handle slightly more (but be conservative - don't auto-increase)
                    workout.notes = 'üìà Last workout felt easy. Consider pushing pace slightly if feeling good. ' + (workout.notes || '');
                }
            }
            
            // Show adaptation notification
            showAdaptationNotification(adaptationType, completedDay, patternReason);
        }

        function showAdaptationNotification(adaptationType, day, patternReason) {
            const messages = {
                'recovery': `üîÑ <strong>Training Adapted - Pattern Detected:</strong><br>${patternReason?.details || 'Multiple tough sessions detected'}. Upcoming workouts reduced for recovery.`,
                'reduce': `‚ö†Ô∏è <strong>Training Adapted - Pattern Detected:</strong><br>${patternReason?.details || 'Consistency issues detected'}. Upcoming intensity reduced.`,
                'maintain': `‚úì <strong>Training Maintained:</strong><br>Recent efforts appropriate. Plan stays as scheduled.`,
                'progress': `üìà <strong>Progression Opportunity Detected:</strong><br>${patternReason?.details || 'Multiple easy sessions'}. Consider pushing pace in upcoming workouts if feeling strong.`
            };
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(255, 77, 0, 0.95);
                color: white;
                padding: 16px 20px;
                border-radius: 12px;
                border: 2px solid var(--accent);
                max-width: 400px;
                z-index: 2000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            `;
            notification.innerHTML = messages[adaptationType] || messages['maintain'];
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(400px)';
                notification.style.transition = 'all 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 7000);
        }

        function adaptTrainingBasedOnFeedback() {
            // Analyze recent feedback to adjust future training
            const recentFeedback = Object.values(workoutFeedback).slice(-7); // Last week
            
            if (recentFeedback.length < 3) return; // Need at least 3 workouts to adapt
            
            const avgEffort = recentFeedback.reduce((sum, f) => sum + f.effort, 0) / recentFeedback.length;
            const completionRate = recentFeedback.filter(f => f.completion === 'full').length / recentFeedback.length;
            
            let adaptationMessage = '';
            
            if (avgEffort > 8.5 && completionRate < 0.7) {
                adaptationMessage = '‚ö†Ô∏è Recent workouts rated very hard with low completion. Consider reducing volume or intensity.';
            } else if (avgEffort < 4 && completionRate > 0.9) {
                adaptationMessage = 'üìà Recent workouts felt easy with full completion. You may be ready for progression.';
            } else if (avgEffort >= 7 && avgEffort <= 8.5 && completionRate > 0.85) {
                adaptationMessage = '‚úÖ Training load is well-balanced. Keep current progression.';
            }
            
            if (adaptationMessage) {
                console.log('Training adaptation:', adaptationMessage);
                // Could display this in the UI if desired
            }
        }

        function getFeedbackIndicator(weekNum, dayName) {
            const key = `week${weekNum}-${dayName}`;
            const feedback = workoutFeedback[key];
            
            if (!feedback) return '';
            
            let indicatorClass = '';
            if (feedback.effort <= 5 && feedback.completion === 'full') {
                indicatorClass = 'good';
            } else if (feedback.effort <= 7 || feedback.completion === 'partial') {
                indicatorClass = 'okay';
            } else {
                indicatorClass = 'tough';
            }
            
            return `<span class="feedback-indicator ${indicatorClass}"></span>`;
        }

        function formatDateShort(date) {
            var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[date.getMonth()] + ' ' + date.getDate();
        }
        
        function parseTimeToSeconds(timeStr) {
            if (!timeStr) return null;
            const parts = timeStr.split(':');
            if (parts.length === 2) {
                return parseInt(parts[0]) * 60 + parseFloat(parts[1]);
            }
            return parseFloat(timeStr);
        }

        function secondsToTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function estimateVDOT(seconds, meters) {
            const velocity = (meters / seconds) * 60;
            const minutes = seconds / 60;
            
            const percentMax = 0.8 + 0.1894393 * Math.exp(-0.012778 * minutes) + 
                             0.2989558 * Math.exp(-0.1932605 * minutes);
            
            const vo2 = -4.60 + 0.182258 * velocity + 0.000104 * Math.pow(velocity, 2);
            const vdot = vo2 / percentMax;
            
            return Math.max(30, Math.round(vdot));
        }

        function vdotToPace(vdot, percentVO2max) {
            const vo2 = vdot * percentVO2max;
            
            const a = 0.000104;
            const b = 0.182258;
            const c = -4.60 - vo2;
            
            const discriminant = b*b - 4*a*c;
            
            if (discriminant < 0) {
                const approxVelocity = 29.54 + 5.000663 * vdot - 0.007546 * vdot * vdot;
                return (1609.344 / approxVelocity) * 60;
            }
            
            const velocity = (-b + Math.sqrt(discriminant)) / (2*a);
            const metersPerMile = 1609.344;
            const secondsPerMile = (metersPerMile / velocity) * 60;
            
            return secondsPerMile;
        }
        
        // Convert per-mile pace (in seconds) to time for a given distance (in meters)
        function paceToRepTime(paceSecondsPerMile, distanceMeters) {
            const metersPerMile = 1609.344;
            const secondsPerMeter = paceSecondsPerMile / metersPerMile;
            const repTimeSeconds = secondsPerMeter * distanceMeters;
            return repTimeSeconds;
        }
        
        // Format rep time nicely (handles both mm:ss and just seconds)
        function formatRepTime(seconds) {
            if (seconds >= 60) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.round(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${Math.round(seconds)}s`;
            }
        }
        
        // Get rep time for a specific distance at a given VDOT percentage
        function getRepTime(vdot, percentVO2max, distanceMeters) {
            const pacePerMile = vdotToPace(vdot, percentVO2max);
            const repSeconds = paceToRepTime(pacePerMile, distanceMeters);
            return formatRepTime(repSeconds);
        }

        function calculatePaces(vdot) {
            // Base per-mile paces (still useful for easy/long runs)
            const easyPaceSlow = vdotToPace(vdot, 0.59);
            const easyPaceFast = vdotToPace(vdot, 0.74);
            const thresholdPace = vdotToPace(vdot, 0.85);
            const tempoPaceFast = vdotToPace(vdot, 0.88);
            const tempoPaceSlow = vdotToPace(vdot, 0.83);
            const fiveKPace = vdotToPace(vdot, 0.95);
            const threeKPace = vdotToPace(vdot, 0.98);
            const milePace = vdotToPace(vdot, 1.00);
            const e800Pace = vdotToPace(vdot, 1.05);
            
            return {
                // Per-mile paces for easy/long runs
                easy: `${secondsToTime(easyPaceFast)}-${secondsToTime(easyPaceSlow)}`,
                threshold: secondsToTime(thresholdPace),
                tempo: `${secondsToTime(tempoPaceFast)}-${secondsToTime(tempoPaceSlow)}`,
                fiveK: secondsToTime(fiveKPace),
                threeK: secondsToTime(threeKPace),
                interval: `${secondsToTime(milePace)}-${secondsToTime(fiveKPace)}`,
                mile: secondsToTime(milePace),
                e800: secondsToTime(e800Pace / 2),
                
                // Rep times for common workout distances
                rep200_mile: formatRepTime(paceToRepTime(milePace, 200)),
                rep200_800: formatRepTime(paceToRepTime(e800Pace, 200)),
                rep300_mile: formatRepTime(paceToRepTime(milePace, 300)),
                rep300_800: formatRepTime(paceToRepTime(e800Pace, 300)),
                rep400_mile: formatRepTime(paceToRepTime(milePace, 400)),
                rep400_800: formatRepTime(paceToRepTime(e800Pace, 400)),
                rep400_5k: formatRepTime(paceToRepTime(fiveKPace, 400)),
                rep400_3k: formatRepTime(paceToRepTime(threeKPace, 400)),
                rep500_mile: formatRepTime(paceToRepTime(milePace, 500)),
                rep600_mile: formatRepTime(paceToRepTime(milePace, 600)),
                rep600_3k: formatRepTime(paceToRepTime(threeKPace, 600)),
                rep800_3k: formatRepTime(paceToRepTime(threeKPace, 800)),
                rep800_5k: formatRepTime(paceToRepTime(fiveKPace, 800)),
                rep1000_threshold: formatRepTime(paceToRepTime(thresholdPace, 1000)),
                rep1000_3k: formatRepTime(paceToRepTime(threeKPace, 1000)),
                rep1000_5k: formatRepTime(paceToRepTime(fiveKPace, 1000))
            };
        }

        function getMileageBand(mileage) {
            if (mileage < 35) return '25-35';
            if (mileage < 50) return '35-50';
            return '50-65';
        }

        console.log('About to define generatePlan function...');

        function generatePlan() {
            // Always start fresh - clear previous plan data
            allWeeksData = [];
            currentPlanData = null;
            workoutFeedback = {};
            
            // Clear any previous error highlighting
            document.querySelectorAll('.input-group').forEach(group => {
                group.style.border = '';
                group.style.background = '';
            });
            
            const times = {
                '800m': parseTimeToSeconds(document.getElementById('time800m').value),
                '1600m': parseTimeToSeconds(document.getElementById('time1600m').value),
                '3200m': parseTimeToSeconds(document.getElementById('time3200m').value),
                '5000m': parseTimeToSeconds(document.getElementById('time5000m').value)
            };

            const currentMileage = parseInt(document.getElementById('currentMileage').value);
            const goalMileage = parseInt(document.getElementById('goalMileage').value);
            const goalEvent = document.getElementById('goalEvent').value;
            
            // Calculate plan duration from start/end dates
            var planDuration = 'quarterly'; // default
            var totalWeeksFromDates = 12; // default
            var startDateEl = document.getElementById('templateStartDate');
            var endDateEl = document.getElementById('templateEndDate');
            if (startDateEl && endDateEl && startDateEl.value && endDateEl.value) {
                var startDate = new Date(startDateEl.value);
                var endDate = new Date(endDateEl.value);
                var diffTime = endDate - startDate;
                var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                totalWeeksFromDates = Math.max(4, Math.ceil(diffDays / 7));
                
                if (totalWeeksFromDates <= 4) {
                    planDuration = 'monthly';
                } else {
                    planDuration = 'quarterly';
                }
            } else {
                planDuration = document.getElementById('planDuration').value;
            }
            
            fitnessLevel = parseInt(document.getElementById('fitnessLevel').value);

            // Validation with highlighting
            const errors = [];
            
            // Check if at least one time is entered
            const hasTime = Object.values(times).some(t => t !== null);
            if (!hasTime) {
                errors.push('race-times');
                // Highlight the race times card
                document.querySelector('#time800m').closest('.card').style.border = '3px solid var(--danger)';
                document.querySelector('#time800m').closest('.card').style.background = 'rgba(255,77,0,0.1)';
            }
            
            if (!currentMileage || currentMileage <= 0) {
                errors.push('current-mileage');
                const input = document.getElementById('currentMileage').closest('.input-group');
                input.style.border = '2px solid var(--danger)';
                input.style.background = 'rgba(255,77,0,0.1)';
                input.style.padding = '12px';
                input.style.borderRadius = '8px';
            }
            
            if (!goalMileage || goalMileage <= 0) {
                errors.push('goal-mileage');
                const input = document.getElementById('goalMileage').closest('.input-group');
                input.style.border = '2px solid var(--danger)';
                input.style.background = 'rgba(255,77,0,0.1)';
                input.style.padding = '12px';
                input.style.borderRadius = '8px';
            }
            
            if (errors.length > 0) {
                let errorMsg = 'Please fill out the following required fields:\n\n';
                if (errors.includes('race-times')) errorMsg += '‚Ä¢ At least ONE race time\n';
                if (errors.includes('current-mileage')) errorMsg += '‚Ä¢ Current Weekly Mileage\n';
                if (errors.includes('goal-mileage')) errorMsg += '‚Ä¢ Goal Weekly Mileage\n';
                
                alert(errorMsg);
                
                // Scroll to first error
                if (errors.includes('race-times')) {
                    document.querySelector('#time800m').closest('.card').scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    document.getElementById(errors.includes('current-mileage') ? 'currentMileage' : 'goalMileage')
                        .closest('.input-group').scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                return;
            }

            // Race schedule - check if fields exist and validate
            const raceSchedule = [];
            var noRacesCheckbox = document.getElementById('noRacesCheckbox');
            var noRaces = noRacesCheckbox ? noRacesCheckbox.checked : true;
            
            if (!noRaces) {
                // Collect all race rows dynamically
                var raceRows = document.querySelectorAll('.race-input-row');
                raceRows.forEach(function(row) {
                    var rowId = row.id.replace('raceRow', '');
                    var dateEl = document.getElementById('raceDate' + rowId);
                    var distanceEl = document.getElementById('raceDistance' + rowId);
                    var priorityEl = document.getElementById('racePriority' + rowId);
                    
                    if (dateEl && distanceEl && dateEl.value && distanceEl.value) {
                        raceSchedule.push({ 
                            date: dateEl.value, 
                            distance: distanceEl.value, 
                            priority: priorityEl ? priorityEl.value : 'B' 
                        });
                    }
                });
                
                // If no races entered and checkbox not checked, show error
                if (raceSchedule.length === 0) {
                    alert('Please either:\n\n‚Ä¢ Add at least one race to your schedule\n\nOR\n\n‚Ä¢ Check "No races planned - just building fitness"');
                    document.getElementById('raceScheduleCard').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
            }

            document.getElementById('dataInput').style.display = 'none';
            document.getElementById('loading').classList.add('active');

            // Use requestAnimationFrame to ensure UI updates before heavy computation
            requestAnimationFrame(function() {
                setTimeout(function() {
                try {
                const vdots = [];
                const distanceMap = {
                    '800m': 800,
                    '1600m': 1600,
                    '3200m': 3200,
                    '5000m': 5000
                };

                for (const [distance, seconds] of Object.entries(times)) {
                    if (seconds !== null) {
                        const meters = distanceMap[distance];
                        const vdot = estimateVDOT(seconds, meters);
                        vdots.push(vdot);
                    }
                }

                const avgVDOT = Math.round(vdots.reduce((a, b) => a + b, 0) / vdots.length);
                
                // For paces, we use the full VDOT - the progressive ramp-up handles intensity
                // Only adjust paces slightly for very low fitness to prevent injury
                let paceMultiplier = 1.0;
                let intensityAdjustment;
                
                if (fitnessLevel <= 25) {
                    paceMultiplier = 0.96;  // 4% slower paces for safety
                    intensityAdjustment = 'RECOVERY MODE: Progressive ramp-up with easier paces. Building back safely.';
                } else if (fitnessLevel <= 50) {
                    paceMultiplier = 0.98;  // 2% slower paces
                    intensityAdjustment = 'BUILDING PHASE: Progressive ramp-up over first few weeks.';
                } else if (fitnessLevel <= 75) {
                    intensityAdjustment = 'RACE READY: Full training with normal progression.';
                } else {
                    intensityAdjustment = 'PEAK FITNESS: Full training load. Maintaining sharpness.';
                }
                
                const adjustedVDOT = Math.round(avgVDOT * paceMultiplier);
                const paces = calculatePaces(adjustedVDOT);
                
                // Store current plan data for saving
                currentPlanData = {
                    vdot: adjustedVDOT,
                    paces: paces,
                    currentMileage: currentMileage,
                    goalMileage: goalMileage,
                    goalEvent: goalEvent,
                    planDuration: planDuration,
                    raceSchedule: raceSchedule,
                    fitnessLevel: fitnessLevel,
                    intensityAdjustment: intensityAdjustment,
                    createdDate: new Date().toISOString()
                };

                displayStats(adjustedVDOT, currentMileage, goalMileage, paces, intensityAdjustment, fitnessLevel);
                displayRaceSchedule(raceSchedule);
                displayPeriodizedPlan(paces, currentMileage, goalMileage, goalEvent, planDuration, raceSchedule, fitnessLevel, totalWeeksFromDates);
                
                // Update profile stats after plan is created
                updateProfileStats();
                
                // Clear the active plan ID since this is a new unsaved plan
                localStorage.removeItem('laktic_active_plan_id');
                
                // Update the banner to show this is an unsaved plan
                updateActivePlanBanner(null, false);
                
                // Hide the "No Active Plan" message, show the workout plan
                document.getElementById('noPlanMessage').style.display = 'none';
                document.getElementById('workoutPlan').style.display = 'block';
                
                // Save start date from template if available
                var templateStartDateEl = document.getElementById('templateStartDate');
                if (templateStartDateEl && templateStartDateEl.value && currentPlanData) {
                    currentPlanData.startDate = templateStartDateEl.value;
                    // Also set the calendar start date
                    var calendarStartDateEl = document.getElementById('calendarStartDate');
                    if (calendarStartDateEl) {
                        calendarStartDateEl.value = templateStartDateEl.value;
                    }
                }
                
                // Switch to My Plans tab to show the generated plan
                switchPage('myPlansPage');
                showActivePlan();

                document.getElementById('loading').classList.remove('active');
                document.getElementById('workoutPlan').classList.add('active');
                } catch(err) {
                    console.error('Plan generation error:', err);
                    alert('Error generating plan: ' + err.message);
                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('dataInput').style.display = 'block';
                }
            }, 50);
            });
        }

        function displayStats(vdot, currentMileage, goalMileage, paces, intensityAdjustment, fitnessLevel) {
            let fitnessLabel, fitnessColor;
            if (fitnessLevel <= 25) {
                fitnessLabel = 'Recovering';
                fitnessColor = 'var(--danger)';
            } else if (fitnessLevel <= 50) {
                fitnessLabel = 'Building';
                fitnessColor = 'var(--warning)';
            } else if (fitnessLevel <= 75) {
                fitnessLabel = 'Race Ready';
                fitnessColor = 'var(--success)';
            } else {
                fitnessLabel = 'Peak Fitness';
                fitnessColor = 'var(--primary-light)';
            }
            
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-box">
                    <div class="stat-value">${vdot}</div>
                    <div class="stat-label">VDOT</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${currentMileage}</div>
                    <div class="stat-label">Current MPW</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${goalMileage}</div>
                    <div class="stat-label">Goal MPW</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${paces.threshold}</div>
                    <div class="stat-label">Threshold</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${paces.mile}</div>
                    <div class="stat-label">Mile Pace</div>
                </div>
                <div class="stat-box" style="grid-column: span 2;">
                    <div class="stat-value" style="font-size: 1.5rem; color: ${fitnessColor};">${fitnessLevel}%</div>
                    <div class="stat-label">${fitnessLabel}</div>
                </div>
            `;
            
            // Add training adjustment notice
            if (intensityAdjustment) {
                const statsCard = document.getElementById('statsGrid').parentElement;
                const existingNotice = document.getElementById('intensityNotice');
                if (existingNotice) existingNotice.remove();
                
                const notice = document.createElement('div');
                notice.id = 'intensityNotice';
                notice.style.cssText = `
                    margin-top: 16px; 
                    padding: 12px; 
                    background: rgba(${fitnessLevel <= 25 ? '255,77,0' : fitnessLevel <= 50 ? '255,230,0' : fitnessLevel <= 75 ? '0,255,136' : '0,217,255'},0.15); 
                    border-left: 4px solid ${fitnessColor}; 
                    border-radius: 8px; 
                    font-size: 0.85rem;
                    color: rgba(255,255,255,0.9);
                `;
                notice.innerHTML = `<strong>üìä Training Adjustment:</strong> ${intensityAdjustment}`;
                statsCard.appendChild(notice);
            }
        }

        function displayRaceSchedule(raceSchedule) {
            if (raceSchedule.length === 0) {
                document.getElementById('raceScheduleDisplayCard').style.display = 'none';
                return;
            }

            document.getElementById('raceScheduleDisplayCard').style.display = 'block';
            
            const priorityClasses = { 'A': 'race-a', 'B': 'race-b', 'C': 'race-c' };
            const priorityLabels = { 'A': 'TARGET RACE', 'B': 'Important Race', 'C': 'Tune-up Race' };

            document.getElementById('raceScheduleDisplay').innerHTML = raceSchedule.map(race => `
                <div class="race-schedule-item ${priorityClasses[race.priority]}">
                    <div>
                        <div style="font-weight: bold; margin-bottom: 4px;">${race.distance.toUpperCase()}</div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">
                            ${new Date(race.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2rem; font-weight: bold;">${race.priority}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${priorityLabels[race.priority]}</div>
                    </div>
                </div>
            `).join('');
        }

        function displayPeriodizedPlan(paces, currentMileage, goalMileage, goalEvent, duration, raceSchedule, fitnessLevel = 75, totalWeeksFromDates = null) {
            const today = new Date();
            
            if (duration === 'weekly') {
                document.getElementById('planTitle').textContent = 'This Week\'s Plan';
                document.getElementById('weekSelector').style.display = 'none';
                
                // For single week, determine workout type based on fitness
                let adjustedMileage, weekType;
                if (fitnessLevel <= 35) {
                    adjustedMileage = Math.round(currentMileage * 0.70);
                    weekType = 'intro';
                    document.getElementById('periodizationNote').innerHTML = `
                        Sample training week (Intro level - ${Math.round(fitnessLevel)}% fitness)<br>
                        <span style="color: var(--accent);">üå± Easy introduction week - building consistency</span>
                    `;
                } else if (fitnessLevel <= 60) {
                    adjustedMileage = Math.round(currentMileage * 0.85);
                    weekType = 'building';
                    document.getElementById('periodizationNote').innerHTML = `
                        Sample training week (Building level - ${Math.round(fitnessLevel)}% fitness)<br>
                        <span style="color: var(--warning);">üìà Moderate intensity - some quality work</span>
                    `;
                } else {
                    adjustedMileage = currentMileage;
                    weekType = 'full';
                    document.getElementById('periodizationNote').textContent = 'Sample training week using Laktic workout system';
                }
                
                displaySampleWeek(paces, adjustedMileage, goalEvent, weekType);
            } else if (duration === 'monthly') {
                var weeksToUse = totalWeeksFromDates || 4;
                document.getElementById('planTitle').textContent = weeksToUse + '-Week Training Block';
                buildMultiWeekPlan(paces, currentMileage, goalMileage, goalEvent, weeksToUse, raceSchedule, today, fitnessLevel);
            } else if (duration === 'quarterly') {
                var weeksToUse = totalWeeksFromDates || 12;
                document.getElementById('planTitle').textContent = weeksToUse + '-Week Training Plan';
                buildMultiWeekPlan(paces, currentMileage, goalMileage, goalEvent, weeksToUse, raceSchedule, today, fitnessLevel);
            }
        }

        function displaySampleWeek(paces, mileage, goalEvent, weekType = 'full') {
            window.currentPaces = paces; // Store for reload after feedback
            
            const band = getMileageBand(mileage);
            const phase = 'Mid';
            
            // Build appropriate week based on weekType
            let week;
            let weekLabel, weekDescription;
            
            if (weekType === 'intro') {
                week = buildIntroductionWeek(paces, mileage, goalEvent, 1);
                weekLabel = 'Introduction Week';
                weekDescription = 'Easy introduction - building consistency and base fitness';
            } else if (weekType === 'building') {
                week = buildBuildingWeek(paces, mileage, goalEvent, phase, band, 1, false);
                weekLabel = 'Building Week';
                weekDescription = 'Moderate intensity - introducing quality work';
            } else {
                week = buildWeekFromLibrary(paces, mileage, goalEvent, phase, band, 1, false);
                weekLabel = 'Sample Week';
                weekDescription = 'Full training week using Laktic workout system';
            }
            
            // IMPORTANT: Populate allWeeksData so the plan can be saved and used in calendar
            allWeeksData = [{
                weekNumber: 1,
                label: weekLabel,
                description: weekDescription,
                mileage: mileage,
                season: phase,
                workouts: week,
                raceWeek: false
            }];
            
            // Calculate total mileage
            let totalMileage = 0;
            week.forEach(w => {
                const mileMatch = w.details.match(/(\d+(?:\.\d+)?)\s*miles/);
                if (mileMatch) {
                    totalMileage += parseFloat(mileMatch[1]);
                }
            });
            
            let html = `
                <div style="background: rgba(0,217,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid var(--accent);">
                    <strong>Weekly Total:</strong> ~${Math.round(totalMileage)} miles (Target: ${mileage} miles)
                </div>
            `;
            
            week.forEach((w, idx) => {
                const feedbackKey = `week1-${w.day}`;
                const hasFeedback = workoutFeedback[feedbackKey];
                const indicator = getFeedbackIndicator(1, w.day);
                
                html += `
                    <div class="workout-item ${w.adapted ? 'adapted' : ''}" style="animation-delay: ${idx * 0.05}s;">
                        <div class="workout-day">${indicator}${w.day}${w.adapted ? ' <span style="color: var(--secondary); font-size: 0.75rem;">‚ö° ADAPTED</span>' : ''}</div>
                        <div class="workout-type">${w.type}</div>
                        <div class="workout-details">${w.details}</div>
                        ${w.rest ? `<div class="workout-rest">Rest: ${w.rest}</div>` : ''}
                        ${w.notes ? `<div class="workout-notes">üìù ${w.notes}</div>` : ''}
                        ${hasFeedback ? 
                            `<div style="margin-top: 8px; padding: 8px; background: rgba(16,185,129,0.1); border: 1px solid var(--success); border-radius: 4px; font-size: 0.8rem;">
                                <strong style="color: var(--success);">‚úì Feedback:</strong> Effort ${hasFeedback.effort}/10, ${hasFeedback.completion === 'full' ? 'Completed' : hasFeedback.completion}
                                ${hasFeedback.notes ? ` - "${hasFeedback.notes}"` : ''}
                                ${hasFeedback.distance || hasFeedback.avgHR ? 
                                    `<br><span style="color: var(--text-muted);">
                                        ${hasFeedback.distance ? `üìè ${hasFeedback.distance}mi` : ''} 
                                        ${hasFeedback.avgPace ? `‚è±Ô∏è ${hasFeedback.avgPace}/mi` : ''}
                                        ${hasFeedback.avgHR ? `‚ù§Ô∏è ${hasFeedback.avgHR}bpm` : ''}
                                    </span>` : ''}
                            </div>` : ''}
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button class="feedback-btn ${hasFeedback ? 'completed' : ''}" 
                                    onclick="openFeedbackModal(1, '${w.day}', '${w.type.replace(/'/g, "\\'")}')">
                                ${hasFeedback ? '‚úì Edit Feedback' : '+ Add Feedback'}
                            </button>
                            ${hasFeedback ? `
                                <button class="feedback-btn" style="background: var(--bg-elevated); border: 1px solid var(--primary); color: var(--primary);"
                                        onclick="openMetricsModal(1, '${w.day}', '${w.type.replace(/'/g, "\\'")}')">
                                    üìä Metrics
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('workoutList').innerHTML = html;
        }

        function buildWeekFromLibrary(paces, mileage, goalEvent, season, band, weekNum, isRaceWeek) {
            // Calculate workout volumes first
            const workoutMileage = isRaceWeek ? 
                Math.round(mileage * 0.08) : // Race week: minimal quality
                Math.round(mileage * 0.12);  // Normal: ~12% in hard workouts
            
            const longRun = Math.min(Math.round(mileage * 0.25), Math.min(14, mileage * 0.28));
            const primerMileage = 3; // ~3 miles for primer workout
            
            // Calculate remaining mileage for easy runs
            let remainingMiles = mileage - workoutMileage - longRun;
            if (isRaceWeek) {
                remainingMiles -= primerMileage;
            }
            
            // Distribute remaining miles across easy days
            const numEasyDays = isRaceWeek ? 3 : 4; // Wed, Thu, Sun (+ possibly Mon in race week)
            const easyDayMiles = Math.max(3, Math.floor(remainingMiles / numEasyDays));
            
            const week = [
                {
                    day: 'Monday',
                    type: 'Speed Development',
                    details: getSpeedDevWorkout(band, weekNum) + ` Total: ${Math.round(easyDayMiles * 0.7)} miles including warm-up/cool-down.`,
                    rest: 'Full recovery between reps (2:00-5:00)',
                    notes: 'Stop early if mechanics fade. Never tiring.'
                },
                {
                    day: 'Tuesday',
                    type: 'Aerobic Bank',
                    details: getAerobicBankWorkout(season, band, paces, isRaceWeek) + ` Total: ${workoutMileage} miles including warm-up/cool-down.`,
                    rest: '60-90s jog between reps',
                    notes: 'Keep it controlled. Last rep should be best without strain.'
                },
                {
                    day: 'Wednesday',
                    type: 'Easy Run',
                    details: `${easyDayMiles} miles at ${paces.easy} pace. Recovery day.`,
                    rest: null,
                    notes: 'Can add light drills/strides if feeling good.'
                },
                {
                    day: 'Thursday',
                    type: isRaceWeek ? 'Primer' : 'Easy Run',
                    details: isRaceWeek ? 
                        getPrimerWorkout(goalEvent, paces) + ` Total: ${primerMileage} miles including warm-up/cool-down.` :
                        `${easyDayMiles} miles easy. Light day before workout.`,
                    rest: isRaceWeek ? '2:30-4:00 full recovery between reps' : null,
                    notes: isRaceWeek ? 'Stay snappy, not fatigued. Quality > density.' : 'Keep it very easy.'
                },
                {
                    day: 'Friday',
                    type: isRaceWeek ? 'RACE or Shakeout' : 'Specific Workout',
                    details: isRaceWeek ? 
                        'Race day! Or easy 3-4 miles if racing Saturday.' : 
                        getSpecificWorkout(season, goalEvent, band, paces, weekNum) + ` Total: ${workoutMileage} miles including warm-up/cool-down.`,
                    rest: isRaceWeek ? null : '2:00-4:00 between reps, 5:00-8:00 between sets',
                    notes: isRaceWeek ? 'Execute your race plan!' : 'Stop if pace drops >2-3%. This is your key session.'
                },
                {
                    day: 'Saturday',
                    type: isRaceWeek ? 'Race Day' : 'Long Run',
                    details: isRaceWeek ? 
                        'Race day or easy ' + longRun + ' miles if raced Friday' : 
                        `${longRun} miles at ${paces.easy} pace. Steady aerobic work.`,
                    rest: null,
                    notes: isRaceWeek ? 'Execute your race plan!' : 'Build the aerobic engine. Stay patient.'
                },
                {
                    day: 'Sunday',
                    type: 'Recovery',
                    details: `${easyDayMiles} miles easy OR complete rest.`,
                    rest: null,
                    notes: 'Listen to your body. Recovery is training.'
                }
            ];
            
            return week;
        }

        function getSpeedDevWorkout(band, weekNum) {
            const workouts = [
                'Accels + Flys: 4-6√ó20-30m accels (walk back + 30-60s) + 3-5√ófly20 (20m build + 20m fly, 3:00-5:00 rest). Full relaxation.',
                'Short hill sprints: 6-10√ó8-12s hills at perfect form. Walk back + 2:00-4:00 full recovery.',
                'Fast-relaxed 150s: 3-5√ó150m smooth (not lactate). 4:00-6:00 full recovery. Use sparingly.',
                'Strides + drills: 6-10√ó100m strides + dynamic drills/skills. 60-120s walk/jog between.'
            ];
            return workouts[weekNum % 4];
        }

        function getAerobicBankWorkout(season, band, paces, isRaceWeek) {
            if (isRaceWeek) {
                return `Short tempo + strides: 16-20 min @ ${paces.tempo}/mi pace + 4√ó150m fast-relaxed (2:00-4:00 rest). Race-week safe anchor.`;
            }
            
            if (season === 'Early') {
                const reps = band === '25-35' ? 4 : band === '35-50' ? 5 : '5-6';
                return `${reps}√ó1000m in ${paces.rep1000_threshold} each (threshold pace). 60-90s jog recovery. Bank aerobic fitness.`;
            } else if (season === 'Mid') {
                const length = band === '25-35' ? '20 min' : band === '35-50' ? '22 min' : '24 min';
                return `Tempo ${length} @ ${paces.tempo}/mi + 4-6√ó150m fast-relaxed (2:00-4:00 rest). Best mid-season default.`;
            } else {
                return `4-5√ó1000m cutdown (${paces.rep1000_threshold}‚Üífaster). 75-90s jog recovery. Stay controlled.`;
            }
        }

        function getPrimerWorkout(goalEvent, paces) {
            if (goalEvent === '800') {
                return `3-5√ó200m in ${paces.rep200_800} each (800 rhythm). 2:30-4:00 full recovery. Quality > density.`;
            } else if (goalEvent === '1500') {
                return `4-6√ó200m in ${paces.rep200_mile} each (mile rhythm). 2:30-4:00 full recovery. Keep mechanics smooth.`;
            } else {
                return `4-6√ó200m in ${paces.rep200_mile} each (3K-mile rhythm). 2:30-4:00 full recovery. Great before Saturday invites.`;
            }
        }

        function getSpecificWorkout(season, goalEvent, band, paces, weekNum) {
            const eventKey = goalEvent === '800' ? 'S' : goalEvent === '1500' ? 'M' : 'K';
            const workoutNum = (weekNum % 6) + 1;
            
            if (eventKey === 'S') {
                const workouts = [
                    `2-3√ó(300-200-100) @ 800 pace: 300s in ${paces.rep300_800}, 200s in ${paces.rep200_800}. 300‚Üí200: 4:00-6:00; 200‚Üí100: 3:00-5:00; sets: 8:00-12:00. Classic 800 work.`,
                    `2√ó(400-200-200) @ 800 pace: 400s in ${paces.rep400_800}, 200s in ${paces.rep200_800}. 2:00 between reps; 7:00 between sets. Speed endurance.`,
                    `8-10√ó200m in ${paces.rep200_800} each (800 pace). 60-90s if rhythm, 2:00-3:00 if all-out. Fewer reps if true race pace.`,
                    `1-2√ó(500-300-200): 500s in ${paces.rep500_mile}, 300/200s in ${paces.rep300_800}/${paces.rep200_800}. 500‚Üí300: 4:00-6:00; 300‚Üí200: 3:00-5:00; sets: 8:00-12:00.`,
                    `2√ó4√ó200 in ${paces.rep200_800} (60-90s rest), 6:00 between sets. Then spike up + 1√ó400 in ${paces.rep400_800} (8:00-12:00 rest).`,
                    `250-150-100-250 @ fast rhythm. 4:00-8:00 full recovery between all reps. Championship sharpening.`
                ];
                return workouts[workoutNum - 1];
            } else if (eventKey === 'M') {
                const workouts = [
                    `2√ó3√ó400 in ${paces.rep400_mile} (mile pace) + 5√ó200 in ${paces.rep200_800} (800 pace). 400s: 90s; sets: 3:00. 200s: 2:00-4:00. Classic miler session.`,
                    `2-3√ó(500-300-200) @ mile pace: 500s in ${paces.rep500_mile}, 300s in ${paces.rep300_mile}, 200s in ${paces.rep200_mile}. 90s between reps; 3:00 set rest. Build speed endurance.`,
                    `10√ó300m in ${paces.rep300_mile} each (mile pace). 100m walk/jog (60-90s) or fixed 2:00 rest. Controlled rhythm.`,
                    `3-4√ó(400-300-200) in ${paces.rep400_mile}/${paces.rep300_mile}/${paces.rep200_mile} + 2-3√ó(250-150). 90s-2:00 within; 2:30-3:30 sets. Speed layering.`,
                    `6-8√ó300 in ${paces.rep300_mile} (mile) + 2-3√ó300 in ${paces.rep300_800} (800 pace). Mile 300s: 60-90s. 800 300s: 3:00-6:00. Quality first.`,
                    `2√ó(600-400-200) in ${paces.rep600_mile}/${paces.rep400_mile}/${paces.rep200_mile} + quick 400 in ${paces.rep400_800}. 600‚Üí400: 3:00-4:00; 400‚Üí200: 2:30-3:30; sets: 6:00-8:00. 400: 8:00-12:00.`
                ];
                return workouts[workoutNum - 1];
            } else {
                const workouts = [
                    `2√ó3√ó600 in ${paces.rep600_3k} (3K pace) + 5√ó200 in ${paces.rep200_mile} (mile pace). 600s: 90s-2:00; sets: 4:00. 200s: 2:00-3:00. Volume builder.`,
                    `1000-1000-800-600-400 @ 3K rhythm: 1000s in ${paces.rep1000_3k}, 800 in ${paces.rep800_3k}, 600 in ${paces.rep600_3k}, 400 in ${paces.rep400_3k}. Rest: 3:00, 3:00, 2:30, 2:00.`,
                    `2-3√ó(1000-600-400): 1000s in ${paces.rep1000_5k} (5K), 600s in ${paces.rep600_3k} (3K), 400s in ${paces.rep400_mile} (mile). 1000‚Üí600: 3:00-4:00; 600‚Üí400: 3:00; sets: 6:00-8:00.`,
                    `2-3√ó(800-600-400) @ 3K pace: 800s in ${paces.rep800_3k}, 600s in ${paces.rep600_3k}, 400s in ${paces.rep400_3k}. 2:00-3:00 between reps; 5:00-7:00 between sets.`,
                    `4-5√ó800 in ${paces.rep800_3k} each (3200 pace). 2:00-3:00 between reps. Classic 2-mile training.`,
                    `12-14√ó400 in ${paces.rep400_3k} each (3K pace). 60-75s rest (or 75-90s for quality). High volume speed work.`
                ];
                return workouts[workoutNum - 1];
            }
        }

        /**
         * Calculate progressive ramp-up schedule based on fitness level
         * Returns an object with ramp-up weeks and weekly multipliers
         */
        function calculateProgressiveRampUp(fitnessLevel, totalWeeks) {
            // For very short plans (1-2 weeks), just apply a flat adjustment
            if (totalWeeks <= 2) {
                const flatMultiplier = fitnessLevel <= 25 ? 0.70 : 
                                       fitnessLevel <= 50 ? 0.85 : 
                                       fitnessLevel <= 75 ? 0.95 : 1.0;
                return {
                    rampUpWeeks: 0,
                    startingLoad: flatMultiplier,
                    targetLoad: flatMultiplier,
                    weeklyMultipliers: Array(totalWeeks).fill(flatMultiplier)
                };
            }
            
            // For 4-week plans, limit ramp-up to 1-2 weeks max
            // For 12-week plans, allow full ramp-up
            const maxRampUpWeeks = totalWeeks <= 4 ? 2 : 
                                   totalWeeks <= 8 ? 3 : 6;
            
            // Determine how many weeks of ramp-up are needed based on fitness
            let rampUpWeeks, startingLoad, targetLoad;
            
            if (fitnessLevel <= 20) {
                // Very low fitness: needs significant ramp-up
                rampUpWeeks = Math.min(maxRampUpWeeks, Math.max(2, Math.floor(totalWeeks * 0.5)));
                startingLoad = totalWeeks <= 4 ? 0.65 : 0.55; // Start higher for short plans
                targetLoad = 0.95;
            } else if (fitnessLevel <= 35) {
                // Low fitness: needs moderate ramp-up
                rampUpWeeks = Math.min(maxRampUpWeeks, Math.max(1, Math.floor(totalWeeks * 0.4)));
                startingLoad = totalWeeks <= 4 ? 0.75 : 0.65;
                targetLoad = 1.0;
            } else if (fitnessLevel <= 50) {
                // Moderate fitness: needs light ramp-up
                rampUpWeeks = Math.min(maxRampUpWeeks, Math.max(1, Math.floor(totalWeeks * 0.3)));
                startingLoad = totalWeeks <= 4 ? 0.85 : 0.75;
                targetLoad = 1.0;
            } else if (fitnessLevel <= 65) {
                // Good fitness: 1 week intro
                rampUpWeeks = Math.min(2, Math.floor(totalWeeks * 0.25));
                startingLoad = 0.85;
                targetLoad = 1.0;
            } else if (fitnessLevel <= 80) {
                // High fitness: minimal intro
                rampUpWeeks = totalWeeks >= 4 ? 1 : 0;
                startingLoad = 0.90;
                targetLoad = 1.0;
            } else {
                // Peak fitness: No ramp needed
                rampUpWeeks = 0;
                startingLoad = 1.0;
                targetLoad = 1.0;
            }
            
            // Generate weekly multipliers
            const weeklyMultipliers = [];
            
            for (let week = 1; week <= totalWeeks; week++) {
                let multiplier;
                
                if (rampUpWeeks === 0) {
                    multiplier = targetLoad;
                } else if (week <= rampUpWeeks) {
                    // During ramp-up: progressively increase
                    const progress = week / rampUpWeeks;
                    // Use smooth easing curve for natural progression
                    const easedProgress = 1 - Math.pow(1 - progress, 2); // Ease-out curve
                    multiplier = startingLoad + (targetLoad - startingLoad) * easedProgress;
                } else {
                    // After ramp-up: full training
                    multiplier = targetLoad;
                }
                
                weeklyMultipliers.push(Math.round(multiplier * 100) / 100);
            }
            
            return {
                rampUpWeeks: rampUpWeeks,
                startingLoad: startingLoad,
                targetLoad: targetLoad,
                weeklyMultipliers: weeklyMultipliers
            };
        }
        
        /**
         * Get workout intensity description for a given week
         */
        function getWeekIntensityLabel(weekMultiplier) {
            if (weekMultiplier < 0.65) {
                return { label: 'Intro Week', color: 'var(--accent)', description: 'Easy introduction - focus on consistency' };
            } else if (weekMultiplier < 0.75) {
                return { label: 'Building', color: 'var(--accent)', description: 'Gradually increasing load' };
            } else if (weekMultiplier < 0.85) {
                return { label: 'Developing', color: 'var(--warning)', description: 'Moderate training load' };
            } else if (weekMultiplier < 0.95) {
                return { label: 'Near Full', color: 'var(--warning)', description: 'Approaching full training' };
            } else {
                return { label: 'Full Training', color: 'var(--success)', description: 'Full training load' };
            }
        }

        function buildMultiWeekPlan(paces, currentMileage, goalMileage, goalEvent, totalWeeks, raceSchedule, today, fitnessLevel = 75) {
            allWeeksData = [];
            const mileageProgression = calculateMileageProgression(currentMileage, goalMileage, totalWeeks);
            
            // Calculate progressive ramp-up based on fitness level
            const rampUp = calculateProgressiveRampUp(fitnessLevel, totalWeeks);
            
            // Calculate training phases (after ramp-up)
            const phases = calculateTrainingPhases(totalWeeks, rampUp.rampUpWeeks, raceSchedule);
            
            for (let week = 1; week <= totalWeeks; week++) {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() + (week - 1) * 7);
                
                // Get this week's multiplier from the progressive ramp-up
                const weekMultiplier = rampUp.weeklyMultipliers[week - 1];
                
                // Apply progressive multiplier to mileage
                const baseWeekMileage = mileageProgression[week - 1];
                const weekMileage = Math.round(baseWeekMileage * weekMultiplier);
                
                const band = getMileageBand(weekMileage);
                const phaseInfo = determinePhase(week, totalWeeks, weekStart, raceSchedule, rampUp.rampUpWeeks, phases);
                
                // Get intensity label for this week
                const intensityInfo = getWeekIntensityLabel(weekMultiplier);
                
                // Build workouts based on phase and intensity
                const workouts = buildWeekForPhase(paces, weekMileage, goalEvent, phaseInfo, band, week, weekMultiplier);
                
                // Build the week label
                let weekLabel = phaseInfo.label;
                if (week <= rampUp.rampUpWeeks) {
                    weekLabel = `${intensityInfo.label}`;
                }
                
                allWeeksData.push({
                    weekNumber: week,
                    label: weekLabel,
                    description: phaseInfo.description,
                    mileage: weekMileage,
                    season: phaseInfo.season,
                    phase: phaseInfo.phase,
                    phaseInfo: phaseInfo,
                    workouts: workouts,
                    raceWeek: phaseInfo.raceWeek,
                    weekMultiplier: weekMultiplier,
                    intensityInfo: intensityInfo,
                    isRampUpWeek: week <= rampUp.rampUpWeeks
                });
            }
            
            setupWeekSelector(totalWeeks);
            displaySelectedWeek(0);
            
            // Build informative periodization note with phase breakdown
            let phaseNote = '';
            if (rampUp.rampUpWeeks > 0) {
                phaseNote += `<br><span style="color: var(--accent);">üå± Weeks 1-${rampUp.rampUpWeeks}: Ramp-Up (${Math.round(rampUp.startingLoad * 100)}%‚Üí${Math.round(rampUp.targetLoad * 100)}%)</span>`;
            }
            if (phases.base.weeks > 0) {
                phaseNote += `<br><span style="color: var(--accent);">ü´Ä Weeks ${phases.base.start}-${phases.base.end}: Base Building</span>`;
            }
            if (phases.strength.weeks > 0) {
                phaseNote += `<br><span style="color: var(--warning);">üí™ Weeks ${phases.strength.start}-${phases.strength.end}: Strength & Stamina</span>`;
            }
            if (phases.speed.weeks > 0) {
                phaseNote += `<br><span style="color: var(--primary);">‚ö° Weeks ${phases.speed.start}-${phases.speed.end}: Speed Development</span>`;
            }
            if (phases.peak.weeks > 0) {
                phaseNote += `<br><span style="color: var(--danger);">üéØ Weeks ${phases.peak.start}-${phases.peak.end}: Peak & Competition</span>`;
            }
            
            document.getElementById('periodizationNote').innerHTML = `
                <strong>${totalWeeks}-Week Plan:</strong> Mileage ${currentMileage}‚Üí${goalMileage} mpw for ${goalEvent === '800' ? '800m' : goalEvent === '1500' ? '1500m/Mile' : '3200m/3K'}.
                ${phaseNote}
            `;
        }
        
        /**
         * Build a week's workouts based on training phase
         */
        function buildWeekForPhase(paces, mileage, goalEvent, phaseInfo, band, weekNum, intensityMultiplier) {
            // Handle ramp-up weeks with simpler workouts
            if (phaseInfo.phase === 'rampup' || intensityMultiplier < 0.70) {
                return buildIntroductionWeek(paces, mileage, goalEvent, weekNum);
            }
            
            if (intensityMultiplier < 0.85) {
                return buildBuildingWeek(paces, mileage, goalEvent, phaseInfo.season, band, weekNum, phaseInfo.raceWeek);
            }
            
            // Handle race weeks
            if (phaseInfo.raceWeek) {
                return buildWeekFromLibrary(paces, mileage, goalEvent, phaseInfo.season, band, weekNum, true);
            }
            
            // Build phase-specific training week
            switch (phaseInfo.phase) {
                case 'base':
                    return buildBasePhaseWeek(paces, mileage, goalEvent, band, weekNum);
                case 'strength':
                    return buildStrengthPhaseWeek(paces, mileage, goalEvent, band, weekNum);
                case 'speed':
                    return buildSpeedPhaseWeek(paces, mileage, goalEvent, band, weekNum);
                case 'peak':
                    return buildPeakPhaseWeek(paces, mileage, goalEvent, band, weekNum);
                default:
                    return buildWeekFromLibrary(paces, mileage, goalEvent, phaseInfo.season, band, weekNum, false);
            }
        }
        
        /**
         * BASE PHASE: Focus on aerobic development, longer intervals, threshold work
         */
        function buildBasePhaseWeek(paces, mileage, goalEvent, band, weekNum) {
            const easyMiles = Math.max(4, Math.round(mileage / 5.5));
            const longRun = Math.min(Math.round(mileage * 0.27), 14);
            const workoutMiles = Math.round(mileage * 0.12);
            
            return [
                {
                    day: 'Monday',
                    type: 'Easy + Strides',
                    details: `${easyMiles} miles easy at ${paces.easy} pace + 6-8√ó100m strides. Walk back recovery.`,
                    rest: 'Full recovery between strides',
                    notes: 'ü´Ä BASE: Strides maintain turnover while building aerobically.'
                },
                {
                    day: 'Tuesday',
                    type: 'Aerobic Threshold',
                    details: getBasePhaseAerobicWorkout(paces, band, weekNum, workoutMiles),
                    rest: '60-90s jog between reps',
                    notes: 'ü´Ä BASE: Building the aerobic engine. Keep effort controlled (85-88% HR max).'
                },
                {
                    day: 'Wednesday',
                    type: 'Easy Run',
                    details: `${easyMiles} miles at ${paces.easy} pace. Recovery day.`,
                    rest: null,
                    notes: 'ü´Ä BASE: True recovery pace. Conversation easy.'
                },
                {
                    day: 'Thursday',
                    type: 'Easy + Drills',
                    details: `${easyMiles} miles easy + running form drills. Focus on mechanics.`,
                    rest: null,
                    notes: 'ü´Ä BASE: Build good habits while maintaining volume.'
                },
                {
                    day: 'Friday',
                    type: 'Tempo/Cruise Intervals',
                    details: getBasePhaseTempoWorkout(paces, band, weekNum, workoutMiles),
                    rest: '90s-2:00 jog between reps',
                    notes: 'ü´Ä BASE: Threshold work builds lactate clearance. Comfortably hard, not racing.'
                },
                {
                    day: 'Saturday',
                    type: 'Long Run',
                    details: `${longRun} miles at ${paces.easy} to ${paces.long} pace. Build aerobic base.`,
                    rest: null,
                    notes: 'ü´Ä BASE: The cornerstone of aerobic development. Patient, steady effort.'
                },
                {
                    day: 'Sunday',
                    type: 'Recovery',
                    details: `${Math.max(3, easyMiles - 1)} miles very easy OR complete rest.`,
                    rest: null,
                    notes: 'ü´Ä BASE: Recover and absorb the week\'s training.'
                }
            ];
        }
        
        /**
         * STRENGTH PHASE: Lactate threshold, race-specific endurance, hill work
         */
        function buildStrengthPhaseWeek(paces, mileage, goalEvent, band, weekNum) {
            const easyMiles = Math.max(4, Math.round(mileage / 5.5));
            const longRun = Math.min(Math.round(mileage * 0.25), 13);
            const workoutMiles = Math.round(mileage * 0.13);
            
            return [
                {
                    day: 'Monday',
                    type: 'Speed Development',
                    details: getSpeedDevWorkout(band, weekNum) + ` Total: ${Math.round(easyMiles * 0.8)} miles including warm-up/cool-down.`,
                    rest: '3:00-5:00 full recovery',
                    notes: 'üí™ STRENGTH: Maintain neuromuscular speed while building strength.'
                },
                {
                    day: 'Tuesday',
                    type: 'Strength Intervals',
                    details: getStrengthPhaseIntervalWorkout(paces, goalEvent, band, weekNum, workoutMiles),
                    rest: '2:00-3:00 between reps, 4:00-5:00 between sets',
                    notes: 'üí™ STRENGTH: Building race-specific strength. Push through fatigue.'
                },
                {
                    day: 'Wednesday',
                    type: 'Easy Run',
                    details: `${easyMiles} miles at ${paces.easy} pace. Recovery from yesterday.`,
                    rest: null,
                    notes: 'üí™ STRENGTH: Recovery is where adaptation happens.'
                },
                {
                    day: 'Thursday',
                    type: 'Moderate + Hills',
                    details: `${easyMiles} miles with 6-8√ó20s hill sprints OR 4√ó90s hill repeats at hard effort. Full recovery between.`,
                    rest: 'Walk/jog back down',
                    notes: 'üí™ STRENGTH: Hills build specific strength without pounding.'
                },
                {
                    day: 'Friday',
                    type: 'Threshold + Speed Touch',
                    details: getStrengthPhaseThresholdWorkout(paces, goalEvent, band, weekNum, workoutMiles),
                    rest: '60-90s between tempo reps, 3:00 before speed',
                    notes: 'üí™ STRENGTH: Threshold with a speed kicker. Build the complete package.'
                },
                {
                    day: 'Saturday',
                    type: 'Long Run with Progression',
                    details: `${longRun} miles: First ${longRun - 2} miles at ${paces.easy}, last 2 miles at ${paces.tempo} pace.`,
                    rest: null,
                    notes: 'üí™ STRENGTH: Progressive long run builds mental and physical toughness.'
                },
                {
                    day: 'Sunday',
                    type: 'Recovery',
                    details: `${Math.max(3, easyMiles - 1)} miles very easy OR complete rest.`,
                    rest: null,
                    notes: 'üí™ STRENGTH: Big week - recover well.'
                }
            ];
        }
        
        /**
         * SPEED PHASE: Race-pace work, speed endurance, sharpening
         */
        function buildSpeedPhaseWeek(paces, mileage, goalEvent, band, weekNum) {
            const easyMiles = Math.max(4, Math.round(mileage / 5.5));
            const longRun = Math.min(Math.round(mileage * 0.23), 12);
            const workoutMiles = Math.round(mileage * 0.12);
            
            return [
                {
                    day: 'Monday',
                    type: 'Speed Development',
                    details: getSpeedDevWorkout(band, weekNum) + ` Total: ${Math.round(easyMiles * 0.8)} miles including warm-up/cool-down.`,
                    rest: '4:00-6:00 full recovery',
                    notes: '‚ö° SPEED: Pure speed work. Quality over quantity.'
                },
                {
                    day: 'Tuesday',
                    type: 'Goal-Pace Intervals',
                    details: getSpeedPhaseRacePaceWorkout(paces, goalEvent, band, weekNum, workoutMiles),
                    rest: '3:00-5:00 between reps (near full recovery)',
                    notes: '‚ö° SPEED: Race-specific speed. Hit your target times.'
                },
                {
                    day: 'Wednesday',
                    type: 'Easy Run',
                    details: `${easyMiles} miles at ${paces.easy} pace. Shake out the legs.`,
                    rest: null,
                    notes: '‚ö° SPEED: Easy days are sacred. Don\'t cheat recovery.'
                },
                {
                    day: 'Thursday',
                    type: 'Easy + Strides',
                    details: `${easyMiles} miles easy + 6√ó150m fast-relaxed strides. Full recovery between.`,
                    rest: '2:00-3:00 between strides',
                    notes: '‚ö° SPEED: Stay loose and quick. Prep for Friday.'
                },
                {
                    day: 'Friday',
                    type: 'Specific Workout',
                    details: getSpecificWorkout('Late', goalEvent, band, paces, weekNum) + ` Total: ${workoutMiles} miles including warm-up/cool-down.`,
                    rest: '2:00-4:00 between reps, 6:00-8:00 between sets',
                    notes: '‚ö° SPEED: Key session. Race simulation quality.'
                },
                {
                    day: 'Saturday',
                    type: 'Long Run',
                    details: `${longRun} miles at ${paces.easy} pace. Steady and controlled.`,
                    rest: null,
                    notes: '‚ö° SPEED: Maintain aerobic base. Don\'t sacrifice endurance for speed.'
                },
                {
                    day: 'Sunday',
                    type: 'Recovery',
                    details: `${Math.max(3, easyMiles - 1)} miles very easy OR complete rest.`,
                    rest: null,
                    notes: '‚ö° SPEED: Quality rest for quality speed.'
                }
            ];
        }
        
        /**
         * PEAK PHASE: Maintaining fitness, race simulation, reduced volume
         */
        function buildPeakPhaseWeek(paces, mileage, goalEvent, band, weekNum) {
            // Reduce mileage in peak phase
            const peakMileage = Math.round(mileage * 0.85);
            const easyMiles = Math.max(3, Math.round(peakMileage / 6));
            const longRun = Math.min(Math.round(peakMileage * 0.20), 10);
            const workoutMiles = Math.round(peakMileage * 0.10);
            
            return [
                {
                    day: 'Monday',
                    type: 'Easy + Strides',
                    details: `${easyMiles} miles easy + 4-6√ó100m strides. Relaxed and smooth.`,
                    rest: 'Full recovery between strides',
                    notes: 'üéØ PEAK: Keep legs fresh and quick. No grinding.'
                },
                {
                    day: 'Tuesday',
                    type: 'Sharpening Workout',
                    details: getPeakPhaseWorkout(paces, goalEvent, band, weekNum),
                    rest: '3:00-5:00 full recovery',
                    notes: 'üéØ PEAK: Short and sharp. Feel fast, not tired.'
                },
                {
                    day: 'Wednesday',
                    type: 'Easy Run',
                    details: `${easyMiles} miles at ${paces.easy} pace. Recover and stay loose.`,
                    rest: null,
                    notes: 'üéØ PEAK: Easy means easy. Trust your fitness.'
                },
                {
                    day: 'Thursday',
                    type: 'Primer',
                    details: getPrimerWorkout(goalEvent, paces) + ` Total: ${Math.round(workoutMiles * 0.8)} miles including warm-up/cool-down.`,
                    rest: '2:30-4:00 full recovery',
                    notes: 'üéØ PEAK: Activate race systems. Quality > volume.'
                },
                {
                    day: 'Friday',
                    type: 'Easy or Rest',
                    details: `${Math.max(2, easyMiles - 1)} miles easy OR complete rest. Your choice.`,
                    rest: null,
                    notes: 'üéØ PEAK: Listen to your body. Fresh legs win races.'
                },
                {
                    day: 'Saturday',
                    type: 'Long Run',
                    details: `${longRun} miles at ${paces.easy} pace. Maintain aerobic fitness.`,
                    rest: null,
                    notes: 'üéØ PEAK: Steady effort. Maintain base while staying fresh.'
                },
                {
                    day: 'Sunday',
                    type: 'Recovery',
                    details: `${Math.max(2, easyMiles - 1)} miles very easy OR complete rest.`,
                    rest: null,
                    notes: 'üéØ PEAK: Recover and reset for next week.'
                }
            ];
        }
        
        // Helper functions for phase-specific workouts
        
        function getBasePhaseAerobicWorkout(paces, band, weekNum, targetMiles) {
            const workouts = [
                `5-6√ó1000m in ${paces.rep1000_threshold} each (threshold). 60-90s jog recovery. Total: ${targetMiles} miles.`,
                `3√ómile in ${paces.tempo} pace (tempo effort). 2:00 jog recovery. Total: ${targetMiles} miles.`,
                `8√ó800m in ${paces.rep800_5k} each (5K effort). 60s jog recovery. Total: ${targetMiles} miles.`,
                `4√ó1200m at ${paces.tempo} pace. 90s jog recovery. Total: ${targetMiles} miles.`
            ];
            return workouts[weekNum % workouts.length];
        }
        
        function getBasePhaseTempoWorkout(paces, band, weekNum, targetMiles) {
            const workouts = [
                `20-25 min continuous tempo at ${paces.tempo} pace. Total: ${targetMiles} miles.`,
                `3√ó10 min at ${paces.tempo} pace. 2:00 jog recovery. Total: ${targetMiles} miles.`,
                `4√ó8 min cruise intervals at ${paces.tempo} pace. 90s jog recovery. Total: ${targetMiles} miles.`,
                `15 min tempo + 4√ó200m in ${paces.rep200_mile}. 2:00 rest before 200s. Total: ${targetMiles} miles.`
            ];
            return workouts[weekNum % workouts.length];
        }
        
        function getStrengthPhaseIntervalWorkout(paces, goalEvent, band, weekNum, targetMiles) {
            if (goalEvent === '800') {
                const workouts = [
                    `3√ó(600-400) at 800-1500 effort: 600s in ${paces.rep600_mile}, 400s in ${paces.rep400_800}. 2:00 between, 5:00 sets. Total: ${targetMiles} miles.`,
                    `5√ó500m in ${paces.rep500_mile}. 2:30 recovery. Building 800 strength. Total: ${targetMiles} miles.`,
                    `2√ó3√ó400 in ${paces.rep400_mile} (90s rest), 4:00 between sets. Total: ${targetMiles} miles.`
                ];
                return workouts[weekNum % workouts.length];
            } else if (goalEvent === '1500') {
                const workouts = [
                    `4√ó800m in ${paces.rep800_3k} (3K effort). 2:30 recovery. Total: ${targetMiles} miles.`,
                    `3√ó1000m in ${paces.rep1000_3k}. 2:30-3:00 recovery. Total: ${targetMiles} miles.`,
                    `6√ó600m in ${paces.rep600_mile} (mile effort). 2:00 recovery. Total: ${targetMiles} miles.`
                ];
                return workouts[weekNum % workouts.length];
            } else {
                const workouts = [
                    `5√ó1000m in ${paces.rep1000_5k} (5K effort). 2:00 recovery. Total: ${targetMiles} miles.`,
                    `3√ó1200m in ${paces.rep1000_3k}. 2:30-3:00 recovery. Total: ${targetMiles} miles.`,
                    `4√ómile at ${paces.tempo} to 5K pace, descending. 2:30 recovery. Total: ${targetMiles} miles.`
                ];
                return workouts[weekNum % workouts.length];
            }
        }
        
        function getStrengthPhaseThresholdWorkout(paces, goalEvent, band, weekNum, targetMiles) {
            const workouts = [
                `15 min tempo at ${paces.tempo} + 4√ó200m in ${paces.rep200_mile} (3:00 rest). Total: ${targetMiles} miles.`,
                `3√ó8 min at ${paces.tempo} (2:00 jog) + 3√ó150m fast-relaxed (3:00 rest). Total: ${targetMiles} miles.`,
                `2√ómile at ${paces.tempo} (2:30 rest) + 4√ó300m in ${paces.rep300_mile} (2:00 rest). Total: ${targetMiles} miles.`
            ];
            return workouts[weekNum % workouts.length];
        }
        
        function getSpeedPhaseRacePaceWorkout(paces, goalEvent, band, weekNum, targetMiles) {
            if (goalEvent === '800') {
                const workouts = [
                    `6√ó300m in ${paces.rep300_800} (800 pace). 3:00-4:00 full recovery. Total: ${targetMiles} miles.`,
                    `4√ó400m in ${paces.rep400_800}. 4:00-5:00 full recovery. Race simulation. Total: ${targetMiles} miles.`,
                    `2√ó(300-200-100) at 800 pace: ${paces.rep300_800}/${paces.rep200_800}. Full recovery between all. Total: ${targetMiles} miles.`
                ];
                return workouts[weekNum % workouts.length];
            } else if (goalEvent === '1500') {
                const workouts = [
                    `5√ó400m in ${paces.rep400_mile} (mile pace). 3:00-4:00 full recovery. Total: ${targetMiles} miles.`,
                    `4√ó500m in ${paces.rep500_mile}. 3:30-4:00 recovery. Total: ${targetMiles} miles.`,
                    `3√ó600m in ${paces.rep600_mile} + 3√ó200m in ${paces.rep200_800}. 4:00 recovery. Total: ${targetMiles} miles.`
                ];
                return workouts[weekNum % workouts.length];
            } else {
                const workouts = [
                    `5√ó800m in ${paces.rep800_3k} (3K pace). 2:30-3:00 recovery. Total: ${targetMiles} miles.`,
                    `4√ó1000m in ${paces.rep1000_3k}. 3:00 recovery. Race simulation. Total: ${targetMiles} miles.`,
                    `6√ó600m in ${paces.rep600_3k} + 2√ó200m fast. 2:30 recovery. Total: ${targetMiles} miles.`
                ];
                return workouts[weekNum % workouts.length];
            }
        }
        
        function getPeakPhaseWorkout(paces, goalEvent, band, weekNum) {
            if (goalEvent === '800') {
                const workouts = [
                    `4√ó200m in ${paces.rep200_800}. 3:00-4:00 full recovery. Feel fast.`,
                    `2√ó300m in ${paces.rep300_800} + 2√ó150m fast-relaxed. Full recovery.`,
                    `3√ó(200-100) at 800 pace. 3:00 between reps, 5:00 between sets.`
                ];
                return workouts[weekNum % workouts.length];
            } else if (goalEvent === '1500') {
                const workouts = [
                    `4√ó300m in ${paces.rep300_mile}. 3:00-4:00 full recovery. Stay sharp.`,
                    `3√ó400m in ${paces.rep400_mile}. 4:00 full recovery.`,
                    `2√ó500m in ${paces.rep500_mile} + 2√ó200m fast. Full recovery.`
                ];
                return workouts[weekNum % workouts.length];
            } else {
                const workouts = [
                    `4√ó400m in ${paces.rep400_3k}. 3:00 recovery. Controlled speed.`,
                    `3√ó600m in ${paces.rep600_3k}. 3:00-4:00 recovery.`,
                    `2√ó800m in ${paces.rep800_3k} + 2√ó200m fast. 3:00 recovery.`
                ];
                return workouts[weekNum % workouts.length];
            }
        }
        
        /**
         * Build an easy introduction week - focus on aerobic base and strides only
         */
        function buildIntroductionWeek(paces, mileage, goalEvent, weekNum) {
            const easyMiles = Math.max(3, Math.round(mileage / 5));
            const longRun = Math.max(4, Math.round(mileage * 0.22));
            
            return [
                {
                    day: 'Monday',
                    type: 'Easy + Strides',
                    details: `${easyMiles} miles easy at ${paces.easy} pace + 4-6√ó100m strides (relaxed, not timed). Walk back recovery.`,
                    rest: 'Full recovery between strides',
                    notes: 'üå± Intro week: Focus on feeling smooth. No hard efforts yet.'
                },
                {
                    day: 'Tuesday',
                    type: 'Easy Run',
                    details: `${easyMiles} miles at ${paces.easy} pace. Relaxed and conversational.`,
                    rest: null,
                    notes: 'üå± Building consistency. Keep it comfortable.'
                },
                {
                    day: 'Wednesday',
                    type: 'Rest or Cross-Train',
                    details: `Complete rest OR 20-30 min easy cross-training (bike, swim, elliptical).`,
                    rest: null,
                    notes: 'üå± Recovery is part of training. Listen to your body.'
                },
                {
                    day: 'Thursday',
                    type: 'Easy + Drills',
                    details: `${easyMiles} miles easy + running drills (high knees, butt kicks, skips). No watch-checking.`,
                    rest: null,
                    notes: 'üå± Focus on form and feeling good.'
                },
                {
                    day: 'Friday',
                    type: 'Easy Run or Rest',
                    details: `${Math.max(2, easyMiles - 1)} miles easy OR complete rest.`,
                    rest: null,
                    notes: 'üå± Your choice based on how you feel.'
                },
                {
                    day: 'Saturday',
                    type: 'Long Run (Easy)',
                    details: `${longRun} miles at comfortable ${paces.easy} pace. Don't push it.`,
                    rest: null,
                    notes: 'üå± Just get the time on your feet. Walk breaks OK if needed.'
                },
                {
                    day: 'Sunday',
                    type: 'Rest',
                    details: `Complete rest. No running.`,
                    rest: null,
                    notes: 'üå± Full recovery day. You earned it!'
                }
            ];
        }
        
        /**
         * Build a building/moderate week - some quality but not full intensity
         */
        function buildBuildingWeek(paces, mileage, goalEvent, season, band, weekNum, isRaceWeek) {
            const easyMiles = Math.max(3, Math.round(mileage / 6));
            const longRun = Math.max(5, Math.round(mileage * 0.23));
            const workoutMiles = Math.round(mileage * 0.10); // Slightly less than full
            
            return [
                {
                    day: 'Monday',
                    type: 'Easy + Strides',
                    details: `${easyMiles} miles easy at ${paces.easy} pace + 6√ó100m strides (smooth, controlled). Walk back recovery.`,
                    rest: 'Full recovery between strides',
                    notes: 'üìà Building week: Strides awaken fast-twitch without fatigue.'
                },
                {
                    day: 'Tuesday',
                    type: 'Tempo Introduction',
                    details: `${workoutMiles} miles total: 1.5mi warm-up, 12-15 min @ ${paces.tempo} pace (comfortably hard), 1mi cool-down.`,
                    rest: null,
                    notes: 'üìà First quality session. Should feel controlled, not maximal.'
                },
                {
                    day: 'Wednesday',
                    type: 'Easy Run',
                    details: `${easyMiles} miles at ${paces.easy} pace. Recovery day.`,
                    rest: null,
                    notes: 'üìà Keep it genuinely easy after yesterday.'
                },
                {
                    day: 'Thursday',
                    type: 'Easy + Drills',
                    details: `${easyMiles} miles easy + form drills. Light day before tomorrow.`,
                    rest: null,
                    notes: 'üìà Stay loose and relaxed.'
                },
                {
                    day: 'Friday',
                    type: 'Light Speed Work',
                    details: `${workoutMiles} miles total: Warm-up + 6-8√ó200m at ${paces.rep200_mile} (mile effort) with 200m jog recovery. Cool-down.`,
                    rest: '200m jog between reps (~90 seconds)',
                    notes: 'üìà Introduce some speed. Focus on smooth mechanics, not times.'
                },
                {
                    day: 'Saturday',
                    type: 'Long Run',
                    details: `${longRun} miles at ${paces.easy} pace. Steady effort.`,
                    rest: null,
                    notes: 'üìà Building aerobic base. Consistent pace throughout.'
                },
                {
                    day: 'Sunday',
                    type: 'Recovery',
                    details: `${Math.max(2, easyMiles - 1)} miles very easy OR complete rest.`,
                    rest: null,
                    notes: 'üìà Active recovery or full rest - your call.'
                }
            ];
        }

        /**
         * Calculate training phases for the plan
         * Phases: Ramp-Up ‚Üí Base ‚Üí Strength ‚Üí Speed ‚Üí Peak
         */
        function calculateTrainingPhases(totalWeeks, rampUpWeeks, raceSchedule) {
            const trainingWeeks = totalWeeks - rampUpWeeks;
            
            // If very short plan after ramp-up, just use simplified phases
            if (trainingWeeks <= 2) {
                return {
                    base: { start: rampUpWeeks + 1, end: rampUpWeeks + 1 },
                    strength: { start: rampUpWeeks + 1, end: rampUpWeeks + 1 },
                    speed: { start: rampUpWeeks + 2, end: totalWeeks },
                    peak: { start: totalWeeks, end: totalWeeks }
                };
            }
            
            // Standard phase distribution (percentage of training weeks after ramp-up)
            // Base: 30%, Strength: 25%, Speed: 30%, Peak: 15%
            const baseWeeks = Math.max(1, Math.round(trainingWeeks * 0.30));
            const strengthWeeks = Math.max(1, Math.round(trainingWeeks * 0.25));
            const peakWeeks = Math.max(1, Math.round(trainingWeeks * 0.15));
            const speedWeeks = Math.max(1, trainingWeeks - baseWeeks - strengthWeeks - peakWeeks);
            
            const baseStart = rampUpWeeks + 1;
            const baseEnd = rampUpWeeks + baseWeeks;
            const strengthStart = baseEnd + 1;
            const strengthEnd = strengthStart + strengthWeeks - 1;
            const speedStart = strengthEnd + 1;
            const speedEnd = speedStart + speedWeeks - 1;
            const peakStart = speedEnd + 1;
            const peakEnd = totalWeeks;
            
            return {
                base: { start: baseStart, end: baseEnd, weeks: baseWeeks },
                strength: { start: strengthStart, end: strengthEnd, weeks: strengthWeeks },
                speed: { start: speedStart, end: speedEnd, weeks: speedWeeks },
                peak: { start: peakStart, end: peakEnd, weeks: peakWeeks }
            };
        }
        
        /**
         * Determine the training phase for a specific week
         */
        function determinePhase(weekNum, totalWeeks, weekStart, raceSchedule, rampUpWeeks = 0, phases = null) {
            // Check for race in this week first (overrides phase)
            const raceInWeek = raceSchedule.find(race => {
                const raceDate = new Date(race.date);
                const daysDiff = Math.floor((raceDate - weekStart) / (1000 * 60 * 60 * 24));
                return daysDiff >= 0 && daysDiff < 7;
            });

            if (raceInWeek) {
                const labels = {
                    'A': `üèÅ Taper - ${raceInWeek.distance} TARGET`,
                    'B': `üèÅ ${raceInWeek.distance} B Race`,
                    'C': `üèÅ Training Week (${raceInWeek.distance} tune-up)`
                };
                return {
                    phase: 'race',
                    season: 'Late',
                    label: labels[raceInWeek.priority],
                    description: raceInWeek.priority === 'A' ? 'Peak week - reduce volume, maintain sharpness' : 
                                raceInWeek.priority === 'B' ? 'Light taper week' : 'Normal training, race as workout',
                    raceWeek: true,
                    icon: 'üèÅ',
                    color: 'var(--warning)'
                };
            }
            
            // Check if in ramp-up period
            if (weekNum <= rampUpWeeks) {
                return {
                    phase: 'rampup',
                    season: 'Early',
                    label: 'Ramp-Up Phase',
                    description: 'Building consistency and preparing body for full training',
                    raceWeek: false,
                    icon: 'üå±',
                    color: 'var(--accent)'
                };
            }
            
            // Use phases if provided, otherwise calculate based on position
            if (phases) {
                if (weekNum <= phases.base.end) {
                    return {
                        phase: 'base',
                        season: 'Early',
                        label: 'Base Building',
                        description: 'Aerobic development, threshold work, building the engine',
                        raceWeek: false,
                        icon: 'ü´Ä',
                        color: 'var(--accent)'
                    };
                } else if (weekNum <= phases.strength.end) {
                    return {
                        phase: 'strength',
                        season: 'Mid',
                        label: 'Strength & Stamina',
                        description: 'Lactate threshold, race-specific endurance, longer intervals',
                        raceWeek: false,
                        icon: 'üí™',
                        color: 'var(--warning)'
                    };
                } else if (weekNum <= phases.speed.end) {
                    return {
                        phase: 'speed',
                        season: 'Mid',
                        label: 'Speed Development',
                        description: 'Race-pace work, speed endurance, neuromuscular power',
                        raceWeek: false,
                        icon: '‚ö°',
                        color: 'var(--primary)'
                    };
                } else {
                    return {
                        phase: 'peak',
                        season: 'Late',
                        label: 'Peak & Competition',
                        description: 'Maintaining fitness, race simulation, staying sharp',
                        raceWeek: false,
                        icon: 'üéØ',
                        color: 'var(--danger)'
                    };
                }
            }
            
            // Fallback: simple percentage-based phases
            const percentThrough = weekNum / totalWeeks;
            if (percentThrough < 0.35) {
                return { phase: 'base', season: 'Early', label: 'Base Building', description: 'Aerobic development, threshold work', raceWeek: false, icon: 'ü´Ä', color: 'var(--accent)' };
            } else if (percentThrough < 0.60) {
                return { phase: 'strength', season: 'Mid', label: 'Strength & Stamina', description: 'Building race-specific fitness', raceWeek: false, icon: 'üí™', color: 'var(--warning)' };
            } else if (percentThrough < 0.85) {
                return { phase: 'speed', season: 'Mid', label: 'Speed Development', description: 'Race-pace work, sharpening', raceWeek: false, icon: '‚ö°', color: 'var(--primary)' };
            } else {
                return { phase: 'peak', season: 'Late', label: 'Peak & Competition', description: 'Maintaining fitness, racing sharp', raceWeek: false, icon: 'üéØ', color: 'var(--danger)' };
            }
        }

        function calculateMileageProgression(start, goal, weeks) {
            const progression = [];
            const increment = (goal - start) / (weeks - 1);
            
            for (let i = 0; i < weeks; i++) {
                let weekMileage = start + (increment * i);
                if ((i + 1) % 4 === 0 && i > 0) {
                    weekMileage *= 0.9;
                }
                progression.push(Math.round(weekMileage));
            }
            
            return progression;
        }

        function setupWeekSelector(totalWeeks) {
            const selector = document.getElementById('weekSelector');
            const dropdown = document.getElementById('weekDropdown');
            
            selector.style.display = 'block';
            dropdown.innerHTML = '';
            
            for (let i = 0; i < totalWeeks; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Week ${i + 1}`;
                dropdown.appendChild(option);
            }
        }

        function changeWeek() {
            const selectedIndex = parseInt(document.getElementById('weekDropdown').value);
            displaySelectedWeek(selectedIndex);
        }

        function displaySelectedWeek(weekIndex) {
            const weekData = allWeeksData[weekIndex];
            if (!weekData) return;
            
            // Calculate total weekly mileage from workouts
            let totalMileage = 0;
            weekData.workouts.forEach(w => {
                const mileMatch = w.details.match(/(\d+(?:\.\d+)?)\s*miles/);
                if (mileMatch) {
                    totalMileage += parseFloat(mileMatch[1]);
                }
            });
            
            // Check if any workouts were adapted
            const hasAdaptations = weekData.workouts.some(w => w.adapted);
            
            // Determine phase styling
            const phaseInfo = weekData.phaseInfo || { icon: 'üìã', color: 'var(--primary)' };
            const phaseClass = weekData.season === 'Early' ? 'phase-early' : 
                              weekData.season === 'Mid' ? 'phase-mid' : 'phase-late';
            
            // Build ramp-up indicator if this is a ramp-up week
            let rampUpIndicator = '';
            if (weekData.isRampUpWeek && weekData.intensityInfo) {
                const loadPercent = Math.round(weekData.weekMultiplier * 100);
                rampUpIndicator = `
                    <div style="background: rgba(16,185,129,0.15); border: 1px solid var(--accent); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                            <span style="font-size: 1.5rem;">üå±</span>
                            <div>
                                <strong style="color: var(--accent);">Ramp-Up Week (${loadPercent}% Load)</strong>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">${weekData.intensityInfo.description}</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; background: var(--bg-elevated); border-radius: 6px; height: 8px; overflow: hidden;">
                            <div style="width: ${loadPercent}%; height: 100%; background: linear-gradient(90deg, var(--accent), var(--primary)); border-radius: 6px; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            }
            
            // Build phase indicator for non-ramp-up weeks
            let phaseIndicator = '';
            if (!weekData.isRampUpWeek && weekData.phaseInfo && weekData.phaseInfo.phase !== 'race') {
                phaseIndicator = `
                    <div style="background: rgba(99,102,241,0.1); border: 1px solid ${phaseInfo.color}; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                            <span style="font-size: 1.5rem;">${phaseInfo.icon}</span>
                            <div>
                                <strong style="color: ${phaseInfo.color};">${weekData.label}</strong>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">${weekData.description}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            let html = `
                <div style="margin-bottom: 32px; border: 1px solid var(--border); border-radius: 12px; padding: 20px; background: var(--bg-elevated);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                        <span class="phase-badge ${phaseClass}">${weekData.season.toUpperCase()}</span>
                        ${weekData.raceWeek ? '<span style="background: rgba(245,158,11,0.2); color: var(--warning); padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">RACE WEEK</span>' : ''}
                        <span id="weekDateRange${weekData.weekNumber}" style="background: var(--bg-dark); color: var(--text-muted); padding: 4px 10px; border-radius: 12px; font-size: 0.75rem;">üìÖ</span>
                    </div>
                    <h3 style="color: var(--text-primary); margin-bottom: 8px; font-size: 1.2rem; font-weight: 600;">
                        ${phaseInfo.icon} Week ${weekData.weekNumber}: ${weekData.label}
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;">
                        Target: ${weekData.mileage} miles | Actual: ~${Math.round(totalMileage)} miles
                    </p>
                    ${rampUpIndicator}
                    ${phaseIndicator}
                    ${hasAdaptations ? `
                        <div style="background: rgba(245,158,11,0.15); border: 1px solid var(--warning); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                            <strong style="color: var(--warning);">‚ö° Adapted Training:</strong> 
                            Some workouts have been automatically adjusted based on your feedback.
                            <button class="regenerate-week-btn" onclick="resetWeekToOriginal(${weekData.weekNumber})" style="margin-left: 12px; display: inline; padding: 6px 12px; font-size: 0.8rem;">
                                üîÑ Reset Week to Original
                            </button>
                        </div>
                    ` : ''}
            `;
            
            weekData.workouts.forEach((w, idx) => {
                const feedbackKey = `week${weekData.weekNumber}-${w.day}`;
                const hasFeedback = workoutFeedback[feedbackKey];
                const indicator = getFeedbackIndicator(weekData.weekNumber, w.day);
                
                html += `
                    <div class="workout-item ${w.adapted ? 'adapted' : ''}" style="margin-bottom: 10px; animation-delay: ${idx * 0.05}s;">
                        <div class="workout-day">${indicator}${w.day}${w.adapted ? ' <span style="color: var(--warning); font-size: 0.75rem;">‚ö° ADAPTED</span>' : ''}</div>
                        <div class="workout-type">${w.type}</div>
                        <div class="workout-details">${w.details}</div>
                        ${w.rest ? `<div class="workout-rest">Rest: ${w.rest}</div>` : ''}
                        ${w.notes ? `<div class="workout-notes">üìù ${w.notes}</div>` : ''}
                        ${hasFeedback ? 
                            `<div style="margin-top: 8px; padding: 10px; background: rgba(16,185,129,0.1); border: 1px solid var(--success); border-radius: 6px; font-size: 0.85rem;">
                                <strong style="color: var(--success);">‚úì Feedback recorded:</strong> Effort ${hasFeedback.effort}/10, ${hasFeedback.completion === 'full' ? 'Completed' : hasFeedback.completion}
                                ${hasFeedback.notes ? `<br><span style="color: var(--text-secondary);">"${hasFeedback.notes}"</span>` : ''}
                                ${hasFeedback.distance || hasFeedback.avgHR || hasFeedback.sleepHours ? 
                                    `<br><span style="color: var(--text-muted); font-size: 0.8rem;">
                                        ${hasFeedback.distance ? `üìè ${hasFeedback.distance}mi` : ''} 
                                        ${hasFeedback.avgPace ? `‚è±Ô∏è ${hasFeedback.avgPace}/mi` : ''}
                                        ${hasFeedback.avgHR ? `‚ù§Ô∏è ${hasFeedback.avgHR}bpm` : ''} 
                                        ${hasFeedback.sleepHours ? `üò¥ ${hasFeedback.sleepHours}hrs` : ''}
                                    </span>` : ''}
                            </div>` : ''}
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button class="feedback-btn ${hasFeedback ? 'completed' : ''}" 
                                    onclick="openFeedbackModal(${weekData.weekNumber}, '${w.day}', '${w.type.replace(/'/g, "\\'")}')">
                                ${hasFeedback ? '‚úì Edit Feedback' : '+ Add Feedback'}
                            </button>
                            ${hasFeedback ? `
                                <button class="feedback-btn" style="background: var(--bg-elevated); border: 1px solid var(--primary); color: var(--primary);"
                                        onclick="openMetricsModal(${weekData.weekNumber}, '${w.day}', '${w.type.replace(/'/g, "\\'")}')">
                                    üìä Metrics
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            document.getElementById('workoutList').innerHTML = html;
            
            // Calculate and display week dates
            var planStartDate = null;
            var startDateEl = document.getElementById('templateStartDate');
            if (startDateEl && startDateEl.value) {
                planStartDate = new Date(startDateEl.value + 'T00:00:00');
            } else if (currentPlanData && currentPlanData.startDate) {
                planStartDate = new Date(currentPlanData.startDate + 'T00:00:00');
            }
            
            if (planStartDate) {
                var weekStartDate = new Date(planStartDate);
                weekStartDate.setDate(weekStartDate.getDate() + ((weekData.weekNumber - 1) * 7));
                var weekEndDate = new Date(weekStartDate);
                weekEndDate.setDate(weekEndDate.getDate() + 6);
                var dateRangeEl = document.getElementById('weekDateRange' + weekData.weekNumber);
                if (dateRangeEl) {
                    dateRangeEl.textContent = 'üìÖ ' + formatDateShort(weekStartDate) + ' - ' + formatDateShort(weekEndDate);
                }
            }
        }

        function resetWeekToOriginal(weekNum) {
            const weekIndex = allWeeksData.findIndex(w => w.weekNumber === weekNum);
            if (weekIndex === -1) return;
            
            const weekData = allWeeksData[weekIndex];
            
            // Reset all workouts to original
            weekData.workouts.forEach(w => {
                if (w.originalDetails) {
                    w.details = w.originalDetails;
                    w.type = w.type.replace('‚ö†Ô∏è ADAPTED: ', '').replace(' ‚Üí Easy', '');
                    // Clean up notes
                    if (w.notes) {
                        w.notes = w.notes
                            .replace(/üîÑ AUTO-ADJUSTED:.*?\./g, '')
                            .replace(/‚úì Maintaining plan.*?\./g, '')
                            .replace(/üìà Last workout.*?\./g, '')
                            .trim();
                    }
                    w.adapted = false;
                    delete w.originalDetails;
                }
            });
            
            // Refresh display
            const currentWeek = parseInt(document.getElementById('weekDropdown')?.value || 0);
            displaySelectedWeek(currentWeek);
            
            // Show notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 217, 255, 0.95);
                color: white;
                padding: 16px 20px;
                border-radius: 12px;
                border: 2px solid var(--accent);
                z-index: 2000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = '‚úì Week ${weekNum} reset to original plan';
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function resetApp() {
            document.getElementById('workoutPlan').classList.remove('active');
            document.getElementById('dataInput').style.display = 'block';
        }
        
        console.log('=== SCRIPT LOADING COMPLETED ===');
        console.log('generatePlan function exists:', typeof generatePlan);
        console.log('All functions loaded successfully');
        
        // Mobile navigation functions
        let currentCalendarMonth = new Date();
        let userProfile = {};
        
        function showActivePlan() {
            document.getElementById('activePlanView').style.display = 'block';
            document.getElementById('savedPlansView').style.display = 'none';
            
            // Update button styling
            document.getElementById('activePlanTab').style.background = 'linear-gradient(135deg, var(--primary), #FF6B00)';
            document.getElementById('activePlanTab').style.border = 'none';
            document.getElementById('activePlanTab').style.color = 'var(--text-primary)';
            
            document.getElementById('savedPlansListTab').style.background = 'rgba(0,217,255,0.2)';
            document.getElementById('savedPlansListTab').style.border = '2px solid var(--accent)';
            document.getElementById('savedPlansListTab').style.color = 'var(--accent)';
        }
        
        function showSavedPlansList() {
            document.getElementById('activePlanView').style.display = 'none';
            document.getElementById('savedPlansView').style.display = 'block';
            
            // Update button styling
            document.getElementById('savedPlansListTab').style.background = 'linear-gradient(135deg, var(--accent), var(--success))';
            document.getElementById('savedPlansListTab').style.border = 'none';
            document.getElementById('savedPlansListTab').style.color = 'var(--bg-card)';
            
            document.getElementById('activePlanTab').style.background = 'rgba(255,77,0,0.2)';
            document.getElementById('activePlanTab').style.border = '2px solid var(--primary)';
            document.getElementById('activePlanTab').style.color = 'var(--primary)';
            
            // Refresh saved plans list
            updateSavedPlansList();
        }
        
        // Load user profile from localStorage
        window.addEventListener('load', () => {
            // Move dataInput into createPlanPage
            const createPlanPage = document.getElementById('createPlanPage');
            const dataInput = document.getElementById('dataInput');
            if (createPlanPage && dataInput) {
                createPlanPage.appendChild(dataInput);
            }
            
            const saved = localStorage.getItem('laktic_feedback');
            if (saved) {
                workoutFeedback = JSON.parse(saved);
            }
            
            const plans = localStorage.getItem('laktic_saved_plans');
            if (plans) {
                savedPlans = JSON.parse(plans);
            }
            
            // Load profile
            const profile = localStorage.getItem('laktic_user_profile');
            if (profile) {
                userProfile = JSON.parse(profile);
                loadProfileData();
            }
            
            // Show saved plans if any exist
            if (Object.keys(savedPlans).length > 0) {
                showLoadPlansOption();
            }
            
            // Check if there's an active plan and load it automatically
            const activePlanId = localStorage.getItem('laktic_active_plan_id');
            if (activePlanId && savedPlans[activePlanId]) {
                console.log('Loading active plan on startup:', activePlanId);
                loadPlan(activePlanId);
            }
            
            // Add event listener for no races checkbox
            const noRacesCheckbox = document.getElementById('noRacesCheckbox');
            if (noRacesCheckbox) {
                noRacesCheckbox.addEventListener('change', function() {
                    toggleRaceInputs(this.checked);
                });
            }
        });
        
        function saveProfile() {
            userProfile = {
                name: document.getElementById('profileName')?.value || '',
                age: document.getElementById('profileAge')?.value || '',
                gender: document.getElementById('profileGender')?.value || '',
                height: document.getElementById('profileHeight')?.value || '',
                weight: document.getElementById('profileWeight')?.value || '',
                restingHR: document.getElementById('profileRestingHR')?.value || '',
                maxHR: document.getElementById('profileMaxHR')?.value || '',
                pr800m: document.getElementById('pr800m')?.value || '',
                pr1600m: document.getElementById('pr1600m')?.value || '',
                pr3200m: document.getElementById('pr3200m')?.value || '',
                pr5000m: document.getElementById('pr5000m')?.value || ''
            };
            localStorage.setItem('laktic_user_profile', JSON.stringify(userProfile));
            localStorage.setItem('laktic_profile', JSON.stringify(userProfile)); // Also save as laktic_profile for pattern analysis
        }
        
        function loadProfileData() {
            if (document.getElementById('profileName')) {
                document.getElementById('profileName').value = userProfile.name || '';
                document.getElementById('profileAge').value = userProfile.age || '';
                document.getElementById('profileGender').value = userProfile.gender || '';
                document.getElementById('profileHeight').value = userProfile.height || '';
                document.getElementById('profileWeight').value = userProfile.weight || '';
                document.getElementById('profileRestingHR').value = userProfile.restingHR || '';
                document.getElementById('profileMaxHR').value = userProfile.maxHR || '';
                document.getElementById('pr800m').value = userProfile.pr800m || '';
                document.getElementById('pr1600m').value = userProfile.pr1600m || '';
                document.getElementById('pr3200m').value = userProfile.pr3200m || '';
                document.getElementById('pr5000m').value = userProfile.pr5000m || '';
                
                // Calculate HR zones if data exists
                if (userProfile.restingHR && userProfile.maxHR) {
                    calculateHRZones();
                }
            }
            updateProfileStats();
            
            // Update role/team UI (always call to show correct UI state)
            updateRoleUI();
        }
        
        function updateProfileStats() {
            const statsDiv = document.getElementById('profileStats');
            if (!statsDiv) return;
            
            if (!currentPlanData) {
                statsDiv.innerHTML = '';
                return;
            }
            
            const eventLabel = currentPlanData.goalEvent === '800' ? '800m' : 
                              currentPlanData.goalEvent === '1500' ? '1500m/Mile' : '3200m/3K';
            
            let html = '<div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid rgba(255,77,0,0.3);">';
            html += '<h3 style="color: var(--accent); margin-bottom: 16px; font-size: 1.1rem;">Current Training Plan</h3>';
            
            html += `<div class="profile-stat-card">
                <span class="profile-stat-label">Goal Event</span>
                <span class="profile-stat-value">${eventLabel}</span>
            </div>`;
            
            html += `<div class="profile-stat-card">
                <span class="profile-stat-label">VDOT</span>
                <span class="profile-stat-value">${currentPlanData.vdot}</span>
            </div>`;
            
            html += `<div class="profile-stat-card">
                <span class="profile-stat-label">Weekly Mileage</span>
                <span class="profile-stat-value">${currentPlanData.currentMileage}-${currentPlanData.goalMileage} mpw</span>
            </div>`;
            
            html += `<div class="profile-stat-card">
                <span class="profile-stat-label">Plan Duration</span>
                <span class="profile-stat-value">${allWeeksData.length} weeks</span>
            </div>`;
            
            // Training Paces
            html += `<h3 style="color: var(--accent); margin: 24px 0 16px 0; font-size: 1.1rem;">Training Paces</h3>`;
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">';
            html += `<div style="background: rgba(255,77,0,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.75rem; color: var(--text-muted);">Easy</div>
                <div style="font-weight: bold; color: var(--primary);">${currentPlanData.paces.easy}</div>
            </div>`;
            html += `<div style="background: rgba(255,77,0,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.75rem; color: var(--text-muted);">Threshold</div>
                <div style="font-weight: bold; color: var(--primary);">${currentPlanData.paces.threshold}</div>
            </div>`;
            html += `<div style="background: rgba(255,77,0,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.75rem; color: var(--text-muted);">Interval</div>
                <div style="font-weight: bold; color: var(--primary);">${currentPlanData.paces.interval}</div>
            </div>`;
            html += `<div style="background: rgba(255,77,0,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.75rem; color: var(--text-muted);">Mile Pace</div>
                <div style="font-weight: bold; color: var(--primary);">${currentPlanData.paces.milePace}</div>
            </div>`;
            html += '</div></div>';
            
            statsDiv.innerHTML = html;
        }
        
        function switchPage(pageId) {
            // Hide all pages - both remove class AND set display none
            document.querySelectorAll('.app-page').forEach(function(page) {
                page.classList.remove('active');
                page.style.display = 'none';
            });
            
            // Show selected page - both add class AND set display block
            var targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                targetPage.style.display = 'block';
            }
            
            // Update nav active state based on pageId
            document.querySelectorAll('.nav-item').forEach(function(item) {
                item.classList.remove('active');
            });
            
            // Map pageId to nav item index
            var navMap = {
                'homePage': 0,
                'todayPage': 1,
                'myPlansPage': 2,
                'calendarPage': 3,
                'profilePage': 4,
                'coachPage': 1, // Coach chat uses Today tab
                'teamPage': 4, // Team page highlights Profile tab
                'createPlanPage': 2 // Create uses Plans tab
            };
            
            var navIndex = navMap[pageId];
            if (navIndex !== undefined) {
                var navItems = document.querySelectorAll('.nav-item');
                if (navItems[navIndex]) {
                    navItems[navIndex].classList.add('active');
                }
            }
            
            // Load page-specific content
            if (pageId === 'createPlanPage') {
                // Always show the input form when going to Create page
                document.getElementById('dataInput').style.display = 'block';
                // Initialize coach plan creation if coach with roster
                initCoachPlanCreation();
            } else if (pageId === 'todayPage') {
                initTodayPage();
            } else if (pageId === 'coachPage') {
                initCoachPage();
            } else if (pageId === 'teamPage') {
                initTeamDashboard();
            } else if (pageId === 'myPlanPage') {
                updateMyPlanPage();
            } else if (pageId === 'calendarPage') {
                updateCalendarPage();
            } else if (pageId === 'profilePage') {
                loadProfileData();
            }
        }
        
        function displayTeamPlans() {
            // Use the new coach team dashboard
            displayCoachTeamDashboard();
        }
        
        function showAthletePlanDetails(athleteId) {
            var athlete = teamData.athletes.find(function(a) { return a.id === athleteId; });
            if (!athlete || !athlete.plan) return;
            
            var plan = athlete.plan;
            var container = document.getElementById('selectedAthletePlan');
            
            var eventLabel = athlete.trainingParams.goalEvent === '800' ? '800m' : 
                            athlete.trainingParams.goalEvent === '1500' ? '1600m/Mile' : '3200m/2Mile';
            
            var html = '<div class="card" style="margin-bottom: 16px; border: 2px solid var(--primary);">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">';
            html += '<h3 style="margin: 0; color: var(--primary);">' + athlete.name + '\'s Plan</h3>';
            html += '<button onclick="document.getElementById(\'selectedAthletePlan\').innerHTML=\'\'" style="padding: 6px 12px; background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--text-muted); cursor: pointer;">‚úï Close</button>';
            html += '</div>';
            
            html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">';
            html += '<div style="text-align: center; background: var(--bg-elevated); padding: 12px; border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">VDOT</div><div style="font-size: 1.3rem; font-weight: bold; color: var(--primary);">' + plan.vdot + '</div></div>';
            html += '<div style="text-align: center; background: var(--bg-elevated); padding: 12px; border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">Event</div><div style="font-size: 1.3rem; font-weight: bold; color: var(--primary);">' + eventLabel + '</div></div>';
            html += '<div style="text-align: center; background: var(--bg-elevated); padding: 12px; border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">Weeks</div><div style="font-size: 1.3rem; font-weight: bold; color: var(--primary);">' + plan.totalWeeks + '</div></div>';
            html += '<div style="text-align: center; background: var(--bg-elevated); padding: 12px; border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">Mileage</div><div style="font-size: 1.3rem; font-weight: bold; color: var(--primary);">' + athlete.trainingParams.goalMileage + '</div></div>';
            html += '</div>';
            html += '</div>';
            
            // Week selector
            html += '<div class="card" style="margin-bottom: 16px;">';
            html += '<label style="font-weight: 600; margin-bottom: 8px; display: block;">Select Week:</label>';
            html += '<select id="athleteWeekSelector_' + athleteId + '" onchange="displayAthleteWeekDetails(\'' + athleteId + '\')" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 2px solid var(--primary); color: var(--text-primary); border-radius: 8px; font-size: 1rem;">';
            
            plan.weeksData.forEach(function(week, idx) {
                var phaseIcon = week.phaseInfo ? week.phaseInfo.icon : 'üìã';
                html += '<option value="' + idx + '">' + phaseIcon + ' Week ' + week.weekNumber + ': ' + week.label + ' (' + week.mileage + ' mi)</option>';
            });
            
            html += '</select>';
            html += '</div>';
            
            // Week content area
            html += '<div id="athleteWeekContent_' + athleteId + '"></div>';
            
            container.innerHTML = html;
            
            // Display first week
            displayAthleteWeekDetails(athleteId, 0);
            
            // Scroll to plan
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function displayAthleteWeekDetails(athleteId, weekIdx) {
            if (weekIdx === undefined) {
                weekIdx = parseInt(document.getElementById('athleteWeekSelector_' + athleteId).value);
            }
            
            var athlete = teamData.athletes.find(function(a) { return a.id === athleteId; });
            if (!athlete || !athlete.plan) return;
            
            var week = athlete.plan.weeksData[weekIdx];
            if (!week) return;
            
            var container = document.getElementById('athleteWeekContent_' + athleteId);
            var phaseInfo = week.phaseInfo || { icon: 'üìã', color: 'var(--primary)' };
            
            var html = '<div class="card">';
            html += '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">';
            html += '<span style="font-size: 2rem;">' + phaseInfo.icon + '</span>';
            html += '<div>';
            html += '<div style="font-weight: 700; color: var(--text-primary); font-size: 1.1rem;">Week ' + week.weekNumber + ': ' + week.label + '</div>';
            html += '<div style="font-size: 0.85rem; color: var(--text-muted);">' + week.description + ' ‚Ä¢ ' + week.mileage + ' miles</div>';
            html += '</div>';
            html += '</div>';
            
            // Workouts
            week.workouts.forEach(function(workout) {
                var bgColor = 'var(--bg-elevated)';
                if (workout.type.toLowerCase().includes('long')) bgColor = 'rgba(0,255,136,0.1)';
                else if (workout.type.toLowerCase().includes('tempo') || workout.type.toLowerCase().includes('threshold')) bgColor = 'rgba(255,77,0,0.1)';
                else if (workout.type.toLowerCase().includes('interval') || workout.type.toLowerCase().includes('vo2')) bgColor = 'rgba(255,77,0,0.15)';
                else if (workout.type.toLowerCase().includes('easy') || workout.type.toLowerCase().includes('recovery')) bgColor = 'rgba(0,217,255,0.1)';
                
                html += '<div style="background: ' + bgColor + '; padding: 14px; border-radius: 10px; margin-bottom: 10px;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">';
                html += '<span style="font-weight: 700; color: var(--accent);">' + workout.day + '</span>';
                html += '<span style="color: var(--primary); font-weight: 600; font-size: 0.9rem;">' + workout.type + '</span>';
                html += '</div>';
                html += '<div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">' + workout.details + '</div>';
                if (workout.rest) {
                    html += '<div style="color: var(--text-muted); font-size: 0.8rem; margin-top: 6px;">‚è±Ô∏è Rest: ' + workout.rest + '</div>';
                }
                if (workout.notes) {
                    html += '<div style="color: var(--warning); font-size: 0.8rem; margin-top: 6px;">üí° ' + workout.notes + '</div>';
                }
                html += '</div>';
            });
            
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        function updateMyPlanPage() {
            // Check if coach with team plans
            if (userRole === 'coach' && teamData && teamData.athletes && teamData.athletes.some(a => a.plan)) {
                displayTeamPlans();
                return;
            }
            
            if (!currentPlanData || !allWeeksData || allWeeksData.length === 0) {
                document.getElementById('myPlanContent').innerHTML = `
                    <div class="card">
                        <h2 style="text-align: center; color: var(--text-muted);">No Active Plan</h2>
                        <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                            Create or load a training plan to see it here!
                        </p>
                        <button onclick="switchPage('plansPage'); showNewPlanView();" class="btn" style="width: 100%; max-width: 300px; margin: 20px auto; display: block;">
                            <span style="position: relative; z-index: 1;">üìù Create Plan</span>
                        </button>
                    </div>
                `;
                return;
            }
            
            const eventLabel = currentPlanData.goalEvent === '800' ? '800m' : 
                              currentPlanData.goalEvent === '1500' ? '1500m/Mile' : '3200m/3K';
            
            let html = `
                <div class="card" style="margin-bottom: 20px;">
                    <h2 style="color: var(--accent); margin-bottom: 16px;">${eventLabel} Training Plan</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted);">VDOT</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary);">${currentPlanData.vdot}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Duration</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary);">${allWeeksData.length}w</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Mileage</div>
                            <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary);">${currentPlanData.goalMileage}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Week selector dropdown if multi-week plan
            if (allWeeksData.length > 1) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <label style="color: var(--accent); font-weight: bold; margin-bottom: 8px; display: block;">Select Week:</label>
                        <select id="myPlanWeekDropdown" onchange="updateMyPlanWeekDisplay()" 
                                style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
                                       border: 2px solid var(--primary); color: var(--text-primary); border-radius: 8px; 
                                       font-size: 1rem; font-weight: bold;">
                `;
                allWeeksData.forEach((week, idx) => {
                    html += `<option value="${idx}">Week ${week.weekNumber}: ${week.label}</option>`;
                });
                html += `</select></div>`;
            }
            
            // Week details container
            html += '<div id="myPlanWeekDetails"></div>';
            
            document.getElementById('myPlanContent').innerHTML = html;
            
            // Display first week by default
            updateMyPlanWeekDisplay();
        }
        
        function updateMyPlanWeekDisplay() {
            const weekIndex = document.getElementById('myPlanWeekDropdown')?.value || 0;
            const weekData = allWeeksData[parseInt(weekIndex)];
            
            if (!weekData) return;
            
            // Calculate total weekly mileage
            let totalMileage = 0;
            weekData.workouts.forEach(w => {
                const mileMatch = w.details.match(/(\d+(?:\.\d+)?)\s*miles/);
                if (mileMatch) {
                    totalMileage += parseFloat(mileMatch[1]);
                }
            });
            
            const hasAdaptations = weekData.workouts.some(w => w.adapted);
            const phaseClass = weekData.season === 'Early' ? 'phase-early' : 
                              weekData.season === 'Mid' ? 'phase-mid' : 'phase-late';
            
            let html = `
                <div style="margin-bottom: 20px; border: 2px solid var(--accent); border-radius: 12px; padding: 16px; background: rgba(255,77,0,0.05);">
                    <span class="phase-badge ${phaseClass}">${weekData.season.toUpperCase()}</span>
                    <h3 style="color: var(--accent); margin: 8px 0; font-size: 1.2rem;">
                        ${weekData.label} ${weekData.raceWeek ? 'üèÅ' : ''}
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 12px;">
                        ${weekData.description}
                    </p>
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                        <span style="color: var(--text-muted);">Target: ${weekData.mileage} miles</span>
                        <span style="color: var(--accent);">Actual: ~${Math.round(totalMileage)} miles</span>
                    </div>
                    ${hasAdaptations ? `
                        <div style="background: rgba(255,230,0,0.15); border: 2px solid var(--secondary); border-radius: 8px; padding: 12px; margin-top: 12px;">
                            <strong style="color: var(--secondary);">‚ö° Adapted Training:</strong> 
                            Some workouts adjusted based on feedback.
                            <button class="regenerate-week-btn" onclick="resetWeekToOriginal(${weekData.weekNumber})" 
                                    style="margin-left: 8px; display: inline; padding: 6px 12px; font-size: 0.75rem;">
                                üîÑ Reset
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Display each workout
            weekData.workouts.forEach((w, idx) => {
                const feedbackKey = `week${weekData.weekNumber}-${w.day}`;
                const hasFeedback = workoutFeedback[feedbackKey];
                const indicator = getFeedbackIndicator(weekData.weekNumber, w.day);
                
                html += `
                    <div class="workout-item ${w.adapted ? 'adapted' : ''}" style="margin-bottom: 12px; animation-delay: ${idx * 0.05}s;">
                        <div class="workout-day">${indicator}${w.day}${w.adapted ? ' <span style="color: var(--secondary); font-size: 0.75rem;">‚ö° ADAPTED</span>' : ''}</div>
                        <div class="workout-type">${w.type}</div>
                        <div class="workout-details">${w.details}</div>
                        ${w.rest ? `<div class="workout-rest">Rest: ${w.rest}</div>` : ''}
                        ${w.notes ? `<div class="workout-notes">üìù ${w.notes}</div>` : ''}
                        ${hasFeedback ? 
                            `<div style="margin-top: 8px; padding: 10px; background: rgba(0,255,136,0.1); border: 1px solid var(--success); border-radius: 6px; font-size: 0.85rem;">
                                <strong style="color: var(--success);">‚úì Feedback recorded:</strong> Effort ${hasFeedback.effort}/10, ${hasFeedback.completion === 'full' ? 'Completed' : hasFeedback.completion}
                                ${hasFeedback.notes ? `<br><span style="color: var(--text-secondary);">"${hasFeedback.notes}"</span>` : ''}
                            </div>` : ''}
                        <button class="feedback-btn ${hasFeedback ? 'completed' : ''}" 
                                onclick="openFeedbackModal(${weekData.weekNumber}, '${w.day}', '${w.type.replace(/'/g, "\\'")}')">
                            ${hasFeedback ? '‚úì Edit Feedback' : '+ Add Feedback'}
                        </button>
                    </div>
                `;
            });
            
            document.getElementById('myPlanWeekDetails').innerHTML = html;
        }
        
        function changeCalendarMonth(direction) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + direction);
            renderCalendar();
        }
        
        let calendarPlanData = null;
        let calendarStartDate = null;
        
        function loadPlanToCalendar() {
            const selector = document.getElementById('calendarPlanSelector');
            const selectedValue = selector.value;
            
            if (!selectedValue) {
                calendarPlanData = null;
                document.getElementById('calendarStartDateSection').style.display = 'none';
                document.getElementById('calendarLegend').style.display = 'none';
                document.getElementById('calendarContent').innerHTML = `
                    <p style="color: var(--text-muted); text-align: center; padding: 40px 20px;">
                        Select a training plan above to view on the calendar!
                    </p>
                `;
                return;
            }
            
            if (selectedValue === 'active') {
                if (!allWeeksData || allWeeksData.length === 0) {
                    alert('No active plan! Create a plan first or select a saved plan.');
                    selector.value = '';
                    return;
                }
                calendarPlanData = { weeksData: allWeeksData };
            } else {
                const plan = savedPlans[selectedValue];
                if (!plan) {
                    alert('Plan not found!');
                    selector.value = '';
                    return;
                }
                if (!plan.weeksData || plan.weeksData.length === 0) {
                    alert('This saved plan has no workout data. Please create and save a new plan.');
                    selector.value = '';
                    return;
                }
                calendarPlanData = plan;
            }
            
            // Show the start date section and legend
            document.getElementById('calendarStartDateSection').style.display = 'block';
            document.getElementById('calendarLegend').style.display = 'block';
            
            // Set start date from plan data if available, otherwise use today
            const startDateInput = document.getElementById('calendarStartDate');
            if (calendarPlanData && calendarPlanData.startDate) {
                startDateInput.value = calendarPlanData.startDate;
            } else if (currentPlanData && currentPlanData.startDate) {
                startDateInput.value = currentPlanData.startDate;
            } else if (!startDateInput.value) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                startDateInput.value = `${yyyy}-${mm}-${dd}`;
            }
            
            // Reset the current calendar month to the start date's month
            const dateParts = startDateInput.value.split('-');
            currentCalendarMonth = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, 1);
            
            // Force an immediate render
            renderCalendar();
            
            // Scroll the calendar content into view to ensure visibility
            const calendarContent = document.getElementById('calendarContent');
            if (calendarContent) {
                calendarContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        function populateCalendarPlanSelector() {
            const selector = document.getElementById('calendarPlanSelector');
            if (!selector) return;
            
            while (selector.options.length > 2) { selector.remove(2); }
            
            for (const [planId, plan] of Object.entries(savedPlans)) {
                const option = document.createElement('option');
                option.value = planId;
                option.textContent = 'üíæ ' + plan.name;
                selector.appendChild(option);
            }
        }
        
        var calendarViewMode = 'individual'; // 'team' or 'individual'
        var selectedCalendarAthleteId = null;
        
        function updateCalendarPage() {
            // Check if coach with team
            if (userRole === 'coach' && teamData && teamData.athletes && teamData.athletes.some(function(a) { return a.plan; })) {
                // Show team view toggle
                document.getElementById('calendarViewToggle').style.display = 'block';
                document.getElementById('calendarPlanSelectorSection').style.display = 'none';
                
                // Populate athlete dropdown
                populateCalendarAthleteDropdown();
                
                // Set default view to team
                setCalendarView('team');
            } else {
                // Regular athlete view
                document.getElementById('calendarViewToggle').style.display = 'none';
                document.getElementById('calendarAthleteSelector').style.display = 'none';
                document.getElementById('calendarPlanSelectorSection').style.display = 'block';
                
                populateCalendarPlanSelector();
                if (calendarPlanData) {
                    renderCalendar();
                }
            }
        }
        
        function setCalendarView(mode) {
            calendarViewMode = mode;
            
            // Update button styles
            var teamBtn = document.getElementById('calendarTeamViewBtn');
            var indBtn = document.getElementById('calendarIndividualViewBtn');
            
            if (mode === 'team') {
                teamBtn.style.background = 'linear-gradient(135deg, var(--primary), var(--accent))';
                teamBtn.style.color = 'white';
                teamBtn.style.border = 'none';
                indBtn.style.background = 'var(--bg-elevated)';
                indBtn.style.color = 'var(--text-secondary)';
                indBtn.style.border = '2px solid var(--border)';
                
                document.getElementById('calendarAthleteSelector').style.display = 'none';
                document.getElementById('calendarStartDateSection').style.display = 'none';
                
                renderTeamCalendar();
            } else {
                indBtn.style.background = 'linear-gradient(135deg, var(--primary), var(--accent))';
                indBtn.style.color = 'white';
                indBtn.style.border = 'none';
                teamBtn.style.background = 'var(--bg-elevated)';
                teamBtn.style.color = 'var(--text-secondary)';
                teamBtn.style.border = '2px solid var(--border)';
                
                document.getElementById('calendarAthleteSelector').style.display = 'block';
                
                if (selectedCalendarAthleteId) {
                    loadAthleteToCalendar();
                }
            }
        }
        
        function populateCalendarAthleteDropdown() {
            var dropdown = document.getElementById('calendarAthleteDropdown');
            var athletesWithPlans = teamData.athletes.filter(function(a) { return a.plan; });
            
            var html = '<option value="">-- Select an athlete --</option>';
            athletesWithPlans.forEach(function(athlete) {
                html += '<option value="' + athlete.id + '">' + athlete.name + '</option>';
            });
            
            dropdown.innerHTML = html;
        }
        
        function loadAthleteToCalendar() {
            var dropdown = document.getElementById('calendarAthleteDropdown');
            selectedCalendarAthleteId = dropdown.value;
            
            if (!selectedCalendarAthleteId) return;
            
            var athlete = teamData.athletes.find(function(a) { return a.id === selectedCalendarAthleteId; });
            if (!athlete || !athlete.plan) return;
            
            // Set calendar data from athlete's plan
            calendarPlanData = {
                weeksData: athlete.plan.weeksData,
                startDate: athlete.plan.startDate
            };
            
            // Set start date
            var startDateInput = document.getElementById('calendarStartDate');
            startDateInput.value = athlete.plan.startDate;
            document.getElementById('calendarStartDateSection').style.display = 'block';
            
            renderCalendar();
        }
        
        function renderTeamCalendar() {
            var athletesWithPlans = teamData.athletes.filter(function(a) { return a.plan; });
            
            if (athletesWithPlans.length === 0) {
                document.getElementById('calendarContent').innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">No athlete plans to display.</p>';
                return;
            }
            
            // Ensure currentCalendarMonth is set
            if (!currentCalendarMonth || isNaN(currentCalendarMonth.getTime())) {
                currentCalendarMonth = new Date();
                currentCalendarMonth.setDate(1);
            }
            
            var year = currentCalendarMonth.getFullYear();
            var month = currentCalendarMonth.getMonth();
            
            document.getElementById('calendarMonthName').textContent = 
                currentCalendarMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            var firstDay = new Date(year, month, 1);
            var lastDay = new Date(year, month + 1, 0);
            var startingDay = firstDay.getDay();
            var totalDays = lastDay.getDate();
            var today = new Date();
            
            var html = '<div class="calendar-grid">';
            
            // Day headers
            var dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(function(d) {
                html += '<div class="calendar-day-header">' + d + '</div>';
            });
            
            // Empty cells before first day
            for (var i = 0; i < startingDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            // Days of month
            for (var day = 1; day <= totalDays; day++) {
                var date = new Date(year, month, day);
                var isToday = (day === today.getDate() && month === today.getMonth() && year === today.getFullYear());
                
                // Get workouts for all athletes on this day
                var dayWorkouts = [];
                athletesWithPlans.forEach(function(athlete) {
                    var workout = getWorkoutForAthleteOnDate(athlete, date);
                    if (workout) {
                        dayWorkouts.push({
                            name: athlete.name.split(' ')[0], // First name only
                            type: workout.type,
                            color: getWorkoutColor(workout.type)
                        });
                    }
                });
                
                var classes = 'calendar-day' + (isToday ? ' today' : '');
                
                html += '<div class="' + classes + '" onclick="showTeamDayDetails(\'' + date.toISOString() + '\')" style="min-height: 80px; cursor: pointer;">';
                html += '<div class="calendar-day-number">' + day + '</div>';
                
                // Show workout indicators for each athlete (compact)
                if (dayWorkouts.length > 0) {
                    html += '<div style="display: flex; flex-direction: column; gap: 2px; margin-top: 4px;">';
                    dayWorkouts.slice(0, 4).forEach(function(w) {
                        html += '<div style="font-size: 0.5rem; padding: 1px 3px; background: ' + w.color + '20; border-left: 2px solid ' + w.color + '; border-radius: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">';
                        html += '<span style="color: ' + w.color + ';">' + w.name + '</span>';
                        html += '</div>';
                    });
                    if (dayWorkouts.length > 4) {
                        html += '<div style="font-size: 0.5rem; color: var(--text-muted);">+' + (dayWorkouts.length - 4) + ' more</div>';
                    }
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            
            document.getElementById('calendarContent').innerHTML = html;
            document.getElementById('calendarLegend').style.display = 'block';
        }
        
        function getWorkoutForAthleteOnDate(athlete, date) {
            if (!athlete.plan || !athlete.plan.weeksData) return null;
            
            var planStart = new Date(athlete.plan.startDate + 'T00:00:00');
            var daysSinceStart = Math.floor((date - planStart) / (1000 * 60 * 60 * 24));
            
            if (daysSinceStart < 0) return null;
            
            var weekIndex = Math.floor(daysSinceStart / 7);
            
            if (weekIndex >= athlete.plan.weeksData.length) return null;
            
            var week = athlete.plan.weeksData[weekIndex];
            if (!week || !week.workouts) return null;
            
            var dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            var dayName = dayNames[date.getDay()];
            
            // Adjust for Monday start
            var adjustedDaysSinceWeekStart = daysSinceStart % 7;
            var workoutDayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            var targetDayName = workoutDayNames[adjustedDaysSinceWeekStart];
            
            return week.workouts.find(function(w) { return w.day === targetDayName; });
        }
        
        function showTeamDayDetails(dateStr) {
            var date = new Date(dateStr);
            var athletesWithPlans = teamData.athletes.filter(function(a) { return a.plan; });
            
            var html = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 3000; padding: 20px; overflow-y: auto;">';
            html += '<div style="max-width: 500px; margin: 20px auto; background: var(--bg-card); border-radius: 16px; padding: 24px;">';
            
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
            html += '<h3 style="margin: 0; color: var(--accent);">üìÖ ' + date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) + '</h3>';
            html += '<button onclick="this.closest(\'div[style*=\\\'position: fixed\\\']\').remove()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>';
            html += '</div>';
            
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            
            athletesWithPlans.forEach(function(athlete) {
                var workout = getWorkoutForAthleteOnDate(athlete, date);
                var color = getWorkoutColor(workout ? workout.type : 'Rest');
                
                html += '<div style="background: var(--bg-elevated); border-radius: 10px; padding: 14px; border-left: 4px solid ' + color + ';">';
                html += '<div style="font-weight: 600; color: var(--text-primary); margin-bottom: 6px;">' + athlete.name + '</div>';
                
                if (workout) {
                    html += '<div style="color: ' + color + '; font-weight: 600; font-size: 0.9rem;">' + workout.type + '</div>';
                    html += '<div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 6px; line-height: 1.4;">' + workout.details + '</div>';
                    if (workout.rest) {
                        html += '<div style="color: var(--text-muted); font-size: 0.8rem; margin-top: 6px;">‚è±Ô∏è Rest: ' + workout.rest + '</div>';
                    }
                } else {
                    html += '<div style="color: var(--text-muted); font-size: 0.85rem;">No workout scheduled</div>';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function renderCalendar() {
            if (!calendarPlanData || !calendarPlanData.weeksData) {
                return;
            }
            
            // Parse start date - ensure we have a valid date
            const startDateInput = document.getElementById('calendarStartDate');
            let dateValue = startDateInput.value;
            
            // If no date value, set today's date
            if (!dateValue) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                dateValue = `${yyyy}-${mm}-${dd}`;
                startDateInput.value = dateValue;
            }
            
            const parts = dateValue.split('-');
            calendarStartDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            
            // Ensure currentCalendarMonth is set
            if (!currentCalendarMonth || isNaN(currentCalendarMonth.getTime())) {
                currentCalendarMonth = new Date(calendarStartDate.getFullYear(), calendarStartDate.getMonth(), 1);
            }
            
            // Day name to index mapping (0 = Sunday, 1 = Monday, etc.)
            const dayNameToIndex = {
                'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
                'Thursday': 4, 'Friday': 5, 'Saturday': 6
            };
            
            // Build workout map
            const workoutMap = {};
            const weeksData = calendarPlanData.weeksData;
            
            // Find the first Monday on or after the start date to begin the plan
            const startDayOfWeek = calendarStartDate.getDay(); // 0 = Sunday
            let planStartDate = new Date(calendarStartDate);
            
            // If start date is not Monday, find next Monday (or adjust to align week)
            // Actually, let's align based on the workout day names
            // Week starts on the start date, and we map each workout to its named day
            
            weeksData.forEach((week, weekIndex) => {
                if (!week.workouts) return;
                week.workouts.forEach((workout) => {
                    // Get the day index from the workout's day name
                    const workoutDayIndex = dayNameToIndex[workout.day];
                    if (workoutDayIndex === undefined) return;
                    
                    // Calculate the date for this workout
                    // Week 0 starts on start date, find the correct day of that week
                    const weekStartDate = new Date(calendarStartDate);
                    weekStartDate.setDate(calendarStartDate.getDate() + (weekIndex * 7));
                    
                    // Find the day of week for the week start
                    const weekStartDay = weekStartDate.getDay();
                    
                    // Calculate offset to get to the workout's day
                    let dayOffset = workoutDayIndex - weekStartDay;
                    if (dayOffset < 0) dayOffset += 7; // Wrap to next week if needed
                    
                    const workoutDate = new Date(weekStartDate);
                    workoutDate.setDate(weekStartDate.getDate() + dayOffset);
                    
                    const y = workoutDate.getFullYear();
                    const m = String(workoutDate.getMonth() + 1).padStart(2, '0');
                    const d = String(workoutDate.getDate()).padStart(2, '0');
                    const dateKey = `${y}-${m}-${d}`;
                    
                    workoutMap[dateKey] = {
                        type: workout.type,
                        details: workout.details,
                        rest: workout.rest,
                        notes: workout.notes,
                        weekNumber: week.weekNumber,
                        weekLabel: week.label
                    };
                });
            });
            
            // Render month name
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonthName').textContent = monthNames[currentCalendarMonth.getMonth()] + ' ' + currentCalendarMonth.getFullYear();
            
            // Build calendar
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            let html = '<div class="calendar-grid">';
            
            // Headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += '<div class="calendar-day-header">' + day + '</div>';
            });
            
            // Empty cells
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            // Day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const m = String(month + 1).padStart(2, '0');
                const d = String(day).padStart(2, '0');
                const dateKey = `${year}-${m}-${d}`;
                
                const workout = workoutMap[dateKey];
                
                let classes = 'calendar-day';
                let label = '';
                let inlineStyle = '';
                
                if (workout) {
                    const type = workout.type.toLowerCase();
                    
                    // For actual race days (not race-pace workouts), show race styling
                    if (type.includes('race') && !type.includes('pace') && !type.includes('goal')) {
                        classes += ' race';
                        inlineStyle = 'background: rgba(255,230,0,0.3); border-color: var(--secondary);';
                        // Show actual workout type, not just "Race"
                        var shortType = workout.type.length > 12 ? workout.type.substring(0, 10) + '..' : workout.type;
                        label = 'üèÅ ' + shortType;
                    } else if (type.includes('long')) {
                        inlineStyle = 'background: rgba(0,255,136,0.25); border-color: var(--success);';
                        label = 'üèÉ Long Run';
                    } else if (type.includes('speed dev') || type.includes('speed development')) {
                        inlineStyle = 'background: rgba(138,43,226,0.3); border-color: #8A2BE2;';
                        label = '‚ö° Speed Dev';
                    } else if (type.includes('tempo') || type.includes('threshold') || type.includes('lt')) {
                        inlineStyle = 'background: rgba(255,77,0,0.3); border-color: var(--primary);';
                        label = 'üî• Tempo';
                    } else if (type.includes('interval') || type.includes('vo2') || type.includes('repeat')) {
                        inlineStyle = 'background: rgba(255,77,0,0.35); border-color: #FF4500;';
                        label = 'üí® Intervals';
                    } else if (type.includes('fartlek')) {
                        inlineStyle = 'background: rgba(255,165,0,0.3); border-color: orange;';
                        label = 'üé≤ Fartlek';
                    } else if (type.includes('tune') || type.includes('primer')) {
                        inlineStyle = 'background: rgba(255,230,0,0.2); border-color: var(--secondary);';
                        var shortType = workout.type.length > 12 ? workout.type.substring(0, 10) + '..' : workout.type;
                        label = shortType;
                    } else if (type.includes('specific') || type.includes('bank')) {
                        inlineStyle = 'background: rgba(255,77,0,0.25); border-color: var(--primary);';
                        label = workout.type.length > 12 ? workout.type.substring(0, 10) + '..' : workout.type;
                    } else if (type.includes('rest') || type.includes('off')) {
                        inlineStyle = 'background: rgba(100,100,100,0.2); border-color: #666;';
                        label = 'üò¥ Rest';
                    } else if (type.includes('easy') || type.includes('recovery') || type.includes('shake')) {
                        inlineStyle = 'background: rgba(0,217,255,0.2); border-color: var(--accent);';
                        label = 'üö∂ Easy';
                    } else if (type.includes('medium') || type.includes('moderate') || type.includes('steady')) {
                        inlineStyle = 'background: rgba(0,200,150,0.25); border-color: #00C896;';
                        label = 'üèÉ Steady';
                    } else if (type.includes('hill') || type.includes('strength')) {
                        inlineStyle = 'background: rgba(139,69,19,0.3); border-color: #8B4513;';
                        label = '‚õ∞Ô∏è Hills';
                    } else if (type.includes('strides') || type.includes('drills')) {
                        inlineStyle = 'background: rgba(0,191,255,0.25); border-color: #00BFFF;';
                        label = 'ü¶µ Strides';
                    } else {
                        // Default for unrecognized types - show actual name
                        inlineStyle = 'background: rgba(150,150,150,0.2); border-color: #999;';
                        label = workout.type.length > 12 ? workout.type.substring(0, 10) + '..' : workout.type;
                    }
                }
                
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    classes += ' today';
                }
                
                html += `<div class="${classes}" style="${inlineStyle}" onclick="showDayDetails('${dateKey}')">`;
                html += `<div class="calendar-day-number">${day}</div>`;
                if (label) {
                    html += `<div class="calendar-workout-indicator">${label}</div>`;
                }
                html += '</div>';
            }
            
            html += '</div>';
            
            document.getElementById('calendarContent').innerHTML = html;
        }
        
        function showDayDetails(dateKey) {
            if (!calendarPlanData || !calendarPlanData.weeksData) return;
            
            // Day name to index mapping
            const dayNameToIndex = {
                'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
                'Thursday': 4, 'Friday': 5, 'Saturday': 6
            };
            
            // Rebuild workout map
            const workoutMap = {};
            const startDateInput = document.getElementById('calendarStartDate');
            const dateValue = startDateInput.value;
            const parts = dateValue.split('-');
            const startDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            
            calendarPlanData.weeksData.forEach((week, weekIndex) => {
                if (!week.workouts) return;
                week.workouts.forEach((workout) => {
                    const workoutDayIndex = dayNameToIndex[workout.day];
                    if (workoutDayIndex === undefined) return;
                    
                    const weekStartDate = new Date(startDate);
                    weekStartDate.setDate(startDate.getDate() + (weekIndex * 7));
                    
                    const weekStartDay = weekStartDate.getDay();
                    let dayOffset = workoutDayIndex - weekStartDay;
                    if (dayOffset < 0) dayOffset += 7;
                    
                    const workoutDate = new Date(weekStartDate);
                    workoutDate.setDate(weekStartDate.getDate() + dayOffset);
                    
                    const y = workoutDate.getFullYear();
                    const m = String(workoutDate.getMonth() + 1).padStart(2, '0');
                    const d = String(workoutDate.getDate()).padStart(2, '0');
                    workoutMap[`${y}-${m}-${d}`] = { ...workout, weekNumber: week.weekNumber, weekLabel: week.label };
                });
            });
            
            const workout = workoutMap[dateKey];
            if (!workout) {
                alert('No workout scheduled for this day');
                return;
            }
            
            const dateParts = dateKey.split('-');
            const dateObj = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
            const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div style="background: var(--bg-card); border: 3px solid var(--primary); border-radius: 16px; padding: 24px; max-width: 400px; width: 100%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="color: var(--accent); margin: 0;">${dateStr}</h3>
                        <button id="closeModalBtn" style="background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;">Week ${workout.weekNumber}: ${workout.weekLabel}</div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary); margin-bottom: 12px;">${workout.type}</div>
                    <div style="color: var(--text-primary); line-height: 1.6; margin-bottom: 12px;">${workout.details}</div>
                    ${workout.rest ? `<div style="color: var(--accent); margin-bottom: 8px;">Rest: ${workout.rest}</div>` : ''}
                    ${workout.notes ? `<div style="color: var(--text-secondary); font-style: italic;">üìù ${workout.notes}</div>` : ''}
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add click handler for close button
            document.getElementById('closeModalBtn').addEventListener('click', function() {
                modal.remove();
            });
        }
        
        // ============================================
        // TODAY PAGE - WORKOUT LOGGING FUNCTIONS
        // ============================================
        
        let workoutLogs = JSON.parse(localStorage.getItem('laktic_workout_logs') || '[]');
        let todayScheduledWorkout = null;
        let todayWeekNumber = null;
        let todayDayName = null;
        
        function initTodayPage() {
            // Set today's date
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('todayDate').textContent = today.toLocaleDateString('en-US', options);
            
            // Store day name for feedback key
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            todayDayName = dayNames[today.getDay()];
            
            // Load active plan data if not already loaded
            if (!allWeeksData || allWeeksData.length === 0) {
                const activePlanId = localStorage.getItem('laktic_active_plan_id');
                if (activePlanId) {
                    const savedPlansData = JSON.parse(localStorage.getItem('laktic_saved_plans') || '[]');
                    const activePlan = savedPlansData.find(p => p.id === activePlanId);
                    if (activePlan && activePlan.weeksData) {
                        allWeeksData = activePlan.weeksData;
                        currentPlanData = activePlan.planData;
                        workoutFeedback = activePlan.feedback || JSON.parse(localStorage.getItem('laktic_feedback') || '{}');
                    }
                }
            }
            
            // Find and display scheduled workout
            findTodaysWorkout(today);
            displayScheduledWorkout();
            
            // Check if feedback already exists for today's workout
            checkExistingFeedback();
            
            // Display recent logs
            displayRecentLogs();
        }
        
        function findTodaysWorkout(date) {
            todayScheduledWorkout = null;
            todayWeekNumber = null;
            
            if (!allWeeksData || allWeeksData.length === 0) return;
            
            // Try to find which week we're in based on plan start date
            const activePlanId = localStorage.getItem('laktic_active_plan_id');
            if (activePlanId) {
                const savedPlansData = JSON.parse(localStorage.getItem('laktic_saved_plans') || '[]');
                const activePlan = savedPlansData.find(p => p.id === activePlanId);
                if (activePlan && activePlan.startDate) {
                    const startDate = new Date(activePlan.startDate);
                    const daysSinceStart = Math.floor((date - startDate) / (1000 * 60 * 60 * 24));
                    const weekIndex = Math.floor(daysSinceStart / 7);
                    
                    if (weekIndex >= 0 && weekIndex < allWeeksData.length) {
                        todayWeekNumber = weekIndex + 1;
                        const currentWeek = allWeeksData[weekIndex];
                        todayScheduledWorkout = currentWeek.workouts.find(w => w.day === todayDayName);
                        return;
                    }
                }
            }
            
            // Fallback: use week 1
            todayWeekNumber = 1;
            const currentWeek = allWeeksData[0];
            todayScheduledWorkout = currentWeek.workouts.find(w => w.day === todayDayName);
        }
        
        function displayScheduledWorkout() {
            const container = document.getElementById('todayScheduledWorkout');
            const logButtonContainer = document.getElementById('todayLogButtonContainer');
            const quickLogSection = document.getElementById('quickLogSection');
            
            if (!allWeeksData || allWeeksData.length === 0) {
                container.innerHTML = `
                    <div style="background: var(--bg-elevated); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 12px;">üìã</div>
                        <div style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 8px;">No active training plan</div>
                        <div style="color: var(--text-secondary); font-size: 0.85rem;">Create or load a plan to see scheduled workouts</div>
                    </div>
                `;
                // Still show log button for manual logging
                logButtonContainer.style.display = 'block';
                document.getElementById('todayLogButton').innerHTML = '+ Log a Workout';
                quickLogSection.style.display = 'block';
                return;
            }
            
            quickLogSection.style.display = 'none';
            
            if (todayScheduledWorkout) {
                const currentWeek = allWeeksData[todayWeekNumber - 1];
                const phaseInfo = currentWeek.phaseInfo || { icon: 'üìã' };
                
                container.innerHTML = `
                    <div style="background: linear-gradient(135deg, var(--bg-elevated), rgba(99,102,241,0.1)); padding: 20px; border-radius: 12px; border: 1px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <span style="background: var(--bg-dark); color: var(--primary); padding: 4px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">
                                ${phaseInfo.icon} Week ${todayWeekNumber} ‚Ä¢ ${currentWeek.label}
                            </span>
                            <span style="color: var(--text-muted); font-size: 0.8rem;">${todayDayName}</span>
                        </div>
                        <div style="color: var(--primary); font-size: 1.3rem; font-weight: 700; margin-bottom: 10px;">${todayScheduledWorkout.type}</div>
                        <div style="color: var(--text-primary); font-size: 0.95rem; line-height: 1.6; margin-bottom: 12px;">${todayScheduledWorkout.details}</div>
                        ${todayScheduledWorkout.rest ? `<div style="color: var(--accent); font-size: 0.85rem; margin-bottom: 8px;">‚è±Ô∏è Rest: ${todayScheduledWorkout.rest}</div>` : ''}
                        ${todayScheduledWorkout.notes ? `<div style="background: rgba(245,158,11,0.1); padding: 10px; border-radius: 8px; color: var(--warning); font-size: 0.85rem;">üí° ${todayScheduledWorkout.notes}</div>` : ''}
                    </div>
                `;
                logButtonContainer.style.display = 'block';
                document.getElementById('todayLogButton').innerHTML = '+ Log Today\'s Workout';
            } else {
                container.innerHTML = `
                    <div style="background: var(--bg-elevated); padding: 20px; border-radius: 12px; border-left: 3px solid var(--success);">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 2rem;">üò¥</span>
                            <div>
                                <div style="color: var(--success); font-size: 1.1rem; font-weight: 600;">Rest Day</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Recovery is part of training. Take it easy!</div>
                            </div>
                        </div>
                    </div>
                `;
                logButtonContainer.style.display = 'block';
                document.getElementById('todayLogButton').innerHTML = '+ Log a Workout Anyway';
            }
        }
        
        function checkExistingFeedback() {
            if (!todayWeekNumber || !todayDayName) return;
            
            const feedbackKey = `week${todayWeekNumber}-${todayDayName}`;
            const existingFeedback = workoutFeedback[feedbackKey];
            
            const statusBadge = document.getElementById('todayFeedbackStatus');
            const logButton = document.getElementById('todayLogButton');
            const existingFeedbackCard = document.getElementById('todayExistingFeedback');
            const additionalMetricsCard = document.getElementById('additionalMetricsCard');
            
            if (existingFeedback) {
                // Show logged status
                statusBadge.style.display = 'inline-block';
                
                // Change button to Edit
                logButton.innerHTML = '‚úèÔ∏è Edit Feedback';
                logButton.style.background = 'var(--bg-elevated)';
                logButton.style.border = '1px solid var(--success)';
                logButton.style.color = 'var(--success)';
                
                // Show feedback summary with workout data
                const summaryParts = [];
                if (existingFeedback.distance) summaryParts.push(`${existingFeedback.distance}mi`);
                if (existingFeedback.avgPace && existingFeedback.avgPace !== '--:--') summaryParts.push(`${existingFeedback.avgPace}/mi`);
                if (existingFeedback.avgHR) summaryParts.push(`${existingFeedback.avgHR}bpm`);
                
                existingFeedbackCard.style.display = 'block';
                document.getElementById('todayFeedbackSummary').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${existingFeedback.effort || '-'}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Effort</div>
                        </div>
                        <div>
                            <div style="font-size: 1.2rem; font-weight: 600; color: var(--success);">${existingFeedback.completion === 'full' ? '‚úÖ' : existingFeedback.completion === 'partial' ? 'üî∂' : existingFeedback.completion === 'modified' ? 'üîÑ' : '‚ùå'}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${existingFeedback.completion || 'Status'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">${existingFeedback.notes ? 'üìù' : '-'}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Notes</div>
                        </div>
                    </div>
                    ${summaryParts.length > 0 ? `<div style="margin-top: 12px; padding: 8px; background: var(--bg-dark); border-radius: 8px; font-size: 0.85rem; color: var(--text-muted); text-align: center;">üìä ${summaryParts.join(' ‚Ä¢ ')}</div>` : ''}
                    ${existingFeedback.notes ? `<div style="margin-top: 8px; padding: 10px; background: var(--bg-dark); border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary);">"${existingFeedback.notes}"</div>` : ''}
                `;
                
                // Show additional metrics card and populate fields
                additionalMetricsCard.style.display = 'block';
                
                // Populate the additional metrics fields
                document.getElementById('todayMetricsSleep').value = existingFeedback.sleepHours || '';
                document.getElementById('todayMetricsSleepQuality').value = existingFeedback.sleepQuality || '';
                document.getElementById('todayMetricsSoreness').value = existingFeedback.soreness || '';
                document.getElementById('todayMetricsEnergy').value = existingFeedback.energy || '';
                document.getElementById('todayMetricsRestingHR').value = existingFeedback.restingHR || '';
                document.getElementById('todayMetricsStress').value = existingFeedback.stress || '';
                document.getElementById('todayMetricsTemp').value = existingFeedback.temp || '';
                document.getElementById('todayMetricsWeather').value = existingFeedback.weather || '';
                document.getElementById('todayMetricsSurface').value = existingFeedback.surface || '';
                document.getElementById('todayMetricsHydration').value = existingFeedback.hydration || '';
                document.getElementById('todayMetricsFueling').value = existingFeedback.fueling || '';
            } else {
                statusBadge.style.display = 'none';
                logButton.innerHTML = '+ Log Today\'s Workout';
                logButton.style.background = '';
                logButton.style.border = '';
                logButton.style.color = '';
                existingFeedbackCard.style.display = 'none';
                additionalMetricsCard.style.display = 'none';
            }
        }
        
        function openTodayFeedbackModal() {
            if (!todayScheduledWorkout || !todayWeekNumber || !todayDayName) {
                alert('No workout scheduled for today.');
                return;
            }
            
            // Use the existing feedback modal from the plan
            openFeedbackModal(todayWeekNumber, todayDayName, todayScheduledWorkout.type);
        }
        
        // Auto-calculate average pace from distance and duration
        function calculateAvgPace() {
            const distanceEl = document.getElementById('logDistance');
            const durationEl = document.getElementById('logDuration');
            const paceEl = document.getElementById('logAvgPace');
            
            if (!distanceEl || !durationEl || !paceEl) return;
            
            const distance = parseFloat(distanceEl.value);
            const duration = parseFloat(durationEl.value);
            
            if (distance > 0 && duration > 0) {
                const paceMinutes = duration / distance;
                const mins = Math.floor(paceMinutes);
                const secs = Math.round((paceMinutes - mins) * 60);
                const paceStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                paceEl.value = paceStr;
            } else {
                paceEl.value = '--:--';
            }
        }
        
        function saveTodayAdditionalMetrics() {
            if (!todayWeekNumber || !todayDayName) return;
            
            const feedbackKey = `week${todayWeekNumber}-${todayDayName}`;
            
            // Get existing feedback
            const existingFeedback = workoutFeedback[feedbackKey] || {};
            
            // Get all additional metrics from Today page form
            workoutFeedback[feedbackKey] = {
                ...existingFeedback,
                sleepHours: parseFloat(document.getElementById('todayMetricsSleep').value) || existingFeedback.sleepHours,
                sleepQuality: parseInt(document.getElementById('todayMetricsSleepQuality').value) || existingFeedback.sleepQuality,
                soreness: document.getElementById('todayMetricsSoreness').value || existingFeedback.soreness,
                energy: document.getElementById('todayMetricsEnergy').value || existingFeedback.energy,
                restingHR: parseInt(document.getElementById('todayMetricsRestingHR').value) || existingFeedback.restingHR,
                stress: parseInt(document.getElementById('todayMetricsStress').value) || existingFeedback.stress,
                temp: parseInt(document.getElementById('todayMetricsTemp').value) || existingFeedback.temp,
                weather: document.getElementById('todayMetricsWeather').value || existingFeedback.weather,
                surface: document.getElementById('todayMetricsSurface').value || existingFeedback.surface,
                hydration: document.getElementById('todayMetricsHydration').value || existingFeedback.hydration,
                fueling: document.getElementById('todayMetricsFueling').value || existingFeedback.fueling,
                metricsTimestamp: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem('laktic_feedback', JSON.stringify(workoutFeedback));
            
            // Also update the active plan if one exists
            const activePlanId = localStorage.getItem('laktic_active_plan_id');
            if (activePlanId && savedPlans[activePlanId]) {
                savedPlans[activePlanId].feedback = workoutFeedback;
                localStorage.setItem('laktic_saved_plans', JSON.stringify(savedPlans));
            }
            
            showNotification('‚úì Additional metrics saved!', 'var(--success)');
        }
        
        function displayRecentLogs() {
            const container = document.getElementById('recentLogs');
            if (!container) return;
            
            // Get feedback entries as recent logs
            const feedbackEntries = Object.entries(workoutFeedback)
                .filter(([key, data]) => data.timestamp)
                .sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp))
                .slice(0, 7);
            
            if (feedbackEntries.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No logs yet. Start tracking today!</p>';
                return;
            }
            
            let html = '';
            feedbackEntries.forEach(([key, data]) => {
                const parts = key.split('-');
                const weekNum = parts[0].replace('week', '');
                const dayName = parts.slice(1).join('-');
                
                const completionIcon = data.completion === 'full' ? '‚úÖ' : 
                                       data.completion === 'partial' ? 'üî∂' : '‚ùå';
                
                html += `
                    <div style="background: var(--bg-elevated); padding: 14px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: var(--text-muted); font-size: 0.75rem;">Week ${weekNum} ‚Ä¢ ${dayName}</div>
                            <div style="color: var(--text-primary); font-weight: 600; font-size: 0.95rem;">${completionIcon} ${data.completion || 'Logged'}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: var(--primary); font-weight: 700;">RPE: ${data.effort || '-'}/10</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Calculate HR zones from profile
        function calculateHRZones() {
            const restingHR = parseInt(document.getElementById('profileRestingHR').value) || 0;
            const maxHR = parseInt(document.getElementById('profileMaxHR').value) || 0;
            
            if (restingHR > 0 && maxHR > 0 && maxHR > restingHR) {
                const hrReserve = maxHR - restingHR;
                
                // Karvonen formula zones
                const zones = [
                    { name: 'Zone 1 (Recovery)', range: '50-60%', low: Math.round(restingHR + hrReserve * 0.50), high: Math.round(restingHR + hrReserve * 0.60) },
                    { name: 'Zone 2 (Easy)', range: '60-70%', low: Math.round(restingHR + hrReserve * 0.60), high: Math.round(restingHR + hrReserve * 0.70) },
                    { name: 'Zone 3 (Tempo)', range: '70-80%', low: Math.round(restingHR + hrReserve * 0.70), high: Math.round(restingHR + hrReserve * 0.80) },
                    { name: 'Zone 4 (Threshold)', range: '80-90%', low: Math.round(restingHR + hrReserve * 0.80), high: Math.round(restingHR + hrReserve * 0.90) },
                    { name: 'Zone 5 (VO2max)', range: '90-100%', low: Math.round(restingHR + hrReserve * 0.90), high: maxHR }
                ];
                
                let html = '<div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px;">';
                html += '<div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">Your HR Zones (Karvonen)</div>';
                zones.forEach(zone => {
                    html += `<div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);">
                        <span style="color: var(--text-secondary); font-size: 0.85rem;">${zone.name}</span>
                        <span style="color: var(--primary); font-weight: 600;">${zone.low}-${zone.high} bpm</span>
                    </div>`;
                });
                html += '</div>';
                
                document.getElementById('hrZonesDisplay').innerHTML = html;
                document.getElementById('hrZonesDisplay').style.display = 'block';
            }
        }
        
        // ==================== SEASON TEMPLATES ====================
        
        const seasonTemplates = {
            xc_season: {
                name: 'Cross Country Season',
                duration: 12,
                goalEvent: '3200',
                description: '12-week XC season plan peaking for championship races',
                phases: [
                    { weeks: 3, name: 'Base Building', focus: 'aerobic', intensity: 0.7 },
                    { weeks: 3, name: 'Strength', focus: 'threshold', intensity: 0.85 },
                    { weeks: 3, name: 'Speed Development', focus: 'vo2max', intensity: 0.95 },
                    { weeks: 2, name: 'Championship Prep', focus: 'race-specific', intensity: 0.9 },
                    { weeks: 1, name: 'Taper', focus: 'recovery', intensity: 0.6 }
                ],
                mileageProgression: [0.8, 0.85, 0.9, 0.95, 1.0, 1.0, 0.95, 0.9, 0.85, 0.8, 0.7, 0.5],
                suggestedRaces: [
                    { week: 4, type: 'tune-up', distance: '5K' },
                    { week: 8, type: 'tune-up', distance: '5K' },
                    { week: 11, type: 'championship', distance: '5K' }
                ]
            },
            indoor_track: {
                name: 'Indoor Track Season',
                duration: 10,
                goalEvent: '1500',
                description: '10-week indoor season for 800m-3200m',
                phases: [
                    { weeks: 2, name: 'Transition', focus: 'speed-intro', intensity: 0.75 },
                    { weeks: 3, name: 'Speed Building', focus: 'vo2max', intensity: 0.9 },
                    { weeks: 3, name: 'Race Sharpening', focus: 'race-specific', intensity: 0.95 },
                    { weeks: 1, name: 'Championship Prep', focus: 'speed', intensity: 0.85 },
                    { weeks: 1, name: 'Taper', focus: 'recovery', intensity: 0.5 }
                ],
                mileageProgression: [0.85, 0.9, 0.95, 1.0, 0.95, 0.9, 0.85, 0.8, 0.7, 0.5],
                suggestedRaces: [
                    { week: 3, type: 'opener', distance: '1600m' },
                    { week: 6, type: 'tune-up', distance: '800m/1600m' },
                    { week: 9, type: 'championship', distance: 'Goal Event' }
                ]
            },
            outdoor_track: {
                name: 'Outdoor Track Season',
                duration: 14,
                goalEvent: '1500',
                description: '14-week outdoor season with full periodization',
                phases: [
                    { weeks: 3, name: 'Early Season Base', focus: 'aerobic', intensity: 0.75 },
                    { weeks: 3, name: 'Strength Phase', focus: 'threshold', intensity: 0.85 },
                    { weeks: 3, name: 'Speed Phase', focus: 'vo2max', intensity: 0.95 },
                    { weeks: 3, name: 'Competition Phase', focus: 'race-specific', intensity: 0.9 },
                    { weeks: 2, name: 'Championship Taper', focus: 'recovery', intensity: 0.6 }
                ],
                mileageProgression: [0.8, 0.85, 0.9, 0.95, 1.0, 1.0, 0.95, 0.95, 0.9, 0.85, 0.8, 0.75, 0.6, 0.4],
                suggestedRaces: [
                    { week: 4, type: 'opener', distance: 'Off-Event' },
                    { week: 7, type: 'tune-up', distance: 'Goal Event' },
                    { week: 10, type: 'qualifier', distance: 'Goal Event' },
                    { week: 13, type: 'championship', distance: 'Goal Event' }
                ]
            },
            summer_base: {
                name: 'Summer Base Building',
                duration: 8,
                goalEvent: '3200',
                description: '8-week aerobic base for fall XC',
                phases: [
                    { weeks: 2, name: 'Easy Introduction', focus: 'recovery', intensity: 0.6 },
                    { weeks: 3, name: 'Mileage Building', focus: 'aerobic', intensity: 0.75 },
                    { weeks: 3, name: 'Aerobic Development', focus: 'aerobic', intensity: 0.8 }
                ],
                mileageProgression: [0.6, 0.7, 0.8, 0.85, 0.9, 0.95, 1.0, 1.0],
                suggestedRaces: [] // No races during base building
            }
        };
        
        function loadSeasonTemplate(templateId) {
            const template = seasonTemplates[templateId];
            if (!template) {
                alert('Template not found');
                return;
            }
            
            // Show a configuration modal for the template
            const modal = document.createElement('div');
            modal.id = 'templateConfigModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.9); backdrop-filter: blur(5px);
                z-index: 3000; display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 16px; padding: 24px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                        <div>
                            <h2 style="margin: 0; color: var(--primary);">${template.name}</h2>
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 4px;">${template.duration} weeks ‚Ä¢ ${template.description}</p>
                        </div>
                        <button onclick="document.getElementById('templateConfigModal').remove()" 
                                style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    
                    <div style="background: var(--bg-elevated); padding: 16px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 10px;">üìÖ Phases</div>
                        ${template.phases.map(p => `
                            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);">
                                <span style="color: var(--text-secondary);">${p.name}</span>
                                <span style="color: var(--text-muted);">${p.weeks} weeks</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="input-group">
                        <label>Your Best Recent Race Time (for pacing)</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <select id="templateRaceDistance" style="padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                <option value="800">800m</option>
                                <option value="1600" selected>1600m / Mile</option>
                                <option value="3200">3200m</option>
                                <option value="5000">5K</option>
                            </select>
                            <input type="text" id="templateRaceTime" placeholder="4:30" 
                                   style="padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>Season Start Date</label>
                        <input type="date" id="templateStartDate" 
                               style="width: 100%; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                    </div>
                    
                    <div class="input-group">
                        <label>Weekly Mileage (peak weeks)</label>
                        <input type="number" id="templateMileage" value="40" placeholder="40"
                               style="width: 100%; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                    </div>
                    
                    <button onclick="generateFromTemplate('${templateId}')" class="btn" style="width: 100%; margin-top: 16px;">
                        <span style="position: relative; z-index: 1;">üöÄ Generate ${template.duration}-Week Plan</span>
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set default start date to next Monday
            const today = new Date();
            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + ((1 + 7 - today.getDay()) % 7 || 7));
            document.getElementById('templateStartDate').value = nextMonday.toISOString().split('T')[0];
            
            // Close on backdrop click
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }
        
        function generateFromTemplate(templateId) {
            // This function is now replaced by selectTemplate + generatePlanFromTemplate
            selectTemplate(templateId);
        }
        
        var selectedTemplate = null;
        
        function selectTemplate(templateId) {
            var template = seasonTemplates[templateId];
            if (!template) return;
            
            selectedTemplate = templateId;
            document.getElementById('selectedTemplateId').value = templateId;
            
            // Reset all template buttons
            var templateIds = ['xc_season', 'indoor_track', 'outdoor_track', 'summer_base'];
            templateIds.forEach(function(id) {
                var btn = document.getElementById('templateBtn_' + id);
                var check = document.getElementById('templateCheck_' + id);
                if (btn) {
                    btn.style.border = '2px solid var(--border)';
                    btn.style.background = 'var(--bg-elevated)';
                }
                if (check) check.style.display = 'none';
            });
            
            // Highlight selected template
            var selectedBtn = document.getElementById('templateBtn_' + templateId);
            var selectedCheck = document.getElementById('templateCheck_' + templateId);
            if (selectedBtn) {
                selectedBtn.style.border = '2px solid var(--primary)';
                selectedBtn.style.background = 'rgba(255,77,0,0.15)';
            }
            if (selectedCheck) selectedCheck.style.display = 'block';
            
            // Show selected template info
            document.getElementById('selectedTemplateInfo').style.display = 'block';
            document.getElementById('selectedTemplateName').textContent = template.name;
            
            // Set smart default start and end dates based on season
            var dates = getDefaultSeasonDates(templateId);
            document.getElementById('templateStartDate').value = dates.start;
            document.getElementById('templateEndDate').value = dates.end;
            calculatePlanDuration();
            
            // Set goal event based on template
            document.getElementById('goalEvent').value = template.goalEvent;
            
            // Enable the rest of the form
            document.getElementById('raceTimesCard').style.opacity = '1';
            document.getElementById('raceTimesCard').style.pointerEvents = 'auto';
            document.getElementById('trainingProfileCard').style.opacity = '1';
            document.getElementById('trainingProfileCard').style.pointerEvents = 'auto';
            document.getElementById('raceScheduleCard').style.opacity = '1';
            document.getElementById('raceScheduleCard').style.pointerEvents = 'auto';
            document.getElementById('generatePlanBtn').style.opacity = '1';
            document.getElementById('generatePlanBtn').style.pointerEvents = 'auto';
            
            // Scroll to race times
            setTimeout(function() {
                document.getElementById('raceTimesCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 200);
        }
        
        function calculatePlanDuration() {
            var startDate = document.getElementById('templateStartDate').value;
            var endDate = document.getElementById('templateEndDate').value;
            
            if (!startDate || !endDate) {
                document.getElementById('selectedTemplateDuration').textContent = 'Select dates to see plan length';
                return;
            }
            
            var start = new Date(startDate);
            var end = new Date(endDate);
            var diffTime = end - start;
            var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            var weeks = Math.ceil(diffDays / 7);
            
            if (weeks < 4) {
                document.getElementById('selectedTemplateDuration').innerHTML = '<span style="color: var(--danger);">‚ö†Ô∏è Plan too short (minimum 4 weeks)</span>';
            } else if (weeks > 20) {
                document.getElementById('selectedTemplateDuration').innerHTML = '<span style="color: var(--warning);">‚ö†Ô∏è ' + weeks + ' weeks - consider shorter blocks</span>';
            } else {
                document.getElementById('selectedTemplateDuration').innerHTML = 'üìÖ <strong>' + weeks + ' weeks</strong> of training';
            }
            
            // Update hidden plan duration
            if (weeks <= 4) {
                document.getElementById('planDuration').value = 'monthly';
            } else {
                document.getElementById('planDuration').value = 'quarterly';
            }
        }
        
        function getDefaultSeasonDates(templateId) {
            var today = new Date();
            var year = today.getFullYear();
            var month = today.getMonth();
            
            // Season date ranges
            var seasons = {
                'xc_season': { startMonth: 7, startDay: 1, endMonth: 11, endDay: 15 },      // Aug 1 - Dec 15
                'indoor_track': { startMonth: 11, startDay: 1, endMonth: 2, endDay: 15 },   // Dec 1 - Mar 15
                'outdoor_track': { startMonth: 2, startDay: 1, endMonth: 5, endDay: 15 },   // Mar 1 - Jun 15
                'summer_base': { startMonth: 5, startDay: 15, endMonth: 8, endDay: 31 }     // Jun 15 - Sep 30
            };
            
            var season = seasons[templateId];
            if (!season) {
                var nextWeek = new Date(today);
                nextWeek.setDate(nextWeek.getDate() + 7);
                var tenWeeks = new Date(today);
                tenWeeks.setDate(tenWeeks.getDate() + 70);
                return { start: formatDateInput(nextWeek), end: formatDateInput(tenWeeks) };
            }
            
            var startDate = new Date(year, season.startMonth, season.startDay);
            var endDate = new Date(year, season.endMonth, season.endDay);
            
            // Handle indoor track crossing year boundary
            if (templateId === 'indoor_track') {
                endDate = new Date(year + 1, season.endMonth, season.endDay);
            }
            
            // If season has passed, use next year
            if (endDate < today) {
                startDate = new Date(year + 1, season.startMonth, season.startDay);
                endDate = new Date(year + 1, season.endMonth, season.endDay);
                if (templateId === 'indoor_track') {
                    endDate = new Date(year + 2, season.endMonth, season.endDay);
                }
            }
            
            return { start: formatDateInput(startDate), end: formatDateInput(endDate) };
        }
        
        function formatDateInput(date) {
            var yyyy = date.getFullYear();
            var mm = String(date.getMonth() + 1).padStart(2, '0');
            var dd = String(date.getDate()).padStart(2, '0');
            return yyyy + '-' + mm + '-' + dd;
        }
        
        function getDefaultStartDate(templateId) {
            var today = new Date();
            var year = today.getFullYear();
            var month = today.getMonth(); // 0-indexed
            
            // Default start dates based on typical HS seasons
            var defaults = {
                'xc_season': new Date(year, 7, 1),      // Aug 1
                'indoor_track': new Date(year, 11, 1),  // Dec 1
                'outdoor_track': new Date(year, 2, 1),  // Mar 1
                'summer_base': new Date(year, 5, 15)    // Jun 15
            };
            
            var defaultDate = defaults[templateId] || today;
            
            // If the default date has passed this year, use next occurrence
            if (defaultDate < today) {
                // For XC (Aug), if we're past Aug, use next year
                if (templateId === 'xc_season' && month >= 8) {
                    defaultDate = new Date(year + 1, 7, 1);
                }
                // For indoor (Dec), if we're past Dec, use next year
                else if (templateId === 'indoor_track' && month >= 11) {
                    defaultDate = new Date(year + 1, 11, 1);
                }
                // For outdoor (Mar), if we're past Mar, use next year
                else if (templateId === 'outdoor_track' && month >= 3) {
                    defaultDate = new Date(year + 1, 2, 1);
                }
                // For summer (Jun), if we're past Jun, use next year
                else if (templateId === 'summer_base' && month >= 6) {
                    defaultDate = new Date(year + 1, 5, 15);
                }
                // Otherwise just use next Monday
                else {
                    var daysUntilMonday = (8 - today.getDay()) % 7 || 7;
                    defaultDate = new Date(today.getTime() + daysUntilMonday * 24 * 60 * 60 * 1000);
                }
            }
            
            // Format as YYYY-MM-DD
            return defaultDate.toISOString().split('T')[0];
        }
        
        function generatePlanFromTemplate() {
            if (!selectedTemplate) {
                alert('Please select a season template first.');
                return;
            }
            
            var template = seasonTemplates[selectedTemplate];
            
            // Validate race times
            var times = {
                '800m': parseTimeToSeconds(document.getElementById('time800m').value),
                '1600m': parseTimeToSeconds(document.getElementById('time1600m').value),
                '3200m': parseTimeToSeconds(document.getElementById('time3200m').value),
                '5000m': parseTimeToSeconds(document.getElementById('time5000m').value)
            };
            
            var hasTime = Object.values(times).some(function(t) { return t !== null; });
            
            if (!hasTime) {
                alert('Please enter at least one race time.');
                document.getElementById('raceTimesCard').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            // Generate the plan
            generatePlan();
            
            // Save template info
            setTimeout(function() {
                if (currentPlanData) {
                    currentPlanData.templateName = template.name;
                    currentPlanData.startDate = document.getElementById('templateStartDate').value;
                }
                showNotification('‚úì ' + template.name + ' plan generated!', 'var(--success)');
            }, 600);
        }
        
        // ==================== PARENT/SHARE VIEW ====================
        
        function generateShareLink() {
            // Create a shareable data package
            const profile = JSON.parse(localStorage.getItem('laktic_profile') || '{}');
            const shareData = {
                type: 'athlete_share',
                name: profile.name || 'Athlete',
                planData: currentPlanData,
                weeksData: allWeeksData,
                feedback: workoutFeedback,
                generated: new Date().toISOString()
            };
            
            // Encode to base64 (in real app, this would be stored on server with a short code)
            const encoded = btoa(JSON.stringify(shareData));
            
            // For demo, we'll use a hash-based URL
            const shareUrl = `${window.location.origin}${window.location.pathname}#share=${encoded.substring(0, 50)}`;
            
            // Store full data locally with the short code
            const shortCode = encoded.substring(0, 8).toUpperCase();
            localStorage.setItem(`laktic_share_${shortCode}`, JSON.stringify(shareData));
            
            return { url: shareUrl, code: shortCode, data: shareData };
        }
        
        function showParentShareModal() {
            if (!allWeeksData || allWeeksData.length === 0) {
                alert('Create a training plan first before sharing.');
                return;
            }
            
            const share = generateShareLink();
            
            const modal = document.createElement('div');
            modal.id = 'parentShareModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.9); backdrop-filter: blur(5px);
                z-index: 3000; display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 16px; padding: 24px; max-width: 450px; width: 100%; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 16px;">üë®‚Äçüë©‚Äçüëß</div>
                    <h2 style="margin: 0 0 8px 0; color: var(--primary);">Share with Parents</h2>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 24px;">
                        Give parents read-only access to view the training plan and logged workouts.
                    </p>
                    
                    <div style="background: var(--bg-elevated); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 8px;">Share Code</div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent); letter-spacing: 4px; font-family: monospace;">${share.code}</div>
                    </div>
                    
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 20px;">
                        Parents can enter this code at<br>
                        <strong style="color: var(--primary);">laktic.app/parent</strong><br>
                        to view training progress.
                    </p>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="copyParentShareCode('${share.code}')" 
                                style="flex: 1; padding: 14px; background: var(--primary); border: none; border-radius: 10px; 
                                       color: white; font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                            üìã Copy Code
                        </button>
                        <button onclick="document.getElementById('parentShareModal').remove()" 
                                style="flex: 1; padding: 14px; background: var(--bg-elevated); border: 1px solid var(--border); 
                                       border-radius: 10px; color: var(--text-secondary); font-weight: 600; cursor: pointer; font-size: 0.95rem;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }
        
        function copyParentShareCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showNotification('‚úì Share code copied!', 'var(--success)');
            }).catch(() => {
                prompt('Copy this code:', code);
            });
        }
        
        function openParentView(code) {
            // Load shared data
            const shareData = localStorage.getItem(`laktic_share_${code}`);
            if (!shareData) {
                alert('Share code not found or expired.');
                return;
            }
            
            const data = JSON.parse(shareData);
            
            // Show parent view modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: var(--bg-dark); z-index: 3000; overflow-y: auto;
            `;
            
            // Build workout summary
            let workoutSummary = '';
            if (data.feedback && Object.keys(data.feedback).length > 0) {
                const entries = Object.entries(data.feedback)
                    .filter(([k, v]) => v.timestamp)
                    .sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp))
                    .slice(0, 10);
                
                workoutSummary = entries.map(([key, f]) => `
                    <div style="padding: 12px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-primary); font-weight: 600;">${key}</span>
                            <span style="color: ${f.completion === 'full' ? 'var(--success)' : 'var(--warning)'};">
                                ${f.completion === 'full' ? '‚úÖ' : '‚ö†Ô∏è'} ${f.effort}/10
                            </span>
                        </div>
                        ${f.notes ? `<div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 4px;">"${f.notes}"</div>` : ''}
                    </div>
                `).join('');
            } else {
                workoutSummary = '<p style="color: var(--text-muted); text-align: center;">No workouts logged yet.</p>';
            }
            
            modal.innerHTML = `
                <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h1 style="margin: 0; color: var(--primary); font-size: 1.5rem;">${data.name}'s Training</h1>
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin: 4px 0 0 0;">Parent View ‚Ä¢ Read Only</p>
                        </div>
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                                style="padding: 8px 16px; background: var(--bg-elevated); border: none; border-radius: 8px; 
                                       color: var(--text-secondary); cursor: pointer;">Close</button>
                    </div>
                    
                    <div class="card">
                        <h2 style="color: var(--accent); font-size: 1.1rem; margin-bottom: 16px;">üìä Recent Workouts</h2>
                        ${workoutSummary}
                    </div>
                    
                    <div class="card">
                        <h2 style="color: var(--accent); font-size: 1.1rem; margin-bottom: 16px;">üìã Current Plan</h2>
                        ${data.planData ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="color: var(--text-muted); font-size: 0.75rem;">Goal Event</div>
                                    <div style="color: var(--primary); font-weight: 700;">${data.planData.goalEvent}m</div>
                                </div>
                                <div style="background: var(--bg-elevated); padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="color: var(--text-muted); font-size: 0.75rem;">Weekly Mileage</div>
                                    <div style="color: var(--primary); font-weight: 700;">${data.planData.goalMileage} mi</div>
                                </div>
                            </div>
                        ` : '<p style="color: var(--text-muted);">No plan data available.</p>'}
                    </div>
                    
                    <p style="text-align: center; color: var(--text-muted); font-size: 0.75rem; margin-top: 20px;">
                        Last updated: ${new Date(data.generated).toLocaleString()}
                    </p>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ==================== TEAM MANAGEMENT ====================
        
        let userRole = localStorage.getItem('laktic_user_role') || null;
        let teamData = JSON.parse(localStorage.getItem('laktic_team_data') || 'null');
        let athleteTeam = JSON.parse(localStorage.getItem('laktic_athlete_team') || 'null');
        
        function setUserRole(role) {
            userRole = role;
            localStorage.setItem('laktic_user_role', role);
            
            // Update UI
            updateRoleUI();
            
            showNotification(`‚úì Set as ${role === 'coach' ? 'Coach' : 'Athlete'}`, 'var(--success)');
        }
        
        function updateRoleUI() {
            var roleSelectionCard = document.getElementById('roleSelectionCard');
            var athleteBtn = document.getElementById('roleAthleteBtn');
            var coachBtn = document.getElementById('roleCoachBtn');
            var athleteTeamCard = document.getElementById('athleteTeamCard');
            var coachTeamCard = document.getElementById('coachTeamCard');
            var athleteProfileCard = document.getElementById('athleteProfileCard');
            
            // If no role selected, show the selection card
            if (!userRole) {
                roleSelectionCard.style.display = 'block';
                athleteTeamCard.style.display = 'none';
                coachTeamCard.style.display = 'none';
                if (athleteProfileCard) athleteProfileCard.style.display = 'none';
                return;
            }
            
            // Hide role selection card once role is selected
            roleSelectionCard.style.display = 'none';
            
            // Show appropriate content based on role
            if (userRole === 'athlete') {
                athleteTeamCard.style.display = 'block';
                coachTeamCard.style.display = 'none';
                if (athleteProfileCard) athleteProfileCard.style.display = 'block';
                updateAthleteTeamUI();
            } else if (userRole === 'coach') {
                athleteTeamCard.style.display = 'none';
                coachTeamCard.style.display = 'block';
                if (athleteProfileCard) athleteProfileCard.style.display = 'none';
                updateCoachProfileUI();
            }
        }
        
        function updateCoachProfileUI() {
            // Update coach team card with team info
            if (teamData) {
                var teamNameInput = document.getElementById('coachTeamName');
                if (teamNameInput) teamNameInput.value = teamData.name || '';
                
                var codeDisplay = document.getElementById('coachTeamCodeDisplay');
                var codeValue = document.getElementById('coachTeamCodeValue');
                if (codeDisplay && codeValue && teamData.code) {
                    codeDisplay.style.display = 'block';
                    codeValue.textContent = teamData.code;
                }
                
                var countEl = document.getElementById('coachAthleteCount');
                if (countEl) countEl.textContent = (teamData.athletes ? teamData.athletes.length : 0) + ' athletes';
                
                // Show roster preview
                var rosterPreview = document.getElementById('coachRosterPreview');
                if (rosterPreview && teamData.athletes && teamData.athletes.length > 0) {
                    var html = '';
                    teamData.athletes.forEach(function(athlete) {
                        html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 8px;">' +
                            '<div>' +
                                '<div style="font-weight: 600; color: var(--text-primary);">' + athlete.name + '</div>' +
                                (athlete.event ? '<div style="font-size: 0.75rem; color: var(--text-muted);">' + athlete.event + '</div>' : '') +
                            '</div>' +
                            '<div style="width: 8px; height: 8px; border-radius: 50%; background: var(--success);"></div>' +
                        '</div>';
                    });
                    rosterPreview.innerHTML = html;
                }
            }
        }
        
        function updateCoachTeamName() {
            var input = document.getElementById('coachTeamName');
            if (input && teamData) {
                teamData.name = input.value;
                localStorage.setItem('laktic_team_data', JSON.stringify(teamData));
            }
        }
        
        function generateTeamCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Removed confusing characters
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        function createTeam() {
            const teamName = prompt('Enter your team name (e.g., "Lincoln HS Track"):');
            if (!teamName) return;
            
            const teamCode = generateTeamCode();
            
            teamData = {
                id: Date.now().toString(),
                name: teamName,
                code: teamCode,
                createdAt: new Date().toISOString(),
                athletes: [],
                plans: []
            };
            
            localStorage.setItem('laktic_team_data', JSON.stringify(teamData));
            
            updateCoachTeamUI();
            showNotification(`‚úì Team "${teamName}" created!`, 'var(--success)');
        }
        
        function updateCoachTeamUI() {
            const previewDiv = document.getElementById('coachTeamPreview');
            
            if (!teamData) {
                previewDiv.innerHTML = `
                    <p style="color: var(--text-muted); font-size: 0.9rem;">Create a team to start coaching athletes.</p>
                    <button onclick="createTeam()" class="btn" style="width: 100%; margin-top: 12px;">
                        <span style="position: relative; z-index: 1;">+ Create Team</span>
                    </button>
                `;
            } else {
                previewDiv.innerHTML = `
                    <div style="background: var(--bg-elevated); padding: 16px; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">${teamData.name}</div>
                        <div style="display: flex; gap: 16px; margin-bottom: 12px;">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${teamData.athletes.length}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Athletes</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${teamData.code}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Team Code</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function updateAthleteTeamUI() {
            const statusDiv = document.getElementById('athleteTeamStatus');
            const infoDiv = document.getElementById('athleteTeamInfo');
            
            if (!athleteTeam) {
                statusDiv.style.display = 'block';
                infoDiv.style.display = 'none';
            } else {
                statusDiv.style.display = 'none';
                infoDiv.style.display = 'block';
                infoDiv.innerHTML = `
                    <div style="background: var(--bg-elevated); padding: 16px; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">${athleteTeam.teamName}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">Coach: ${athleteTeam.coachName || 'Unknown'}</div>
                            </div>
                            <span style="background: var(--success); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem;">Connected</span>
                        </div>
                        <button onclick="leaveTeam()" style="margin-top: 16px; padding: 8px 16px; background: transparent; 
                                       border: 1px solid var(--danger); border-radius: 8px; color: var(--danger); 
                                       cursor: pointer; font-size: 0.85rem; width: 100%;">
                            Leave Team
                        </button>
                    </div>
                `;
            }
        }
        
        function joinTeam() {
            const codeInput = document.getElementById('joinTeamCode');
            const code = codeInput.value.trim().toUpperCase();
            
            if (code.length !== 6) {
                alert('Please enter a valid 6-character team code.');
                return;
            }
            
            // In a real app, this would verify with a server
            // For now, we'll simulate joining and store locally
            const profile = JSON.parse(localStorage.getItem('laktic_profile') || '{}');
            
            athleteTeam = {
                code: code,
                teamName: 'Team ' + code, // Would come from server
                coachName: 'Coach', // Would come from server
                joinedAt: new Date().toISOString(),
                athleteName: profile.name || 'Athlete',
                athleteId: Date.now().toString()
            };
            
            localStorage.setItem('laktic_athlete_team', JSON.stringify(athleteTeam));
            
            updateAthleteTeamUI();
            showNotification('‚úì Joined team! Your coach can now see your training.', 'var(--success)');
            
            // Generate a sync code the athlete can share with coach
            generateAthleteSyncCode();
        }
        
        function leaveTeam() {
            if (!confirm('Are you sure you want to leave this team? Your coach will no longer see your training data.')) {
                return;
            }
            
            athleteTeam = null;
            localStorage.removeItem('laktic_athlete_team');
            updateAthleteTeamUI();
            showNotification('Left team', 'var(--text-muted)');
        }
        
        function generateAthleteSyncCode() {
            // Generate a code that contains athlete's data for coach to import
            const profile = JSON.parse(localStorage.getItem('laktic_profile') || '{}');
            const syncData = {
                type: 'athlete_sync',
                name: profile.name || 'Athlete',
                id: athleteTeam.athleteId,
                teamCode: athleteTeam.code,
                prs: {
                    '800m': profile.pr800m || null,
                    '1600m': profile.pr1600m || null,
                    '3200m': profile.pr3200m || null
                },
                feedback: workoutFeedback,
                timestamp: new Date().toISOString()
            };
            
            // Store for sharing
            localStorage.setItem('laktic_athlete_sync', JSON.stringify(syncData));
        }
        
        function initTeamDashboard() {
            if (!teamData) {
                document.getElementById('teamDashboardContent').innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">üë•</div>
                        <p style="color: var(--text-muted); margin-bottom: 20px;">You haven't created a team yet.</p>
                        <button onclick="createTeam()" class="btn">
                            <span style="position: relative; z-index: 1;">+ Create Team</span>
                        </button>
                    </div>
                `;
                return;
            }
            
            // Show team info
            document.getElementById('teamDashboardContent').innerHTML = `
                <div style="background: linear-gradient(135deg, rgba(255,77,0,0.1), rgba(0,217,255,0.1)); 
                            padding: 20px; border-radius: 12px; border: 1px solid var(--primary);">
                    <div style="font-size: 1.4rem; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${teamData.name}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Created ${new Date(teamData.createdAt).toLocaleDateString()}</div>
                </div>
            `;
            
            // Show team code card
            document.getElementById('teamCodeCard').style.display = 'block';
            document.getElementById('teamCodeDisplay').textContent = teamData.code;
            
            // Update roster display with new function
            updateRosterDisplay();
        }
        
        function updateAthletesList() {
            const listDiv = document.getElementById('athletesList');
            
            if (!teamData || teamData.athletes.length === 0) {
                listDiv.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 20px;">No athletes yet. Share your team code to get started!</p>`;
                return;
            }
            
            let html = '';
            teamData.athletes.forEach(athlete => {
                const lastActive = athlete.lastSync ? new Date(athlete.lastSync).toLocaleDateString() : 'Never';
                const statusColor = athlete.lastSync && (Date.now() - new Date(athlete.lastSync)) < 86400000 * 3 ? 'var(--success)' : 'var(--text-muted)';
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px; 
                                background: var(--bg-elevated); border-radius: 10px; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${athlete.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Last active: ${lastActive}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: ${statusColor};"></div>
                            <button onclick="viewAthleteDetail('${athlete.id}')" 
                                    style="padding: 6px 12px; background: var(--primary); border: none; border-radius: 6px; 
                                           color: white; font-size: 0.8rem; cursor: pointer;">
                                View
                            </button>
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }
        
        function updateTeamActivityFeed() {
            const feedDiv = document.getElementById('teamActivityFeed');
            
            if (!teamData || teamData.athletes.length === 0) {
                feedDiv.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 20px;">No activity yet.</p>`;
                return;
            }
            
            // Collect all feedback from all athletes
            let allActivity = [];
            teamData.athletes.forEach(athlete => {
                if (athlete.feedback) {
                    Object.entries(athlete.feedback).forEach(([key, data]) => {
                        if (data.timestamp) {
                            allActivity.push({
                                athleteName: athlete.name,
                                athleteId: athlete.id,
                                workoutKey: key,
                                ...data
                            });
                        }
                    });
                }
            });
            
            // Sort by timestamp (newest first)
            allActivity.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Show last 10
            const recentActivity = allActivity.slice(0, 10);
            
            if (recentActivity.length === 0) {
                feedDiv.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 20px;">No logged workouts yet.</p>`;
                return;
            }
            
            let html = '';
            recentActivity.forEach(activity => {
                const date = new Date(activity.timestamp).toLocaleDateString();
                const completionIcon = activity.completion === 'full' ? '‚úÖ' : activity.completion === 'partial' ? 'üî∂' : '‚ùå';
                
                html += `
                    <div style="padding: 12px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <span style="font-weight: 600; color: var(--primary);">${activity.athleteName}</span>
                                <span style="color: var(--text-muted); font-size: 0.85rem;"> logged ${activity.workoutKey}</span>
                            </div>
                            <span style="font-size: 0.75rem; color: var(--text-muted);">${date}</span>
                        </div>
                        <div style="margin-top: 6px; font-size: 0.85rem;">
                            ${completionIcon} Effort: ${activity.effort}/10
                            ${activity.notes ? `<br><span style="color: var(--text-secondary);">"${activity.notes}"</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            feedDiv.innerHTML = html;
        }
        
        function populateAssignPlanDropdowns() {
            const planSelect = document.getElementById('planToAssign');
            const athleteSelect = document.getElementById('assignTo');
            
            // Populate plans
            planSelect.innerHTML = '<option value="">-- Select a saved plan --</option>';
            Object.values(savedPlans).forEach(plan => {
                planSelect.innerHTML += `<option value="${plan.id}">${plan.name}</option>`;
            });
            
            // Populate athletes
            athleteSelect.innerHTML = '<option value="all">All Athletes</option>';
            if (teamData && teamData.athletes) {
                teamData.athletes.forEach(athlete => {
                    athleteSelect.innerHTML += `<option value="${athlete.id}">${athlete.name}</option>`;
                });
            }
            
            // Set default date to today
            document.getElementById('planStartDate').value = new Date().toISOString().split('T')[0];
        }
        
        function assignPlanToAthletes() {
            const planId = document.getElementById('planToAssign').value;
            const assignTo = document.getElementById('assignTo').value;
            const startDate = document.getElementById('planStartDate').value;
            
            if (!planId) {
                alert('Please select a plan to assign.');
                return;
            }
            
            if (!startDate) {
                alert('Please select a start date.');
                return;
            }
            
            const plan = savedPlans[planId];
            if (!plan) {
                alert('Plan not found.');
                return;
            }
            
            // In a real app, this would push to athletes via server
            // For now, we'll just create an assignment record
            const assignment = {
                planId: planId,
                planName: plan.name,
                assignTo: assignTo,
                startDate: startDate,
                assignedAt: new Date().toISOString()
            };
            
            if (!teamData.assignments) {
                teamData.assignments = [];
            }
            teamData.assignments.push(assignment);
            localStorage.setItem('laktic_team_data', JSON.stringify(teamData));
            
            const athleteText = assignTo === 'all' ? 'all athletes' : teamData.athletes.find(a => a.id === assignTo)?.name || 'athlete';
            showNotification(`‚úì Plan assigned to ${athleteText}!`, 'var(--success)');
        }
        
        function copyTeamCode() {
            if (!teamData) return;
            
            navigator.clipboard.writeText(teamData.code).then(() => {
                showNotification('‚úì Team code copied!', 'var(--success)');
            }).catch(() => {
                // Fallback for older browsers
                prompt('Copy this team code:', teamData.code);
            });
        }
        
        function viewAthleteDetail(athleteId) {
            const athlete = teamData.athletes.find(a => a.id === athleteId);
            if (!athlete) return;
            
            // Create a modal showing athlete details
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
                z-index: 3000; display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            // Build feedback summary
            let feedbackHtml = '<p style="color: var(--text-muted);">No logged workouts yet.</p>';
            if (athlete.feedback && Object.keys(athlete.feedback).length > 0) {
                const entries = Object.entries(athlete.feedback)
                    .filter(([k, v]) => v.timestamp)
                    .sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp))
                    .slice(0, 5);
                
                if (entries.length > 0) {
                    feedbackHtml = entries.map(([key, data]) => `
                        <div style="padding: 10px; background: var(--bg-elevated); border-radius: 6px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-primary); font-weight: 600;">${key}</span>
                                <span style="color: var(--text-muted); font-size: 0.8rem;">${data.effort}/10</span>
                            </div>
                            ${data.notes ? `<div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 4px;">"${data.notes}"</div>` : ''}
                        </div>
                    `).join('');
                }
            }
            
            modal.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 16px; padding: 24px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                        <div>
                            <h2 style="margin: 0; color: var(--text-primary);">${athlete.name}</h2>
                            <div style="color: var(--text-muted); font-size: 0.85rem;">Joined ${new Date(athlete.joinedAt).toLocaleDateString()}</div>
                        </div>
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                                style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    
                    ${athlete.prs ? `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--accent); font-size: 1rem; margin-bottom: 12px;">Personal Records</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            ${athlete.prs['800m'] ? `<div style="background: var(--bg-elevated); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="color: var(--primary); font-weight: 700;">${athlete.prs['800m']}</div>
                                <div style="color: var(--text-muted); font-size: 0.75rem;">800m</div>
                            </div>` : ''}
                            ${athlete.prs['1600m'] ? `<div style="background: var(--bg-elevated); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="color: var(--primary); font-weight: 700;">${athlete.prs['1600m']}</div>
                                <div style="color: var(--text-muted); font-size: 0.75rem;">1600m</div>
                            </div>` : ''}
                            ${athlete.prs['3200m'] ? `<div style="background: var(--bg-elevated); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="color: var(--primary); font-weight: 700;">${athlete.prs['3200m']}</div>
                                <div style="color: var(--text-muted); font-size: 0.75rem;">3200m</div>
                            </div>` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div>
                        <h3 style="color: var(--accent); font-size: 1rem; margin-bottom: 12px;">Recent Workouts</h3>
                        ${feedbackHtml}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }
        
        function addAthleteToTeam(syncCode) {
            // Parse sync code from athlete
            try {
                const syncData = JSON.parse(atob(syncCode));
                if (syncData.type !== 'athlete_sync' || syncData.teamCode !== teamData.code) {
                    alert('Invalid sync code or wrong team.');
                    return;
                }
                
                // Check if athlete already exists
                if (teamData.athletes.find(a => a.id === syncData.id)) {
                    // Update existing athlete
                    const idx = teamData.athletes.findIndex(a => a.id === syncData.id);
                    teamData.athletes[idx] = {
                        ...teamData.athletes[idx],
                        ...syncData,
                        lastSync: new Date().toISOString()
                    };
                } else {
                    // Add new athlete
                    teamData.athletes.push({
                        id: syncData.id,
                        name: syncData.name,
                        prs: syncData.prs,
                        feedback: syncData.feedback,
                        joinedAt: new Date().toISOString(),
                        lastSync: new Date().toISOString()
                    });
                }
                
                localStorage.setItem('laktic_team_data', JSON.stringify(teamData));
                updateAthletesList();
                updateTeamActivityFeed();
                
                showNotification(`‚úì ${syncData.name} synced!`, 'var(--success)');
            } catch (e) {
                alert('Invalid sync code.');
            }
        }
        
        // ==================== COACH ROSTER MANAGEMENT ====================
        
        function openAddAthleteModal() {
            document.getElementById('addAthleteModal').style.display = 'block';
            document.getElementById('newAthleteName').value = '';
            document.getElementById('newAthleteGrade').value = '';
            document.getElementById('event800').checked = false;
            document.getElementById('event1600').checked = false;
            document.getElementById('event3200').checked = false;
            document.getElementById('event5k').checked = false;
        }
        
        function closeAddAthleteModal() {
            document.getElementById('addAthleteModal').style.display = 'none';
        }
        
        function saveNewAthlete() {
            var name = document.getElementById('newAthleteName').value.trim();
            if (!name) {
                alert('Please enter athlete name');
                return;
            }
            
            var events = [];
            if (document.getElementById('event800').checked) events.push('800m');
            if (document.getElementById('event1600').checked) events.push('1600m');
            if (document.getElementById('event3200').checked) events.push('3200m');
            if (document.getElementById('event5k').checked) events.push('5K');
            
            var athlete = {
                id: Date.now().toString(),
                name: name,
                grade: document.getElementById('newAthleteGrade').value,
                events: events,
                prs: {},
                trainingParams: null, // Will be set up later
                plan: null, // Will be generated later
                feedback: {},
                joinedAt: new Date().toISOString()
            };
            
            if (!teamData) {
                teamData = { name: '', code: '', athletes: [] };
            }
            if (!teamData.athletes) teamData.athletes = [];
            teamData.athletes.push(athlete);
            localStorage.setItem('laktic_team_data', JSON.stringify(teamData));
            
            closeAddAthleteModal();
            updateRosterDisplay();
            showNotification('‚úì ' + name + ' added to roster!', 'var(--success)');
        }
        
        function updateRosterDisplay() {
            var listEl = document.getElementById('athletesList');
            var countEl = document.getElementById('athleteCount');
            var buildPlansCard = document.getElementById('buildPlansCard');
            
            if (!teamData || !teamData.athletes || teamData.athletes.length === 0) {
                listEl.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No athletes yet. Add your roster!</p>';
                countEl.textContent = '0';
                buildPlansCard.style.display = 'none';
                return;
            }
            
            countEl.textContent = teamData.athletes.length;
            
            var html = '';
            var needsSetup = [];
            
            teamData.athletes.forEach(function(athlete) {
                var eventStr = athlete.events && athlete.events.length > 0 ? athlete.events.join(', ') : 'No events';
                var statusColor = athlete.trainingParams ? 'var(--success)' : 'var(--warning)';
                var statusText = athlete.trainingParams ? '‚úì Ready' : '‚ö†Ô∏è Needs Setup';
                
                if (!athlete.trainingParams) needsSetup.push(athlete);
                
                html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-elevated); border-radius: 10px; margin-bottom: 10px; border-left: 3px solid ' + statusColor + ';">';
                html += '<div style="flex: 1;">';
                html += '<div style="font-weight: 600; color: var(--text-primary);">' + athlete.name + '</div>';
                html += '<div style="font-size: 0.8rem; color: var(--text-muted);">' + (athlete.grade || '') + ' ‚Ä¢ ' + eventStr + '</div>';
                html += '<div style="font-size: 0.75rem; color: ' + statusColor + '; margin-top: 4px;">' + statusText + '</div>';
                html += '</div>';
                html += '<div style="display: flex; gap: 8px;">';
                html += '<button onclick="openAthleteSetup(\'' + athlete.id + '\')" style="padding: 8px 12px; background: var(--primary); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.8rem;">' + (athlete.trainingParams ? '‚úèÔ∏è' : '‚öôÔ∏è') + '</button>';
                html += '<button onclick="removeAthlete(\'' + athlete.id + '\')" style="padding: 8px 12px; background: transparent; border: 1px solid var(--danger); border-radius: 6px; color: var(--danger); cursor: pointer; font-size: 0.8rem;">‚úï</button>';
                html += '</div>';
                html += '</div>';
            });
            
            listEl.innerHTML = html;
            
            // Show build plans section if athletes exist
            if (teamData.athletes.length > 0) {
                buildPlansCard.style.display = 'block';
                updateAthleteSetupList();
            }
        }
        
        function removeAthlete(athleteId) {
            if (!confirm('Remove this athlete from roster?')) return;
            
            teamData.athletes = teamData.athletes.filter(function(a) { return a.id !== athleteId; });
            localStorage.setItem('laktic_team_data', JSON.stringify(teamData));
            updateRosterDisplay();
            showNotification('Athlete removed', 'var(--text-muted)');
        }
        
        function openAthleteSetup(athleteId) {
            var athlete = teamData.athletes.find(function(a) { return a.id === athleteId; });
            if (!athlete) return;
            
            document.getElementById('athleteSetupModal').style.display = 'block';
            document.getElementById('setupAthleteName').textContent = 'Setup: ' + athlete.name;
            document.getElementById('setupAthleteId').value = athleteId;
            
            // Pre-fill if already has params
            if (athlete.trainingParams) {
                document.getElementById('setup800m').value = athlete.trainingParams.time800m || '';
                document.getElementById('setup1600m').value = athlete.trainingParams.time1600m || '';
                document.getElementById('setup3200m').value = athlete.trainingParams.time3200m || '';
                document.getElementById('setup5k').value = athlete.trainingParams.time5k || '';
                document.getElementById('setupCurrentMileage').value = athlete.trainingParams.currentMileage || '';
                document.getElementById('setupGoalMileage').value = athlete.trainingParams.goalMileage || '';
                document.getElementById('setupGoalEvent').value = athlete.trainingParams.goalEvent || '1500';
                document.getElementById('setupFitnessLevel').value = athlete.trainingParams.fitnessLevel || '75';
            } else {
                document.getElementById('setup800m').value = '';
                document.getElementById('setup1600m').value = '';
                document.getElementById('setup3200m').value = '';
                document.getElementById('setup5k').value = '';
                document.getElementById('setupCurrentMileage').value = '';
                document.getElementById('setupGoalMileage').value = '';
                document.getElementById('setupGoalEvent').value = '1500';
                document.getElementById('setupFitnessLevel').value = '75';
            }
        }
        
        function closeAthleteSetupModal() {
            document.getElementById('athleteSetupModal').style.display = 'none';
        }
        
        function saveAthleteSetup() {
            var athleteId = document.getElementById('setupAthleteId').value;
            var athlete = teamData.athletes.find(function(a) { return a.id === athleteId; });
            if (!athlete) return;
            
            var time800m = document.getElementById('setup800m').value.trim();
            var time1600m = document.getElementById('setup1600m').value.trim();
            var time3200m = document.getElementById('setup3200m').value.trim();
            var time5k = document.getElementById('setup5k').value.trim();
            var currentMileage = parseInt(document.getElementById('setupCurrentMileage').value);
            var goalMileage = parseInt(document.getElementById('setupGoalMileage').value);
            
            // Validate at least one time
            if (!time800m && !time1600m && !time3200m && !time5k) {
                alert('Please enter at least one race time');
                return;
            }
            
            if (!currentMileage || !goalMileage) {
                alert('Please enter current and goal mileage');
                return;
            }
            
            athlete.trainingParams = {
                time800m: time800m,
                time1600m: time1600m,
                time3200m: time3200m,
                time5k: time5k,
                currentMileage: currentMileage,
                goalMileage: goalMileage,
                goalEvent: document.getElementById('setupGoalEvent').value,
                fitnessLevel: parseInt(document.getElementById('setupFitnessLevel').value)
            };
            
            localStorage.setItem('laktic_team_data', JSON.stringify(teamData));
            closeAthleteSetupModal();
            updateRosterDisplay();
            showNotification('‚úì ' + athlete.name + ' parameters saved!', 'var(--success)');
        }
        
        function updateAthleteSetupList() {
            var setupList = document.getElementById('athleteSetupList');
            var generateBtn = document.getElementById('generateAllPlansBtn');
            
            if (!teamData || !teamData.athletes) return;
            
            var readyCount = 0;
            var html = '';
            
            teamData.athletes.forEach(function(athlete) {
                var isReady = athlete.trainingParams !== null;
                if (isReady) readyCount++;
                
                var statusColor = isReady ? 'var(--success)' : 'var(--warning)';
                var statusIcon = isReady ? '‚úì' : '‚ö†Ô∏è';
                var hasPlan = athlete.plan !== null;
                
                html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 8px;">';
                html += '<div>';
                html += '<span style="font-weight: 600; color: var(--text-primary);">' + athlete.name + '</span>';
                html += '<span style="color: ' + statusColor + '; font-size: 0.8rem; margin-left: 8px;">' + statusIcon + ' ' + (isReady ? 'Ready' : 'Needs setup') + '</span>';
                if (hasPlan) {
                    html += '<span style="color: var(--accent); font-size: 0.75rem; margin-left: 8px;">üìã Has plan</span>';
                }
                html += '</div>';
                html += '<button onclick="openAthleteSetup(\'' + athlete.id + '\')" style="padding: 6px 12px; background: ' + (isReady ? 'transparent' : 'var(--primary)') + '; border: 1px solid ' + (isReady ? 'var(--border)' : 'var(--primary)') + '; border-radius: 6px; color: ' + (isReady ? 'var(--text-secondary)' : 'white') + '; cursor: pointer; font-size: 0.8rem;">';
                html += isReady ? 'Edit' : 'Setup';
                html += '</button>';
                html += '</div>';
            });
            
            setupList.innerHTML = html;
            
            // Show generate button if at least one athlete is ready
            if (readyCount > 0) {
                generateBtn.style.display = 'block';
                generateBtn.innerHTML = '<span style="position: relative; z-index: 1;">üöÄ Generate Plans for ' + readyCount + ' Athlete' + (readyCount > 1 ? 's' : '') + '</span>';
            } else {
                generateBtn.style.display = 'none';
            }
        }
        
        // Store team plans
        var teamPlans = JSON.parse(localStorage.getItem('laktic_team_plans') || '{}');
        
        function generateAllAthletePlans() {
            if (!teamData || !teamData.athletes) return;
            
            var startDate = document.getElementById('templateStartDate');
            var endDate = document.getElementById('templateEndDate');
            
            // Get plan dates from the season template if set, otherwise use defaults
            var planStart = startDate && startDate.value ? startDate.value : getDefaultSeasonDates('outdoor_track').start;
            var planEnd = endDate && endDate.value ? endDate.value : getDefaultSeasonDates('outdoor_track').end;
            
            var startD = new Date(planStart);
            var endD = new Date(planEnd);
            var totalWeeks = Math.max(4, Math.ceil((endD - startD) / (1000 * 60 * 60 * 24 * 7)));
            
            var generated = 0;
            
            teamData.athletes.forEach(function(athlete) {
                if (!athlete.trainingParams) return;
                
                var params = athlete.trainingParams;
                
                // Parse times to calculate VDOT
                var times = {
                    '800m': params.time800m ? parseTimeToSeconds(params.time800m) : null,
                    '1600m': params.time1600m ? parseTimeToSeconds(params.time1600m) : null,
                    '3200m': params.time3200m ? parseTimeToSeconds(params.time3200m) : null,
                    '5000m': params.time5k ? parseTimeToSeconds(params.time5k) : null
                };
                
                var vdots = [];
                var distanceMap = { '800m': 800, '1600m': 1600, '3200m': 3200, '5000m': 5000 };
                for (var dist in times) {
                    if (times[dist]) {
                        vdots.push(estimateVDOT(times[dist], distanceMap[dist]));
                    }
                }
                
                if (vdots.length === 0) return;
                
                var avgVDOT = Math.round(vdots.reduce(function(a, b) { return a + b; }, 0) / vdots.length);
                var paces = calculatePaces(avgVDOT);
                
                // Build the plan
                var today = new Date();
                var raceSchedule = []; // Could add per-athlete race schedule later
                
                // Store for this athlete
                var athletePlan = buildMultiWeekPlanForAthlete(paces, params.currentMileage, params.goalMileage, params.goalEvent, totalWeeks, raceSchedule, today, params.fitnessLevel);
                
                athlete.plan = {
                    vdot: avgVDOT,
                    paces: paces,
                    startDate: planStart,
                    endDate: planEnd,
                    totalWeeks: totalWeeks,
                    weeksData: athletePlan,
                    generatedAt: new Date().toISOString()
                };
                
                generated++;
            });
            
            localStorage.setItem('laktic_team_data', JSON.stringify(teamData));
            updateRosterDisplay();
            showNotification('‚úì Generated plans for ' + generated + ' athletes!', 'var(--success)');
            
            // Navigate to plans page to show team plans
            setTimeout(function() {
                switchPage('myPlansPage');
            }, 1000);
        }
        
        function buildMultiWeekPlanForAthlete(paces, currentMileage, goalMileage, goalEvent, totalWeeks, raceSchedule, today, fitnessLevel) {
            // Simplified version of buildMultiWeekPlan that returns weeksData
            var weeks = [];
            var rampUp = calculateProgressiveRampUp(fitnessLevel, totalWeeks);
            var phases = calculateTrainingPhases(totalWeeks, rampUp.rampUpWeeks, raceSchedule);
            
            for (var weekNum = 1; weekNum <= totalWeeks; weekNum++) {
                var weekStart = new Date(today);
                weekStart.setDate(today.getDate() + (weekNum - 1) * 7);
                
                var phaseInfo = determinePhase(weekNum, totalWeeks, weekStart, raceSchedule, rampUp.rampUpWeeks, phases);
                var band = getMileageBand(goalMileage);
                
                var weekMultiplier = weekNum <= rampUp.rampUpWeeks ? rampUp.weeklyMultipliers[weekNum - 1] : 1.0;
                var weekMileage = Math.round(currentMileage + (goalMileage - currentMileage) * Math.min(1, weekNum / (totalWeeks * 0.6)));
                weekMileage = Math.round(weekMileage * weekMultiplier);
                
                var workouts = buildWeekForPhase(paces, weekMileage, goalEvent, phaseInfo, band, weekNum, weekMultiplier);
                
                weeks.push({
                    weekNumber: weekNum,
                    label: phaseInfo.label,
                    description: phaseInfo.description,
                    mileage: weekMileage,
                    season: phaseInfo.season,
                    workouts: workouts,
                    phaseInfo: phaseInfo,
                    weekMultiplier: weekMultiplier,
                    isRampUpWeek: weekNum <= rampUp.rampUpWeeks,
                    raceWeek: phaseInfo.raceWeek
                });
            }
            
            return weeks;
        }
        
        // Legacy function for compatibility
        function addDemoAthlete() {
            openAddAthleteModal();
        }
        
        // ==================== COACH PLAN CREATION FLOW ====================
        
        var coachSelectedTemplate = null;
        
        function initCoachPlanCreation() {
            // Check if coach with athletes
            if (userRole === 'coach' && teamData && teamData.athletes && teamData.athletes.length > 0) {
                // HIDE any stale personal workout plan display
                var workoutPlan = document.getElementById('workoutPlan');
                if (workoutPlan) workoutPlan.style.display = 'none';
                
                // Hide no plan message
                var noPlanMessage = document.getElementById('noPlanMessage');
                if (noPlanMessage) noPlanMessage.style.display = 'none';
                
                // Hide myPlanContent (which might show old plans)
                var myPlanContent = document.getElementById('myPlanContent');
                if (myPlanContent) myPlanContent.style.display = 'none';
                
                // Show coach roster section
                document.getElementById('coachRosterPlanSection').style.display = 'block';
                
                // COMPLETELY HIDE the regular athlete plan creation form
                document.getElementById('athletePlanSection').style.display = 'none';
                
                // Also hide the generate button for individual plans
                var generateBtn = document.getElementById('generatePlanBtn');
                if (generateBtn) generateBtn.style.display = 'none';
                
                // Update athlete count
                document.getElementById('rosterAthleteCount').innerHTML = 
                    '<span style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">' + teamData.athletes.length + '</span>' +
                    '<span style="color: var(--text-muted);"> athletes on roster</span>';
                
                // Populate athlete params list
                populateCoachAthleteParams();
            } else {
                // For athletes or coaches without roster, show normal form
                document.getElementById('coachRosterPlanSection').style.display = 'none';
                document.getElementById('athletePlanSection').style.display = 'block';
                
                var generateBtn = document.getElementById('generatePlanBtn');
                if (generateBtn) generateBtn.style.display = 'block';
            }
        }
        
        function selectCoachTemplate(templateId) {
            coachSelectedTemplate = templateId;
            
            // Update button styles
            document.querySelectorAll('.coach-season-btn').forEach(function(btn) {
                btn.style.border = '2px solid var(--border)';
                btn.style.background = 'var(--bg-elevated)';
            });
            
            var btnMap = {
                'xc_season': 'coachTemplateBtn_xc',
                'indoor_track': 'coachTemplateBtn_indoor',
                'outdoor_track': 'coachTemplateBtn_outdoor',
                'summer_base': 'coachTemplateBtn_summer'
            };
            
            var selectedBtn = document.getElementById(btnMap[templateId]);
            if (selectedBtn) {
                selectedBtn.style.border = '2px solid var(--primary)';
                selectedBtn.style.background = 'rgba(255,77,0,0.15)';
            }
            
            // Set default dates
            var dates = getDefaultSeasonDates(templateId);
            document.getElementById('coachStartDate').value = dates.start;
            document.getElementById('coachEndDate').value = dates.end;
            updateCoachPlanDuration();
        }
        
        function updateCoachPlanDuration() {
            var startDate = document.getElementById('coachStartDate').value;
            var endDate = document.getElementById('coachEndDate').value;
            var durationEl = document.getElementById('coachPlanDuration');
            
            if (!startDate || !endDate) {
                durationEl.textContent = 'Select dates to see plan length';
                return;
            }
            
            var start = new Date(startDate);
            var end = new Date(endDate);
            var weeks = Math.ceil((end - start) / (1000 * 60 * 60 * 24 * 7));
            
            if (weeks < 4) {
                durationEl.innerHTML = '<span style="color: var(--danger);">‚ö†Ô∏è Plan too short (minimum 4 weeks)</span>';
            } else {
                durationEl.innerHTML = 'üìÖ <strong>' + weeks + ' weeks</strong> of training';
            }
            
            checkGenerateButtonState();
        }
        
        function populateCoachAthleteParams() {
            var container = document.getElementById('coachAthleteParamsList');
            if (!teamData || !teamData.athletes) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No athletes on roster</p>';
                return;
            }
            
            var html = '';
            teamData.athletes.forEach(function(athlete, idx) {
                var isComplete = athlete.trainingParams && 
                    (athlete.trainingParams.time800m || athlete.trainingParams.time1600m || athlete.trainingParams.time3200m || athlete.trainingParams.time5k) &&
                    athlete.trainingParams.currentMileage && athlete.trainingParams.goalMileage;
                
                var statusColor = isComplete ? 'var(--success)' : 'var(--warning)';
                var statusText = isComplete ? '‚úì Ready' : '‚ö†Ô∏è Needs info';
                
                html += '<div id="athleteParam_' + athlete.id + '" style="background: var(--bg-elevated); border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 4px solid ' + statusColor + ';">';
                
                // Header
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
                html += '<div>';
                html += '<div style="font-weight: 600; color: var(--text-primary); font-size: 1.1rem;">' + athlete.name + '</div>';
                html += '<div style="font-size: 0.8rem; color: var(--text-muted);">' + (athlete.grade || '') + ' ‚Ä¢ ' + (athlete.events ? athlete.events.join(', ') : 'No events') + '</div>';
                html += '</div>';
                html += '<span id="athleteStatus_' + athlete.id + '" style="color: ' + statusColor + '; font-size: 0.85rem; font-weight: 600;">' + statusText + '</span>';
                html += '</div>';
                
                // Collapsible params section
                html += '<div id="athleteParamsExpanded_' + athlete.id + '" style="display: ' + (isComplete ? 'none' : 'block') + ';">';
                
                // Race times row
                html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px;">';
                html += '<div class="input-group" style="margin: 0;"><label style="font-size: 0.7rem;">800m</label>';
                html += '<input type="text" id="param800_' + athlete.id + '" placeholder="2:05" value="' + (athlete.trainingParams?.time800m || '') + '" onchange="updateAthleteParam(\'' + athlete.id + '\')" style="width: 100%; padding: 8px; font-size: 0.85rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);"></div>';
                html += '<div class="input-group" style="margin: 0;"><label style="font-size: 0.7rem;">1600m</label>';
                html += '<input type="text" id="param1600_' + athlete.id + '" placeholder="4:30" value="' + (athlete.trainingParams?.time1600m || '') + '" onchange="updateAthleteParam(\'' + athlete.id + '\')" style="width: 100%; padding: 8px; font-size: 0.85rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);"></div>';
                html += '<div class="input-group" style="margin: 0;"><label style="font-size: 0.7rem;">3200m</label>';
                html += '<input type="text" id="param3200_' + athlete.id + '" placeholder="9:45" value="' + (athlete.trainingParams?.time3200m || '') + '" onchange="updateAthleteParam(\'' + athlete.id + '\')" style="width: 100%; padding: 8px; font-size: 0.85rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);"></div>';
                html += '<div class="input-group" style="margin: 0;"><label style="font-size: 0.7rem;">5K</label>';
                html += '<input type="text" id="param5k_' + athlete.id + '" placeholder="16:30" value="' + (athlete.trainingParams?.time5k || '') + '" onchange="updateAthleteParam(\'' + athlete.id + '\')" style="width: 100%; padding: 8px; font-size: 0.85rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);"></div>';
                html += '</div>';
                
                // Mileage and event row
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">';
                html += '<div class="input-group" style="margin: 0;"><label style="font-size: 0.7rem;">Current MPW</label>';
                html += '<input type="number" id="paramCurrent_' + athlete.id + '" placeholder="25" value="' + (athlete.trainingParams?.currentMileage || '') + '" onchange="updateAthleteParam(\'' + athlete.id + '\')" style="width: 100%; padding: 8px; font-size: 0.85rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);"></div>';
                html += '<div class="input-group" style="margin: 0;"><label style="font-size: 0.7rem;">Goal MPW</label>';
                html += '<input type="number" id="paramGoal_' + athlete.id + '" placeholder="35" value="' + (athlete.trainingParams?.goalMileage || '') + '" onchange="updateAthleteParam(\'' + athlete.id + '\')" style="width: 100%; padding: 8px; font-size: 0.85rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);"></div>';
                html += '<div class="input-group" style="margin: 0;"><label style="font-size: 0.7rem;">Event</label>';
                html += '<select id="paramEvent_' + athlete.id + '" onchange="updateAthleteParam(\'' + athlete.id + '\')" style="width: 100%; padding: 8px; font-size: 0.85rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">';
                html += '<option value="800"' + (athlete.trainingParams?.goalEvent === '800' ? ' selected' : '') + '>800m</option>';
                html += '<option value="1500"' + (!athlete.trainingParams?.goalEvent || athlete.trainingParams?.goalEvent === '1500' ? ' selected' : '') + '>1600m</option>';
                html += '<option value="3200"' + (athlete.trainingParams?.goalEvent === '3200' ? ' selected' : '') + '>3200m</option>';
                html += '</select></div>';
                html += '</div>';
                
                html += '</div>'; // End expanded params
                
                // Toggle button for completed athletes
                if (isComplete) {
                    html += '<button onclick="toggleAthleteParams(\'' + athlete.id + '\')" style="width: 100%; padding: 8px; background: transparent; border: 1px dashed var(--border); border-radius: 6px; color: var(--text-muted); cursor: pointer; font-size: 0.8rem;">Edit Parameters</button>';
                }
                
                html += '</div>';
            });
            
            container.innerHTML = html;
            checkGenerateButtonState();
        }
        
        function toggleAthleteParams(athleteId) {
            var expandedEl = document.getElementById('athleteParamsExpanded_' + athleteId);
            if (expandedEl.style.display === 'none') {
                expandedEl.style.display = 'block';
            } else {
                expandedEl.style.display = 'none';
            }
        }
        
        function updateAthleteParam(athleteId) {
            var athlete = teamData.athletes.find(function(a) { return a.id === athleteId; });
            if (!athlete) return;
            
            if (!athlete.trainingParams) athlete.trainingParams = {};
            
            athlete.trainingParams.time800m = document.getElementById('param800_' + athleteId).value.trim();
            athlete.trainingParams.time1600m = document.getElementById('param1600_' + athleteId).value.trim();
            athlete.trainingParams.time3200m = document.getElementById('param3200_' + athleteId).value.trim();
            athlete.trainingParams.time5k = document.getElementById('param5k_' + athleteId).value.trim();
            athlete.trainingParams.currentMileage = parseInt(document.getElementById('paramCurrent_' + athleteId).value) || 0;
            athlete.trainingParams.goalMileage = parseInt(document.getElementById('paramGoal_' + athleteId).value) || 0;
            athlete.trainingParams.goalEvent = document.getElementById('paramEvent_' + athleteId).value;
            athlete.trainingParams.fitnessLevel = 75; // Default
            
            localStorage.setItem('laktic_team_data', JSON.stringify(teamData));
            
            // Update status
            var isComplete = (athlete.trainingParams.time800m || athlete.trainingParams.time1600m || athlete.trainingParams.time3200m || athlete.trainingParams.time5k) &&
                athlete.trainingParams.currentMileage && athlete.trainingParams.goalMileage;
            
            var statusEl = document.getElementById('athleteStatus_' + athleteId);
            var cardEl = document.getElementById('athleteParam_' + athleteId);
            if (isComplete) {
                statusEl.innerHTML = '‚úì Ready';
                statusEl.style.color = 'var(--success)';
                cardEl.style.borderLeftColor = 'var(--success)';
            } else {
                statusEl.innerHTML = '‚ö†Ô∏è Needs info';
                statusEl.style.color = 'var(--warning)';
                cardEl.style.borderLeftColor = 'var(--warning)';
            }
            
            checkGenerateButtonState();
        }
        
        function checkGenerateButtonState() {
            var btn = document.getElementById('generateRosterPlansBtn');
            var startDate = document.getElementById('coachStartDate').value;
            var endDate = document.getElementById('coachEndDate').value;
            
            if (!startDate || !endDate || !coachSelectedTemplate) {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                return;
            }
            
            // Check if at least one athlete is ready
            var readyCount = 0;
            if (teamData && teamData.athletes) {
                teamData.athletes.forEach(function(athlete) {
                    var isComplete = athlete.trainingParams && 
                        (athlete.trainingParams.time800m || athlete.trainingParams.time1600m || athlete.trainingParams.time3200m || athlete.trainingParams.time5k) &&
                        athlete.trainingParams.currentMileage && athlete.trainingParams.goalMileage;
                    if (isComplete) readyCount++;
                });
            }
            
            if (readyCount > 0) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerHTML = '<span style="position: relative; z-index: 1;">üöÄ Generate Plans for ' + readyCount + ' Athlete' + (readyCount > 1 ? 's' : '') + '</span>';
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.innerHTML = '<span style="position: relative; z-index: 1;">üöÄ Generate Plans for All Athletes</span>';
            }
        }
        
        function generateAllRosterPlans() {
            var startDate = document.getElementById('coachStartDate').value;
            var endDate = document.getElementById('coachEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select start and end dates');
                return;
            }
            
            var start = new Date(startDate);
            var end = new Date(endDate);
            var totalWeeks = Math.max(4, Math.ceil((end - start) / (1000 * 60 * 60 * 24 * 7)));
            
            var generated = 0;
            var planStartDate = new Date(startDate + 'T00:00:00');
            
            teamData.athletes.forEach(function(athlete) {
                if (!athlete.trainingParams) return;
                var params = athlete.trainingParams;
                
                // Check if complete
                var hasTime = params.time800m || params.time1600m || params.time3200m || params.time5k;
                if (!hasTime || !params.currentMileage || !params.goalMileage) return;
                
                // Parse times to calculate VDOT
                var times = {
                    '800m': params.time800m ? parseTimeToSeconds(params.time800m) : null,
                    '1600m': params.time1600m ? parseTimeToSeconds(params.time1600m) : null,
                    '3200m': params.time3200m ? parseTimeToSeconds(params.time3200m) : null,
                    '5000m': params.time5k ? parseTimeToSeconds(params.time5k) : null
                };
                
                var vdots = [];
                var distanceMap = { '800m': 800, '1600m': 1600, '3200m': 3200, '5000m': 5000 };
                for (var dist in times) {
                    if (times[dist]) {
                        vdots.push(estimateVDOT(times[dist], distanceMap[dist]));
                    }
                }
                
                if (vdots.length === 0) return;
                
                var avgVDOT = Math.round(vdots.reduce(function(a, b) { return a + b; }, 0) / vdots.length);
                var paces = calculatePaces(avgVDOT);
                
                // Build the plan
                var raceSchedule = [];
                var athletePlan = buildMultiWeekPlanForAthlete(paces, params.currentMileage, params.goalMileage, params.goalEvent, totalWeeks, raceSchedule, planStartDate, params.fitnessLevel || 75);
                
                athlete.plan = {
                    vdot: avgVDOT,
                    paces: paces,
                    startDate: startDate,
                    endDate: endDate,
                    totalWeeks: totalWeeks,
                    weeksData: athletePlan,
                    generatedAt: new Date().toISOString()
                };
                
                generated++;
            });
            
            localStorage.setItem('laktic_team_data', JSON.stringify(teamData));
            
            showNotification('‚úì Generated plans for ' + generated + ' athletes!', 'var(--success)');
            
            // Hide the creation form
            var dataInput = document.getElementById('dataInput');
            if (dataInput) dataInput.style.display = 'none';
            
            // Show the team plans view
            setTimeout(function() {
                displayCoachTeamDashboard();
            }, 300);
        }
        
        function displayCoachTeamDashboard() {
            var container = document.getElementById('myPlanContent');
            if (!container) {
                container = document.getElementById('myPlansContent');
            }
            if (container) container.style.display = 'block';
            
            var athletesWithPlans = teamData.athletes.filter(function(a) { return a.plan; });
            
            if (athletesWithPlans.length === 0) {
                container.innerHTML = '<div class="card" style="text-align: center; padding: 40px;"><p style="color: var(--text-muted);">No plans generated yet.</p></div>';
                return;
            }
            
            var today = new Date();
            var todayStr = today.toDateString();
            
            var html = '';
            
            // Today's Workouts Summary Card
            html += '<div class="card" style="margin-bottom: 20px; border: 2px solid var(--primary);">';
            html += '<h2 style="color: var(--primary); margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">';
            html += '<span style="font-size: 1.5rem;">üìÖ</span> Today\'s Workouts';
            html += '</h2>';
            html += '<div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">' + today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) + '</div>';
            
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            
            athletesWithPlans.forEach(function(athlete) {
                var todayWorkout = getTodayWorkoutForAthlete(athlete, today);
                var workoutColor = getWorkoutColor(todayWorkout ? todayWorkout.type : 'Rest');
                
                html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 14px; background: var(--bg-elevated); border-radius: 10px; border-left: 4px solid ' + workoutColor + ';">';
                html += '<div style="flex: 1;">';
                html += '<div style="font-weight: 600; color: var(--text-primary); font-size: 1rem;">' + athlete.name + '</div>';
                if (todayWorkout) {
                    html += '<div style="color: ' + workoutColor + '; font-weight: 600; font-size: 0.9rem; margin-top: 2px;">' + todayWorkout.type + '</div>';
                    html += '<div style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 4px; line-height: 1.4;">' + (todayWorkout.details.length > 80 ? todayWorkout.details.substring(0, 80) + '...' : todayWorkout.details) + '</div>';
                } else {
                    html += '<div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 2px;">No workout scheduled</div>';
                }
                html += '</div>';
                html += '<button onclick="showAthletePlanDetails(\'' + athlete.id + '\')" style="padding: 8px 14px; background: var(--primary); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.8rem; white-space: nowrap; margin-left: 12px;">View Plan</button>';
                html += '</div>';
            });
            
            html += '</div>';
            html += '</div>';
            
            // Full Roster Plans Section
            html += '<div class="card">';
            html += '<h3 style="color: var(--accent); margin-bottom: 16px;">üë• Team Roster (' + athletesWithPlans.length + ' athletes)</h3>';
            html += '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            athletesWithPlans.forEach(function(athlete) {
                var eventLabel = athlete.trainingParams.goalEvent === '800' ? '800m' : 
                                athlete.trainingParams.goalEvent === '1500' ? '1600m' : '3200m';
                
                html += '<button onclick="showAthletePlanDetails(\'' + athlete.id + '\')" ';
                html += 'style="display: flex; justify-content: space-between; align-items: center; padding: 16px; ';
                html += 'background: var(--bg-elevated); border: 2px solid var(--border); border-radius: 12px; ';
                html += 'cursor: pointer; text-align: left; transition: all 0.2s ease; width: 100%;" ';
                html += 'onmouseover="this.style.borderColor=\'var(--primary)\'" onmouseout="this.style.borderColor=\'var(--border)\'">';
                html += '<div>';
                html += '<div style="font-weight: 600; color: var(--text-primary); font-size: 1.05rem;">' + athlete.name + '</div>';
                html += '<div style="font-size: 0.85rem; color: var(--text-muted);">' + eventLabel + ' ‚Ä¢ VDOT ' + athlete.plan.vdot + ' ‚Ä¢ ' + athlete.plan.totalWeeks + ' weeks</div>';
                html += '</div>';
                html += '<div style="color: var(--primary); font-size: 1.2rem;">‚Üí</div>';
                html += '</button>';
            });
            
            html += '</div>';
            html += '</div>';
            
            // Selected athlete plan display area
            html += '<div id="selectedAthletePlan" style="margin-top: 20px;"></div>';
            
            container.innerHTML = html;
        }
        
        function getTodayWorkoutForAthlete(athlete, today) {
            if (!athlete.plan || !athlete.plan.weeksData) return null;
            
            var planStart = new Date(athlete.plan.startDate + 'T00:00:00');
            var daysSinceStart = Math.floor((today - planStart) / (1000 * 60 * 60 * 24));
            
            if (daysSinceStart < 0) return null; // Plan hasn't started yet
            
            var weekIndex = Math.floor(daysSinceStart / 7);
            var dayOfWeek = daysSinceStart % 7;
            
            if (weekIndex >= athlete.plan.weeksData.length) return null; // Plan is over
            
            var week = athlete.plan.weeksData[weekIndex];
            if (!week || !week.workouts) return null;
            
            var dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            var todayName = dayNames[dayOfWeek];
            
            return week.workouts.find(function(w) { return w.day === todayName; });
        }
        
        function getWorkoutColor(type) {
            if (!type) return 'var(--text-muted)';
            var t = type.toLowerCase();
            if (t.includes('long')) return 'var(--success)';
            if (t.includes('tempo') || t.includes('threshold')) return 'var(--primary)';
            if (t.includes('interval') || t.includes('vo2') || t.includes('repeat')) return '#FF4500';
            if (t.includes('easy') || t.includes('recovery')) return 'var(--accent)';
            if (t.includes('rest') || t.includes('off')) return 'var(--text-muted)';
            if (t.includes('fartlek')) return 'orange';
            if (t.includes('hill') || t.includes('strength')) return '#8B4513';
            if (t.includes('speed')) return '#8A2BE2';
            return 'var(--primary)';
        }

        // ==================== COACH CHATBOT ====================
        
        let chatHistory = [];
        
        function initCoachPage() {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Show welcome message if no history
            if (chatHistory.length === 0) {
                addCoachMessage("Hey! üëã I'm your Laktic Coach. I can help you with:\n\n‚Ä¢ Your training plan & today's workout\n‚Ä¢ Logging workouts\n‚Ä¢ Pacing & effort questions\n‚Ä¢ Recovery & training tips\n\nWhat would you like to know?");
            } else {
                // Restore chat history
                messagesContainer.innerHTML = '';
                chatHistory.forEach(msg => {
                    appendMessageToDOM(msg.type, msg.text, msg.time);
                });
            }
            
            scrollChatToBottom();
        }
        
        function addCoachMessage(text) {
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            chatHistory.push({ type: 'coach', text, time });
            appendMessageToDOM('coach', text, time);
            scrollChatToBottom();
        }
        
        function addUserMessage(text) {
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            chatHistory.push({ type: 'user', text, time });
            appendMessageToDOM('user', text, time);
            scrollChatToBottom();
        }
        
        function appendMessageToDOM(type, text, time) {
            const messagesContainer = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${type}`;
            
            // Convert newlines to <br> for display
            const formattedText = text.replace(/\n/g, '<br>');
            
            msgDiv.innerHTML = `
                <div class="chat-bubble">${formattedText}</div>
                <div class="chat-time">${time}</div>
            `;
            messagesContainer.appendChild(msgDiv);
        }
        
        function scrollChatToBottom() {
            const container = document.getElementById('chatContainer');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            addUserMessage(text);
            input.value = '';
            
            // Process and respond
            setTimeout(() => {
                const response = processUserMessage(text);
                addCoachMessage(response);
            }, 500);
        }
        
        function coachQuickAction(action) {
            let message = '';
            switch(action) {
                case 'today':
                    message = "What's my workout today?";
                    break;
                case 'week':
                    message = "What does my week look like?";
                    break;
                case 'log':
                    message = "I want to log my workout";
                    break;
                case 'tips':
                    message = "Give me a training tip";
                    break;
            }
            
            document.getElementById('chatInput').value = message;
            sendChatMessage();
        }
        
        function processUserMessage(text) {
            const lower = text.toLowerCase();
            
            // ===== TODAY'S WORKOUT =====
            if (lower.includes('today') && (lower.includes('workout') || lower.includes('run') || lower.includes('training') || lower.includes('do'))) {
                return getTodaysWorkoutResponse();
            }
            
            // ===== THIS WEEK =====
            if (lower.includes('week') && (lower.includes('this') || lower.includes('my') || lower.includes('look'))) {
                return getWeekOverviewResponse();
            }
            
            // ===== LOG WORKOUT =====
            if (lower.includes('log') || lower.includes('record') || lower.includes('finished') || lower.includes('completed') || lower.includes('just ran') || lower.includes('just did')) {
                return getLogWorkoutResponse();
            }
            
            // ===== PACING QUESTIONS =====
            if (lower.includes('pace') || lower.includes('how fast') || lower.includes('speed')) {
                return getPacingResponse();
            }
            
            // ===== EFFORT / RPE =====
            if (lower.includes('effort') || lower.includes('rpe') || lower.includes('how hard')) {
                return getEffortResponse();
            }
            
            // ===== TIRED / FATIGUED =====
            if (lower.includes('tired') || lower.includes('fatigue') || lower.includes('exhausted') || lower.includes('worn out')) {
                return getTiredResponse();
            }
            
            // ===== SORE / PAIN =====
            if (lower.includes('sore') || lower.includes('pain') || lower.includes('hurt') || lower.includes('injury')) {
                return getSorenessResponse();
            }
            
            // ===== TRAINING TIPS =====
            if (lower.includes('tip') || lower.includes('advice') || lower.includes('suggest')) {
                return getRandomTip();
            }
            
            // ===== WHAT IS / EXPLAIN =====
            if (lower.includes('what is') || lower.includes('what\'s a') || lower.includes('explain') || lower.includes('define')) {
                return getDefinitionResponse(lower);
            }
            
            // ===== TEMPO =====
            if (lower.includes('tempo')) {
                return "**Tempo runs** are sustained efforts at your lactate threshold pace - comfortably hard. You should be able to speak in short phrases but not hold a conversation.\n\nTypically 20-40 minutes at this effort, with warm-up and cool-down. They build your ability to hold a fast pace and are key for race fitness!";
            }
            
            // ===== INTERVALS =====
            if (lower.includes('interval') || lower.includes('repeat')) {
                return "**Intervals** are fast repeats with recovery between. They build speed and VO2max.\n\nExamples:\n‚Ä¢ 400m repeats at mile pace\n‚Ä¢ 800m repeats at 3K-5K pace\n‚Ä¢ 1000m repeats at 5K pace\n\nRecovery is usually 50-100% of the rep time. The key is consistent pacing - don't start too fast!";
            }
            
            // ===== EASY RUN =====
            if (lower.includes('easy') && lower.includes('run')) {
                return "**Easy runs** should feel... easy! üòä\n\nYou should be able to hold a full conversation. If you're breathing hard, slow down. These runs build aerobic base and aid recovery.\n\nMost of your weekly mileage (70-80%) should be at this effort. Don't skip these or turn them into workouts!";
            }
            
            // ===== LONG RUN =====
            if (lower.includes('long run')) {
                return "**Long runs** build endurance and mental toughness. They should be:\n\n‚Ä¢ 1-2 minutes slower than race pace\n‚Ä¢ Conversational effort\n‚Ä¢ 20-30% of weekly mileage\n\nStart conservative and finish strong. Fuel and hydrate on runs over 90 minutes.";
            }
            
            // ===== HOW AM I DOING =====
            if (lower.includes('how am i') || lower.includes('my progress') || lower.includes('doing')) {
                return getProgressResponse();
            }
            
            // ===== GREETING =====
            if (lower.match(/^(hi|hey|hello|yo|sup)/)) {
                return "Hey! üëã How can I help with your training today?";
            }
            
            // ===== THANKS =====
            if (lower.includes('thank') || lower.includes('thanks')) {
                return "You're welcome! Keep up the great work. Let me know if you need anything else! üí™";
            }
            
            // ===== DEFAULT =====
            return getDefaultResponse();
        }
        
        function getTodaysWorkoutResponse() {
            if (!allWeeksData || allWeeksData.length === 0) {
                return "You don't have an active training plan yet. Head to the **Plans** tab to create one, and I'll be able to tell you exactly what's on tap for today!";
            }
            
            // Find today's workout
            const today = new Date();
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayName = dayNames[today.getDay()];
            
            let weekNum = 1;
            const activePlanId = localStorage.getItem('laktic_active_plan_id');
            if (activePlanId) {
                const savedPlansData = JSON.parse(localStorage.getItem('laktic_saved_plans') || '[]');
                const activePlan = savedPlansData.find(p => p.id === activePlanId);
                if (activePlan && activePlan.startDate) {
                    const startDate = new Date(activePlan.startDate);
                    const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                    weekNum = Math.floor(daysSinceStart / 7) + 1;
                    if (weekNum < 1) weekNum = 1;
                    if (weekNum > allWeeksData.length) weekNum = allWeeksData.length;
                }
            }
            
            const currentWeek = allWeeksData[weekNum - 1];
            const todayWorkout = currentWeek?.workouts?.find(w => w.day === dayName);
            
            if (!todayWorkout) {
                return `Today is **${dayName}** - looks like a **rest day**! üò¥\n\nRest is part of training. Your body adapts and gets stronger during recovery, not during the workout itself. Enjoy it!`;
            }
            
            let response = `Today is **${dayName}** (Week ${weekNum}).\n\n`;
            response += `**${todayWorkout.type}**\n${todayWorkout.details}`;
            
            if (todayWorkout.rest) {
                response += `\n\n‚è±Ô∏è Rest: ${todayWorkout.rest}`;
            }
            if (todayWorkout.notes) {
                response += `\n\nüí° ${todayWorkout.notes}`;
            }
            
            response += `\n\nReady to crush it? Let me know when you're done and I'll help you log it!`;
            
            return response;
        }
        
        function getWeekOverviewResponse() {
            if (!allWeeksData || allWeeksData.length === 0) {
                return "No active plan loaded. Create a plan first and I can show you the week ahead!";
            }
            
            const today = new Date();
            let weekNum = 1;
            const activePlanId = localStorage.getItem('laktic_active_plan_id');
            if (activePlanId) {
                const savedPlansData = JSON.parse(localStorage.getItem('laktic_saved_plans') || '[]');
                const activePlan = savedPlansData.find(p => p.id === activePlanId);
                if (activePlan && activePlan.startDate) {
                    const startDate = new Date(activePlan.startDate);
                    const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                    weekNum = Math.floor(daysSinceStart / 7) + 1;
                    if (weekNum < 1) weekNum = 1;
                    if (weekNum > allWeeksData.length) weekNum = allWeeksData.length;
                }
            }
            
            const currentWeek = allWeeksData[weekNum - 1];
            let response = `**Week ${weekNum}** - ${currentWeek.label || 'Training Week'}\n\n`;
            
            currentWeek.workouts.forEach(w => {
                const feedbackKey = `week${weekNum}-${w.day}`;
                const hasFeedback = workoutFeedback[feedbackKey];
                const checkmark = hasFeedback ? '‚úÖ ' : '';
                response += `${checkmark}**${w.day}**: ${w.type}\n`;
            });
            
            const loggedCount = currentWeek.workouts.filter(w => workoutFeedback[`week${weekNum}-${w.day}`]).length;
            response += `\nüìä ${loggedCount}/${currentWeek.workouts.length} workouts logged`;
            
            return response;
        }
        
        function getLogWorkoutResponse() {
            if (!allWeeksData || allWeeksData.length === 0) {
                return "You'll need an active training plan first to log workouts. Head to **Plans** to create one!";
            }
            
            return "Great job getting your workout in! üí™\n\nTo log it:\n1. Go to the **Today** tab\n2. Tap **Log Today's Workout**\n3. Rate your effort and completion\n\nOr you can go to **Plans** and tap the feedback button next to any workout.\n\nWant me to take you there?";
        }
        
        function getPacingResponse() {
            if (currentPlanData && currentPlanData.paces) {
                const paces = currentPlanData.paces;
                let response = "Based on your plan, here are your training paces:\n\n";
                
                if (paces.easy) response += `üü¢ **Easy**: ${paces.easy}\n`;
                if (paces.long) response += `üîµ **Long Run**: ${paces.long}\n`;
                if (paces.tempo) response += `üü† **Tempo**: ${paces.tempo}\n`;
                if (paces.interval) response += `üî¥ **Intervals**: ${paces.interval}\n`;
                if (paces.race) response += `üèÅ **Race Pace**: ${paces.race}\n`;
                
                response += "\nRemember: easy should feel EASY. Most runners go too fast on easy days!";
                return response;
            }
            
            return "I don't have your specific paces yet. Create a training plan with your recent race times and I can calculate your training zones!\n\nGeneral guide:\n‚Ä¢ Easy: Can hold a conversation\n‚Ä¢ Tempo: Comfortably hard, short phrases\n‚Ä¢ Intervals: Hard effort, can only say a few words";
        }
        
        function getEffortResponse() {
            return "**RPE (Rate of Perceived Exertion)** is a 1-10 scale:\n\n" +
                   "1-3: Very easy, recovery\n" +
                   "4-5: Easy, conversational\n" +
                   "6-7: Moderate, tempo effort\n" +
                   "8-9: Hard, interval effort\n" +
                   "10: Maximum, all-out sprint\n\n" +
                   "Most easy runs should be 4-5. Workouts target 7-9. You shouldn't hit 10 very often!";
        }
        
        function getTiredResponse() {
            // Check recent feedback for patterns
            const recentFeedback = Object.values(workoutFeedback)
                .filter(f => f.timestamp)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            const highEffortCount = recentFeedback.filter(f => f.effort >= 8).length;
            
            let response = "Feeling tired is your body's signal. Here's what might help:\n\n";
            
            if (highEffortCount >= 3) {
                response += "üìä I noticed you've had several high-effort workouts recently. You might need more recovery.\n\n";
            }
            
            response += "‚Ä¢ **Sleep**: Aim for 7-9 hours\n";
            response += "‚Ä¢ **Nutrition**: Fuel properly, especially carbs\n";
            response += "‚Ä¢ **Hydration**: Drink consistently\n";
            response += "‚Ä¢ **Easy days**: Keep them truly easy\n\n";
            response += "It's OK to cut a workout short or take an extra rest day. Listen to your body!";
            
            return response;
        }
        
        function getSorenessResponse() {
            return "Soreness is normal, but pain is a warning sign.\n\n" +
                   "**Normal soreness:**\n" +
                   "‚Ä¢ Dull, achy muscles\n" +
                   "‚Ä¢ Goes away during warm-up\n" +
                   "‚Ä¢ Improves with movement\n\n" +
                   "**Warning signs (take a rest day):**\n" +
                   "‚Ä¢ Sharp or stabbing pain\n" +
                   "‚Ä¢ Pain that gets worse while running\n" +
                   "‚Ä¢ Limping or altered gait\n" +
                   "‚Ä¢ Swelling\n\n" +
                   "When in doubt, take a day off. One rest day is better than weeks of injury!";
        }
        
        function getRandomTip() {
            const tips = [
                "üí° **Tip**: Run your easy days EASY. 80% of your training should be conversational pace. This is where aerobic fitness is built!",
                "üí° **Tip**: Consistency beats intensity. Three 30-minute runs per week, every week, beats sporadic hard efforts.",
                "üí° **Tip**: Sleep is your superpower. Most adaptation happens while you sleep. Prioritize 7-9 hours.",
                "üí° **Tip**: Don't skip the warm-up! 10-15 minutes of easy jogging before workouts prevents injury and improves performance.",
                "üí° **Tip**: Hydrate all day, not just during runs. If you're thirsty during a run, you started dehydrated.",
                "üí° **Tip**: Strength training 2x/week reduces injury risk significantly. Focus on hips, glutes, and core.",
                "üí° **Tip**: The workout doesn't make you faster - recovery does. Train hard, rest harder.",
                "üí° **Tip**: Bad runs happen to everyone. One workout doesn't make or break your fitness. Stay consistent!",
                "üí° **Tip**: Race day isn't for trying new things. Practice your nutrition, shoes, and clothing in training.",
                "üí° **Tip**: Run by effort, not pace, on hot or hilly days. The effort is what matters, not the number.",
                "üí° **Tip**: Speed work is like seasoning - a little goes a long way. Don't overdo it!",
                "üí° **Tip**: Your body doesn't know miles or kilometers. It only knows stress and recovery. Listen to it."
            ];
            
            return tips[Math.floor(Math.random() * tips.length)];
        }
        
        function getDefinitionResponse(text) {
            if (text.includes('tempo')) {
                return "**Tempo run**: A sustained effort at lactate threshold pace, typically 20-40 minutes. Should feel 'comfortably hard.'";
            }
            if (text.includes('fartlek')) {
                return "**Fartlek**: Swedish for 'speed play.' Unstructured speed work where you vary pace by feel - fun and effective!";
            }
            if (text.includes('threshold')) {
                return "**Threshold pace**: The fastest pace you can sustain for about an hour. Training here improves your lactate clearance.";
            }
            if (text.includes('vo2') || text.includes('v02')) {
                return "**VO2max**: Your maximum oxygen uptake. Interval training at hard effort (3K-5K pace) improves this.";
            }
            if (text.includes('strides')) {
                return "**Strides**: Short accelerations (80-100m) at fast but controlled pace. Great for neuromuscular activation before workouts or races.";
            }
            if (text.includes('taper')) {
                return "**Taper**: Reducing training volume before a race while maintaining intensity. Lets your body recover and peak on race day.";
            }
            if (text.includes('cadence')) {
                return "**Cadence**: Steps per minute. Most elites run 180+. Higher cadence often means less injury risk and better efficiency.";
            }
            
            return "I'm not sure about that term. Try asking about: tempo, fartlek, threshold, VO2max, strides, taper, or cadence!";
        }
        
        function getProgressResponse() {
            const feedbackCount = Object.keys(workoutFeedback).length;
            
            if (feedbackCount === 0) {
                return "I don't have any logged workouts yet to analyze. Start logging your workouts and I can give you insights on your progress!";
            }
            
            const recentFeedback = Object.values(workoutFeedback)
                .filter(f => f.timestamp)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 7);
            
            const avgEffort = recentFeedback.reduce((sum, f) => sum + (f.effort || 0), 0) / recentFeedback.length;
            const completedFull = recentFeedback.filter(f => f.completion === 'full').length;
            
            let response = `**Your Recent Training**\n\n`;
            response += `üìä ${feedbackCount} workouts logged total\n`;
            response += `üí™ Average effort: ${avgEffort.toFixed(1)}/10\n`;
            response += `‚úÖ ${completedFull}/${recentFeedback.length} recent workouts completed fully\n\n`;
            
            if (avgEffort > 8) {
                response += "Your effort has been high lately. Make sure you're recovering well!";
            } else if (avgEffort < 5) {
                response += "Efforts are looking comfortable. You might be ready to push a bit more on hard days!";
            } else {
                response += "Looking like a good balance of effort. Keep it up!";
            }
            
            return response;
        }
        
        function getDefaultResponse() {
            const responses = [
                "I'm not sure I understood that. Try asking about:\n‚Ä¢ Today's workout\n‚Ä¢ This week's plan\n‚Ä¢ Pacing questions\n‚Ä¢ Training tips\n‚Ä¢ How to log workouts",
                "Hmm, I didn't catch that. I can help with your training plan, pacing, logging workouts, or general running tips!",
                "I'm still learning! Try asking 'What's my workout today?' or 'Give me a training tip'",
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        // ==================== WEATHER FUNCTIONS ====================
        
        var raceRowCount = 1;
        
        function addRaceRow() {
            raceRowCount++;
            var container = document.getElementById('raceInputsList');
            var newRow = document.createElement('div');
            newRow.className = 'race-input-row';
            newRow.id = 'raceRow' + raceRowCount;
            newRow.style.cssText = 'display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: flex-end;';
            newRow.innerHTML = `
                <div style="flex: 1; min-width: 120px;">
                    <label style="font-size: 0.8rem;">Race Date</label>
                    <input type="date" id="raceDate${raceRowCount}" style="width: 100%;">
                </div>
                <div style="flex: 1; min-width: 100px;">
                    <label style="font-size: 0.8rem;">Distance</label>
                    <select id="raceDistance${raceRowCount}" style="width: 100%;">
                        <option value="">Select...</option>
                        <option value="800m">800m</option>
                        <option value="1600m">1600m/Mile</option>
                        <option value="3200m">3200m/2Mi</option>
                        <option value="5000m">5K</option>
                    </select>
                </div>
                <div style="flex: 0.5; min-width: 60px;">
                    <label style="font-size: 0.8rem;">Priority</label>
                    <select id="racePriority${raceRowCount}" style="width: 100%;">
                        <option value="C">C</option>
                        <option value="B">B</option>
                        <option value="A">A ‚≠ê</option>
                    </select>
                </div>
                <button onclick="removeRaceRow(${raceRowCount})" 
                        style="padding: 8px 12px; background: transparent; border: 1px solid var(--danger); 
                               border-radius: 6px; color: var(--danger); cursor: pointer; font-size: 0.9rem;">
                    ‚úï
                </button>
            `;
            container.appendChild(newRow);
        }
        
        function removeRaceRow(rowNum) {
            var row = document.getElementById('raceRow' + rowNum);
            if (row) row.remove();
        }
        
        function toggleRaceInputs() {
            var checkbox = document.getElementById('noRacesCheckbox');
            var container = document.getElementById('raceInputsContainer');
            if (checkbox.checked) {
                container.style.opacity = '0.4';
                container.style.pointerEvents = 'none';
            } else {
                container.style.opacity = '1';
                container.style.pointerEvents = 'auto';
            }
        }
        
        var weatherData = {
            location: 'Enter your location',
            temp: '--',
            feelsLike: '--',
            condition: 'sunny',
            wind: 0,
            humidity: 50,
            lat: null,
            lon: null
        };
        
        // Try to auto-fetch weather on page load
        (function() {
            var saved = localStorage.getItem('laktic_weather');
            if (saved) {
                weatherData = JSON.parse(saved);
                updateWeatherDisplay();
            }
            // Auto-fetch if we have coordinates saved
            if (weatherData.lat && weatherData.lon) {
                fetchWeatherByCoords(weatherData.lat, weatherData.lon, weatherData.location);
            }
        })();
        
        function fetchWeatherAuto() {
            // Show loading state
            document.getElementById('weatherNotSet').innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 8px;">üîÑ</div>
                <p style="color: var(--text-muted);">Getting your location...</p>
            `;
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        var lat = position.coords.latitude;
                        var lon = position.coords.longitude;
                        fetchWeatherByCoords(lat, lon, 'Current Location');
                    },
                    function(error) {
                        console.log('Geolocation error:', error);
                        document.getElementById('weatherNotSet').innerHTML = `
                            <div style="font-size: 2rem; margin-bottom: 8px;">üìç</div>
                            <p style="color: var(--text-muted); margin-bottom: 8px;">Location access denied</p>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 12px;">Enter your city to get weather</p>
                            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                                <input type="text" id="manualCity" placeholder="City name (e.g., Austin)" 
                                       style="padding: 10px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); width: 160px;">
                                <button onclick="fetchWeatherByCity()" style="padding: 10px 16px; background: var(--primary); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                                    Get Weather
                                </button>
                            </div>
                        `;
                    },
                    { timeout: 10000 }
                );
            } else {
                showManualCityInput();
            }
        }
        
        function showManualCityInput() {
            document.getElementById('weatherNotSet').innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 8px;">üå°Ô∏è</div>
                <p style="color: var(--text-muted); margin-bottom: 12px;">Enter your city to get weather</p>
                <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                    <input type="text" id="manualCity" placeholder="City name (e.g., Austin)" 
                           style="padding: 10px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); width: 160px;">
                    <button onclick="fetchWeatherByCity()" style="padding: 10px 16px; background: var(--primary); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                        Get Weather
                    </button>
                </div>
            `;
        }
        
        function fetchWeatherByCity() {
            var city = document.getElementById('manualCity').value.trim();
            if (!city) {
                alert('Please enter a city name');
                return;
            }
            
            document.getElementById('weatherNotSet').innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 8px;">üîÑ</div>
                <p style="color: var(--text-muted);">Fetching weather for ${city}...</p>
            `;
            
            // Use Open-Meteo geocoding to get coordinates
            fetch('https://geocoding-api.open-meteo.com/v1/search?name=' + encodeURIComponent(city) + '&count=1&language=en&format=json')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.results && data.results.length > 0) {
                        var result = data.results[0];
                        var locationName = result.name + (result.admin1 ? ', ' + result.admin1 : '');
                        fetchWeatherByCoords(result.latitude, result.longitude, locationName);
                    } else {
                        alert('City not found. Try a different spelling or larger nearby city.');
                        showManualCityInput();
                    }
                })
                .catch(function(err) {
                    console.error('Geocoding error:', err);
                    alert('Could not find city. Please try again or enter weather manually.');
                    showManualCityInput();
                });
        }
        
        function fetchWeatherByCoords(lat, lon, locationName) {
            // Fetch from Open-Meteo API (free, no API key needed)
            var url = 'https://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lon + 
                      '&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m' +
                      '&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto';
            
            fetch(url)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.current) {
                        var current = data.current;
                        var weatherCode = current.weather_code;
                        
                        // Map weather codes to conditions
                        var condition = mapWeatherCode(weatherCode);
                        
                        weatherData = {
                            location: locationName,
                            temp: Math.round(current.temperature_2m),
                            feelsLike: Math.round(current.apparent_temperature),
                            condition: condition,
                            wind: Math.round(current.wind_speed_10m),
                            humidity: Math.round(current.relative_humidity_2m),
                            lat: lat,
                            lon: lon,
                            lastUpdated: new Date().toISOString()
                        };
                        
                        localStorage.setItem('laktic_weather', JSON.stringify(weatherData));
                        updateWeatherDisplay();
                        showNotification('Weather updated!', 'var(--success)');
                    }
                })
                .catch(function(err) {
                    console.error('Weather fetch error:', err);
                    alert('Could not fetch weather. Please enter manually.');
                    showManualCityInput();
                });
        }
        
        function mapWeatherCode(code) {
            // WMO Weather interpretation codes
            // https://open-meteo.com/en/docs
            if (code === 0) return 'sunny';
            if (code === 1 || code === 2) return 'partly_cloudy';
            if (code === 3) return 'cloudy';
            if (code >= 45 && code <= 48) return 'fog';
            if (code >= 51 && code <= 55) return 'light_rain';
            if (code >= 56 && code <= 57) return 'ice';
            if (code >= 61 && code <= 65) return 'rain';
            if (code >= 66 && code <= 67) return 'ice';
            if (code >= 71 && code <= 75) return 'snow';
            if (code === 77) return 'snow';
            if (code >= 80 && code <= 82) return 'rain';
            if (code >= 85 && code <= 86) return 'heavy_snow';
            if (code >= 95 && code <= 99) return 'heavy_rain';
            return 'cloudy';
        }
        
        function refreshWeather() {
            if (weatherData.lat && weatherData.lon) {
                fetchWeatherByCoords(weatherData.lat, weatherData.lon, weatherData.location);
            } else {
                fetchWeatherAuto();
            }
        }
        
        // Load saved weather on startup
        (function() {
            var saved = localStorage.getItem('laktic_weather');
            if (saved) {
                weatherData = JSON.parse(saved);
                updateWeatherDisplay();
            }
        })();
        
        function openWeatherModal() {
            document.getElementById('weatherModal').style.display = 'block';
            document.getElementById('weatherLocationInput').value = weatherData.location || '';
            document.getElementById('weatherTempInput').value = weatherData.temp || 72;
            document.getElementById('weatherFeelsLikeInput').value = weatherData.feelsLike || weatherData.temp || 72;
            document.getElementById('weatherConditionInput').value = weatherData.condition || 'sunny';
            document.getElementById('weatherWindInput').value = weatherData.wind || 5;
            document.getElementById('weatherHumidityInput').value = weatherData.humidity || 50;
        }
        
        function closeWeatherModal() {
            document.getElementById('weatherModal').style.display = 'none';
        }
        
        function saveWeather() {
            weatherData = {
                location: document.getElementById('weatherLocationInput').value || 'Your Location',
                temp: parseInt(document.getElementById('weatherTempInput').value) || 72,
                feelsLike: parseInt(document.getElementById('weatherFeelsLikeInput').value) || parseInt(document.getElementById('weatherTempInput').value) || 72,
                condition: document.getElementById('weatherConditionInput').value || 'sunny',
                wind: parseInt(document.getElementById('weatherWindInput').value) || 5,
                humidity: parseInt(document.getElementById('weatherHumidityInput').value) || 50
            };
            
            localStorage.setItem('laktic_weather', JSON.stringify(weatherData));
            updateWeatherDisplay();
            closeWeatherModal();
            showNotification('Weather updated!', 'var(--success)');
        }
        
        function updateWeatherDisplay() {
            // Check if weather has been set
            if (weatherData.temp === '--' || !weatherData.temp) {
                document.getElementById('weatherNotSet').style.display = 'block';
                document.getElementById('weatherSet').style.display = 'none';
                return;
            }
            
            document.getElementById('weatherNotSet').style.display = 'none';
            document.getElementById('weatherSet').style.display = 'block';
            
            var icons = {
                'sunny': '‚òÄÔ∏è',
                'partly_cloudy': '‚õÖ',
                'cloudy': '‚òÅÔ∏è',
                'light_rain': 'üåßÔ∏è',
                'rain': 'üåßÔ∏è',
                'heavy_rain': '‚õàÔ∏è',
                'snow': 'üå®Ô∏è',
                'heavy_snow': '‚ùÑÔ∏è',
                'ice': 'üßä',
                'windy': 'üí®',
                'fog': 'üå´Ô∏è',
                'extreme_heat': 'üî•',
                'extreme_cold': 'ü•∂'
            };
            
            var conditions = {
                'sunny': 'Clear skies',
                'partly_cloudy': 'Partly cloudy',
                'cloudy': 'Overcast',
                'light_rain': 'Light rain',
                'rain': 'Rain',
                'heavy_rain': 'Heavy rain / Storms',
                'snow': 'Snow',
                'heavy_snow': 'Heavy snow / Blizzard',
                'ice': 'Ice / Freezing rain',
                'windy': 'Very windy',
                'fog': 'Foggy',
                'extreme_heat': 'Extreme heat',
                'extreme_cold': 'Extreme cold'
            };
            
            document.getElementById('weatherIcon').textContent = icons[weatherData.condition] || '‚òÄÔ∏è';
            document.getElementById('weatherTemp').textContent = weatherData.temp;
            document.getElementById('weatherCondition').textContent = conditions[weatherData.condition] || 'Clear';
            document.getElementById('weatherLocation').textContent = weatherData.location;
            document.getElementById('weatherFeelsLike').textContent = 'Feels like ' + weatherData.feelsLike + '¬∞F';
            document.getElementById('weatherWind').textContent = weatherData.wind || 0;
            document.getElementById('weatherHumidity').textContent = weatherData.humidity || 50;
            
            // Generate advisory
            generateWeatherAdvisory();
        }
        
        function generateWeatherAdvisory() {
            var advisory = document.getElementById('weatherAdvisory');
            var temp = weatherData.feelsLike || weatherData.temp;
            var condition = weatherData.condition;
            var wind = weatherData.wind || 0;
            var humidity = weatherData.humidity || 50;
            
            var level = 'good'; // good, caution, warning, danger
            var icon = '‚úÖ';
            var title = 'Great conditions for running!';
            var message = '';
            var tips = [];
            
            // Check temperature
            if (temp >= 95) {
                level = 'danger';
                icon = 'üî•';
                title = 'EXTREME HEAT - High Risk';
                message = 'Heat stroke risk is high. Consider moving workout indoors or to early morning/evening.';
                tips.push('Run before 7am or after 7pm');
                tips.push('Reduce intensity by 20-30%');
                tips.push('Hydrate heavily before, during, and after');
                tips.push('Consider treadmill or pool running');
            } else if (temp >= 85) {
                level = 'caution';
                icon = 'üå°Ô∏è';
                title = 'Hot - Adjust Your Effort';
                message = 'Heat will impact performance. Slow down and hydrate.';
                tips.push('Start 10-15 seconds/mile slower');
                tips.push('Carry water or plan a route with fountains');
                tips.push('Wear light, breathable clothing');
            } else if (temp <= 15) {
                level = 'danger';
                icon = 'ü•∂';
                title = 'EXTREME COLD - Frostbite Risk';
                message = 'Exposed skin can get frostbite in minutes. Consider indoor alternatives.';
                tips.push('Treadmill or indoor track recommended');
                tips.push('If running outside: cover ALL exposed skin');
                tips.push('Shorten the workout');
                tips.push('Run in school hallways if available');
            } else if (temp <= 32) {
                level = 'caution';
                icon = '‚ùÑÔ∏è';
                title = 'Cold - Layer Up';
                message = 'Cold weather running is fine with proper gear.';
                tips.push('Wear moisture-wicking base layer');
                tips.push('Cover extremities (gloves, hat, ear cover)');
                tips.push('Warm up indoors first');
            } else if (temp >= 60 && temp <= 75 && humidity < 70) {
                level = 'good';
                icon = '‚úÖ';
                title = 'Perfect Running Weather!';
                message = 'Ideal conditions. Full send on your workout!';
            }
            
            // Check conditions
            if (condition === 'heavy_snow' || condition === 'ice') {
                level = 'danger';
                icon = '‚õî';
                title = 'DANGEROUS CONDITIONS';
                message = 'Icy/snowy surfaces are extremely hazardous. Do NOT run outside.';
                tips = ['Move workout to treadmill', 'Use indoor track', 'Run in school hallways', 'Pool running is great cross-training'];
            } else if (condition === 'heavy_rain') {
                level = 'warning';
                icon = '‚õàÔ∏è';
                title = 'Storms - Move Indoors';
                message = 'Lightning risk. Do not run outside during thunderstorms.';
                tips = ['Wait for storms to pass', 'Treadmill workout', 'Strength training alternative'];
            } else if (condition === 'snow' || condition === 'rain') {
                if (level === 'good') {
                    level = 'caution';
                    icon = 'üåßÔ∏è';
                    title = 'Wet Conditions';
                    message = 'Running is fine but be careful.';
                }
                tips.push('Watch for slippery surfaces');
                tips.push('Wear bright/reflective gear');
                tips.push('Avoid puddles (wet feet = blisters)');
            }
            
            // Check wind
            if (wind >= 25) {
                if (level === 'good') level = 'caution';
                tips.push('Start into the wind, finish with it at your back');
                tips.push('Expect slower times - don\'t fight it');
            }
            
            // Check humidity
            if (humidity >= 80 && temp >= 75) {
                if (level === 'good') level = 'caution';
                icon = 'üí¶';
                title = title === 'Perfect Running Weather!' ? 'Humid - Sweat Won\'t Evaporate' : title;
                tips.push('Your body can\'t cool efficiently');
                tips.push('Slow pace by 10-20 seconds/mile');
                tips.push('Take walk breaks if needed');
            }
            
            // Set colors and display
            var colors = {
                'good': { bg: 'rgba(0,255,136,0.15)', border: 'var(--success)', text: 'var(--success)' },
                'caution': { bg: 'rgba(255,230,0,0.15)', border: 'var(--secondary)', text: 'var(--secondary)' },
                'warning': { bg: 'rgba(255,165,0,0.2)', border: 'orange', text: 'orange' },
                'danger': { bg: 'rgba(255,77,0,0.2)', border: 'var(--danger)', text: 'var(--danger)' }
            };
            
            var style = colors[level];
            advisory.style.background = style.bg;
            advisory.style.border = '1px solid ' + style.border;
            advisory.style.display = 'block';
            
            var html = '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">';
            html += '<span style="font-size: 1.5rem;">' + icon + '</span>';
            html += '<span style="font-weight: bold; color: ' + style.text + ';">' + title + '</span>';
            html += '</div>';
            
            if (message) {
                html += '<p style="color: var(--text-secondary); margin-bottom: 10px; font-size: 0.9rem;">' + message + '</p>';
            }
            
            if (tips.length > 0) {
                html += '<div style="font-size: 0.85rem; color: var(--text-muted);">';
                tips.forEach(function(tip) {
                    html += '<div style="margin: 4px 0;">‚Ä¢ ' + tip + '</div>';
                });
                html += '</div>';
            }
            
            advisory.innerHTML = html;
        }
        
    </script>
    
    <!-- Weather Modal -->
    <div id="weatherModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 3000; padding: 20px; overflow-y: auto;">
        <div style="max-width: 400px; margin: 40px auto; background: var(--bg-card); border-radius: 16px; padding: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: var(--accent);">üå§Ô∏è Update Weather</h2>
                <button onclick="closeWeatherModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            
            <div class="input-group">
                <label>Your Location</label>
                <input type="text" id="weatherLocationInput" placeholder="City, State (e.g., Austin, TX)" 
                       style="width: 100%; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
            </div>
            
            <div class="input-group">
                <label>Current Temperature (¬∞F)</label>
                <input type="number" id="weatherTempInput" placeholder="72" 
                       style="width: 100%; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
            </div>
            
            <div class="input-group">
                <label>Feels Like (¬∞F)</label>
                <input type="number" id="weatherFeelsLikeInput" placeholder="72" 
                       style="width: 100%; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
            </div>
            
            <div class="input-group">
                <label>Conditions</label>
                <select id="weatherConditionInput" style="width: 100%; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                    <option value="sunny">‚òÄÔ∏è Sunny / Clear</option>
                    <option value="partly_cloudy">‚õÖ Partly Cloudy</option>
                    <option value="cloudy">‚òÅÔ∏è Cloudy / Overcast</option>
                    <option value="light_rain">üåßÔ∏è Light Rain / Drizzle</option>
                    <option value="rain">üåßÔ∏è Rain</option>
                    <option value="heavy_rain">‚õàÔ∏è Heavy Rain / Thunderstorm</option>
                    <option value="snow">üå®Ô∏è Snow</option>
                    <option value="heavy_snow">‚ùÑÔ∏è Heavy Snow / Blizzard</option>
                    <option value="ice">üßä Ice / Freezing Rain</option>
                    <option value="windy">üí® Very Windy (25+ mph)</option>
                    <option value="fog">üå´Ô∏è Fog</option>
                    <option value="extreme_heat">üî• Extreme Heat (95¬∞F+)</option>
                    <option value="extreme_cold">ü•∂ Extreme Cold (Below 20¬∞F)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Wind Speed (mph)</label>
                <input type="number" id="weatherWindInput" placeholder="5" 
                       style="width: 100%; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
            </div>
            
            <div class="input-group">
                <label>Humidity (%)</label>
                <input type="number" id="weatherHumidityInput" placeholder="50" min="0" max="100"
                       style="width: 100%; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
            </div>
            
            <button onclick="saveWeather()" class="btn" style="width: 100%; margin-top: 16px;">
                <span style="position: relative; z-index: 1;">Save & Get Advice</span>
            </button>
        </div>
    </div>

    <!-- Mobile Navigation Bar -->
    <div class="mobile-nav">
        <div class="nav-item active" onclick="switchPage('homePage')">
            <div class="nav-icon">üè†</div>
            <div>Home</div>
        </div>
        <div class="nav-item" onclick="switchPage('todayPage')">
            <div class="nav-icon">üìä</div>
            <div>Today</div>
        </div>
        <div class="nav-item" onclick="switchPage('myPlansPage'); document.getElementById('dataInput').style.display='block';">
            <div class="nav-icon">üìã</div>
            <div>Plans</div>
        </div>
        <div class="nav-item" onclick="switchPage('calendarPage')">
            <div class="nav-icon">üìÖ</div>
            <div>Calendar</div>
        </div>
        <div class="nav-item" onclick="switchPage('profilePage')">
            <div class="nav-icon">üë§</div>
            <div>Profile</div>
        </div>
    </div>
</body>
</html>
